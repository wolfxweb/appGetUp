{% extends "base.html" %}

{% block title %}Cadastro de Usuário{% endblock %}

{% block head %}
<script>
    function buscarEnderecoPorCEP() {
        const cepInput = document.getElementById('cep');
        const searchCepButton = document.getElementById('searchCep');
        const cep = cepInput.value.replace(/\D/g, '');
        
        // Validar CEP
        if (cep.length !== 8) {
            alert('CEP inválido. Digite um CEP com 8 dígitos.');
            return;
        }

        // Mostrar loading no botão
        searchCepButton.disabled = true;
        searchCepButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Buscando...';

        // Fazer requisição para ViaCEP
        fetch(`https://viacep.com.br/ws/${cep}/json/`)
            .then(response => response.json())
            .then(data => {
                if (data.erro) {
                    throw new Error('CEP não encontrado');
                }

                console.log("data", data);

                // Preencher os campos com os dados retornados
                document.getElementById('street').value = data.logradouro || '';
                document.getElementById('neighborhood').value = data.bairro || '';
                document.getElementById('city').value = data.localidade || '';
                
                // Preencher estado (UF)
                const stateSelect = document.getElementById('state');
                stateSelect.value = data.uf || '';
            })
            .catch(error => {
                alert(error.message || 'Erro ao buscar CEP. Tente novamente.');
            })
            .finally(() => {
                // Restaurar botão
                searchCepButton.disabled = false;
                searchCepButton.innerHTML = '<i class="bi bi-search"></i> Buscar';
            });
    }
</script>
{% endblock %}

{% block content %}
<div class="row justify-content-center p-1 mt-5">
    <div class="col-md-10 col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">Cadastro de Usuário</h3>
            </div>
            <div class="card-body">
                {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
                {% endif %}
                
                <!-- Logo -->
                <div class="text-center mb-4">
                    <img src="/static/images/Logo.png" alt="Gestão de Custos" class="img-fluid" style="max-width: 300px;">
                </div>

                <form method="post" action="/register" class="needs-validation" novalidate>
                    <!-- Informações Pessoais -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Informações Pessoais</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="name" class="form-label">Nome Completo <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="name" name="name" required>
                                    <div class="invalid-feedback">
                                        Por favor, informe seu nome completo.
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Sexo <span class="text-danger">*</span></label>
                                    <div class="d-flex gap-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="gender" id="gender_male" value="Masculino" required>
                                            <label class="form-check-label" for="gender_male">Masculino</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="gender" id="gender_female" value="Feminino" required>
                                            <label class="form-check-label" for="gender_female">Feminino</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Aniversário <span class="text-danger">*</span></label>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <input type="number" class="form-control" id="birth_day" name="birth_day" min="1" max="31" placeholder="Dia" required>
                                        </div>
                                        <div class="col-6">
                                            <select class="form-select" id="birth_month" name="birth_month" required>
                                                <option value="" selected disabled>Mês</option>
                                                <option value="1">Janeiro</option>
                                                <option value="2">Fevereiro</option>
                                                <option value="3">Março</option>
                                                <option value="4">Abril</option>
                                                <option value="5">Maio</option>
                                                <option value="6">Junho</option>
                                                <option value="7">Julho</option>
                                                <option value="8">Agosto</option>
                                                <option value="9">Setembro</option>
                                                <option value="10">Outubro</option>
                                                <option value="11">Novembro</option>
                                                <option value="12">Dezembro</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="email" name="email" required>
                                    <div class="invalid-feedback">
                                        Por favor, informe um email válido.
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="whatsapp" class="form-label">WhatsApp <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" id="whatsapp" name="whatsapp" required>
                                    <div class="invalid-feedback">
                                        Por favor, informe um número de WhatsApp válido.
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="password" class="form-label">Senha <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="password" name="password" required>
                                    <div class="invalid-feedback">
                                        A senha deve ter pelo menos 6 caracteres.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Situação Familiar -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Situação Familiar</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Casado?</label>
                                    <div class="d-flex gap-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="married" id="married_yes" value="Sim">
                                            <label class="form-check-label" for="married_yes">Sim</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="married" id="married_no" value="Não">
                                            <label class="form-check-label" for="married_no">Não</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Filhos?</label>
                                    <div class="d-flex gap-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="children" id="children_yes" value="Sim">
                                            <label class="form-check-label" for="children_yes">Sim</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="children" id="children_no" value="Não">
                                            <label class="form-check-label" for="children_no">Não</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Netos?</label>
                                    <div class="d-flex gap-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="grandchildren" id="grandchildren_yes" value="Sim">
                                            <label class="form-check-label" for="grandchildren_yes">Sim</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="grandchildren" id="grandchildren_no" value="Não">
                                            <label class="form-check-label" for="grandchildren_no">Não</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Localização -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Localização</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="cep" class="form-label">CEP <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="cep" name="cep" required 
                                               pattern="[0-9]{5}-[0-9]{3}" placeholder="00000-000"
                                               title="Digite um CEP válido no formato 00000-000">
                                        <button class="btn btn-outline-primary" type="button" id="searchCep" onclick="buscarEnderecoPorCEP()">
                                            <i class="bi bi-search"></i> Buscar
                                        </button>
                                    </div>
                                    <div class="invalid-feedback">
                                        Por favor, informe um CEP válido no formato 00000-000.
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="street" class="form-label">Logradouro <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="street" name="street" required>
                                    <div class="invalid-feedback">
                                        Por favor, informe o logradouro.
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="neighborhood" class="form-label">Bairro <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="neighborhood" name="neighborhood" required>
                                    <div class="invalid-feedback">
                                        Por favor, informe o bairro.
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="state" class="form-label">Estado <span class="text-danger">*</span></label>
                                    <select class="form-select" id="state" name="state" required>
                                        <option value="" selected disabled>Selecione o estado</option>
                                        <option value="AC">Acre</option>
                                        <option value="AL">Alagoas</option>
                                        <option value="AP">Amapá</option>
                                        <option value="AM">Amazonas</option>
                                        <option value="BA">Bahia</option>
                                        <option value="CE">Ceará</option>
                                        <option value="DF">Distrito Federal</option>
                                        <option value="ES">Espírito Santo</option>
                                        <option value="GO">Goiás</option>
                                        <option value="MA">Maranhão</option>
                                        <option value="MT">Mato Grosso</option>
                                        <option value="MS">Mato Grosso do Sul</option>
                                        <option value="MG">Minas Gerais</option>
                                        <option value="PA">Pará</option>
                                        <option value="PB">Paraíba</option>
                                        <option value="PR">Paraná</option>
                                        <option value="PE">Pernambuco</option>
                                        <option value="PI">Piauí</option>
                                        <option value="RJ">Rio de Janeiro</option>
                                        <option value="RN">Rio Grande do Norte</option>
                                        <option value="RS">Rio Grande do Sul</option>
                                        <option value="RO">Rondônia</option>
                                        <option value="RR">Roraima</option>
                                        <option value="SC">Santa Catarina</option>
                                        <option value="SP">São Paulo</option>
                                        <option value="SE">Sergipe</option>
                                        <option value="TO">Tocantins</option>
                                    </select>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="city" class="form-label">Cidade <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="city" name="city" required>
                                    <div class="invalid-feedback">
                                        Por favor, informe a cidade.
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="complement" class="form-label">Complemento</label>
                                    <input type="text" class="form-control" id="complement" name="complement">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informações da Empresa -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Informações da Empresa</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="activity_type" class="form-label">Tipo de Atividade <span class="text-danger">*</span></label>
                                    <select class="form-select" id="activity_type" name="activity_type" required>
                                        <option value="" selected disabled>Selecione o tipo de atividade</option>
                                        <option value="Serviços">Serviços</option>
                                        <option value="Comércio">Comércio</option>
                                        <option value="Indústria">Indústria</option>
                                    </select>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="company_activity" class="form-label">Atividade da Empresa <span class="text-danger">*</span></label>
                                    <select class="form-select" id="company_activity" name="company_activity" required>
                                        <option value="" selected disabled>Selecione a atividade</option>
                                        <option value="AMBULANTE">AMBULANTE</option>
                                        <option value="ATACADO">ATACADO</option>
                                        <option value="AUTOMOTORES">AUTOMOTORES</option>
                                        <option value="VAREJO - Alimentação fora do Lar">VAREJO - Alimentação fora do Lar</option>
                                        <option value="Varejo - Animais domesticos">Varejo - Animais domesticos</option>
                                        <option value="Varejo - Arte, decoração e utilidades para o Lar">Varejo - Arte, decoração e utilidades para o Lar</option>
                                        <option value="Varejo - Bebidas e produtos alimentícios">Varejo - Bebidas e produtos alimentícios</option>
                                        <option value="Varejo - Copa e cozinha">Varejo - Copa e cozinha</option>
                                        <option value="Varejo - Eletroeletrônicos e informática">Varejo - Eletroeletrônicos e informática</option>
                                        <option value="Varejo - Festas, leitura, música, esporte e lazer">Varejo - Festas, leitura, música, esporte e lazer</option>
                                        <option value="Varejo - Jardinagem">Varejo - Jardinagem</option>
                                        <option value="Varejo - Materiais de construção">Varejo - Materiais de construção</option>
                                        <option value="Varejo - Papéis e utilidades para escritórios">Varejo - Papéis e utilidades para escritórios</option>
                                        <option value="Varejo - Saúde e bem-estar">Varejo - Saúde e bem-estar</option>
                                        <option value="Varejo - Vestuário,calçados e complementos">Varejo - Vestuário,calçados e complementos</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="specialty_area" class="form-label">Área de Especialidade <span class="text-danger">*</span></label>
                                    <select class="form-select" id="specialty_area" name="specialty_area" required disabled>
                                        <option value="" selected disabled>Selecione a área de especialidade</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Termos e Condições -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Termos e Condições</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="terms_accepted" name="terms_accepted" required>
                                <label class="form-check-label" for="terms_accepted">
                                    Li e aceito os <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">termos e condições</a> <span class="text-danger">*</span>
                                </label>
                                <div class="invalid-feedback">
                                    Você deve aceitar os termos e condições.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botões de Ação -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">Cadastrar</button>
                        <a href="/login" class="btn btn-outline-secondary">Já tem uma conta? Faça login</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Termos e Condições -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="termsModalLabel">Termos e Condições</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <h5>Termos de Uso do Sistema</h5>
                <p>Ao utilizar este sistema, você concorda com os seguintes termos:</p>
                <ol>
                    <li>Todas as informações fornecidas são verdadeiras e precisas.</li>
                    <li>Você é responsável por manter a confidencialidade de suas credenciais de login.</li>
                    <li>Você concorda em não usar o sistema para fins ilegais ou não autorizados.</li>
                    <li>Seus dados pessoais serão processados de acordo com nossa política de privacidade.</li>
                    <li>A empresa reserva o direito de modificar ou encerrar o serviço a qualquer momento.</li>
                </ol>
                <p>Estes termos podem ser atualizados periodicamente sem aviso prévio.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Ajuda para Email -->
<div class="modal fade" id="emailHelpModal" tabindex="-1" aria-labelledby="emailHelpModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emailHelpModalLabel">Informações sobre Email</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p>O email será utilizado para:</p>
                <ul>
                    <li>Identificação no sistema</li>
                    <li>Comunicações importantes sobre sua conta</li>
                    <li>Recuperação de senha</li>
                    <li>Notificações de segurança</li>
                </ul>
                <p class="text-info"><i class="bi bi-info-circle" style="color: var(--primary-color) !important;"></i> Certifique-se de fornecer um email válido e que você tenha acesso regular.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Ajuda para WhatsApp -->
<div class="modal fade" id="whatsappHelpModal" tabindex="-1" aria-labelledby="whatsappHelpModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="whatsappHelpModalLabel">Informações sobre WhatsApp</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p>Seu número de WhatsApp será utilizado para:</p>
                <ul>
                    <li>Contato rápido para assuntos urgentes</li>
                    <li>Envio de notificações importantes sobre seu uso do sistema</li>
                    <li>Confirmação de ações críticas na plataforma</li>
                </ul>
                <p class="text-info"><i class="bi bi-info-circle" style="color: var(--primary-color) !important;"></i> Formato recomendado: (XX) XXXXX-XXXX</p>
                <p class="text-warning"><i class="bi bi-shield-lock" style="color: var(--primary-color) !important;"></i> Seu número não será compartilhado com terceiros.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Ajuda para Chave de Ativação -->
<div class="modal fade" id="activationKeyHelpModal" tabindex="-1" aria-labelledby="activationKeyHelpModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="activationKeyHelpModalLabel">Informações sobre Chave de Ativação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p>A chave de ativação é um código opcional que pode ser utilizado para:</p>
                <ul>
                    <li>Desbloquear recursos premium na plataforma</li>
                    <li>Ativar funcionalidades específicas para sua conta</li>
                    <li>Integrar seu cadastro a um plano empresarial</li>
                    <li>Validar sua participação em programas especiais</li>
                </ul>
                <p class="text-info"><i class="bi bi-info-circle" style="color: var(--primary-color) !important;"></i> Se você recebeu uma chave de ativação de um representante, insira-a neste campo.</p>
                <p class="text-secondary">Este campo é opcional. Você pode criar sua conta e adicionar uma chave posteriormente.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Ajuda para Data de Cadastro -->
<div class="modal fade" id="dateHelpModal" tabindex="-1" aria-labelledby="dateHelpModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dateHelpModalLabel">Informações sobre Data de Cadastro</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p>A data de cadastro:</p>
                <ul>
                    <li>É registrada automaticamente no momento que você finaliza seu cadastro</li>
                    <li>Será utilizada como referência para cálculos de tempo de uso da plataforma</li>
                    <li>Pode influenciar em promoções e benefícios para usuários mais antigos</li>
                    <li>É armazenada em nosso sistema para fins de auditoria e segurança</li>
                </ul>
                <p class="text-info"><i class="bi bi-info-circle" style="color: var(--primary-color) !important;"></i> Este campo não pode ser alterado manualmente.</p>
                <p class="text-secondary">A data é registrada no formato DD/MM/AAAA conforme o fuso horário do servidor.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>

document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const whatsappInput = document.getElementById('whatsapp');

    // Formatar WhatsApp
    if (whatsappInput) {
        whatsappInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length > 11) {
                value = value.substring(0, 11);
            }
            
            // Formatar como (XX) XXXXX-XXXX
            if (value.length > 2) {
                value = '(' + value.substring(0, 2) + ') ' + value.substring(2);
            }
            if (value.length > 10) {
                value = value.substring(0, 10) + '-' + value.substring(10);
            }
            
            e.target.value = value;
        });
    }

    // Enviar formulário
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        
        fetch('/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(formData)
        })
        .then(response => {
            if (response.ok) {
                window.location.href = '/login';
            } else {
                return response.json().then(data => {
                    throw new Error(data.detail || 'Erro ao cadastrar usuário');
                });
            }
        })
        .catch(error => {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger';
            errorDiv.textContent = error.message;
            
            const existingError = form.querySelector('.alert');
            if (existingError) {
                existingError.remove();
            }
            
            form.insertBefore(errorDiv, form.firstChild);
        });
    });
});
</script>
{% endblock %}

{% block extra_css %}
<style>
    .help-icon {
        cursor: pointer;
        margin-left: 5px;
        opacity: 0.8;
        color: var(--primary-color);
    }
    
    .help-icon:hover {
        opacity: 1;
    }
    
    .form-label {
        font-weight: 500;
    }
    
    .required:after {
        content: "*";
        color: red;
        margin-left: 3px;
    }

    .input-group .btn {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }
</style>
{% endblock %} 