{% extends "base.html" %}

{% block title %}Diagnóstico - GetUp Gestão{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #F5F5F5 !important;
    }
    .container-fluid, .container {
        background-color: #F5F5F5 !important;
    }
    .card, .card-body {
        background-color: #F0F0F0 !important;
    }
    .card-header.bg-secondary {
        background-color: #6c757d !important;
        color: white !important;
    }
    .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
    }
    .btn-secondary:hover {
        background-color: #5a6268;
        border-color: #545b62;
        color: white;
    }
    .form-control, .form-select {
        background-color: #F5F5F5 !important;
    }
    .diagnostic-content {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        border: 1px solid #dee2e6;
    }
    .alert-critical {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        font-weight: bold;
    }
    .alert-attention {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        font-weight: bold;
    }
    .metrics-row {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin: 20px 0;
    }
    .metric-item {
        background-color: #f8f9fa;
        padding: 10px 15px;
        border-radius: 5px;
        border-left: 4px solid #6c757d;
        flex: 1;
        min-width: 200px;
    }
    .metric-label {
        font-weight: bold;
        color: #495057;
    }
    .metric-value {
        font-size: 1.1em;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="background-color: #F5F5F5; min-height: 100vh;">
  <div class="row">
    <div class="col-md-12 mt-5">
        <div class="col-md-12 mb-4">
            <img src="/static/images/Logo.png" alt="Logo" height="40">
         </div>
      <!-- Botões de navegação -->
      <div class="row mb-4 justify-content-center">
        <div class="col-12 col-md-2 mb-2 mb-md-0">
          <a href="/dashboard" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
            Índice
          </a>
        </div>
        <div class="col-12 col-md-2 mb-2 mb-md-0">
          <a href="/basic-data/new" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
            Dados Básicos
          </a>
        </div>
        <div class="col-12 col-md-2 mb-2 mb-md-0">
          <button type="button" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
            Simulador
          </button>
        </div>
        <div class="col-12 col-md-2 mb-2 mb-md-0">
          <button type="button" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
            Calculadora de preços
          </button>
        </div>
      </div>
      
      <!-- Card com seleção de período -->
      <div class="card shadow mb-4" style="background-color: #F0F0F0;">
        <div class="card-header bg-secondary text-white">
          <h4 class="card-title mb-0">Diagnóstico</h4>
        </div>
        <div class="card-body">
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="form-group">
                <label for="basicDataSelect" class="form-label">Selecione o Período dos dados básicos que deseja visualizar</label>
                <select class="form-select" id="basicDataSelect">
                    <option value="">Selecione um período...</option>
                    {% for data in basic_data_list %}
                    <option value="{{ data.id }}" {% if data.is_current %}selected{% endif %}>
                        {{ data.month }}/{{ data.year }}
                    </option>
                    {% endfor %}
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
            
      <!-- Conteúdo do diagnóstico (inicialmente oculto) -->
      <div id="diagnosticContent" style="display: none;">
        <!-- Verificar se o usuário é de comércio varejista ou atacadista -->
        {% if user.activity_type in ['Comércio varejista', 'Comércio atacadista', 'Comércio Varejista', 'Comércio Atacadista'] %}
        <div class="alert alert-info mb-4">
            <strong>Informações para os cálculos:</strong> todas as informações necessárias estão nos dados básicos.
        </div>
        
        <!-- Resultado Principal -->
        <div class="card shadow mb-4" style="background-color: #F0F0F0;">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Resultado do Período</h5>
            </div>
            <div class="card-body">
                <div id="mainResult" class="mb-3"></div>
                <div id="criticalStatus" class="mb-3"></div>
                <div id="salesCapacityAnalysis" class="mb-3"></div>
            </div>
        </div>
        
        <!-- Análises Detalhadas -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100 shadow" style="background-color: #F0F0F0;">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Margem de Contribuição</h5>
                    </div>
                    <div class="card-body">
                        <div id="contributionMarginAnalysis"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100 shadow" style="background-color: #F0F0F0;">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Ponto de Equilíbrio</h5>
                    </div>
                    <div class="card-body">
                        <div id="breakEvenAnalysis"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Resumo e Recomendações -->
        <div class="card shadow mb-4" style="background-color: #F0F0F0;">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Resumo e Próximos Passos</h5>
            </div>
            <div class="card-body">
                <div id="summaryAnalysis"></div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-warning">
            <strong>Diagnóstico não disponível:</strong> Esta funcionalidade está disponível apenas para empresas de Comércio Varejista e Comércio Atacadista.
        </div>
        {% endif %}
      </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
console.log('=== SCRIPT CARREGADO ===');
console.log('Teste básico de JavaScript funcionando!');

document.addEventListener('DOMContentLoaded', function() {
    console.log('=== INÍCIO DO SCRIPT DIAGNÓSTICO ===');
    
    const basicDataSelect = document.getElementById('basicDataSelect');
    const diagnosticContent = document.getElementById('diagnosticContent');
    
    console.log('Elementos encontrados:');
    console.log('- basicDataSelect:', basicDataSelect);
    console.log('- diagnosticContent:', diagnosticContent);
    
    if (basicDataSelect) {
        console.log('Adicionando event listener ao basicDataSelect...');
        
        basicDataSelect.addEventListener('change', function() {
            console.log('=== EVENTO CHANGE DISPARADO ===');
            console.log('Valor selecionado:', this.value);
            console.log('Opção selecionada:', this.options[this.selectedIndex].text);
            
            if (this.value) {
                console.log('Valor válido selecionado, mostrando conteúdo...');
                diagnosticContent.style.display = 'block';
                console.log('diagnosticContent display:', diagnosticContent.style.display);
                console.log('diagnosticContent offsetHeight:', diagnosticContent.offsetHeight);
                console.log('diagnosticContent offsetWidth:', diagnosticContent.offsetWidth);
                console.log('diagnosticContent getBoundingClientRect:', diagnosticContent.getBoundingClientRect());
                
                loadDiagnosticData(this.value);
            } else {
                console.log('Nenhum valor selecionado, escondendo conteúdo...');
                diagnosticContent.style.display = 'none';
            }
        });
        
        // Testar se o evento está funcionando
        console.log('Testando se o select tem opções...');
        console.log('Número de opções:', basicDataSelect.options.length);
        for (let i = 0; i < basicDataSelect.options.length; i++) {
            console.log(`Opção ${i}:`, basicDataSelect.options[i].value, basicDataSelect.options[i].text);
        }
        
        // Carregar dados se já houver um período selecionado
        if (basicDataSelect.value) {
            console.log('Carregamento automático - valor:', basicDataSelect.value);
            diagnosticContent.style.display = 'block';
            loadDiagnosticData(basicDataSelect.value);
        }
    } else {
        console.error('ERRO: Elemento basicDataSelect não encontrado!');
    }
    
    console.log('=== FIM DO SCRIPT DIAGNÓSTICO ===');
});

async function loadDiagnosticData(basicDataId) {
    console.log('=== INÍCIO loadDiagnosticData ===');
    console.log('ID recebido:', basicDataId);
    
    try {
        const url = `/diagnostico/api/basic-data/${basicDataId}`;
        console.log('Fazendo requisição para:', url);
        
        const response = await fetch(url);
        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Dados recebidos:', data);
        
        calculateAndDisplayDiagnosis(data);
        
    } catch (error) {
        console.error('Erro em loadDiagnosticData:', error);
        const mainResult = document.getElementById('mainResult');
        if (mainResult) {
            mainResult.innerHTML = `<div class="alert alert-danger">Erro ao carregar os dados do diagnóstico: ${error.message}</div>`;
        } else {
            console.error('Elemento mainResult não encontrado para exibir erro!');
        }
    }
    
    console.log('=== FIM loadDiagnosticData ===');
}

function calculateAndDisplayDiagnosis(data) {
    // Cálculos básicos
    const faturamento = data.sales_revenue || 0;
    const gastosVendas = data.sales_expenses || 0;
    const gastosCompras = data.input_product_expenses || 0;
    const custosFixos = data.fixed_costs || data.other_fixed_costs || 0;
    const vendas = data.clients_served || 0;
    const capacidadeAtendimento = parseInt(data.service_capacity) || 0;
    const margemIdeal = (data.ideal_profit_margin || data.ideal_service_profit_margin || 0) / 100;
    
    // Cálculo da margem
    const totalGastos = gastosVendas + gastosCompras + custosFixos;
    const margemValor = faturamento - totalGastos;
    const margemPercentual = faturamento > 0 ? (margemValor / faturamento) * 100 : 0;
    
    // Determinar tipo de resultado
    let tipoResultado, valorResultado;
    if (margemValor < 0) {
        tipoResultado = "prejuízo";
        valorResultado = Math.abs(margemValor);
    } else if (margemValor === 0) {
        tipoResultado = "margem";
        valorResultado = 0;
    } else {
        tipoResultado = "lucro";
        valorResultado = margemValor;
    }
    
    // Ticket médio
    const ticketMedio = vendas > 0 ? faturamento / vendas : 0;
    
    // Margem de contribuição unitária
    const margemContribuicao = vendas > 0 ? (faturamento - (gastosVendas + gastosCompras)) / vendas : 0;
    
    // Ponto de equilíbrio
    const pontoEquilibrio = margemContribuicao > 0 && margemContribuicao * vendas >= custosFixos ? 
        Math.ceil(custosFixos / margemContribuicao) : null;
    
    // Margem potencial (capacidade máxima)
    const faturamentoPotencial = capacidadeAtendimento * ticketMedio;
         const margemPotencial = faturamentoPotencial > 0 && faturamento > 0 ? 
         ((faturamentoPotencial - ((faturamentoPotencial * (gastosVendas + gastosCompras) / faturamento) + custosFixos)) / faturamentoPotencial) * 100 : 0;
    
    // Distância do objetivo
    let distanciaObjetivo = 0;
    if (margemValor < 0) {
        distanciaObjetivo = Math.abs(margemValor) + (margemIdeal * faturamento);
    } else if (margemValor === 0) {
        distanciaObjetivo = margemIdeal * faturamento;
    } else {
        const objetivoValor = margemIdeal * faturamento;
        if (objetivoValor <= margemValor) {
            distanciaObjetivo = margemValor - objetivoValor;
        } else {
            distanciaObjetivo = objetivoValor - margemValor;
        }
    }
    
    // Exibir resultado principal
    console.log('Chamando displayMainResult...');
    displayMainResult(data, faturamento, tipoResultado, margemPercentual, valorResultado);
    
    // Exibir status crítico
    console.log('Chamando displayCriticalStatus...');
    displayCriticalStatus(margemValor, vendas, capacidadeAtendimento);
    
    // Análise vendas vs capacidade
    console.log('Chamando displaySalesCapacityAnalysis...');
    displaySalesCapacityAnalysis(margemValor, vendas, capacidadeAtendimento);
    
    // Análise da margem de contribuição
    console.log('Chamando displayContributionMarginAnalysis...');
    displayContributionMarginAnalysis(margemContribuicao, vendas, custosFixos);
    
    // Análise do ponto de equilíbrio
    console.log('Chamando displayBreakEvenAnalysis...');
    displayBreakEvenAnalysis(pontoEquilibrio, vendas, margemContribuicao);
    
    // Resumo e próximos passos
    console.log('Chamando displaySummaryAnalysis...');
    displaySummaryAnalysis(margemValor, margemPercentual, margemIdeal, distanciaObjetivo, margemPotencial);
}

function displayMainResult(data, faturamento, tipoResultado, margemPercentual, valorResultado) {
    console.log('displayMainResult executando...');
    
    // Pegar mês e ano do combo selecionado
    const basicDataSelect = document.getElementById('basicDataSelect');
    const selectedOption = basicDataSelect.options[basicDataSelect.selectedIndex];
    const mesAno = selectedOption ? selectedOption.text : 'N/A';
    
    console.log('Mês/Ano do combo:', mesAno);
    
    let texto = "";
    
    if (tipoResultado === "prejuízo") {
        texto = `Em ${mesAno} seu Negócio alcançou um faturamento bruto de R$ ${faturamento.toLocaleString('pt-BR', {minimumFractionDigits: 2})}, com ${tipoResultado} de ${margemPercentual.toFixed(2)}%, o que significa que gastou R$ ${valorResultado.toLocaleString('pt-BR', {minimumFractionDigits: 2})} mais do que faturou!`;
    } else if (tipoResultado === "margem") {
        texto = `Em ${mesAno} seu Negócio alcançou um faturamento bruto de R$ ${faturamento.toLocaleString('pt-BR', {minimumFractionDigits: 2})}, com ${tipoResultado} de ${margemPercentual.toFixed(2)}%, o que significa que gastou tudo que faturou!`;
    } else {
        texto = `Em ${mesAno} seu Negócio alcançou um faturamento bruto de R$ ${faturamento.toLocaleString('pt-BR', {minimumFractionDigits: 2})}, com ${tipoResultado} de ${margemPercentual.toFixed(2)}%, o que significa que gastou R$ ${valorResultado.toLocaleString('pt-BR', {minimumFractionDigits: 2})} menos do que faturou!`;
    }
    
    const alertClass = tipoResultado === "prejuízo" ? "alert-danger" : 
                     tipoResultado === "margem" ? "alert-warning" : "alert-success";
    
    const mainElement = document.getElementById('mainResult');
    console.log('mainResult element:', mainElement);
    console.log('texto gerado:', texto);
    
    if (mainElement) {
        mainElement.innerHTML = `<div class="alert ${alertClass}">${texto}</div>`;
        console.log('HTML inserido no mainResult');
    } else {
        console.error('Elemento mainResult não encontrado!');
    }
}

function displayCriticalStatus(margemValor, vendas, capacidadeAtendimento) {
    let status = "";
    let alertClass = "";
    
    if (margemValor < 0) {
        status = "ESTA É UMA SITUAÇÃO CRÍTICA!";
        alertClass = "alert-danger";
    } else if (margemValor === 0) {
        status = "ATENÇÃO!";
        alertClass = "alert-warning";
    } else if (vendas > capacidadeAtendimento * 1.05) {
        status = "ATENÇÃO!";
        alertClass = "alert-warning";
    }
    
    if (status) {
        document.getElementById('criticalStatus').innerHTML = `<div class="alert ${alertClass}"><strong>${status}</strong></div>`;
    }
}

function displaySalesCapacityAnalysis(margemValor, vendas, capacidadeAtendimento) {
    let texto = "";
    
    if (margemValor < 0) {
        if (vendas > capacidadeAtendimento * 1.05) {
            texto = `Este resultado negativo aconteceu mesmo com as vendas (${vendas}) superando a capacidade de atendimento (${capacidadeAtendimento}).`;
        } else if (vendas >= capacidadeAtendimento * 0.95 && vendas <= capacidadeAtendimento * 1.05) {
            texto = `Este resultado negativo aconteceu mesmo com as vendas nos limites da capacidade de atendimento (${capacidadeAtendimento}).`;
        } else {
            texto = `Este resultado negativo aconteceu com as vendas (${vendas}) abaixo da capacidade de atendimento (${capacidadeAtendimento}).`;
        }
    }
    
    if (texto) {
        document.getElementById('salesCapacityAnalysis').innerHTML = `<p>${texto}</p>`;
    }
}

function displayContributionMarginAnalysis(margemContribuicao, vendas, custosFixos) {
    let texto = "";
    
    if (margemContribuicao <= 0) {
        texto = "A margem de contribuição unitária é negativa ou zero, o que significa que cada venda não cobre nem os custos variáveis.";
    } else {
        const totalContribuicao = margemContribuicao * vendas;
        if (totalContribuicao >= custosFixos) {
            texto = `A margem de contribuição unitária é de R$ ${margemContribuicao.toLocaleString('pt-BR', {minimumFractionDigits: 2})}. Com ${vendas} vendas, você gera R$ ${totalContribuicao.toLocaleString('pt-BR', {minimumFractionDigits: 2})} para cobrir os custos fixos de R$ ${custosFixos.toLocaleString('pt-BR', {minimumFractionDigits: 2})}.`;
        } else {
            texto = `A margem de contribuição unitária é de R$ ${margemContribuicao.toLocaleString('pt-BR', {minimumFractionDigits: 2})}. Com ${vendas} vendas, você gera apenas R$ ${totalContribuicao.toLocaleString('pt-BR', {minimumFractionDigits: 2})}, insuficiente para cobrir os custos fixos de R$ ${custosFixos.toLocaleString('pt-BR', {minimumFractionDigits: 2})}.`;
        }
    }
    
    document.getElementById('contributionMarginAnalysis').innerHTML = `<p>${texto}</p>`;
}

function displayBreakEvenAnalysis(pontoEquilibrio, vendas, margemContribuicao) {
    let texto = "";
    
    if (pontoEquilibrio) {
        if (vendas >= pontoEquilibrio) {
            texto = `Seu ponto de equilíbrio é de ${pontoEquilibrio} vendas. Com ${vendas} vendas realizadas, você superou o ponto de equilíbrio.`;
        } else {
            const faltam = pontoEquilibrio - vendas;
            texto = `Seu ponto de equilíbrio é de ${pontoEquilibrio} vendas. Você precisa de mais ${faltam} vendas para atingir o equilíbrio.`;
        }
    } else {
        texto = "Não foi possível calcular o ponto de equilíbrio com os dados atuais.";
    }
    
    document.getElementById('breakEvenAnalysis').innerHTML = `<p>${texto}</p>`;
}

function displaySummaryAnalysis(margemValor, margemPercentual, margemIdeal, distanciaObjetivo, margemPotencial) {
    let recomendacoes = [];
    
    if (margemValor < 0) {
        recomendacoes.push("• Revisar imediatamente todos os custos e despesas");
        recomendacoes.push("• Analisar a possibilidade de aumento de preços");
        recomendacoes.push("• Buscar fornecedores com melhores condições");
        recomendacoes.push("• Reduzir custos fixos onde possível");
    } else if (margemPercentual < margemIdeal * 100) {
        recomendacoes.push("• Trabalhar para atingir a margem ideal");
        recomendacoes.push("• Otimizar processos para reduzir custos");
        recomendacoes.push("• Avaliar estratégias de precificação");
    } else {
        recomendacoes.push("• Manter os bons resultados");
        recomendacoes.push("• Buscar oportunidades de crescimento");
        recomendacoes.push("• Reinvestir os lucros no negócio");
    }
    
    if (margemPotencial > margemPercentual) {
        recomendacoes.push(`• Potencial de melhoria: margem pode chegar a ${margemPotencial.toFixed(2)}% operando na capacidade máxima`);
    }
    
    const texto = `
        <p><strong>Distância do objetivo:</strong> R$ ${distanciaObjetivo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
        <p><strong>Próximos passos recomendados:</strong></p>
        <ul class="mb-0">
            ${recomendacoes.map(rec => `<li>${rec}</li>`).join('')}
        </ul>
    `;
    
    document.getElementById('summaryAnalysis').innerHTML = texto;
}
</script>
{% endblock %} 