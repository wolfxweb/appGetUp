{% extends "base.html" %}

{% block title %}Diagnóstico - GetUp Gestão{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #F5F5F5 !important;
    }
    .container-fluid, .container {
        background-color: #F5F5F5 !important;
    }
    .card, .card-body {
        background-color: #F0F0F0 !important;
    }
    .card-header.bg-secondary {
        background-color: #6c757d !important;
        color: white !important;
    }
    .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
    }
    .btn-secondary:hover {
        background-color: #5a6268;
        border-color: #545b62;
        color: white;
    }
    .form-control, .form-select {
        background-color: #F5F5F5 !important;
    }
    .diagnostic-content {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        border: 1px solid #dee2e6;
    }
    .alert-critical {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        font-weight: bold;
    }
    .alert-attention {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        font-weight: bold;
    }
    .metrics-row {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin: 20px 0;
    }
    .metric-item {
        background-color: #f8f9fa;
        padding: 10px 15px;
        border-radius: 5px;
        border-left: 4px solid #6c757d;
        flex: 1;
        min-width: 200px;
    }
    .metric-label {
        font-weight: bold;
        color: #495057;
    }
    .metric-value {
        font-size: 1.1em;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="background-color: #F5F5F5; min-height: 100vh;">
  <div class="row">
    <div class="col-md-12 mt-5">
        <div class="col-md-12 mb-4">
            <img src="/static/images/Logo.png" alt="Logo" height="40">
            </div>
      <!-- Botões de navegação -->
      <div class="row mb-4 justify-content-center">
        <div class="col-12 col-md-2 mb-2 mb-md-0">
          <a href="/dashboard" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
            Índice
          </a>
        </div>
        <div class="col-12 col-md-2 mb-2 mb-md-0">
          <a href="/basic-data/new" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
            Dados Básicos
          </a>
        </div>
        <div class="col-12 col-md-2 mb-2 mb-md-0">
          <button type="button" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
            Simulador
          </button>
        </div>
        <div class="col-12 col-md-2 mb-2 mb-md-0">
          <button type="button" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
            Calculadora de preços
          </button>
        </div>
                </div>

      <!-- Card com seleção de período -->
      <div class="card shadow mb-4" style="background-color: #F0F0F0;">
        <div class="card-header bg-secondary text-white">
                <h4 class="card-title mb-0">Diagnóstico</h4>
                    </div>
            <div class="card-body">
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="form-group">
                                                        <label for="basicDataSelect" class="form-label">Selecione o Período dos dados básicos que deseja visualizar</label>
                <select class="form-select" id="basicDataSelect">
                    <option value="">Selecione um período...</option>
                    {% for data in basic_data_list %}
                    <option value="{{ data.id }}" {% if data.is_current %}selected{% endif %}>
                        {{ data.month }}/{{ data.year }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
                </div>
    </div>

      <!-- Conteúdo do diagnóstico (inicialmente oculto) -->
      <div id="diagnosticContent" style="display: none;">
        <!-- Verificar se o usuário é de comércio varejista ou atacadista -->
        {% if user.activity_type in ['Comércio varejista', 'Comércio atacadista', 'Comércio Varejista', 'Comércio Atacadista'] %}
        <div class="alert alert-info mb-4">
            <strong>Informações para os cálculos:</strong> todas as informações necessárias estão nos dados básicos.
                    </div>
        
        <!-- Resultado Principal -->
        <div class="card shadow mb-4" style="background-color: #F0F0F0;">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Resultado do Período</h5>
                                </div>
            <div class="card-body">
                <div id="mainResult" class="mb-3"></div>
                <div id="criticalStatus" class="mb-3"></div>
                <div id="salesCapacityAnalysis" class="mb-3"></div>
        </div>
    </div>

        <!-- Análises Detalhadas -->
                <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100 shadow" style="background-color: #F0F0F0;">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Margem de Contribuição</h5>
                </div>
                <div class="card-body">
                        <div id="contributionMarginAnalysis"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100 shadow" style="background-color: #F0F0F0;">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Ponto de Equilíbrio</h5>
                    </div>
                    <div class="card-body">
                        <div id="breakEvenAnalysis"></div>
                                </div>
                </div>
            </div>
        </div>

        <!-- Resumo e Recomendações -->
        <div class="card shadow mb-4" style="background-color: #F0F0F0;">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Resumo e Próximos Passos</h5>
                </div>
                <div class="card-body">
                <div id="summaryAnalysis"></div>
                        </div>
                    </div>

        {% elif user.activity_type in ['Alimentação fora do Lar', 'Alimentação Fora do Lar', 'Alimentação fora do lar'] %}
        
        <!-- Resultado Principal -->
        <div class="card shadow mb-4" style="background-color: #F0F0F0;">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Resultado do Período</h5>
            </div>
            <div class="card-body">
                <div id="mainResultAlimentacao" class="mb-3"></div>
                <div id="criticalStatusAlimentacao" class="mb-3"></div>
                <div id="salesCapacityAnalysisAlimentacao" class="mb-3"></div>
            </div>
        </div>

        <!-- Análises Detalhadas -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100 shadow" style="background-color: #F0F0F0;">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Ticket Médio e Margem de Contribuição</h5>
                                    </div>
                    <div class="card-body">
                        <div id="ticketMarginAnalysisAlimentacao"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100 shadow" style="background-color: #F0F0F0;">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Ponto de Equilíbrio</h5>
                    </div>
                    <div class="card-body">
                        <div id="breakEvenAnalysisAlimentacao"></div>
                                </div>
                            </div>
                        </div>
                    </div>

        <!-- Análise de Capacidade -->
        <div class="card shadow mb-4" style="background-color: #F0F0F0;">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Análise de Capacidade e Potencial</h5>
                            </div>
                            <div class="card-body">
                <div id="capacityAnalysisAlimentacao"></div>
                                </div>
                                </div>
        
        <!-- Resumo e Recomendações -->
        <div class="card shadow mb-4" style="background-color: #F0F0F0;">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Resumo e Próximos Passos</h5>
                            </div>
            <div class="card-body">
                <div id="summaryAnalysisAlimentacao"></div>
                        </div>
        </div>
        
        <!-- Recomendações Específicas -->
        <div class="card shadow mb-4" style="background-color: #F0F0F0;">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Recomendações Específicas</h5>
            </div>
            <div class="card-body">
                <div id="recommendationsAlimentacao"></div>
                    </div>
                </div>

        <!-- Verificar se o usuário é de indústria -->
        {% elif user.activity_type in ['Indústria', 'Industria'] %}
        
        <!-- Resultado Principal -->
        <div class="card shadow mb-4" style="background-color: #F0F0F0;">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Resultado do Período</h5>
                            </div>
                            <div class="card-body">
                <div id="mainResultIndustria" class="mb-3"></div>
                <div id="criticalStatusIndustria" class="mb-3"></div>
                <div id="salesCapacityAnalysisIndustria" class="mb-3"></div>
                                        </div>
                                    </div>
        
        <!-- Análises Detalhadas -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100 shadow" style="background-color: #F0F0F0;">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Ticket Médio e Margem de Contribuição</h5>
                                </div>
                    <div class="card-body">
                        <div id="ticketMarginAnalysisIndustria"></div>
                            </div>
                        </div>
                    </div>
            <div class="col-md-6">
                <div class="card h-100 shadow" style="background-color: #F0F0F0;">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Ponto de Equilíbrio</h5>
                </div>
                    <div class="card-body">
                        <div id="breakEvenAnalysisIndustria"></div>
            </div>
        </div>
    </div>
</div>

        <!-- Análise de Capacidade de Produção -->
        <div class="card shadow mb-4" style="background-color: #F0F0F0;">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Análise de Capacidade de Produção e Potencial</h5>
            </div>
            <div class="card-body">
                <div id="capacityAnalysisIndustria"></div>
                </div>
            </div>
        
        <!-- Resumo e Recomendações -->
        <div class="card shadow mb-4" style="background-color: #F0F0F0;">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Resumo e Próximos Passos</h5>
        </div>
            <div class="card-body">
                <div id="summaryAnalysisIndustria"></div>
    </div>
</div>

        <!-- Recomendações Específicas -->
        <div class="card shadow mb-4" style="background-color: #F0F0F0;">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Recomendações Específicas</h5>
            </div>
            <div class="card-body">
                <div id="recommendationsIndustria"></div>
                </div>
            </div>
        
        <!-- Verificar se o usuário é prestador de serviços -->
        {% elif user.activity_type in ['Prestação de serviços', 'Prestador de serviços', 'Prestação de Serviços'] %}
        
        <!-- Resultado Principal -->
        <div class="card shadow mb-4" style="background-color: #F0F0F0;">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Resultado do Período</h5>
        </div>
            <div class="card-body">
                <div id="mainResultServicos" class="mb-3"></div>
                <div id="criticalStatusServicos" class="mb-3"></div>
                <div id="salesCapacityAnalysisServicos" class="mb-3"></div>
    </div>
</div>

        <!-- Análises Detalhadas -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100 shadow" style="background-color: #F0F0F0;">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Ticket Médio e Margem de Contribuição</h5>
            </div>
                    <div class="card-body">
                        <div id="ticketMarginAnalysisServicos"></div>
                </div>
            </div>
        </div>
            <div class="col-md-6">
                <div class="card h-100 shadow" style="background-color: #F0F0F0;">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Ponto de Equilíbrio</h5>
                    </div>
                    <div class="card-body">
                        <div id="breakEvenAnalysisServicos"></div>
                    </div>
                </div>
    </div>
</div>

        <!-- Análise de Capacidade de Atendimento -->
        <div class="card shadow mb-4" style="background-color: #F0F0F0;">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Análise de Capacidade de Atendimento e Potencial</h5>
            </div>
            <div class="card-body">
                <div id="capacityAnalysisServicos"></div>
                </div>
            </div>
        
        <!-- Resumo e Recomendações -->
        <div class="card shadow mb-4" style="background-color: #F0F0F0;">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Resumo e Próximos Passos</h5>
        </div>
            <div class="card-body">
                <div id="summaryAnalysisServicos"></div>
    </div>
</div>

        <!-- Recomendações Específicas -->
        <div class="card shadow mb-4" style="background-color: #F0F0F0;">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Recomendações Específicas</h5>
            </div>
            <div class="card-body">
                <div id="recommendationsServicos"></div>
                </div>
            </div>
        
        {% else %}
        <div class="alert alert-warning">
            <strong>Diagnóstico não disponível:</strong> Esta funcionalidade está disponível apenas para empresas de Comércio Varejista, Comércio Atacadista, Alimentação fora do lar, Indústria e Prestador de serviços.
        </div>
        {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
console.log('=== SCRIPT CARREGADO ===');
console.log('Teste básico de JavaScript funcionando!');

document.addEventListener('DOMContentLoaded', function() {
    console.log('=== INÍCIO DO SCRIPT DIAGNÓSTICO ===');
    
    const basicDataSelect = document.getElementById('basicDataSelect');
    const diagnosticContent = document.getElementById('diagnosticContent');
    
    console.log('Elementos encontrados:');
    console.log('- basicDataSelect:', basicDataSelect);
    console.log('- diagnosticContent:', diagnosticContent);
    
    if (basicDataSelect) {
        console.log('Adicionando event listener ao basicDataSelect...');
        
        basicDataSelect.addEventListener('change', function() {
            console.log('=== EVENTO CHANGE DISPARADO ===');
            console.log('Valor selecionado:', this.value);
            console.log('Opção selecionada:', this.options[this.selectedIndex].text);
            
            if (this.value) {
                console.log('Valor válido selecionado, mostrando conteúdo...');
                diagnosticContent.style.display = 'block';
                console.log('diagnosticContent display:', diagnosticContent.style.display);
                console.log('diagnosticContent offsetHeight:', diagnosticContent.offsetHeight);
                console.log('diagnosticContent offsetWidth:', diagnosticContent.offsetWidth);
                console.log('diagnosticContent getBoundingClientRect:', diagnosticContent.getBoundingClientRect());
                
                loadDiagnosticData(this.value);
            } else {
                console.log('Nenhum valor selecionado, escondendo conteúdo...');
                diagnosticContent.style.display = 'none';
            }
        });
        
        // Testar se o evento está funcionando
        console.log('Testando se o select tem opções...');
        console.log('Número de opções:', basicDataSelect.options.length);
        for (let i = 0; i < basicDataSelect.options.length; i++) {
            console.log(`Opção ${i}:`, basicDataSelect.options[i].value, basicDataSelect.options[i].text);
        }
        
        // Carregar dados se já houver um período selecionado
        if (basicDataSelect.value) {
            console.log('Carregamento automático - valor:', basicDataSelect.value);
            diagnosticContent.style.display = 'block';
            loadDiagnosticData(basicDataSelect.value);
        }
    } else {
        console.error('ERRO: Elemento basicDataSelect não encontrado!');
    }
    
    console.log('=== FIM DO SCRIPT DIAGNÓSTICO ===');
});

async function loadDiagnosticData(basicDataId) {
    console.log('=== INÍCIO loadDiagnosticData ===');
    console.log('ID recebido:', basicDataId);
    
    try {
        const url = `/diagnostico/api/basic-data/${basicDataId}`;
        console.log('Fazendo requisição para:', url);
        
        const response = await fetch(url);
        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Dados recebidos:', data);
        
        calculateAndDisplayDiagnosis(data);
        
    } catch (error) {
        console.error('Erro em loadDiagnosticData:', error);
        const mainResult = document.getElementById('mainResult');
        if (mainResult) {
            mainResult.innerHTML = `<div class="alert alert-danger">Erro ao carregar os dados do diagnóstico: ${error.message}</div>`;
        } else {
            console.error('Elemento mainResult não encontrado para exibir erro!');
        }
    }
    
    console.log('=== FIM loadDiagnosticData ===');
}

function calculateAndDisplayDiagnosis(data) {
    // Verificar o tipo de atividade do usuário
    const activityType = '{{ user.activity_type }}';
    
    if (activityType === 'Alimentação fora do Lar' || activityType === 'Alimentação Fora do Lar' || activityType === 'Alimentação fora do lar') {
        calculateAndDisplayDiagnosisAlimentacao(data);
    } else if (activityType === 'Indústria' || activityType === 'Industria') {
        calculateAndDisplayDiagnosisIndustria(data);
    } else if (activityType === 'Prestação de serviços' || activityType === 'Prestador de serviços' || activityType === 'Prestação de Serviços') {
        calculateAndDisplayDiagnosisServicos(data);
    } else {
        // Cálculos para Comércio Varejista e Atacadista (código existente)
        calculateAndDisplayDiagnosisComercio(data);
    }
}

function calculateAndDisplayDiagnosisComercio(data) {
    // Cálculos básicos
    const faturamento = data.sales_revenue || 0;
    const gastosVendas = data.sales_expenses || 0;
    const gastosCompras = data.input_product_expenses || 0;
    const custosFixos = data.fixed_costs || data.other_fixed_costs || 0;
    const vendas = data.clients_served || 0;
    const capacidadeAtendimento = parseInt(data.service_capacity) || 0;
    const margemIdeal = (data.ideal_profit_margin || data.ideal_service_profit_margin || 0) / 100;
    
    // Cálculo da margem
    const totalGastos = gastosVendas + gastosCompras + custosFixos;
    const margemValor = faturamento - totalGastos;
    const margemPercentual = faturamento > 0 ? (margemValor / faturamento) * 100 : 0;
    
    // Determinar tipo de resultado
    let tipoResultado, valorResultado;
    if (margemValor < 0) {
        tipoResultado = "prejuízo";
        valorResultado = Math.abs(margemValor);
    } else if (margemValor === 0) {
        tipoResultado = "margem";
        valorResultado = 0;
    } else {
        tipoResultado = "lucro";
        valorResultado = margemValor;
    }
    
    // Ticket médio
    const ticketMedio = vendas > 0 ? faturamento / vendas : 0;
    
    // Margem de contribuição unitária
    const margemContribuicao = vendas > 0 ? (faturamento - (gastosVendas + gastosCompras)) / vendas : 0;
    
    // Ponto de equilíbrio
    const pontoEquilibrio = margemContribuicao > 0 && margemContribuicao * vendas >= custosFixos ? 
        Math.ceil(custosFixos / margemContribuicao) : null;
    
    // Margem potencial (capacidade máxima)
    const faturamentoPotencial = capacidadeAtendimento * ticketMedio;
         const margemPotencial = faturamentoPotencial > 0 && faturamento > 0 ? 
         ((faturamentoPotencial - ((faturamentoPotencial * (gastosVendas + gastosCompras) / faturamento) + custosFixos)) / faturamentoPotencial) * 100 : 0;
    
    // Distância do objetivo
    let distanciaObjetivo = 0;
    if (margemValor < 0) {
        distanciaObjetivo = Math.abs(margemValor) + (margemIdeal * faturamento);
    } else if (margemValor === 0) {
        distanciaObjetivo = margemIdeal * faturamento;
    } else {
        const objetivoValor = margemIdeal * faturamento;
        if (objetivoValor <= margemValor) {
            distanciaObjetivo = margemValor - objetivoValor;
        } else {
            distanciaObjetivo = objetivoValor - margemValor;
        }
    }
    
    // Exibir resultado principal
    console.log('Chamando displayMainResult...');
    displayMainResult(data, faturamento, tipoResultado, margemPercentual, valorResultado);
    
    // Exibir status crítico
    console.log('Chamando displayCriticalStatus...');
    displayCriticalStatus(margemValor, vendas, capacidadeAtendimento);
    
    // Análise vendas vs capacidade
    console.log('Chamando displaySalesCapacityAnalysis...');
    displaySalesCapacityAnalysis(margemValor, vendas, capacidadeAtendimento);
    
    // Análise da margem de contribuição
    console.log('Chamando displayContributionMarginAnalysis...');
    displayContributionMarginAnalysis(margemContribuicao, vendas, custosFixos);
    
    // Análise do ponto de equilíbrio
    console.log('Chamando displayBreakEvenAnalysis...');
    displayBreakEvenAnalysis(pontoEquilibrio, vendas, margemContribuicao);
    
    // Resumo e próximos passos
    console.log('Chamando displaySummaryAnalysis...');
    displaySummaryAnalysis(margemValor, margemPercentual, margemIdeal, distanciaObjetivo, margemPotencial);
}

function calculateAndDisplayDiagnosisAlimentacao(data) {
    console.log('=== INÍCIO CÁLCULOS ALIMENTAÇÃO FORA DO LAR ===');
    
    // Pegar mês e ano do combo selecionado
    const basicDataSelect = document.getElementById('basicDataSelect');
    const selectedOption = basicDataSelect.options[basicDataSelect.selectedIndex];
    const mesAno = selectedOption ? selectedOption.text : 'N/A';
    
    // Dados básicos
    const faturamento = data.sales_revenue || 0; // (R$B)
    const gastosVendas = data.sales_expenses || 0;
    const gastosInsumos = data.input_product_expenses || 0;
    const proLabore = data.pro_labore || 0;
    const custoMOD = data.work_hours_per_week || 0; // Usando work_hours_per_week como custo MOD temporariamente
    const demaisCustosFixos = data.other_fixed_costs || 0;
    const vendas = data.clients_served || 0;
    const capacidadeAtendimento = parseInt(data.service_capacity) || 0;
    const margemIdeal = (data.ideal_profit_margin || data.ideal_service_profit_margin || 0) / 100;
    
    // Fórmula (C): SE(P7<0;"prejuízo";SE(P7=0;"margem";SE(P7>0; "lucro")))
    const totalGastos = gastosVendas + gastosInsumos + proLabore + custoMOD + demaisCustosFixos;
    const margemValor = faturamento - totalGastos;
    let tipoResultado;
    if (margemValor < 0) {
        tipoResultado = "prejuízo";
    } else if (margemValor === 0) {
        tipoResultado = "margem";
    } else {
        tipoResultado = "lucro";
    }
    
    // Fórmula (D%): (Faturamento-(gastos com vendas + gastos com insumos e produtos + pró-labore +custo MOD + demais custos fixos)) / Faturamento
    const margemPercentual = faturamento > 0 ? (margemValor / faturamento) * 100 : 0;
    
    // Fórmula (R$E): SE(Margem="";"";SE(Margem<0;(gastos com vendas + gastos com insumos e produtos + pró-labore + custo MOD + demais custos fixos)-Faturamento;SE(Margem >=0;Faturamento - (gastos com vendas + gastos com insumos e produtos + pró-labore + custo MOD + demais custos fixos))))
    let valorResultado;
    if (margemValor < 0) {
        valorResultado = totalGastos - faturamento;
    } else {
        valorResultado = faturamento - totalGastos;
    }
    
    // Fórmula (R$F): Faturamento/Vendas
    const ticketMedio = vendas > 0 ? faturamento / vendas : 0;
    
    // Fórmula (R$G): (Faturamento-(gastos com vendas + gastos com insumos e produtos))/Vendas
    const margemContribuicao = vendas > 0 ? (faturamento - (gastosVendas + gastosInsumos)) / vendas : 0;
    
    // Fórmula (R$H): Margem de contribuição*Vendas
    const margemContribuicaoTotal = margemContribuicao * vendas;
    
    // Fórmula (i): SE(Margem de contribuição*Vendas>=(pró-labore +custo MOD + demais custos fixos);(pró-labore +custo MOD + demais custos fixos)/Margem de contribuição;"")
    const custosFixos = proLabore + custoMOD + demaisCustosFixos;
    const pontoEquilibrio = margemContribuicaoTotal >= custosFixos && margemContribuicao > 0 ? 
        Math.ceil(custosFixos / margemContribuicao) : null;
    
    // Fórmula (J%): ((Capac. atendimento*Ticket médio)-((Capac. atendimento*Ticket médio*(%Gastos vendas+%gastos com insumos e produtos))+(pró-labore +custo MOD + demais custos fixos)))/(Capac. atendimento*Ticket médio)
    const faturamentoPotencial = capacidadeAtendimento * ticketMedio;
    const percentualGastosVendas = faturamento > 0 ? (gastosVendas / faturamento) * 100 : 0;
    const percentualGastosInsumos = faturamento > 0 ? (gastosInsumos / faturamento) * 100 : 0;
    const margemPotencial = faturamentoPotencial > 0 ? 
        ((faturamentoPotencial - ((faturamentoPotencial * (percentualGastosVendas + percentualGastosInsumos) / 100) + custosFixos)) / faturamentoPotencial) * 100 : 0;
    
    // Fórmula (R$K): SE(Margem<0;Valor gasto a mais do que o faturamento+(Margem ideal*Faturamento);SE(mARGEM=0;Margem ideal*Faturamento;SE(E(Margem>0;(Margem ideal*Faturamento)<=Valor gasto a menos do que o faturamento);Valor gasto a menos do que o faturamento-(Margem ideal*Faturamento);SE(E(Margem>0;(Margem ideal*Faturamento)>Valor gasto a menos do que o faturamento);(Margem ideal*Faturamento)-Valor gasto a menos do que o faturamento))))
    let distanciaObjetivo;
    if (margemValor < 0) {
        distanciaObjetivo = Math.abs(margemValor) + (margemIdeal * faturamento);
    } else if (margemValor === 0) {
        distanciaObjetivo = margemIdeal * faturamento;
    } else {
        const objetivoValor = margemIdeal * faturamento;
        if (objetivoValor <= margemValor) {
            distanciaObjetivo = margemValor - objetivoValor;
        } else {
            distanciaObjetivo = objetivoValor - margemValor;
        }
    }
    
    console.log('Cálculos realizados:', {
        faturamento, gastosVendas, gastosInsumos, proLabore, custoMOD, demaisCustosFixos,
        vendas, capacidadeAtendimento, margemIdeal, totalGastos, margemValor, tipoResultado,
        margemPercentual, valorResultado, ticketMedio, margemContribuicao, margemContribuicaoTotal,
        pontoEquilibrio, margemPotencial, distanciaObjetivo
    });
    
    // Exibir resultados
    displayMainResultAlimentacao(mesAno, faturamento, tipoResultado, margemPercentual, valorResultado);
    displayCriticalStatusAlimentacao(margemValor, vendas, capacidadeAtendimento);
    displaySalesCapacityAnalysisAlimentacao(margemValor, margemPercentual, margemIdeal, vendas, capacidadeAtendimento);
    displayTicketMarginAnalysisAlimentacao(ticketMedio, margemContribuicao, margemContribuicaoTotal, custosFixos);
    displayBreakEvenAnalysisAlimentacao(pontoEquilibrio, vendas, margemContribuicao, custosFixos, capacidadeAtendimento);
    displayCapacityAnalysisAlimentacao(margemPotencial, margemPercentual, faturamentoPotencial, capacidadeAtendimento, vendas);
    displaySummaryAnalysisAlimentacao(margemValor, margemPercentual, margemIdeal, distanciaObjetivo, margemPotencial);
    displayRecommendationsAlimentacao(margemContribuicao, margemContribuicaoTotal, custosFixos, pontoEquilibrio, capacidadeAtendimento, vendas, margemPercentual, margemIdeal);
    
    console.log('=== FIM CÁLCULOS ALIMENTAÇÃO FORA DO LAR ===');
}

function calculateAndDisplayDiagnosisIndustria(data) {
    console.log('=== INÍCIO CÁLCULOS INDÚSTRIA ===');
    
    // Pegar mês e ano do combo selecionado
    const basicDataSelect = document.getElementById('basicDataSelect');
    const selectedOption = basicDataSelect.options[basicDataSelect.selectedIndex];
    const mesAno = selectedOption ? selectedOption.text : 'N/A';
    
    // Dados básicos
    const faturamento = data.sales_revenue || 0; // (R$B)
    const gastosVendas = data.sales_expenses || 0;
    const gastosInsumos = data.input_product_expenses || 0;
    const proLabore = data.pro_labore || 0;
    const custoMOD = data.work_hours_per_week || 0; // Usando work_hours_per_week como custo MOD temporariamente
    const demaisCustosFixos = data.other_fixed_costs || 0;
    const vendas = data.clients_served || 0;
    const capacidadeProducao = parseInt(data.service_capacity) || 0; // Capacidade de produção
    const margemIdeal = (data.ideal_profit_margin || data.ideal_service_profit_margin || 0) / 100;
    
    // Fórmula (C): SE(P7<0;"prejuízo";SE(P7=0;"margem";SE(P7>0; "lucro")))
    const totalGastos = gastosVendas + gastosInsumos + proLabore + custoMOD + demaisCustosFixos;
    const margemValor = faturamento - totalGastos;
    let tipoResultado;
    if (margemValor < 0) {
        tipoResultado = "prejuízo";
    } else if (margemValor === 0) {
        tipoResultado = "margem";
    } else {
        tipoResultado = "lucro";
    }
    
    // Fórmula (D%): (Faturamento-(gastos com vendas + gastos com insumos e produtos + pró-labore +custo MOD + demais custos fixos)) / Faturamento
    const margemPercentual = faturamento > 0 ? (margemValor / faturamento) * 100 : 0;
    
    // Fórmula (R$E): SE(Margem="";"";SE(Margem<0;(gastos com vendas + gastos com insumos e produtos + pró-labore + custo MOD + demais custos fixos)-Faturamento;SE(Margem >=0;Faturamento - (gastos com vendas + gastos com insumos e produtos + pró-labore + custo MOD + demais custos fixos))))
    let valorResultado;
    if (margemValor < 0) {
        valorResultado = totalGastos - faturamento;
    } else {
        valorResultado = faturamento - totalGastos;
    }
    
    // Fórmula (R$F): Faturamento/Vendas
    const ticketMedio = vendas > 0 ? faturamento / vendas : 0;
    
    // Fórmula (R$G): (Faturamento-(gastos com vendas + gastos com insumos e produtos))/Vendas
    const margemContribuicao = vendas > 0 ? (faturamento - (gastosVendas + gastosInsumos)) / vendas : 0;
    
    // Fórmula (R$H): Margem de contribuição*Vendas
    const margemContribuicaoTotal = margemContribuicao * vendas;
    
    // Fórmula (i): SE(Margem de contribuição*Vendas>=(pró-labore +custo MOD + demais custos fixos);(pró-labore +custo MOD + demais custos fixos)/Margem de contribuição;"")
    const custosFixos = proLabore + custoMOD + demaisCustosFixos;
    const pontoEquilibrio = margemContribuicaoTotal >= custosFixos && margemContribuicao > 0 ? 
        Math.ceil(custosFixos / margemContribuicao) : null;
    
    // Fórmula (J%): ((Capac. produção*Ticket médio)-((Capac. produção*Ticket médio*(%Gastos vendas+%gastos com insumos e produtos))+(pró-labore +custo MOD + demais custos fixos)))/(Capac. produção*Ticket médio)
    const faturamentoPotencial = capacidadeProducao * ticketMedio;
    const percentualGastosVendas = faturamento > 0 ? (gastosVendas / faturamento) * 100 : 0;
    const percentualGastosInsumos = faturamento > 0 ? (gastosInsumos / faturamento) * 100 : 0;
    const margemPotencial = faturamentoPotencial > 0 ? 
        ((faturamentoPotencial - ((faturamentoPotencial * (percentualGastosVendas + percentualGastosInsumos) / 100) + custosFixos)) / faturamentoPotencial) * 100 : 0;
    
    // Fórmula (R$K): SE(Margem<0;Valor gasto a mais do que o faturamento+(Margem ideal*Faturamento);SE(mARGEM=0;Margem ideal*Faturamento;SE(E(Margem>0;(Margem ideal*Faturamento)<=Valor gasto a menos do que o faturamento);Valor gasto a menos do que o faturamento-(Margem ideal*Faturamento);SE(E(Margem>0;(Margem ideal*Faturamento)>Valor gasto a menos do que o faturamento);(Margem ideal*Faturamento)-Valor gasto a menos do que o faturamento))))
    let distanciaObjetivo;
    if (margemValor < 0) {
        distanciaObjetivo = Math.abs(margemValor) + (margemIdeal * faturamento);
    } else if (margemValor === 0) {
        distanciaObjetivo = margemIdeal * faturamento;
    } else {
        const objetivoValor = margemIdeal * faturamento;
        if (objetivoValor <= margemValor) {
            distanciaObjetivo = margemValor - objetivoValor;
        } else {
            distanciaObjetivo = objetivoValor - margemValor;
        }
    }
    
    console.log('Cálculos realizados:', {
        faturamento, gastosVendas, gastosInsumos, proLabore, custoMOD, demaisCustosFixos,
        vendas, capacidadeProducao, margemIdeal, totalGastos, margemValor, tipoResultado,
        margemPercentual, valorResultado, ticketMedio, margemContribuicao, margemContribuicaoTotal,
        pontoEquilibrio, margemPotencial, distanciaObjetivo
    });
    
    // Exibir resultados
    displayMainResultIndustria(mesAno, faturamento, tipoResultado, margemPercentual, valorResultado);
    displayCriticalStatusIndustria(margemValor, vendas, capacidadeProducao);
    displaySalesCapacityAnalysisIndustria(margemValor, margemPercentual, margemIdeal, vendas, capacidadeProducao);
    displayTicketMarginAnalysisIndustria(ticketMedio, margemContribuicao, margemContribuicaoTotal, custosFixos);
    displayBreakEvenAnalysisIndustria(pontoEquilibrio, vendas, margemContribuicao, custosFixos, capacidadeProducao);
    displayCapacityAnalysisIndustria(margemPotencial, margemPercentual, faturamentoPotencial, capacidadeProducao, vendas);
    displaySummaryAnalysisIndustria(margemValor, margemPercentual, margemIdeal, distanciaObjetivo, margemPotencial);
    displayRecommendationsIndustria(margemContribuicao, margemContribuicaoTotal, custosFixos, pontoEquilibrio, capacidadeProducao, vendas, margemPercentual, margemIdeal);
    
    console.log('=== FIM CÁLCULOS INDÚSTRIA ===');
}

function calculateAndDisplayDiagnosisServicos(data) {
    console.log('=== INÍCIO CÁLCULOS PRESTADOR DE SERVIÇOS ===');
    
    // Pegar mês e ano do combo selecionado
    const basicDataSelect = document.getElementById('basicDataSelect');
    const selectedOption = basicDataSelect.options[basicDataSelect.selectedIndex];
    const mesAno = selectedOption ? selectedOption.text : 'N/A';
    
    // Dados básicos
    const faturamento = data.sales_revenue || 0; // (R$B)
    const gastosVendas = data.sales_expenses || 0;
    const gastosInsumos = data.input_product_expenses || 0;
    const proLabore = data.pro_labore || 0;
    const custoMOD = data.work_hours_per_week || 0; // Usando work_hours_per_week como custo MOD
    const demaisCustosFixos = data.other_fixed_costs || 0;
    const vendas = data.clients_served || 0;
    const capacidadeAtendimento = parseInt(data.service_capacity) || 0;
    const margemIdeal = (data.ideal_profit_margin || data.ideal_service_profit_margin || 0) / 100;
    
    // Fórmula (C): SE(P7<0;"prejuízo";SE(P7=0;"margem";SE(P7>0; "lucro")))
    const totalGastos = gastosVendas + gastosInsumos + proLabore + custoMOD + demaisCustosFixos;
    const margemValor = faturamento - totalGastos;
    let tipoResultado;
    if (margemValor < 0) {
        tipoResultado = "prejuízo";
    } else if (margemValor === 0) {
        tipoResultado = "margem";
    } else {
        tipoResultado = "lucro";
    }
    
    // Fórmula (D%): (Faturamento-(gastos com vendas + gastos com insumos e produtos + pró-labore +custo MOD + demais custos fixos)) / Faturamento
    const margemPercentual = faturamento > 0 ? (margemValor / faturamento) * 100 : 0;
    
    // Fórmula (R$E): SE(Margem="";"";SE(Margem<0;(gastos com vendas + gastos com insumos e produtos + pró-labore + custo MOD + demais custos fixos)-Faturamento;SE(Margem >=0;Faturamento - (gastos com vendas + gastos com insumos e produtos + pró-labore + custo MOD + demais custos fixos))))
    let valorResultado;
    if (margemValor < 0) {
        valorResultado = totalGastos - faturamento;
    } else {
        valorResultado = faturamento - totalGastos;
    }
    
    // Fórmula (R$F): Faturamento/Vendas
    const ticketMedio = vendas > 0 ? faturamento / vendas : 0;
    
    // Fórmula (R$G): (Faturamento-(gastos com vendas + gastos com insumos e produtos))/Vendas
    const margemContribuicao = vendas > 0 ? (faturamento - (gastosVendas + gastosInsumos)) / vendas : 0;
    
    // Fórmula (R$H): Margem de contribuição*Vendas
    const margemContribuicaoTotal = margemContribuicao * vendas;
    
    // Fórmula (i): SE(Margem de contribuição*Vendas>=(pró-labore +custo MOD + demais custos fixos);(pró-labore +custo MOD + demais custos fixos)/Margem de contribuição;"")
    const custosFixos = proLabore + custoMOD + demaisCustosFixos;
    const pontoEquilibrio = margemContribuicaoTotal >= custosFixos && margemContribuicao > 0 ? 
        Math.ceil(custosFixos / margemContribuicao) : null;
    
    // Fórmula (J%): ((Capac. atendimento*Ticket médio)-((Capac. atendimento*Ticket médio*(%Gastos vendas+%gastos com insumos e produtos))+(pró-labore +custo MOD + demais custos fixos)))/(Capac. atendimento*Ticket médio)
    const faturamentoPotencial = capacidadeAtendimento * ticketMedio;
    const percentualGastosVendas = faturamento > 0 ? (gastosVendas / faturamento) * 100 : 0;
    const percentualGastosInsumos = faturamento > 0 ? (gastosInsumos / faturamento) * 100 : 0;
    const margemPotencial = faturamentoPotencial > 0 ? 
        ((faturamentoPotencial - ((faturamentoPotencial * (percentualGastosVendas + percentualGastosInsumos) / 100) + custosFixos)) / faturamentoPotencial) * 100 : 0;
    
    // Fórmula (R$K): SE(Margem<0;Valor gasto a mais do que o faturamento+(Margem ideal*Faturamento);SE(mARGEM=0;Margem ideal*Faturamento;SE(E(Margem>0;(Margem ideal*Faturamento)<=Valor gasto a menos do que o faturamento);Valor gasto a menos do que o faturamento-(Margem ideal*Faturamento);SE(E(Margem>0;(Margem ideal*Faturamento)>Valor gasto a menos do que o faturamento);(Margem ideal*Faturamento)-Valor gasto a menos do que o faturamento))))
    let distanciaObjetivo;
    if (margemValor < 0) {
        distanciaObjetivo = Math.abs(margemValor) + (margemIdeal * faturamento);
    } else if (margemValor === 0) {
        distanciaObjetivo = margemIdeal * faturamento;
    } else {
        const objetivoValor = margemIdeal * faturamento;
        if (objetivoValor <= margemValor) {
            distanciaObjetivo = margemValor - objetivoValor;
        } else {
            distanciaObjetivo = objetivoValor - margemValor;
        }
    }
    
    console.log('Cálculos realizados:', {
        faturamento, gastosVendas, gastosInsumos, proLabore, custoMOD, demaisCustosFixos,
        vendas, capacidadeAtendimento, margemIdeal, totalGastos, margemValor, tipoResultado,
        margemPercentual, valorResultado, ticketMedio, margemContribuicao, margemContribuicaoTotal,
        pontoEquilibrio, margemPotencial, distanciaObjetivo
    });
    
    // Exibir resultados
    displayMainResultServicos(mesAno, faturamento, tipoResultado, margemPercentual, valorResultado);
    displayCriticalStatusServicos(margemValor, vendas, capacidadeAtendimento);
    displaySalesCapacityAnalysisServicos(margemValor, margemPercentual, margemIdeal, vendas, capacidadeAtendimento);
    displayTicketMarginAnalysisServicos(ticketMedio, margemContribuicao, margemContribuicaoTotal, custosFixos);
    displayBreakEvenAnalysisServicos(pontoEquilibrio, vendas, margemContribuicao, custosFixos, capacidadeAtendimento);
    displayCapacityAnalysisServicos(margemPotencial, margemPercentual, faturamentoPotencial, capacidadeAtendimento, vendas);
    displaySummaryAnalysisServicos(margemValor, margemPercentual, margemIdeal, distanciaObjetivo, margemPotencial);
    displayRecommendationsServicos(margemContribuicao, margemContribuicaoTotal, custosFixos, pontoEquilibrio, capacidadeAtendimento, vendas, margemPercentual, margemIdeal);
    
    console.log('=== FIM CÁLCULOS PRESTADOR DE SERVIÇOS ===');
}

function displayMainResult(data, faturamento, tipoResultado, margemPercentual, valorResultado) {
    console.log('displayMainResult executando...');
    
    // Pegar mês e ano do combo selecionado
    const basicDataSelect = document.getElementById('basicDataSelect');
    const selectedOption = basicDataSelect.options[basicDataSelect.selectedIndex];
    const mesAno = selectedOption ? selectedOption.text : 'N/A';
    
    console.log('Mês/Ano do combo:', mesAno);
    
    let texto = "";
    
    if (tipoResultado === "prejuízo") {
        texto = `Em ${mesAno} seu Negócio alcançou um faturamento bruto de R$ ${faturamento.toLocaleString('pt-BR', {minimumFractionDigits: 2})}, com ${tipoResultado} de ${margemPercentual.toFixed(2)}%, o que significa que gastou R$ ${valorResultado.toLocaleString('pt-BR', {minimumFractionDigits: 2})} mais do que faturou!`;
    } else if (tipoResultado === "margem") {
        texto = `Em ${mesAno} seu Negócio alcançou um faturamento bruto de R$ ${faturamento.toLocaleString('pt-BR', {minimumFractionDigits: 2})}, com ${tipoResultado} de ${margemPercentual.toFixed(2)}%, o que significa que gastou tudo que faturou!`;
    } else {
        texto = `Em ${mesAno} seu Negócio alcançou um faturamento bruto de R$ ${faturamento.toLocaleString('pt-BR', {minimumFractionDigits: 2})}, com ${tipoResultado} de ${margemPercentual.toFixed(2)}%, o que significa que gastou R$ ${valorResultado.toLocaleString('pt-BR', {minimumFractionDigits: 2})} menos do que faturou!`;
    }
    
    const alertClass = tipoResultado === "prejuízo" ? "alert-danger" : 
                     tipoResultado === "margem" ? "alert-warning" : "alert-success";
    
    const mainElement = document.getElementById('mainResult');
    console.log('mainResult element:', mainElement);
    console.log('texto gerado:', texto);
    
    if (mainElement) {
        mainElement.innerHTML = `<div class="alert ${alertClass}">${texto}</div>`;
        console.log('HTML inserido no mainResult');
    } else {
        console.error('Elemento mainResult não encontrado!');
    }
}

function displayCriticalStatus(margemValor, vendas, capacidadeAtendimento) {
    let status = "";
    let alertClass = "";
    
    if (margemValor < 0) {
        status = "ESTA É UMA SITUAÇÃO CRÍTICA!";
        alertClass = "alert-danger";
    } else if (margemValor === 0) {
        status = "ATENÇÃO!";
        alertClass = "alert-warning";
    } else if (vendas > capacidadeAtendimento * 1.05) {
        status = "ATENÇÃO!";
        alertClass = "alert-warning";
    }
    
    if (status) {
        document.getElementById('criticalStatus').innerHTML = `<div class="alert ${alertClass}"><strong>${status}</strong></div>`;
    }
}

function displaySalesCapacityAnalysis(margemValor, vendas, capacidadeAtendimento) {
    let texto = "";
    
    if (margemValor < 0) {
        if (vendas > capacidadeAtendimento * 1.05) {
            texto = `Este resultado negativo aconteceu mesmo com as vendas (${vendas}) superando a capacidade de atendimento (${capacidadeAtendimento}).`;
        } else if (vendas >= capacidadeAtendimento * 0.95 && vendas <= capacidadeAtendimento * 1.05) {
            texto = `Este resultado negativo aconteceu mesmo com as vendas nos limites da capacidade de atendimento (${capacidadeAtendimento}).`;
        } else {
            texto = `Este resultado negativo aconteceu com as vendas (${vendas}) abaixo da capacidade de atendimento (${capacidadeAtendimento}).`;
        }
    }
    
    if (texto) {
        document.getElementById('salesCapacityAnalysis').innerHTML = `<p>${texto}</p>`;
    }
}

function displayContributionMarginAnalysis(margemContribuicao, vendas, custosFixos) {
    let texto = "";
    
    if (margemContribuicao <= 0) {
        texto = "A margem de contribuição unitária é negativa ou zero, o que significa que cada venda não cobre nem os custos variáveis.";
    } else {
        const totalContribuicao = margemContribuicao * vendas;
        if (totalContribuicao >= custosFixos) {
            texto = `A margem de contribuição unitária é de R$ ${margemContribuicao.toLocaleString('pt-BR', {minimumFractionDigits: 2})}. Com ${vendas} vendas, você gera R$ ${totalContribuicao.toLocaleString('pt-BR', {minimumFractionDigits: 2})} para cobrir os custos fixos de R$ ${custosFixos.toLocaleString('pt-BR', {minimumFractionDigits: 2})}.`;
        } else {
            texto = `A margem de contribuição unitária é de R$ ${margemContribuicao.toLocaleString('pt-BR', {minimumFractionDigits: 2})}. Com ${vendas} vendas, você gera apenas R$ ${totalContribuicao.toLocaleString('pt-BR', {minimumFractionDigits: 2})}, insuficiente para cobrir os custos fixos de R$ ${custosFixos.toLocaleString('pt-BR', {minimumFractionDigits: 2})}.`;
        }
    }
    
    document.getElementById('contributionMarginAnalysis').innerHTML = `<p>${texto}</p>`;
}

function displayBreakEvenAnalysis(pontoEquilibrio, vendas, margemContribuicao) {
    let texto = "";
    
    if (pontoEquilibrio) {
        if (vendas >= pontoEquilibrio) {
            texto = `Seu ponto de equilíbrio é de ${pontoEquilibrio} vendas. Com ${vendas} vendas realizadas, você superou o ponto de equilíbrio.`;
        } else {
            const faltam = pontoEquilibrio - vendas;
            texto = `Seu ponto de equilíbrio é de ${pontoEquilibrio} vendas. Você precisa de mais ${faltam} vendas para atingir o equilíbrio.`;
        }
    } else {
        texto = "Não foi possível calcular o ponto de equilíbrio com os dados atuais.";
    }
    
    document.getElementById('breakEvenAnalysis').innerHTML = `<p>${texto}</p>`;
}

function displaySummaryAnalysis(margemValor, margemPercentual, margemIdeal, distanciaObjetivo, margemPotencial) {
    let recomendacoes = [];
    
    if (margemValor < 0) {
        recomendacoes.push("• Revisar imediatamente todos os custos e despesas");
        recomendacoes.push("• Analisar a possibilidade de aumento de preços");
        recomendacoes.push("• Buscar fornecedores com melhores condições");
        recomendacoes.push("• Reduzir custos fixos onde possível");
    } else if (margemPercentual < margemIdeal * 100) {
        recomendacoes.push("• Trabalhar para atingir a margem ideal");
        recomendacoes.push("• Otimizar processos para reduzir custos");
        recomendacoes.push("• Avaliar estratégias de precificação");
    } else {
        recomendacoes.push("• Manter os bons resultados");
        recomendacoes.push("• Buscar oportunidades de crescimento");
        recomendacoes.push("• Reinvestir os lucros no negócio");
    }
    
    if (margemPotencial > margemPercentual) {
        recomendacoes.push(`• Potencial de melhoria: margem pode chegar a ${margemPotencial.toFixed(2)}% operando na capacidade máxima`);
    }
    
    const texto = `
        <p><strong>Distância do objetivo:</strong> R$ ${distanciaObjetivo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
        <p><strong>Próximos passos recomendados:</strong></p>
        <ul class="mb-0">
            ${recomendacoes.map(rec => `<li>${rec}</li>`).join('')}
        </ul>
    `;
    
    document.getElementById('summaryAnalysis').innerHTML = texto;
}

function displayMainResultAlimentacao(mesAno, faturamento, tipoResultado, margemPercentual, valorResultado) {
    console.log('displayMainResultAlimentacao executando...');
    
    let texto = "";
    
    if (tipoResultado === "prejuízo") {
        texto = `Em ${mesAno} seu Negócio alcançou um faturamento bruto de R$ ${faturamento.toLocaleString('pt-BR', {minimumFractionDigits: 2})}, com ${tipoResultado} de ${margemPercentual.toFixed(2)}%, o que significa que gastou R$ ${valorResultado.toLocaleString('pt-BR', {minimumFractionDigits: 2})} mais do que faturou!`;
    } else if (tipoResultado === "margem") {
        texto = `Em ${mesAno} seu Negócio alcançou um faturamento bruto de R$ ${faturamento.toLocaleString('pt-BR', {minimumFractionDigits: 2})}, com ${tipoResultado} de ${margemPercentual.toFixed(2)}%, o que significa que gastou tudo que faturou!`;
    } else {
        texto = `Em ${mesAno} seu Negócio alcançou um faturamento bruto de R$ ${faturamento.toLocaleString('pt-BR', {minimumFractionDigits: 2})}, com ${tipoResultado} de ${margemPercentual.toFixed(2)}%, o que significa que gastou R$ ${valorResultado.toLocaleString('pt-BR', {minimumFractionDigits: 2})} menos do que faturou!`;
    }
    
    const alertClass = tipoResultado === "prejuízo" ? "alert-danger" : 
                     tipoResultado === "margem" ? "alert-warning" : "alert-success";
    
    const mainElement = document.getElementById('mainResultAlimentacao');
    if (mainElement) {
        mainElement.innerHTML = `<div class="alert ${alertClass}">${texto}</div>`;
        console.log('HTML inserido no mainResultAlimentacao');
    } else {
        console.error('Elemento mainResultAlimentacao não encontrado!');
    }
}

function displayCriticalStatusAlimentacao(margemValor, vendas, capacidadeAtendimento) {
    let status = "";
    let alertClass = "";
    
    if (margemValor < 0) {
        status = "ESTA É UMA SITUAÇÃO CRÍTICA!";
        alertClass = "alert-danger";
    } else if (margemValor === 0) {
        status = "ATENÇÃO!";
        alertClass = "alert-warning";
    } else if (vendas > capacidadeAtendimento * 1.05) {
        status = "ATENÇÃO!";
        alertClass = "alert-warning";
    }
    
    if (status) {
        const element = document.getElementById('criticalStatusAlimentacao');
        if (element) {
            element.innerHTML = `<div class="alert ${alertClass}"><strong>${status}</strong></div>`;
        }
    }
}

function displaySalesCapacityAnalysisAlimentacao(margemValor, margemPercentual, margemIdeal, vendas, capacidadeAtendimento) {
    let texto = "";
    
    if (margemValor < 0) {
        if (vendas > capacidadeAtendimento * 1.05) {
            texto = "Este resultado negativo aconteceu mesmo com as vendas superando a capacidade de atendimento.";
        } else if (vendas >= capacidadeAtendimento * 0.95 && vendas <= capacidadeAtendimento * 1.05) {
            texto = "Este resultado negativo aconteceu mesmo com as vendas nos limites da capacidade de atendimento.";
        } else {
            texto = "Este resultado negativo aconteceu com as vendas abaixo da capacidade de atendimento.";
        }
    } else if (margemValor === 0) {
        if (vendas > capacidadeAtendimento * 1.05) {
            texto = "Mesmo com as vendas superando a capacidade de atendimento, o resultado do mês ficou em zero: nem lucro, nem prejuízo.";
        } else if (vendas >= capacidadeAtendimento * 0.95 && vendas <= capacidadeAtendimento * 1.05) {
            texto = "Mesmo vendendo nos limites da capacidade de atendimento, o resultado do mês ficou em zero: nem lucro, nem prejuízo.";
        } else {
            texto = "Com vendas abaixo da capacidade de atendimento, o resultado do mês ficou em zero: nem lucro, nem prejuízo.";
        }
    } else if (margemPercentual < margemIdeal * 95) {
        if (vendas > capacidadeAtendimento * 1.05) {
            texto = "O lucro foi menor do que você gostaria, mesmo com vendas maiores do que a capacidade de atendimento.";
        } else if (vendas >= capacidadeAtendimento * 0.95 && vendas <= capacidadeAtendimento * 1.05) {
            texto = "Mesmo vendendo nos limites da capacidade de atendimento, o lucro foi menor do que você gostaria.";
        } else {
            texto = "Este resultado não corresponde à sua expectativa de lucro, e as vendas foram menores do que a capacidade de atendimento.";
        }
    } else if (margemPercentual >= margemIdeal * 95) {
        if (vendas > capacidadeAtendimento * 1.05) {
            texto = "Este lucro corresponde às suas expectativas, mas foi alcançado com vendas maiores do que a capacidade de atendimento.";
        } else if (vendas >= capacidadeAtendimento * 0.95 && vendas <= capacidadeAtendimento * 1.05) {
            texto = "Este lucro corresponde à sua expectativa e foi alcançado com vendas que ficaram nos limites da capacidade de atendimento.";
        } else {
            texto = "Este lucro corresponde à sua expectativa, mesmo com vendas menores do que a capacidade de atendimento.";
        }
    }
    
    if (texto) {
        const element = document.getElementById('salesCapacityAnalysisAlimentacao');
        if (element) {
            element.innerHTML = `<p>${texto}</p>`;
        }
    }
}

function displayTicketMarginAnalysisAlimentacao(ticketMedio, margemContribuicao, margemContribuicaoTotal, custosFixos) {
    let texto = "";
    
    texto += `<p><strong>Ticket médio:</strong> R$ ${ticketMedio.toLocaleString('pt-BR', {minimumFractionDigits: 2})} - Faturamento médio por venda</p>`;
    texto += `<p><strong>Margem de contribuição:</strong> R$ ${margemContribuicao.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>`;
    
    if (margemContribuicao <= 0) {
        texto += "<p><strong>Aqui temos uma explicação para o prejuízo!</strong></p>";
        texto += "<p>Margem de contribuição menor ou igual a zero significa que quanto mais vende, mais perde.</p>";
    } else if (margemContribuicaoTotal <= custosFixos) {
        texto += "<p><strong>Aqui temos uma explicação para o prejuízo!</strong></p>";
        texto += `<p>Se a margem de contribuição multiplicada pelas vendas (R$ ${margemContribuicaoTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}) não supera os custos fixos (R$ ${custosFixos.toLocaleString('pt-BR', {minimumFractionDigits: 2})}), o Negócio, na melhor das hipóteses, está numa situação frágil, sem folga para enfrentar imprevistos ou crescer.</p>`;
    }
    
    const element = document.getElementById('ticketMarginAnalysisAlimentacao');
    if (element) {
        element.innerHTML = texto;
    }
}

function displayBreakEvenAnalysisAlimentacao(pontoEquilibrio, vendas, margemContribuicao, custosFixos, capacidadeAtendimento) {
    let texto = "";
    
    if (pontoEquilibrio) {
        texto += `<p><strong>Ponto de equilíbrio:</strong> ${pontoEquilibrio} vendas</p>`;
        
        if (margemContribuicao * vendas > custosFixos && pontoEquilibrio >= capacidadeAtendimento) {
            texto += "<p><strong>ALERTA MÁXIMO!</strong></p>";
            texto += "<p>Para alcançar margem zero teria sido preciso vender mais (ou o equivalente) à capacidade de atendimento, ou seja: sua empresa está mal estruturada (custos elevados, preços mal calculados e/ou capacidade de atendimento insuficiente)!</p>";
        } else if (pontoEquilibrio > 0 && pontoEquilibrio < capacidadeAtendimento) {
            texto += "<p>Isso significa que se as vendas tivessem sido iguais à capacidade de atendimento, o lucro teria sido maior.</p>";
        }
    } else {
        texto += "<p><strong>Ponto de equilíbrio:</strong> não alcançado</p>";
    }
    
    const element = document.getElementById('breakEvenAnalysisAlimentacao');
    if (element) {
        element.innerHTML = texto;
    }
}

function displayCapacityAnalysisAlimentacao(margemPotencial, margemPercentual, faturamentoPotencial, capacidadeAtendimento, vendas) {
    let texto = "";
    
    if (margemPotencial > margemPercentual) {
        texto += `<p>Isso significa que se as vendas tivessem sido iguais à capacidade de atendimento (${capacidadeAtendimento}), o lucro de ${margemPercentual.toFixed(2)}% teria sido de ${margemPotencial.toFixed(2)}%.</p>`;
    }
    
    if (vendas < capacidadeAtendimento * 0.95) {
        texto += "<p><strong>Por que não vendeu mais:</strong></p>";
        texto += "<ul>";
        texto += "<li>1) Mercado não comporta? Então aumente o valor do ticket médio e/ou reduza custos fixos;</li>";
        texto += "<li>2) Concorrência? Crie diferenciais e corrija seus pontos fracos;</li>";
        texto += "<li>3) Mês fraco? Crie incentivos.</li>";
        texto += "</ul>";
    } else if (vendas > capacidadeAtendimento * 1.05) {
        texto += "<p>Vendas acima da capacidade de atendimento, se rotineiras, podem prejudicar a qualidade e/ou lucratividade dos produtos, gerar stress com os clientes, nos funcionários e em você, à menos que tenham sido viabilizadas por estoques de mês(es) anterior(es)!</p>";
    }
    
    const element = document.getElementById('capacityAnalysisAlimentacao');
    if (element) {
        element.innerHTML = texto;
    }
}

function displaySummaryAnalysisAlimentacao(margemValor, margemPercentual, margemIdeal, distanciaObjetivo, margemPotencial) {
    let texto = "";
    
    if (margemValor <= 0) {
        texto += `<p><strong>Você tem motivo para estar muito preocupado com este prejuízo de ${margemPercentual.toFixed(2)}%. É preciso agir rápido!</strong></p>`;
    } else if (margemPercentual < margemIdeal * 50) {
        texto += `<p><strong>Você deve estar bem chateado com este resultado ${margemPercentual.toFixed(2)}%, longe dos ${(margemIdeal * 100).toFixed(2)}% que considera ideal!</strong></p>`;
    } else if (margemPercentual >= margemIdeal * 50 && margemPercentual < margemIdeal * 80) {
        texto += `<p><strong>Você deve estar insatisfeito com este resultado ${margemPercentual.toFixed(2)}% e quer melhorá-lo, já que o ideal teria sido ${(margemIdeal * 100).toFixed(2)}%!</strong></p>`;
    } else if (margemPercentual >= margemIdeal * 80 && margemPercentual < margemIdeal) {
        texto += `<p><strong>Você deve estar satisfeito com este resultado ${margemPercentual.toFixed(2)}%, mas gostaria de ter alcançado ${(margemIdeal * 100).toFixed(2)}%!</strong></p>`;
    } else if (margemPercentual >= margemIdeal) {
        texto += `<p><strong>Você tem motivo para estar muito satisfeito com este lucro de ${margemPercentual.toFixed(2)}%!</strong></p>`;
    }
    
    texto += `<p><strong>Distância do objetivo:</strong> R$ ${distanciaObjetivo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>`;
    
    if (margemPotencial > margemPercentual) {
        texto += `<p><strong>Potencial de melhoria:</strong> margem pode chegar a ${margemPotencial.toFixed(2)}% operando na capacidade máxima</p>`;
    }
    
    const element = document.getElementById('summaryAnalysisAlimentacao');
    if (element) {
        element.innerHTML = texto;
    }
}

function displayRecommendationsAlimentacao(margemContribuicao, margemContribuicaoTotal, custosFixos, pontoEquilibrio, capacidadeAtendimento, vendas, margemPercentual, margemIdeal) {
    let texto = "";
    
    // Adicionar nome do usuário
    const userName = '{{ user.name }}' || 'Usuário';
    
    if (margemContribuicao <= 0) {
        texto += "<p><strong>Principalmente, devido aos custos variáveis (gastos com vendas e compra de mercadorias).</strong></p>";
    } else if (margemContribuicaoTotal <= custosFixos) {
        texto += "<p><strong>Principalmente, devido aos custos variáveis (gastos com vendas e compra de mercadorias).</strong></p>";
    } else if (pontoEquilibrio >= capacidadeAtendimento) {
        texto += "<p><strong>Como vimos, sua empresa precisa ser reestruturada.</strong></p>";
    } else {
        texto += "<p><strong>Duas causas principais: os custos fixos e/ou os preços praticados.</strong></p>";
    }
    
    if (margemContribuicaoTotal > custosFixos && pontoEquilibrio >= capacidadeAtendimento) {
        texto += "<p><strong>Recomendamos que leia: NEM TUDO QUE RELUZ É OURO, no e-book!</strong></p>";
    }
    
    texto += "<p><strong>Sugerimos ler, no e-book: BOAS PRÁTICAS e CAMINHOS PARA O SUCESSO.</strong></p>";
    
    if (margemPercentual < margemIdeal * 95) {
        texto += `<p><strong>${userName},</strong> as análises acima referem-se a um período já encerrado. Elas são úteis para identificar o que pode ser melhorado para construir um futuro que corresponda às suas expectativas.</p>`;
    }
    
    texto += "<p>Tendo em vista a dinâmica da economia, as características de cada mês, a atividade da concorrência, e os efeitos sobre o comportamento do seu público-alvo, é importante considerar (alterações e estimativas) nos próximos meses.</p>";
    texto += "<p><strong>Sendo assim, recomendamos que você acesse o Simulador</strong></p>";
    
    const element = document.getElementById('recommendationsAlimentacao');
    if (element) {
        element.innerHTML = texto;
    }
}

function displayMainResultIndustria(mesAno, faturamento, tipoResultado, margemPercentual, valorResultado) {
    console.log('displayMainResultIndustria executando...');
    
    let texto = "";
    
    if (tipoResultado === "prejuízo") {
        texto = `Em ${mesAno} seu Negócio alcançou um faturamento bruto de R$ ${faturamento.toLocaleString('pt-BR', {minimumFractionDigits: 2})}, com ${tipoResultado} de ${margemPercentual.toFixed(2)}%, o que significa que gastou R$ ${valorResultado.toLocaleString('pt-BR', {minimumFractionDigits: 2})} mais do que faturou!`;
    } else if (tipoResultado === "margem") {
        texto = `Em ${mesAno} seu Negócio alcançou um faturamento bruto de R$ ${faturamento.toLocaleString('pt-BR', {minimumFractionDigits: 2})}, com ${tipoResultado} de ${margemPercentual.toFixed(2)}%, o que significa que gastou tudo que faturou!`;
    } else {
        texto = `Em ${mesAno} seu Negócio alcançou um faturamento bruto de R$ ${faturamento.toLocaleString('pt-BR', {minimumFractionDigits: 2})}, com ${tipoResultado} de ${margemPercentual.toFixed(2)}%, o que significa que gastou R$ ${valorResultado.toLocaleString('pt-BR', {minimumFractionDigits: 2})} menos do que faturou!`;
    }
    
    const alertClass = tipoResultado === "prejuízo" ? "alert-danger" : 
                     tipoResultado === "margem" ? "alert-warning" : "alert-success";
    
    const mainElement = document.getElementById('mainResultIndustria');
    if (mainElement) {
        mainElement.innerHTML = `<div class="alert ${alertClass}">${texto}</div>`;
        console.log('HTML inserido no mainResultIndustria');
    } else {
        console.error('Elemento mainResultIndustria não encontrado!');
    }
}

function displayCriticalStatusIndustria(margemValor, vendas, capacidadeProducao) {
    let status = "";
    let alertClass = "";
    
    if (margemValor < 0) {
        status = "ESTA É UMA SITUAÇÃO CRÍTICA!";
        alertClass = "alert-danger";
    } else if (margemValor === 0) {
        status = "ATENÇÃO!";
        alertClass = "alert-warning";
    } else if (vendas > capacidadeProducao * 1.05) {
        status = "ATENÇÃO!";
        alertClass = "alert-warning";
    }
    
    if (status) {
        const element = document.getElementById('criticalStatusIndustria');
        if (element) {
            element.innerHTML = `<div class="alert ${alertClass}"><strong>${status}</strong></div>`;
        }
    }
}

function displaySalesCapacityAnalysisIndustria(margemValor, margemPercentual, margemIdeal, vendas, capacidadeProducao) {
    let texto = "";
    
    if (margemValor < 0) {
        if (vendas > capacidadeProducao * 1.05) {
            texto = "Este resultado negativo aconteceu mesmo com as vendas superando a capacidade de produção.";
        } else if (vendas >= capacidadeProducao * 0.95 && vendas <= capacidadeProducao * 1.05) {
            texto = "Este resultado negativo aconteceu mesmo com as vendas nos limites da capacidade de produção.";
        } else {
            texto = "Este resultado negativo aconteceu com as vendas abaixo da capacidade de produção.";
        }
    } else if (margemValor === 0) {
        if (vendas > capacidadeProducao * 1.05) {
            texto = "Mesmo com as vendas superando a capacidade de produção, o resultado do mês ficou em zero: nem lucro, nem prejuízo.";
        } else if (vendas >= capacidadeProducao * 0.95 && vendas <= capacidadeProducao * 1.05) {
            texto = "Mesmo vendendo nos limites da capacidade de produção, o resultado do mês ficou em zero: nem lucro, nem prejuízo.";
        } else {
            texto = "Com vendas abaixo da capacidade de produção, o resultado do mês ficou em zero: nem lucro, nem prejuízo.";
        }
    } else if (margemPercentual < margemIdeal * 95) {
        if (vendas > capacidadeProducao * 1.05) {
            texto = "O lucro foi menor do que você gostaria, mesmo com vendas maiores do que a capacidade de produção.";
        } else if (vendas >= capacidadeProducao * 0.95 && vendas <= capacidadeProducao * 1.05) {
            texto = "Mesmo vendendo nos limites da capacidade de produção, o lucro foi menor do que você gostaria.";
        } else {
            texto = "Este resultado não corresponde à sua expectativa de lucro, e as vendas foram menores do que a capacidade de produção.";
        }
    } else if (margemPercentual >= margemIdeal * 95) {
        if (vendas > capacidadeProducao * 1.05) {
            texto = "Este lucro corresponde às suas expectativas, mas foi alcançado com vendas maiores do que a capacidade de produção.";
        } else if (vendas >= capacidadeProducao * 0.95 && vendas <= capacidadeProducao * 1.05) {
            texto = "Este lucro corresponde à sua expectativa e foi alcançado com vendas que ficaram nos limites da capacidade de produção.";
        } else {
            texto = "Este lucro corresponde à sua expectativa, mesmo com vendas menores do que a capacidade de produção.";
        }
    }
    
    if (texto) {
        const element = document.getElementById('salesCapacityAnalysisIndustria');
        if (element) {
            element.innerHTML = `<p>${texto}</p>`;
        }
    }
}

function displayTicketMarginAnalysisIndustria(ticketMedio, margemContribuicao, margemContribuicaoTotal, custosFixos) {
    let texto = "";
    
    texto += `<p><strong>Ticket médio:</strong> R$ ${ticketMedio.toLocaleString('pt-BR', {minimumFractionDigits: 2})} - Faturamento médio por venda</p>`;
    texto += `<p><strong>Margem de contribuição:</strong> R$ ${margemContribuicao.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>`;
    
    if (margemContribuicao <= 0) {
        texto += "<p><strong>Aqui temos uma explicação para o prejuízo!</strong></p>";
        texto += "<p>Margem de contribuição menor ou igual a zero significa que quanto mais vende, mais perde.</p>";
    } else if (margemContribuicaoTotal <= custosFixos) {
        texto += "<p><strong>Aqui temos uma explicação para o prejuízo!</strong></p>";
        texto += `<p>Se a margem de contribuição multiplicada pelas vendas (R$ ${margemContribuicaoTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}) não supera os custos fixos (R$ ${custosFixos.toLocaleString('pt-BR', {minimumFractionDigits: 2})}), o Negócio, na melhor das hipóteses, está numa situação frágil, sem folga para enfrentar imprevistos ou crescer.</p>`;
    }
    
    const element = document.getElementById('ticketMarginAnalysisIndustria');
    if (element) {
        element.innerHTML = texto;
    }
}

function displayBreakEvenAnalysisIndustria(pontoEquilibrio, vendas, margemContribuicao, custosFixos, capacidadeProducao) {
    let texto = "";
    
    if (pontoEquilibrio) {
        texto += `<p><strong>Ponto de equilíbrio:</strong> ${pontoEquilibrio} vendas</p>`;
        
        if (margemContribuicao * vendas > custosFixos && pontoEquilibrio >= capacidadeProducao) {
            texto += "<p><strong>ALERTA MÁXIMO!</strong></p>";
            texto += "<p>Para alcançar margem zero teria sido preciso vender mais (ou o equivalente) à capacidade de produção, ou seja: sua empresa está mal estruturada (custos elevados, preços mal calculados e/ou capacidade de produção insuficiente)!</p>";
        } else if (pontoEquilibrio > 0 && pontoEquilibrio < capacidadeProducao) {
            texto += "<p>Isso significa que se as vendas tivessem sido iguais à capacidade de produção, o lucro teria sido maior.</p>";
        }
        } else {
        texto += "<p><strong>Ponto de equilíbrio:</strong> não alcançado</p>";
    }
    
    const element = document.getElementById('breakEvenAnalysisIndustria');
    if (element) {
        element.innerHTML = texto;
    }
}

function displayCapacityAnalysisIndustria(margemPotencial, margemPercentual, faturamentoPotencial, capacidadeProducao, vendas) {
    let texto = "";
    
    if (margemPotencial > margemPercentual) {
        texto += `<p>Isso significa que se as vendas tivessem sido iguais à capacidade de produção (${capacidadeProducao}), o lucro de ${margemPercentual.toFixed(2)}% teria sido de ${margemPotencial.toFixed(2)}%.</p>`;
    }
    
    if (vendas < capacidadeProducao * 0.95) {
        texto += "<p><strong>Por que não vendeu mais:</strong></p>";
        texto += "<ul>";
        texto += "<li>1) Mercado não comporta? Então aumente o valor do ticket médio e/ou reduza custos fixos;</li>";
        texto += "<li>2) Concorrência? Crie diferenciais e corrija seus pontos fracos;</li>";
        texto += "<li>3) Mês fraco? Crie incentivos.</li>";
        texto += "</ul>";
    } else if (vendas > capacidadeProducao * 1.05) {
        texto += "<p>Vendas acima da capacidade de produção, se rotineiras, podem prejudicar a qualidade e/ou lucratividade dos produtos, gerar stress com os clientes, nos funcionários e em você, à menos que tenham sido viabilizadas por estoques de mês(es) anterior(es)!</p>";
    }
    
    const element = document.getElementById('capacityAnalysisIndustria');
    if (element) {
        element.innerHTML = texto;
    }
}

function displaySummaryAnalysisIndustria(margemValor, margemPercentual, margemIdeal, distanciaObjetivo, margemPotencial) {
    let texto = "";
    
    if (margemValor <= 0) {
        texto += `<p><strong>Você tem motivo para estar muito preocupado com este prejuízo de ${margemPercentual.toFixed(2)}%. É preciso agir rápido!</strong></p>`;
    } else if (margemPercentual < margemIdeal * 50) {
        texto += `<p><strong>Você deve estar bem chateado com este resultado ${margemPercentual.toFixed(2)}%, longe dos ${(margemIdeal * 100).toFixed(2)}% que considera ideal!</strong></p>`;
    } else if (margemPercentual >= margemIdeal * 50 && margemPercentual < margemIdeal * 80) {
        texto += `<p><strong>Você deve estar insatisfeito com este resultado ${margemPercentual.toFixed(2)}% e quer melhorá-lo, já que o ideal teria sido ${(margemIdeal * 100).toFixed(2)}%!</strong></p>`;
    } else if (margemPercentual >= margemIdeal * 80 && margemPercentual < margemIdeal) {
        texto += `<p><strong>Você deve estar satisfeito com este resultado ${margemPercentual.toFixed(2)}%, mas gostaria de ter alcançado ${(margemIdeal * 100).toFixed(2)}%!</strong></p>`;
    } else if (margemPercentual >= margemIdeal) {
        texto += `<p><strong>Você tem motivo para estar muito satisfeito com este lucro de ${margemPercentual.toFixed(2)}%!</strong></p>`;
    }
    
    texto += `<p><strong>Distância do objetivo:</strong> R$ ${distanciaObjetivo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>`;
    
    if (margemPotencial > margemPercentual) {
        texto += `<p><strong>Potencial de melhoria:</strong> margem pode chegar a ${margemPotencial.toFixed(2)}% operando na capacidade máxima</p>`;
    }
    
    const element = document.getElementById('summaryAnalysisIndustria');
    if (element) {
        element.innerHTML = texto;
    }
}

function displayRecommendationsIndustria(margemContribuicao, margemContribuicaoTotal, custosFixos, pontoEquilibrio, capacidadeProducao, vendas, margemPercentual, margemIdeal) {
    let texto = "";
    
    // Adicionar nome do usuário
    const userName = '{{ user.name }}' || 'Usuário';
    
    if (margemContribuicao <= 0) {
        texto += "<p><strong>Principalmente, devido aos custos variáveis (gastos com vendas e compra de mercadorias).</strong></p>";
    } else if (margemContribuicaoTotal <= custosFixos) {
        texto += "<p><strong>Principalmente, devido aos custos variáveis (gastos com vendas e compra de mercadorias).</strong></p>";
    } else if (pontoEquilibrio >= capacidadeProducao) {
        texto += "<p><strong>Como vimos, sua empresa precisa ser reestruturada.</strong></p>";
    } else {
        texto += "<p><strong>Duas causas principais: os custos fixos e/ou os preços praticados.</strong></p>";
    }
    
    if (margemContribuicaoTotal > custosFixos && pontoEquilibrio >= capacidadeProducao) {
        texto += "<p><strong>Recomendamos que leia: NEM TUDO QUE RELUZ É OURO, no e-book!</strong></p>";
    }
    
    texto += "<p><strong>Sugerimos ler, no e-book: BOAS PRÁTICAS e CAMINHOS PARA O SUCESSO.</strong></p>";
    
    if (margemPercentual < margemIdeal * 95) {
        texto += `<p><strong>${userName},</strong> as análises acima são úteis para identificar o que pode ser melhorado para construir um futuro que corresponda às suas expectativas.</p>`;
    }
    
    texto += "<p>Tendo em vista a dinâmica da economia, as características de cada mês, a atividade da concorrência, e os efeitos sobre o comportamento do seu público-alvo, é importante considerar (alterações e estimativas) mirando nos próximos meses.</p>";
    texto += "<p><strong>Sendo assim, recomendamos que você acesse o Simulador</strong></p>";
    
    const element = document.getElementById('recommendationsIndustria');
    if (element) {
        element.innerHTML = texto;
    }
}

function displayMainResultServicos(mesAno, faturamento, tipoResultado, margemPercentual, valorResultado) {
    console.log('displayMainResultServicos executando...');
    
    let texto = "";
    
    if (tipoResultado === "prejuízo") {
        texto = `Em ${mesAno} seu Negócio alcançou um faturamento bruto de R$ ${faturamento.toLocaleString('pt-BR', {minimumFractionDigits: 2})}, com ${tipoResultado} de ${margemPercentual.toFixed(2)}%, o que significa que gastou R$ ${valorResultado.toLocaleString('pt-BR', {minimumFractionDigits: 2})} mais do que faturou!`;
    } else if (tipoResultado === "margem") {
        texto = `Em ${mesAno} seu Negócio alcançou um faturamento bruto de R$ ${faturamento.toLocaleString('pt-BR', {minimumFractionDigits: 2})}, com ${tipoResultado} de ${margemPercentual.toFixed(2)}%, o que significa que gastou tudo que faturou!`;
     } else {
        texto = `Em ${mesAno} seu Negócio alcançou um faturamento bruto de R$ ${faturamento.toLocaleString('pt-BR', {minimumFractionDigits: 2})}, com ${tipoResultado} de ${margemPercentual.toFixed(2)}%, o que significa que gastou R$ ${valorResultado.toLocaleString('pt-BR', {minimumFractionDigits: 2})} menos do que faturou!`;
    }
    
    const alertClass = tipoResultado === "prejuízo" ? "alert-danger" : 
                     tipoResultado === "margem" ? "alert-warning" : "alert-success";
    
    const mainElement = document.getElementById('mainResultServicos');
    if (mainElement) {
        mainElement.innerHTML = `<div class="alert ${alertClass}">${texto}</div>`;
        console.log('HTML inserido no mainResultServicos');
    } else {
        console.error('Elemento mainResultServicos não encontrado!');
    }
}

function displayCriticalStatusServicos(margemValor, vendas, capacidadeAtendimento) {
    let status = "";
    let alertClass = "";
    
    if (margemValor < 0) {
        status = "ESTA É UMA SITUAÇÃO CRÍTICA!";
        alertClass = "alert-danger";
    } else if (margemValor === 0) {
        status = "ATENÇÃO!";
        alertClass = "alert-warning";
    } else if (vendas > capacidadeAtendimento * 1.05) {
        status = "ATENÇÃO!";
        alertClass = "alert-warning";
    }
    
    if (status) {
        const element = document.getElementById('criticalStatusServicos');
        if (element) {
            element.innerHTML = `<div class="alert ${alertClass}"><strong>${status}</strong></div>`;
        }
    }
}

function displaySalesCapacityAnalysisServicos(margemValor, margemPercentual, margemIdeal, vendas, capacidadeAtendimento) {
    let texto = "";
    
    if (margemValor < 0) {
        if (vendas > capacidadeAtendimento * 1.05) {
            texto = "Este resultado negativo aconteceu mesmo com as vendas superando a capacidade de atendimento.";
        } else if (vendas >= capacidadeAtendimento * 0.95 && vendas <= capacidadeAtendimento * 1.05) {
            texto = "Este resultado negativo aconteceu mesmo com as vendas nos limites da capacidade de atendimento.";
        } else {
            texto = "Este resultado negativo aconteceu com as vendas abaixo da capacidade de atendimento.";
        }
    } else if (margemValor === 0) {
        if (vendas > capacidadeAtendimento * 1.05) {
            texto = "Mesmo com as vendas superando a capacidade de atendimento, o resultado do mês ficou em zero: nem lucro, nem prejuízo.";
        } else if (vendas >= capacidadeAtendimento * 0.95 && vendas <= capacidadeAtendimento * 1.05) {
            texto = "Mesmo vendendo nos limites da capacidade de atendimento, o resultado do mês ficou em zero: nem lucro, nem prejuízo.";
        } else {
            texto = "Com vendas abaixo da capacidade de atendimento, o resultado do mês ficou em zero: nem lucro, nem prejuízo.";
        }
    } else if (margemPercentual < margemIdeal * 95) {
        if (vendas > capacidadeAtendimento * 1.05) {
            texto = "O lucro foi menor do que você gostaria, mesmo com vendas maiores do que a capacidade de atendimento.";
        } else if (vendas >= capacidadeAtendimento * 0.95 && vendas <= capacidadeAtendimento * 1.05) {
            texto = "Mesmo vendendo nos limites da capacidade de atendimento, o lucro foi menor do que você gostaria.";
        } else {
            texto = "Este resultado não corresponde à sua expectativa de lucro, e as vendas foram menores do que a capacidade de atendimento.";
        }
    } else if (margemPercentual >= margemIdeal * 95) {
        if (vendas > capacidadeAtendimento * 1.05) {
            texto = "Este lucro corresponde às suas expectativas, mas foi alcançado com vendas maiores do que a capacidade de atendimento.";
        } else if (vendas >= capacidadeAtendimento * 0.95 && vendas <= capacidadeAtendimento * 1.05) {
            texto = "Este lucro corresponde à sua expectativa e foi alcançado com vendas que ficaram nos limites da capacidade de atendimento.";
        } else {
            texto = "Este lucro corresponde à sua expectativa, mesmo com vendas menores do que a capacidade de atendimento.";
        }
    }
    
    if (texto) {
        const element = document.getElementById('salesCapacityAnalysisServicos');
        if (element) {
            element.innerHTML = `<p>${texto}</p>`;
        }
    }
}

function displayTicketMarginAnalysisServicos(ticketMedio, margemContribuicao, margemContribuicaoTotal, custosFixos) {
    let texto = "";
    
    texto += `<p><strong>Ticket médio:</strong> R$ ${ticketMedio.toLocaleString('pt-BR', {minimumFractionDigits: 2})} - Faturamento médio por venda</p>`;
    texto += `<p><strong>Margem de contribuição:</strong> R$ ${margemContribuicao.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>`;
    
    if (margemContribuicao <= 0) {
        texto += "<p><strong>Aqui temos uma explicação para o prejuízo!</strong></p>";
        texto += "<p>Margem de contribuição menor ou igual a zero significa que quanto mais vende, mais perde.</p>";
    } else if (margemContribuicaoTotal <= custosFixos) {
        texto += "<p><strong>Aqui temos uma explicação para o prejuízo!</strong></p>";
        texto += `<p>Se a margem de contribuição multiplicada pelas vendas (R$ ${margemContribuicaoTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}) não supera os custos fixos (R$ ${custosFixos.toLocaleString('pt-BR', {minimumFractionDigits: 2})}), o Negócio, na melhor das hipóteses, está numa situação frágil, sem folga para enfrentar imprevistos ou crescer.</p>`;
    }
    
    const element = document.getElementById('ticketMarginAnalysisServicos');
    if (element) {
        element.innerHTML = texto;
    }
}

function displayBreakEvenAnalysisServicos(pontoEquilibrio, vendas, margemContribuicao, custosFixos, capacidadeAtendimento) {
    let texto = "";
    
    if (pontoEquilibrio) {
        texto += `<p><strong>Ponto de equilíbrio:</strong> ${pontoEquilibrio} vendas</p>`;
        
        if (margemContribuicao * vendas > custosFixos && pontoEquilibrio >= capacidadeAtendimento) {
            texto += "<p><strong>ALERTA MÁXIMO!</strong></p>";
            texto += "<p>Para alcançar margem zero teria sido preciso vender mais (ou o equivalente) à capacidade de atendimento, ou seja: sua empresa está mal estruturada (custos elevados, preços mal calculados e/ou capacidade de atendimento insuficiente)!</p>";
        } else if (pontoEquilibrio > 0 && pontoEquilibrio < capacidadeAtendimento) {
            texto += "<p>Isso significa que se as vendas tivessem sido iguais à capacidade de atendimento, o lucro teria sido maior.</p>";
        }
    } else {
        texto += "<p><strong>Ponto de equilíbrio:</strong> não alcançado</p>";
    }
    
    const element = document.getElementById('breakEvenAnalysisServicos');
    if (element) {
        element.innerHTML = texto;
    }
}

function displayCapacityAnalysisServicos(margemPotencial, margemPercentual, faturamentoPotencial, capacidadeAtendimento, vendas) {
    let texto = "";
    
    if (margemPotencial > margemPercentual) {
        texto += `<p>Isso significa que se as vendas tivessem sido iguais à capacidade de atendimento (${capacidadeAtendimento}), o lucro de ${margemPercentual.toFixed(2)}% teria sido de ${margemPotencial.toFixed(2)}%.</p>`;
    }
    
    if (vendas < capacidadeAtendimento * 0.95) {
        texto += "<p><strong>Por que não vendeu mais:</strong></p>";
        texto += "<ul>";
        texto += "<li>1) Mercado não comporta? Então aumente o valor do ticket médio e/ou reduza custos fixos;</li>";
        texto += "<li>2) Concorrência? Crie diferenciais e corrija seus pontos fracos;</li>";
        texto += "<li>3) Mês fraco? Crie incentivos.</li>";
        texto += "</ul>";
    } else if (vendas > capacidadeAtendimento * 1.05) {
        texto += "<p>Vendas acima da capacidade de atendimento, se rotineiras, podem prejudicar a qualidade e/ou lucratividade dos produtos, gerar stress com os clientes, nos funcionários e em você, à menos que tenham sido viabilizadas por estoques de mês(es) anterior(es)!</p>";
    }
    
    const element = document.getElementById('capacityAnalysisServicos');
    if (element) {
        element.innerHTML = texto;
    }
}

function displaySummaryAnalysisServicos(margemValor, margemPercentual, margemIdeal, distanciaObjetivo, margemPotencial) {
    let texto = "";
    
    if (margemValor <= 0) {
        texto += `<p><strong>Você tem motivo para estar muito preocupado com este prejuízo de ${margemPercentual.toFixed(2)}%. É preciso agir rápido!</strong></p>`;
    } else if (margemPercentual < margemIdeal * 50) {
        texto += `<p><strong>Você deve estar bem chateado com este resultado ${margemPercentual.toFixed(2)}%, longe dos ${(margemIdeal * 100).toFixed(2)}% que considera ideal!</strong></p>`;
    } else if (margemPercentual >= margemIdeal * 50 && margemPercentual < margemIdeal * 80) {
        texto += `<p><strong>Você deve estar insatisfeito com este resultado ${margemPercentual.toFixed(2)}% e quer melhorá-lo, já que o ideal teria sido ${(margemIdeal * 100).toFixed(2)}%!</strong></p>`;
    } else if (margemPercentual >= margemIdeal * 80 && margemPercentual < margemIdeal) {
        texto += `<p><strong>Você deve estar satisfeito com este resultado ${margemPercentual.toFixed(2)}%, mas gostaria de ter alcançado ${(margemIdeal * 100).toFixed(2)}%!</strong></p>`;
    } else if (margemPercentual >= margemIdeal) {
        texto += `<p><strong>Você tem motivo para estar muito satisfeito com este lucro de ${margemPercentual.toFixed(2)}%!</strong></p>`;
    }
    
    texto += `<p><strong>Distância do objetivo:</strong> R$ ${distanciaObjetivo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>`;
    
    if (margemPotencial > margemPercentual) {
        texto += `<p><strong>Potencial de melhoria:</strong> margem pode chegar a ${margemPotencial.toFixed(2)}% operando na capacidade máxima</p>`;
    }
    
    const element = document.getElementById('summaryAnalysisServicos');
    if (element) {
        element.innerHTML = texto;
    }
}

function displayRecommendationsServicos(margemContribuicao, margemContribuicaoTotal, custosFixos, pontoEquilibrio, capacidadeAtendimento, vendas, margemPercentual, margemIdeal) {
    let texto = "";
    
    // Adicionar nome do usuário
    const userName = '{{ user.name }}' || 'Usuário';
    
    if (margemContribuicao <= 0) {
        texto += "<p><strong>Principalmente, devido aos custos variáveis (gastos com vendas e compra de mercadorias).</strong></p>";
    } else if (margemContribuicaoTotal <= custosFixos) {
        texto += "<p><strong>Principalmente, devido aos custos variáveis (gastos com vendas e compra de mercadorias).</strong></p>";
    } else if (pontoEquilibrio >= capacidadeAtendimento) {
        texto += "<p><strong>Como vimos, sua empresa precisa ser reestruturada.</strong></p>";
    } else {
        texto += "<p><strong>Duas causas principais: os custos fixos e/ou os preços praticados.</strong></p>";
    }
    
    if (margemContribuicaoTotal > custosFixos && pontoEquilibrio >= capacidadeAtendimento) {
        texto += "<p><strong>Recomendamos que leia: NEM TUDO QUE RELUZ É OURO, no e-book!</strong></p>";
    }
    
    texto += "<p><strong>Sugerimos ler, no e-book: BOAS PRÁTICAS e CAMINHOS PARA O SUCESSO.</strong></p>";
    
    if (margemPercentual < margemIdeal * 95) {
        texto += `<p><strong>${userName},</strong> as análises acima referem-se a um período já encerrado. Elas são úteis para identificar o que pode ser melhorado para construir um futuro que corresponda às suas expectativas.</p>`;
    }
    
    texto += "<p>Tendo em vista a dinâmica da economia, as características de cada mês, a atividade da concorrência, e os efeitos sobre o comportamento do seu público-alvo, é importante considerar (alterações e estimativas) nos próximos meses.</p>";
    texto += "<p><strong>Sendo assim, recomendamos que você acesse o Simulador</strong></p>";
    
    const element = document.getElementById('recommendationsServicos');
    if (element) {
        element.innerHTML = texto;
    }
}
</script>
{% endblock %} 