{% extends "base.html" %}

{% block title %}Diagnóstico - GetUp Gestão{% endblock %}

{% block content %}
    {% include "components/navbar.html" %}
    <div class="container py-4">
        <!-- Card Principal -->
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="card-title mb-0">Diagnóstico</h4>
            </div>
            <div class="card-body">
                <!-- Descrição do diagnóstico -->
                <div class="mb-4">
                    <p>Esta tela permite que o gestor ou empreendedor:</p>
                    <ul>
                        <li>Tenha uma visão holística da saúde financeira do negócio</li>
                        <li>Identifique rapidamente se está operando com lucro ou prejuízo</li>
                        <li>Entenda quais custos estão impactando mais o resultado</li>
                        <li>Monitore se está utilizando sua capacidade de forma eficiente</li>
                        <li>Tome decisões baseadas em métricas financeiras importantes</li>
                        <li>Compare desempenho entre diferentes períodos</li>
                    </ul>
                    <p>A organização em cards com informações relacionadas e a disponibilidade de modais explicativos (ícones de engrenagem) para cada métrica demonstra uma preocupação em tornar dados financeiros complexos mais acessíveis e compreensíveis para o usuário.</p>
                </div>

                <!-- Dados Básicos -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Dados Básicos</h5>
                    </div>
                    <div class="card-body p-4">
                        <!-- Select Box -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="basicDataSelect" class="form-label">Selecione o Período dos dados básicos que deseja visualizar</label>
                                    <select class="form-select" id="basicDataSelect">
                                        {% for data in basic_data_list %}
                                            <option value="{{ data.id }}" {% if data.is_current %}selected{% endif %}>
                                                {{ data.month }}/{{ data.year }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dados Básicos em formato de texto -->
                        <div class="row">
                            {% if user.activity_type != 'Serviços' %}
                                <div class="col-md-6 mb-3">
                                    <p><strong>Quantidade de Clientes Atendidos:</strong> <span id="clientsServed">-</span></p>
                                    <p><strong>Capacidade de Atendimento:</strong> <span id="capacidadeAtendimento">-</span></p>
                                    <p><strong>Faturamento:</strong> <span id="salesRevenue">-</span></p>
                                
                                    <p><strong>Custos Fixos:</strong> <span id="fixedCosts">-</span></p>
                            
                                </div>
                                <div class="col-md-6 mb-3">
                                    <p><strong>Despesas de Vendas:</strong> <span id="salesExpenses">-</span></p>
                                    <p><strong>Gastos com Insumos e Produtos:</strong> <span id="operationalExpenses">-</span></p>
                                    <p><strong>Margem de Lucro Ideal:</strong> <span id="margemIdeial">-</span></p>
                                
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Gráficos e Métricas -->
                <div class="row mb-4">
                    <!-- Gráfico de Barras -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">Custos e Faturamento</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="costsChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Métricas -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">Métricas Financeiras</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">
                                        Lucro
                                        <i class="bi bi-gear-fill ms-2" data-bs-toggle="modal" data-bs-target="#margemModal" style="cursor: pointer;"></i>
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="lucro_reais" readonly>
                                        <input type="text" class="form-control" id="lucro_percentual" readonly>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        Ticket Médio
                                        <i class="bi bi-gear-fill ms-2" data-bs-toggle="modal" data-bs-target="#ticketMedioModal" style="cursor: pointer;"></i>
                                    </label>
                                    <input type="text" class="form-control" id="ticketMedio" readonly>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        Margem de Contribuição
                                        <i class="bi bi-gear-fill ms-2" data-bs-toggle="modal" data-bs-target="#margemContribuicaoModal" style="cursor: pointer;"></i>
                                    </label>
                                    <input type="text" class="form-control" id="margemContribuicao" readonly>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        Produtividade
                                        <i class="bi bi-gear-fill ms-2" data-bs-toggle="modal" data-bs-target="#produtividadeModal" style="cursor: pointer;"></i>
                                    </label>
                                    <input type="text" class="form-control" id="produtividade" readonly>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        Ponto de Equilíbrio
                                        <i class="bi bi-gear-fill ms-2" data-bs-toggle="modal" data-bs-target="#pontoEquilibrioModal" style="cursor: pointer;"></i>
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="pontoEquilibrio" readonly>
                                        <input type="text" class="form-control" id="pontoEquilibrioPercentual" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos de Pizza -->
                <div class="row mb-4">
                    <!-- Análise do Cálculo -->
                    <div class="col-12">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">Análise do Cálculo</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-3">
                                            <label class="form-label">Resultado da Análise</label>
                                            <textarea class="form-control" id="analiseCalculo" rows="10" readonly></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">Distribuição de Despesas</h5>
                            </div>
                            <div class="card-body">
                                {% if user.activity_type != 'Serviços' %}
                                <div style="height: 300px;">
                                    <canvas id="expensesPieChart"></canvas>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">Capacidade vs Atendimento</h5>
                            </div>
                            <div class="card-body">
                                <div style="height: 300px;">
                                    <canvas id="capacityChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modais de Ajuste -->
    <!-- Modal Margem -->
    <div class="modal fade" id="margemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajuste de Margem</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Fórmula</label>
                        <input type="text" class="form-control" value="(Receita - Custos) / Receita" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ticket Médio -->
    <div class="modal fade" id="ticketMedioModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajuste de Ticket Médio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Fórmula</label>
                        <input type="text" class="form-control" value="Receita / Clientes Atendidos" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Margem de Contribuição -->
    <div class="modal fade" id="margemContribuicaoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajuste de Margem de Contribuição</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Fórmula</label>
                        <input type="text" class="form-control" value="(Receita - Custos Variáveis) / Receita" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Produtividade -->
    <div class="modal fade" id="produtividadeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajuste de Produtividade</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Fórmula</label>
                        <input type="text" class="form-control" value="Receita / Custos" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ponto de Equilíbrio -->
    <div class="modal fade" id="pontoEquilibrioModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajuste de Ponto de Equilíbrio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Fórmula</label>
                        <input type="text" class="form-control" value="Custos Fixos / (1 - Custos Variáveis/Receita)" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

document.addEventListener('DOMContentLoaded', function() {
    // Função para formatar valores monetários (apenas para exibição)
    function formatMoney(value) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value);
    }

    // Função para obter valor numérico (para cálculos)
    function getNumericValue(value) {
        return parseFloat(value) || 0;
    }

    // Inicializar o gráfico de barras
    const ctx = document.getElementById('costsChart').getContext('2d');
    window.costsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Custos', 'Faturamento'],
            datasets: [{
                data: [0, 0],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.5)',
                    'rgba(54, 162, 235, 0.5)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'R$ ' + context.raw.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                        }
                    }
                }
            }
        }
    });

    {% if user.activity_type != 'Serviços' %}
    // Inicializar o gráfico de pizza de despesas
    const pieCtx = document.getElementById('expensesPieChart').getContext('2d');
    window.expensesPieChart = new Chart(pieCtx, {
        type: 'pie',
        data: {
            labels: ['Despesas de Vendas', 'Custos Fixos', 'Gastos com Insumos e Produtos'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.7)',
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 206, 86, 0.7)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            return `${label}: R$ ${value.toLocaleString('pt-BR', {minimumFractionDigits: 2})} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    {% endif %}

    // Inicializar o gráfico de pizza de capacidade
    const capacityCtx = document.getElementById('capacityChart').getContext('2d');
    window.capacityChart = new Chart(capacityCtx, {
        type: 'pie',
        data: {
            labels: ['Clientes Atendidos', 'Capacidade Não Utilizada'],
            datasets: [{
                data: [0, 0],
                backgroundColor: [
                    'rgba(75, 192, 192, 0.7)', // Verde-azulado para clientes atendidos
                    'rgba(220, 220, 220, 0.7)' // Cinza para capacidade não utilizada
                ],
                borderColor: [
                    'rgba(75, 192, 192, 1)',
                    'rgba(200, 200, 200, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            return `${label}: ${value} clientes (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Função para atualizar os indicadores
    function updateIndicators() {
        const {
            salesRevenue,
            salesExpenses,
            fixedCosts,
            operationalExpenses,
            clientsServed
        } = window.rawData;
        
        {% if user.activity_type != 'Serviços' %}
        // Calcular Lucro em Reais (F11-(F12+F13+F14))
        const lucroReais = salesRevenue - (salesExpenses + operationalExpenses + fixedCosts);
        
        // Calcular Lucro Percentual (L13/F11)
        const lucroPercentual = salesRevenue > 0 ? (lucroReais / salesRevenue) * 100 : 0;
        
        // Calcular Ticket Médio (F11/F10)
        const ticketMedio = clientsServed > 0 ? salesRevenue / clientsServed : 0;
        
        // Calcular Margem de Contribuição ((F11-(F12+F13))/F10)
        const margemContribuicao = clientsServed > 0 ? 
            (salesRevenue - (salesExpenses + operationalExpenses)) / clientsServed : 0;
        
        // Calcular Produtividade (F11/F14)
        const produtividade = fixedCosts > 0 ? salesRevenue / fixedCosts : 0;
        
        // Calcular L24 (custos fixos / (ticket médio - custos variáveis por cliente))
        const custosVariaveisPorCliente = clientsServed > 0 ? 
            (salesExpenses + operationalExpenses) / clientsServed : 0;
        const L24 = ticketMedio > 0 ? 
            fixedCosts / (ticketMedio - custosVariaveisPorCliente) : 0;
        
        // Calcular Ponto de Equilíbrio (L24*(F11/F10))
        const pontoEquilibrio = L24 * ticketMedio;
        
        // Calcular Ponto de Equilíbrio Percentual ((L24*(F11/F10))/(F11/F10))
        const pontoEquilibrioPercentual = ticketMedio > 0 ? pontoEquilibrio / ticketMedio : 0;

        // Definir textos das variáveis
        const variavel1 = `Você tem motivo para estar bem preocupado!
É preciso agir rápido! Seja racional, objetivo e frio! Faça o que for preciso! Agora!
Com está margem de contribuição, vender mais não irá tirar o Negócio do prejuízo!
Faça simulações na "Gestão de Prioridades", tratando de reduzir prioritariamente os gastos com vendas (consulte seu Contador para verificar seu enquadramento fiscal).
Também será preciso reduzir, os custos dos insumos e/ou mercadorias de terceiros: 
    a) comprando bem (preços, prazos e quantidades); 
    b) eliminando desperdícios, retrabalhos, perdas e desvios.
Utilize a "Calculadora de preços" para analisar:
    1) a margem de cada item;
    2) a comparação com os preços dos concorrentes.
Assim você saberá: 
    a) o que deve deixar de produzir/vender; 
    b) em quais ainda existe espaço para aumentar preços; 
    c) o que terá que associar com os mais lucrativos (combos); 
    d) em quais concentrar suas vendas.
Se o Negócio ainda continuar no prejuízo, veja o que consegue reduzir nos custos fixos (aumento da produtividade).
O negócio é viável? Então assuma a responsabilidade e aprenda com os erros. 
Levante a cabeça. Não demonstre que está com problemas. 
Não comente. Priorize o pagamento de dívidas pequenas.
Proponha acordos para as maiores, considerando que será vital cumpri-los fielmente!`;

        const variavel2 = `Você tem motivo para estar bem preocupado!
É preciso agir rápido! Seja racional, objetivo e frio! Faça o que for preciso. Agora!
Comece utilizando a "Calculadora de preços" para verificar: 
    1) a margem de cada item; 
    2) seus preços em relação aos dos concorrentes.
Assim você saberá: 
    a) o que deve deixar de produzir/vender; 
    b) em quais ainda existe espaço para aumentar preços;
    c) quais terá que associar com os mais lucrativos (combos); 
    d) em quais concentrar suas vendas.
Melhore sua produtividade! Analise seus custos fixos e veja o que pode fazer para reduzi-los.
É possível vender mais? (Existe demanda? Preparado para competir? Capital de giro suficiente? Fornecedores?).
Utilize a ferramenta "Gestão de Prioridades" para simular o resultado de suas análises. 
O negócio é viável? Então assuma a responsabilidade e aprenda com os erros.
Levante a cabeça. Não demonstre que está com problemas. 
Não comente. Priorize o pagamento de dívidas pequenas. 
Proponha acordos para as maiores, considerando que será vital cumpri-los fielmente!`;

        const variavel3 = `O lucro alcançado não é aquele que você gostaria! E o negócio está sendo onerado por capacidade ociosa (vendas menores do que a capacidade de atendimento)!
Na ferramenta "Gestão de Prioridades" aumente a quantidade de clientes atendidos até o limite de sua capacidade de atendimento (desde que exista demanda, esteja preparado para competir, disponha de capital de giro suficiente e haja disponibilidades nos fornecedores). Verifique a margem resultante.
Se não for possível vender mais, ou se não for suficiente, você ainda pode tentar estimular aumento do valor do ticket médio e verificar a possibilidade de reduzir despesas e custos.
Utilize a "Calculadora de preços" para analisar: 
    1) a margem de cada item; 
    2) a comparação com os preços dos concorrentes.
Assim você saberá:
    a) se deve deixar de produzir/vender algum item;
    b) em quais ainda existe espaço para aumentar preços; 
    c) o que terá que associar com os mais lucrativos (combos); 
    d) em quais concentrar suas vendas.
Se a margem continuar menor do que o ideal, considere a hipótese de que o negócio não permite a lucratividade que você considera ideal!`;

        const variavel4 = `O lucro alcançado não é aquele que você gostaria, mesmo atendendo no limite de sua capacidade!
Comece utilizando a "Calculadora de preços" para verificar: 
    1) a margem de cada item; 
    2) seus preços em relação aos dos concorrentes.
Assim você saberá: 
    a) o que deve deixar de produzir/vender; 
    b) em quais ainda existe espaço para aumentar preços; 
    c) quais terá que associar com os mais lucrativos (combos); 
    d) em quais concentrar suas vendas.
Ainda assim a lucratividade não é a desejada?
Na ferramenta "Gestão de Prioridades" simule uma possível redução dos custos fixos e veja o que acontece com a margem. Se isso ainda não for suficiente, verifique a possibilidade de reduzir os demais custos!
Se a margem continuar menor do que o ideal, considere a hipótese de que o negócio não permite a lucratividade que você considera ideal!`;

        const variavel5 = `O lucro alcançado não é aquele que você gostaria, mesmo vendendo mais do que a capacidade de atendimento (alto risco de estresse e mal atendimento, o que acabará prejudicando o Negócio!).
Utilize a "Calculadora de Preços" para verificar: 
    1) a margem de cada item; 
    2) seus preços em relação aos dos concorrentes.
Assim você saberá: 
    a) o que deve deixar de produzir/vender; 
    b) em quais ainda existe espaço para aumentar preços; 
    c) quais terá que associar com os mais lucrativos (combos); 
    d) em quais concentrar suas vendas.
Com a ferramenta "Gestão de Prioridades" simule reduzir a quantidade de clientes atendidos para o limite de sua capacidade de atendimento. 
Depois, para melhorar a produtividade, reduza os custos fixos. Ainda não está bom? Veja o que dá para reduzir nos demais custos.
Se a margem continuar menor do que o ideal, considere a hipótese de que o negócio não permite a lucratividade que você considera ideal! 
E, avalie a conveniência de investir para ampliar sua capacidade de atendimento!`;

        const variavel6 = `Você deve estar satisfeito com o lucro alcançado, mesmo vendendo menos do que o possível!
É preciso reduzir a capacidade ociosa (custos e recursos subutilizados).
Por que não vendeu mais:
    1) Mercado não comporta? Então aumente o valor do ticket médio e/ou reduza custos fixos (utilize a ferramenta "Gestão de Prioridades" para fazer simulações);
    2) Concorrência? a) crie diferenciais e corrija seus pontos fracos; b) utilize a "Calculadora de Preços" para comparar seus preços com os dos concorrentes. Faça simulações em "Definição de Prioridades".`;

        const variavel7 = `Você deve estar satisfeito com o lucro alcançado!
Suas vendas corresponderam à sua capacidade de atendimento.
Estude o potencial do mercado em que atua! 
Observe os indícios de alterações: aumento ou redução da demanda; mudanças tecnológicas e/ou nas preferências dos clientes; situação dos fornecedores; comportamento dos preços;ações importantes na concorrência e o impacto em sua competitividade; situações sócio econômicas, mudanças na legislação, obras públicas, etc.
Traduza suas conclusões em percentuais de aumento ou redução (em relação aos dados atuais), na ferramenta "Definição de Prioridades" e veja como afeta sua lucratividade. Se acredita em variações nos preços dos insumos e/ou mercadorias de terceiros; ou nos preços dos concorrentes, recorra à "Calculadora de Preços"!`;

        const variavel8 = `Você deve estar satisfeito com o lucro alcançado!
Mas fique atento, pois está vendendo mais do que a capacidade de atendimento (alto risco de estresse e mal atendimento, o que acabará prejudicando o Negócio!).
Considere a viabilidade de ampliar sua capacidade de atendimento! Fora de cogitação?
Então, na ferramenta "Gestão de Prioridades" simule reduzir a quantidade de clientes atendidos para o limite de sua capacidade de atendimento.
Verifique o impacto na margem! Para retomar o lucro anterior, verifique o resultado de um aumento no valor do ticket médio; também, reduza os custos fixos, (aumento da produtividade). 
Ainda não está bom? Então utilize a "Calculadora de Preços" para comparar seus preços com os da concorrência: existe espaço para aumentos? é possível estimular a venda dos itens mais lucrativos?`;

        const variavel9 = `Você deve estar muito satisfeito com o lucro alcançado, mesmo vendendo menos do que o possível.
É preciso reduzir a capacidade ociosa (custos e recursos subutilizados).
Por que não vendeu mais:
1) Mercado não comporta? Então aumente o valor do ticket médio e/ou reduza custos fixos (utilize a ferramenta "Gestão de Prioridades" para fazer simulações);
2) Concorrência? a) crie diferenciais e corrija seus pontos fracos; b) utilize a "Calculadora de Preços" para comparar seus preços com os dos concorrentes. Faça simulações em "Definição de Prioridades".`;

        const variavel10 = `Você deve estar muito satisfeito com o lucro alcançado!
Suas vendas correspondem à sua capacidade de atendimento.
Estude o potencial do mercado em que atua! Observe os indícios de alterações: aumento ou redução da demanda; mudanças tecnológicas e/ou nas preferências dos clientes; situação dos fornecedores; comportamento dos preços; ações importantes na concorrência e o impacto em sua competitividade; situações sócio econômicas, mudanças na legislação, obras públicas, etc.
Traduza suas conclusões em percentuais de aumento ou redução (em relação aos dados atuais), na ferramenta "Definição de Prioridades" e veja como afeta sua lucratividade. Se acredita em variações nos preços dos insumos e/ou mercadorias de terceiros; ou nos preços dos concorrentes, recorra à "Calculadora de Preços"!`;

        const variavel11 = `Você deve estar muito satisfeito com o lucro alcançado!
Mas fique atento, pois está vendendo mais do que a capacidade de atendimento (risco de estresse e mal atendimento)!
Considere a viabilidade de ampliar sua capacidade de atendimento! Fora de cogitação?
Com a ferramenta "Gestão de Prioridades" simule reduzir a quantidade de clientes atendidos para o limite de sua capacidade de atendimento. Isso reduzirá a margem. Então, tente melhorar a produtividade, reduzindo os custos fixos. Ainda não está bom? Veja o que dá para reduzir nos demais custos. Ainda assim a margem continua menor? O que acontece se conseguir aumentar o ticket médio? Com a ajuda da "Calculadora de Preços" identifique os produtos mais lucrativos e considere a possibilidade de aumentar o volume de vendas deles. Nas comparações com os concorrentes, veja se há espaço para aumento de preços.`;

        // Calcular Análise
        let analiseResultado = "";
        
        // L14 = pontoEquilibrio
        // L19 = margemContribuicao
        // F15 = salesRevenue (capacidade de faturamento)
        // F16 = serviceCapacity (capacidade de atendimento)
        // F10 = clientsServed (clientes atendidos)
        
        if (pontoEquilibrio <= 0 && margemContribuicao <= 0) {
            analiseResultado = variavel1;
        } else if (pontoEquilibrio <= 0 && margemContribuicao > 0) {
            analiseResultado = variavel2;
        } else if (pontoEquilibrio > 0 && pontoEquilibrio < salesRevenue * 0.9 && clientsServed < window.serviceCapacity * 0.9 && margemContribuicao > 0) {
            analiseResultado = variavel3;
        } else if (pontoEquilibrio > 0 && pontoEquilibrio < salesRevenue * 0.9 && clientsServed > window.serviceCapacity * 0.9 && clientsServed < window.serviceCapacity * 1.05 && margemContribuicao > 0) {
            analiseResultado = variavel4;
        } else if (pontoEquilibrio > 0 && pontoEquilibrio < salesRevenue * 0.9 && clientsServed > window.serviceCapacity * 1.05 && margemContribuicao > 0) {
            analiseResultado = variavel5;
        } else if (pontoEquilibrio > salesRevenue * 0.9 && pontoEquilibrio < salesRevenue * 1.05 && clientsServed < window.serviceCapacity * 0.9 && margemContribuicao > 0) {
            analiseResultado = variavel6;
        } else if (pontoEquilibrio > salesRevenue * 0.9 && pontoEquilibrio < salesRevenue * 1.05 && clientsServed > window.serviceCapacity * 0.9 && clientsServed < window.serviceCapacity * 1.05 && margemContribuicao > 0) {
            analiseResultado = variavel7;
        } else if (pontoEquilibrio > salesRevenue * 0.9 && pontoEquilibrio < salesRevenue * 1.05 && clientsServed >= window.serviceCapacity * 1.05 && margemContribuicao > 0) {
            analiseResultado = variavel8;
        } else if (pontoEquilibrio > salesRevenue * 1.05 && clientsServed < window.serviceCapacity * 0.9 && margemContribuicao > 0) {
            analiseResultado = variavel9;
        } else if (pontoEquilibrio > salesRevenue * 1.05 && clientsServed > window.serviceCapacity * 0.9 && clientsServed < window.serviceCapacity * 1.05 && margemContribuicao > 0) {
            analiseResultado = variavel10;
        } else if (pontoEquilibrio > salesRevenue * 1.05 && clientsServed > window.serviceCapacity * 1.05 && margemContribuicao > 0) {
            analiseResultado = variavel11;
        }

        // Atualizar os elementos na interface
        document.getElementById('lucro_reais').value = formatMoney(lucroReais);
        document.getElementById('lucro_percentual').value = lucroPercentual.toFixed(2) + '%';
        document.getElementById('ticketMedio').value = formatMoney(ticketMedio);
        document.getElementById('margemContribuicao').value = formatMoney(margemContribuicao);
        document.getElementById('produtividade').value = produtividade.toFixed(2);
        document.getElementById('pontoEquilibrio').value = formatMoney(pontoEquilibrio);
        document.getElementById('pontoEquilibrioPercentual').value = pontoEquilibrioPercentual.toFixed(0);
        document.getElementById('analiseCalculo').value = analiseResultado;
        
        // Atualizar o gráfico de pizza
        updateExpensesPieChart(salesExpenses, fixedCosts, operationalExpenses);
        {% endif %}

        // Atualizar o gráfico de capacidade
        updateCapacityChart(clientsServed, window.serviceCapacity);
    }

    {% if user.activity_type != 'Serviços' %}
    // Função para atualizar o gráfico de pizza
    function updateExpensesPieChart(salesExpenses, fixedCosts, operationalExpenses) {
        // Atualizar dados do gráfico de pizza
        window.expensesPieChart.data.datasets[0].data = [
            salesExpenses,
            fixedCosts,
            operationalExpenses
        ];
        window.expensesPieChart.update();
    }
    {% endif %}

    // Função para atualizar o gráfico de capacidade
    function updateCapacityChart(clientsServed, serviceCapacity) {
        // Garantir que os valores sejam números
        const actualClientsServed = parseInt(clientsServed) || 0;
        const actualCapacity = parseInt(serviceCapacity) || 0;
        
        console.log("Valores recebidos:", {
            clientsServed,
            serviceCapacity,
            actualClientsServed,
            actualCapacity
        });

        // Atualizar dados do gráfico de pizza
        window.capacityChart.data.datasets[0].data = [
            actualClientsServed,
            actualCapacity
        ];
        
        // Atualizar a legenda com os valores reais
        window.capacityChart.data.labels = [
            `Clientes Atendidos (${actualClientsServed})`, 
            `Capacidade Total (${actualCapacity})`
        ];
        
        // Atualizar cores com base na ocupação
        const utilizationRatio = actualCapacity > 0 ? actualClientsServed / actualCapacity : 0;
        let clientsColor = 'rgba(75, 192, 192, 0.7)'; // Verde por padrão
        
        // Se estiver próximo da capacidade máxima, mudar para amarelo ou vermelho
        if (utilizationRatio > 0.9) {
            clientsColor = 'rgba(255, 99, 132, 0.7)'; // Vermelho para ocupação acima de 90%
        } else if (utilizationRatio > 0.7) {
            clientsColor = 'rgba(255, 205, 86, 0.7)'; // Amarelo para ocupação entre 70-90%
        }
        
        window.capacityChart.data.datasets[0].backgroundColor[0] = clientsColor;
        window.capacityChart.data.datasets[0].borderColor[0] = clientsColor.replace('0.7', '1');
        
        window.capacityChart.update();
        
        console.log("Capacidade atualizada:", {
            actualClientsServed,
            actualCapacity,
            utilizationRatio
        });
    }

    // Função para atualizar o gráfico com os valores da tabela
    function updateChart() {
        // Usar os valores numéricos originais para cálculos
        const {
            salesRevenue,
            salesExpenses,
            fixedCosts,
            operationalExpenses,
            financialExpenses,
            clientsServed
        } = window.rawData;

        // Calcular o total de custos
        const totalCosts = salesExpenses + fixedCosts + operationalExpenses + financialExpenses;

        // Atualizar o gráfico
        window.costsChart.data.datasets[0].data = [totalCosts, salesRevenue];
        window.costsChart.update();
        
        // Atualizar os indicadores
        updateIndicators();
    }

    // Listener para o evento change
    document.getElementById('basicDataSelect').addEventListener('change', function() {
        const basicDataId = this.value;
        console.log("ID selecionado:", basicDataId);
        
        fetch(`/diagnostico/api/basic-data/${basicDataId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Dados não encontrados');
                }
                return response.json();
            })
            .then(data => {
                console.log("Dados recebidos:", data);
                console.log("Service Capacity:", data.service_capacity);
                console.log("Clients Served:", data.clients_served);
                
                // Atualizar a tabela com os dados (formatação para exibição)
                document.getElementById('clientsServed').textContent = data.clients_served;
                const capacidade = data.service_capacity || 'Não definido';
                document.getElementById('capacidadeAtendimento').textContent = `${capacidade} clientes`;
                document.getElementById('salesRevenue').textContent = formatMoney(data.sales_revenue);
                document.getElementById('salesExpenses').textContent = formatMoney(data.sales_expenses);
                {% if user.activity_type != 'Serviços' %}
                document.getElementById('fixedCosts').textContent = formatMoney(data.fixed_costs);
                {% endif %}
                document.getElementById('operationalExpenses').textContent = formatMoney(data.operational_expenses);
                {% if user.activity_type == 'Serviços' %}
                document.getElementById('proLabore').textContent = formatMoney(data.pro_labore);
                document.getElementById('weeklyHours').textContent = `${data.weekly_hours}h`;
                {% endif %}
                
                // Atualizar a margem de lucro ideal
                const idealMargin = data.ideal_profit_margin !== null && data.ideal_profit_margin !== undefined ? data.ideal_profit_margin : 0;
                console.log("Valor final da margem ideal:", idealMargin);
                document.getElementById('margemIdeial').textContent = `${idealMargin.toFixed(2)}%`;
                
                // Guardar os valores numéricos originais para cálculos
                window.rawData = {
                    salesRevenue: getNumericValue(data.sales_revenue),
                    salesExpenses: getNumericValue(data.sales_expenses),
                    fixedCosts: getNumericValue(data.fixed_costs),
                    operationalExpenses: getNumericValue(data.operational_expenses),
                    financialExpenses: getNumericValue(data.financial_expenses),
                    proLabore: getNumericValue(data.pro_labore),
                    clientsServed: data.clients_served
                };
                
                // Guardar a capacidade de atendimento para uso no gráfico
                window.serviceCapacity = data.service_capacity;
                
                // Atualizar o gráfico e os indicadores usando os valores numéricos
                updateChart();
            })
            .catch(error => {
                console.error('Erro ao carregar dados:', error);
                alert('Erro ao carregar os dados. Por favor, tente novamente.');
            });
    });
    
    // Disparar o evento change automaticamente quando a página carregar
    const selectElement = document.getElementById('basicDataSelect');
    if (selectElement && selectElement.value) {
        selectElement.dispatchEvent(new Event('change'));
    } else {
        console.warn('Select não encontrado ou sem valor para carregar dados iniciais');
    }
});
</script>
{% endblock %} 