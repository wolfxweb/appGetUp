{% extends "base.html" %}

{% block title %}Diagnóstico - GetUp Gestão{% endblock %}

{% block content %}
    {% include "components/navbar.html" %}
    <div class="container py-4">
        <!-- Card Principal -->
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="card-title mb-0">Diagnóstico</h4>
            </div>
            <div class="card-body">
                <!-- Descrição do diagnóstico -->
                <div class="mb-4">
                    <p>Esta tela permite que o gestor ou empreendedor:</p>
                    <ul>
                        <li>Tenha uma visão holística da saúde financeira do negócio</li>
                        <li>Identifique rapidamente se está operando com lucro ou prejuízo</li>
                        <li>Entenda quais custos estão impactando mais o resultado</li>
                        <li>Monitore se está utilizando sua capacidade de forma eficiente</li>
                        <li>Tome decisões baseadas em métricas financeiras importantes</li>
                        <li>Compare desempenho entre diferentes períodos</li>
                    </ul>
                    <p>A organização em cards com informações relacionadas e a disponibilidade de modais explicativos (ícones de engrenagem) para cada métrica demonstra uma preocupação em tornar dados financeiros complexos mais acessíveis e compreensíveis para o usuário.</p>
                </div>

                <!-- Dados Básicos -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Dados Básicos</h5>
                    </div>
                    <div class="card-body p-4">
                        <!-- Select Box -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="basicDataSelect" class="form-label">Selecione o Período dos dados básicos que deseja visualizar</label>
                                    <select class="form-select" id="basicDataSelect">
                                        {% for data in basic_data_list %}
                                            <option value="{{ data.id }}" {% if data.is_current %}selected{% endif %}>
                                                {{ data.month }}/{{ data.year }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dados Básicos em formato de texto -->
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <p><strong>Quantidade de Clientes Atendidos:</strong> <span id="clientsServed">-</span></p>
                                <p><strong>Capacidade de Atendimento:</strong> <span id="capacidadeAtendimento">-</span></p>
                                <p><strong>Faturamento:</strong> <span id="salesRevenue">-</span></p>
                                <p><strong>Despesas de Vendas:</strong> <span id="salesExpenses">-</span></p>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <p><strong>Gastos com Insumos e Produtos:</strong> <span id="operationalExpenses">-</span></p>
                                <p><strong>Gastos com Vendas:</strong> <span id="financialExpenses">-</span></p>
                                <p><strong>Impostos:</strong> <span id="taxes">-</span></p>
                                <p><strong>Outras Despesas:</strong> <span id="otherExpenses">-</span></p>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <p><strong>Margem de Lucro Ideal:</strong> <span id="margemIdeial">-</span></p>
                                {% if user.activity_type == 'Serviços' %}
                                    <p><strong>Pro-labore:</strong> <span id="proLabore">-</span></p>
                                    <p><strong>Horas Trabalhadas por Semana:</strong> <span id="weeklyHours">-</span></p>
                                {% endif %}
                                {% if user.activity_type != 'Serviços' %}
                                    <p><strong>Custos Fixos:</strong> <span id="fixedCosts">-</span></p>
                                {% endif %}              
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos e Métricas -->
                <div class="row mb-4">
                    <!-- Gráfico de Barras -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">Custos e Faturamento</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="costsChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Métricas -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">Métricas Financeiras</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">
                                        Margem
                                        <i class="bi bi-gear-fill ms-2" data-bs-toggle="modal" data-bs-target="#margemModal" style="cursor: pointer;"></i>
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="margem" readonly>
                                        <span class="input-group-text" id="margemPercentual"></span>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        Ticket Médio
                                        <i class="bi bi-gear-fill ms-2" data-bs-toggle="modal" data-bs-target="#ticketMedioModal" style="cursor: pointer;"></i>
                                    </label>
                                    <input type="text" class="form-control" id="ticketMedio" readonly>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        Margem de Contribuição
                                        <i class="bi bi-gear-fill ms-2" data-bs-toggle="modal" data-bs-target="#margemContribuicaoModal" style="cursor: pointer;"></i>
                                    </label>
                                    <input type="text" class="form-control" id="margemContribuicao" readonly>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        Produtividade
                                        <i class="bi bi-gear-fill ms-2" data-bs-toggle="modal" data-bs-target="#produtividadeModal" style="cursor: pointer;"></i>
                                    </label>
                                    <input type="text" class="form-control" id="produtividade" readonly>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        Ponto de Equilíbrio
                                        <i class="bi bi-gear-fill ms-2" data-bs-toggle="modal" data-bs-target="#pontoEquilibrioModal" style="cursor: pointer;"></i>
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="pontoEquilibrio" readonly>
                                        <span class="input-group-text" id="pontoEquilibrioPercentual"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos de Pizza -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">Distribuição de Despesas</h5>
                            </div>
                            <div class="card-body">
                                {% if user.activity_type != 'Serviços' %}
                                <div style="height: 300px;">
                                    <canvas id="expensesPieChart"></canvas>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">Capacidade vs Atendimento</h5>
                            </div>
                            <div class="card-body">
                                <div style="height: 300px;">
                                    <canvas id="capacityChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modais de Ajuste -->
    <!-- Modal Margem -->
    <div class="modal fade" id="margemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajuste de Margem</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Fórmula</label>
                        <input type="text" class="form-control" value="(Receita - Custos) / Receita" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ticket Médio -->
    <div class="modal fade" id="ticketMedioModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajuste de Ticket Médio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Fórmula</label>
                        <input type="text" class="form-control" value="Receita / Clientes Atendidos" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Margem de Contribuição -->
    <div class="modal fade" id="margemContribuicaoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajuste de Margem de Contribuição</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Fórmula</label>
                        <input type="text" class="form-control" value="(Receita - Custos Variáveis) / Receita" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Produtividade -->
    <div class="modal fade" id="produtividadeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajuste de Produtividade</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Fórmula</label>
                        <input type="text" class="form-control" value="Receita / Custos" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ponto de Equilíbrio -->
    <div class="modal fade" id="pontoEquilibrioModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajuste de Ponto de Equilíbrio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Fórmula</label>
                        <input type="text" class="form-control" value="Custos Fixos / (1 - Custos Variáveis/Receita)" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

document.addEventListener('DOMContentLoaded', function() {
    // Função para formatar valores monetários (apenas para exibição)
    function formatMoney(value) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value);
    }

    // Função para obter valor numérico (para cálculos)
    function getNumericValue(value) {
        return parseFloat(value) || 0;
    }

    // Inicializar o gráfico de barras
    const ctx = document.getElementById('costsChart').getContext('2d');
    window.costsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Custos', 'Faturamento'],
            datasets: [{
                data: [0, 0],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.5)',
                    'rgba(54, 162, 235, 0.5)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'R$ ' + context.raw.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                        }
                    }
                }
            }
        }
    });

    {% if user.activity_type != 'Serviços' %}
    // Inicializar o gráfico de pizza de despesas
    const pieCtx = document.getElementById('expensesPieChart').getContext('2d');
    window.expensesPieChart = new Chart(pieCtx, {
        type: 'pie',
        data: {
            labels: ['Despesas de Vendas', 'Custos Fixos', 'Gastos com Insumos e Produtos', 'Gastos com Vendas'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.7)',
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 206, 86, 0.7)',
                    'rgba(75, 192, 192, 0.7)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            return `${label}: R$ ${value.toLocaleString('pt-BR', {minimumFractionDigits: 2})} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    {% endif %}

    // Inicializar o gráfico de pizza de capacidade
    const capacityCtx = document.getElementById('capacityChart').getContext('2d');
    window.capacityChart = new Chart(capacityCtx, {
        type: 'pie',
        data: {
            labels: ['Clientes Atendidos', 'Capacidade Não Utilizada'],
            datasets: [{
                data: [0, 0],
                backgroundColor: [
                    'rgba(75, 192, 192, 0.7)', // Verde-azulado para clientes atendidos
                    'rgba(220, 220, 220, 0.7)' // Cinza para capacidade não utilizada
                ],
                borderColor: [
                    'rgba(75, 192, 192, 1)',
                    'rgba(200, 200, 200, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            return `${label}: ${value} clientes (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Função para atualizar os indicadores
    function updateIndicators() {
        const {
            salesRevenue,
            salesExpenses,
            fixedCosts,
            operationalExpenses,
            financialExpenses,
            taxes,
            otherExpenses,
            clientsServed
        } = window.rawData;
        
        // Calcular a Margem
        const totalCosts = salesExpenses + fixedCosts + operationalExpenses + financialExpenses + taxes + otherExpenses;
        const margin = salesRevenue > 0 ? ((salesRevenue - totalCosts) / salesRevenue * 100) : 0;
        
        // Calcular o Ticket Médio
        const averageTicket = salesRevenue / clientsServed;
        
        // Calcular a Margem de Contribuição
        const contributionMargin = salesRevenue > 0 ? ((salesRevenue - salesExpenses) / salesRevenue * 100) : 0;
        
        // Calcular Produtividade
        const fixedExpenses = fixedCosts + operationalExpenses + financialExpenses + taxes + otherExpenses;
        const productivity = fixedExpenses > 0 ? (salesRevenue / fixedExpenses) : 0;
        
        // Calcular Ponto de Equilíbrio
        const breakEvenPoint = salesRevenue > 0 ? (fixedCosts / (1 - (salesExpenses / salesRevenue))) : 0;

        // Atualizar os elementos na interface
        document.getElementById('margem').value = margin.toFixed(2) + '%';
        document.getElementById('ticketMedio').value = formatMoney(averageTicket);
        document.getElementById('margemContribuicao').value = contributionMargin.toFixed(2) + '%';
        document.getElementById('produtividade').value = productivity.toFixed(2);
        document.getElementById('pontoEquilibrio').value = formatMoney(breakEvenPoint);
        
        {% if user.activity_type != 'Serviços' %}
        // Atualizar o gráfico de pizza
        updateExpensesPieChart(salesExpenses, fixedCosts, operationalExpenses, financialExpenses);
        {% endif %}

        // Atualizar o gráfico de capacidade
        updateCapacityChart(clientsServed, window.serviceCapacity);
    }

    {% if user.activity_type != 'Serviços' %}
    // Função para atualizar o gráfico de pizza
    function updateExpensesPieChart(salesExpenses, fixedCosts, operationalExpenses, financialExpenses) {
        // Atualizar dados do gráfico de pizza
        window.expensesPieChart.data.datasets[0].data = [
            salesExpenses,
            fixedCosts,
            operationalExpenses,
            financialExpenses
        ];
        window.expensesPieChart.update();
    }
    {% endif %}

    // Função para atualizar o gráfico de capacidade
    function updateCapacityChart(clientsServed, serviceCapacity) {
        // Usar o valor guardado na janela ou o valor passado como parâmetro
        const actualCapacity = window.serviceCapacity || serviceCapacity;
        
        // Verificar se a capacidade é maior que os clientes atendidos
        const capacity = Math.max(actualCapacity, clientsServed);
        const unusedCapacity = Math.max(0, capacity - clientsServed);

        // Atualizar dados do gráfico de pizza
        window.capacityChart.data.datasets[0].data = [
            clientsServed,
            unusedCapacity
        ];
        
        // Atualizar a legenda com os valores reais
        window.capacityChart.data.labels = [
            `Clientes Atendidos (${clientsServed})`, 
            `Capacidade Não Utilizada (${unusedCapacity})`
        ];
        
        // Atualizar cores com base na ocupação
        const utilizationRatio = clientsServed / capacity;
        let clientsColor = 'rgba(75, 192, 192, 0.7)'; // Verde por padrão
        
        // Se estiver próximo da capacidade máxima, mudar para amarelo ou vermelho
        if (utilizationRatio > 0.9) {
            clientsColor = 'rgba(255, 99, 132, 0.7)'; // Vermelho para ocupação acima de 90%
        } else if (utilizationRatio > 0.7) {
            clientsColor = 'rgba(255, 205, 86, 0.7)'; // Amarelo para ocupação entre 70-90%
        }
        
        window.capacityChart.data.datasets[0].backgroundColor[0] = clientsColor;
        window.capacityChart.data.datasets[0].borderColor[0] = clientsColor.replace('0.7', '1');
        
        window.capacityChart.update();
        
        console.log("Capacidade atualizada:", {
            clientsServed, actualCapacity, unusedCapacity, utilizationRatio
        });
    }

    // Função para atualizar o gráfico com os valores da tabela
    function updateChart() {
        // Usar os valores numéricos originais para cálculos
        const {
            salesRevenue,
            salesExpenses,
            fixedCosts,
            operationalExpenses,
            financialExpenses,
            taxes,
            otherExpenses,
            clientsServed
        } = window.rawData;

        // Calcular o total de custos
        const totalCosts = salesExpenses + fixedCosts + operationalExpenses + 
                          financialExpenses + taxes + otherExpenses;

        // Atualizar o gráfico
        window.costsChart.data.datasets[0].data = [totalCosts, salesRevenue];
        window.costsChart.update();
        
        // Atualizar os indicadores
        updateIndicators();
    }

    // Listener para o evento change
    document.getElementById('basicDataSelect').addEventListener('change', function() {
        const basicDataId = this.value;
        console.log("ID selecionado:", basicDataId);
        
        fetch(`/diagnostico/api/basic-data/${basicDataId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Dados não encontrados');
                }
                return response.json();
            })
            .then(data => {
                console.log("Dados recebidos:", data);
                console.log("Service Capacity:", data.service_capacity);
                
                // Atualizar a tabela com os dados (formatação para exibição)
                document.getElementById('clientsServed').textContent = data.clients_served;
                const capacidade = data.service_capacity || 'Não definido';
                document.getElementById('capacidadeAtendimento').textContent = `${capacidade} clientes`;
                document.getElementById('salesRevenue').textContent = formatMoney(data.sales_revenue);
                document.getElementById('salesExpenses').textContent = formatMoney(data.sales_expenses);
                {% if user.activity_type != 'Serviços' %}
                document.getElementById('fixedCosts').textContent = formatMoney(data.fixed_costs);
                {% endif %}
                document.getElementById('operationalExpenses').textContent = formatMoney(data.operational_expenses);
                document.getElementById('financialExpenses').textContent = formatMoney(data.financial_expenses);
                document.getElementById('taxes').textContent = formatMoney(data.taxes);
                document.getElementById('otherExpenses').textContent = formatMoney(data.other_expenses);
                {% if user.activity_type == 'Serviços' %}
                document.getElementById('proLabore').textContent = formatMoney(data.pro_labore);
                document.getElementById('weeklyHours').textContent = `${data.weekly_hours}h`;
                {% endif %}
                
                // Guardar os valores numéricos originais para cálculos
                window.rawData = {
                    salesRevenue: getNumericValue(data.sales_revenue),
                    salesExpenses: getNumericValue(data.sales_expenses),
                    fixedCosts: getNumericValue(data.fixed_costs),
                    operationalExpenses: getNumericValue(data.operational_expenses),
                    financialExpenses: getNumericValue(data.financial_expenses),
                    taxes: getNumericValue(data.taxes),
                    otherExpenses: getNumericValue(data.other_expenses),
                    proLabore: getNumericValue(data.pro_labore),
                    clientsServed: parseInt(data.clients_served) || 0
                };
                
                // Guardar a capacidade de atendimento para uso no gráfico
                window.serviceCapacity = data.service_capacity || data.clients_served * 1.5;
                
                // Atualizar o gráfico e os indicadores usando os valores numéricos
                updateChart();
            })
            .catch(error => {
                console.error('Erro ao carregar dados:', error);
                alert('Erro ao carregar os dados. Por favor, tente novamente.');
            });
    });
    
    // Disparar o evento change automaticamente quando a página carregar
    const selectElement = document.getElementById('basicDataSelect');
    if (selectElement && selectElement.value) {
        selectElement.dispatchEvent(new Event('change'));
    } else {
        console.warn('Select não encontrado ou sem valor para carregar dados iniciais');
    }
});
</script>
{% endblock %} 