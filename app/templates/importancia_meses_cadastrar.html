{% extends "base.html" %}

{% block title %}Cadastrar Importâncias dos Meses - GetUp Gestão{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #F5F5F5 !important;
    }
    .container-fluid, .container {
        background-color: #F5F5F5 !important;
    }
    .card, .card-body {
        background-color: #F0F0F0 !important;
    }
    .card-header.bg-secondary {
        background-color: #6c757d !important;
        color: white !important;
    }
    .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
    }
    .btn-secondary:hover {
        background-color: #5a6268;
        border-color: #545b62;
        color: white;
    }
    .form-control, .form-select {
        background-color: #F5F5F5 !important;
    }
    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
    }
    .mes-nome {
        font-weight: bold;
    }
    .campo-calculado {
        background-color: #e9ecef !important;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="background-color: #F5F5F5; min-height: 100vh;">
  <div class="row">
    <div class="col-md-12 mt-5">
        <div class="col-md-12 mb-4">
            <img src="/static/images/Logo.png" alt="Logo" height="40">
        </div>
      
      <!-- Botão Voltar -->
      <div class="row mb-4">
        <div class="col-12">
          <a href="/importancia-meses" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
          </a>
        </div>
      </div>

      <!-- Card principal -->
      <div class="card shadow mb-4" style="background-color: #F0F0F0;">
        <div class="card-header bg-secondary text-white">
          <h4 class="card-title mb-0">Cadastrar Importâncias dos Meses</h4>
        </div>
        <div class="card-body">
          <!-- Seção: Seleção de Dado Básico -->
          <div class="row mb-4">
            <div class="col-md-6">
              <label for="basicDataSelect" class="form-label">Selecione o Dado Básico:</label>
              <select class="form-select" id="basicDataSelect">
                <option value="">Selecione um dado básico...</option>
                {% for data in basic_data_list %}
                <option value="{{ data.id }}" data-year="{{ data.year }}" data-month="{{ data.month }}">
                  {{ data.month }}/{{ data.year }}
                </option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- Seção: Eventos que Influenciam as Vendas (EDITÁVEL) -->
          <div id="tabelaEventosContainer" class="mt-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">Eventos que Influenciam as Vendas da Loja</h5>
              <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalEvento">
                <i class="bi bi-plus-circle"></i> Adicionar novo evento
              </button>
            </div>
            <div class="table-responsive">
              <table class="table table-bordered table-sm">
                <thead class="table-light">
                  <tr>
                    <th>Nome do Evento</th>
                    <th>AUMENTAM</th>
                    <th>DIMINUEM</th>
                    <th>JAN</th>
                    <th>FEV</th>
                    <th>MAR</th>
                    <th>ABR</th>
                    <th>MAI</th>
                    <th>JUN</th>
                    <th>JUL</th>
                    <th>AGO</th>
                    <th>SET</th>
                    <th>OUT</th>
                    <th>NOV</th>
                    <th>DEZ</th>
                  </tr>
                </thead>
                <tbody id="tabelaEventos">
                  {% if eventos_padrao %}
                    {% for evento in eventos_padrao %}
                    <tr>
                      <td>{{ evento.nome_evento }}</td>
                      <td class="text-center">
                        <input type="checkbox" class="form-check-input evento-aumenta-checkbox" 
                               data-event-id="{{ evento.id }}" {% if evento.aumenta_vendas %}checked{% endif %}>
                      </td>
                      <td class="text-center">
                        <input type="checkbox" class="form-check-input evento-diminui-checkbox" 
                               data-event-id="{{ evento.id }}" {% if evento.diminui_vendas %}checked{% endif %}>
                      </td>
                      {% for mes in range(1, 13) %}
                      <td class="text-center">
                        <input type="checkbox" class="form-check-input evento-mes-checkbox" 
                               data-event-id="{{ evento.id }}" data-month="{{ mes }}" 
                               {% if mes in (evento.meses_afetados or []) %}checked{% endif %}>
                      </td>
                      {% endfor %}
                    </tr>
                    {% endfor %}
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>

          <!-- Botão Salvar -->
          <div class="row mt-4">
            <div class="col-12 text-end">
              <button type="button" class="btn btn-secondary btn-lg" onclick="salvarImportanciaMeses()">
                <i class="bi bi-save"></i> Salvar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Adicionar Evento -->
<div class="modal fade" id="modalEvento" tabindex="-1" aria-labelledby="modalEventoLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-secondary text-white">
        <h5 class="modal-title" id="modalEventoLabel">Adicionar Novo Evento</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="formEvento">
          <div class="mb-3">
            <label for="eventoNome" class="form-label">Nome do Evento:</label>
            <input type="text" class="form-control" id="eventoNome" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Tipo de Impacto:</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="eventoAumenta">
              <label class="form-check-label" for="eventoAumenta">Aumentam vendas</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="eventoDiminui">
              <label class="form-check-label" for="eventoDiminui">Diminuem vendas</label>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Meses Afetados:</label>
            <div class="row">
              {% for mes_num, mes_nome in [
                (1, 'JAN'), (2, 'FEV'), (3, 'MAR'), (4, 'ABR'),
                (5, 'MAI'), (6, 'JUN'), (7, 'JUL'), (8, 'AGO'),
                (9, 'SET'), (10, 'OUT'), (11, 'NOV'), (12, 'DEZ')
              ] %}
              <div class="col-3 mb-2">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="mes{{ mes_num }}" value="{{ mes_num }}">
                  <label class="form-check-label" for="mes{{ mes_num }}">{{ mes_nome }}</label>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-secondary" id="btnSalvarEvento" onclick="if(typeof window.salvarEvento === 'function') { window.salvarEvento(); } else { console.error('window.salvarEvento não encontrado'); alert('Erro: Função não encontrada. Recarregue a página.'); } return false;">Salvar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// IMPORTANTE: Definir funções globais PRIMEIRO, antes de qualquer uso
window.salvarEvento = async function() {
    console.log('=== salvarEvento chamada ===');
    
    const nomeInput = document.getElementById('eventoNome');
    const aumentaInput = document.getElementById('eventoAumenta');
    const diminuiInput = document.getElementById('eventoDiminui');
    
    if (!nomeInput) {
        alert('Erro: Campo nome não encontrado.');
        console.error('Campo eventoNome não encontrado');
        return;
    }
    
    const nome = nomeInput.value.trim();
    const aumenta = aumentaInput ? aumentaInput.checked : false;
    const diminui = diminuiInput ? diminuiInput.checked : false;
    
    console.log('Valores capturados:', { nome, aumenta, diminui });
    
    if (!nome) {
        alert('Por favor, informe o nome do evento.');
        return;
    }
    
    if (!aumenta && !diminui) {
        alert('Por favor, marque pelo menos um tipo de impacto (Aumentam ou Diminuem vendas).');
        return;
    }
    
    const mesesAfetados = [];
    for (let i = 1; i <= 12; i++) {
        const checkbox = document.getElementById(`mes${i}`);
        if (checkbox && checkbox.checked) {
            mesesAfetados.push(i);
        }
    }
    
    console.log('Meses afetados:', mesesAfetados);
    
    try {
        const formData = new FormData();
        formData.append('nome_evento', nome);
        formData.append('aumenta_vendas', aumenta);
        formData.append('diminui_vendas', diminui);
        formData.append('meses_afetados', JSON.stringify(mesesAfetados));
        
        console.log('Enviando requisição para /importancia-meses/api/sales-event...');
        const response = await fetch('/importancia-meses/api/sales-event', {
            method: 'POST',
            body: formData
        });
        
        console.log('Resposta recebida:', response.status, response.statusText);
        
        const responseData = await response.json().catch(() => {
            console.error('Erro ao parsear JSON da resposta');
            return { error: 'Erro ao processar resposta do servidor' };
        });
        
        console.log('Dados da resposta:', responseData);
        
        // Verificar se a resposta foi bem-sucedida
        if (!response.ok) {
            const errorMsg = responseData.error || responseData.message || `Erro ${response.status}: ${response.statusText}`;
            console.error('Erro na resposta do servidor:', errorMsg);
            throw new Error(errorMsg);
        }
        
        // Verificar se o evento foi salvo com sucesso
        const sucesso = responseData.success === true || responseData.id !== undefined;
        console.log('Evento salvo com sucesso?', sucesso, 'responseData:', responseData);
        
        if (!sucesso) {
            throw new Error('Resposta do servidor não indica sucesso');
        }
        
        // Fechar modal
        const modalElement = document.getElementById('modalEvento');
        if (modalElement) {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
                console.log('Modal fechado');
            } else {
                // Tentar fechar manualmente se a instância não existir
                modalElement.classList.remove('show');
                modalElement.style.display = 'none';
                document.body.classList.remove('modal-open');
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) backdrop.remove();
                console.log('Modal fechado manualmente');
            }
        }
        
        // Limpar formulário
        const formEvento = document.getElementById('formEvento');
        if (formEvento) formEvento.reset();
        
        // Recarregar eventos do servidor para atualizar a lista
        console.log('Recarregando eventos após salvar...');
        await carregarEventos();
        
        // Mostrar mensagem de sucesso
        alert('Evento salvo com sucesso!');
    } catch (error) {
        console.error('Erro ao salvar evento:', error);
        alert('Erro ao salvar evento: ' + error.message);
    }
};

window.deletarEvento = async function(eventId) {
    if (!confirm('Tem certeza que deseja excluir este evento?')) {
        return;
    }
    
    try {
        const response = await fetch(`/importancia-meses/api/sales-event/${eventId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) throw new Error('Erro ao excluir evento');
        
        // Recarregar eventos
        await carregarEventos();
    } catch (error) {
        console.error('Erro ao excluir evento:', error);
        alert('Erro ao excluir evento. Tente novamente.');
    }
};

// Eventos padrão em hardcode
const EVENTOS_PADRAO_HARDCODE = [
    { id: 1, nome_evento: "Atividades agrícolas", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 2, nome_evento: "Carnaval", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 3, nome_evento: "Comemorações de fim-de-ano", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 4, nome_evento: "Comemorações e eventos religiosos", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 5, nome_evento: "Dia da Mulher", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 6, nome_evento: "Dia da Secretária", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 7, nome_evento: "Dia das Crianças", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 8, nome_evento: "Dia das Mães", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 9, nome_evento: "Dia dos Avós", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 10, nome_evento: "Dia dos Namorados", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 11, nome_evento: "Dia dos Pais", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 12, nome_evento: "Eventos esportivos", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 13, nome_evento: "Eventos folclóricos", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 14, nome_evento: "Festas Juninas", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 15, nome_evento: "Festas de peão (rodeios)", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 16, nome_evento: "Festivais, feiras e exposições", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 17, nome_evento: "Férias escolares/recessos", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 18, nome_evento: "Obras e empreendimentos particulares", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 19, nome_evento: "Obras públicas", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 20, nome_evento: "Períodos de muita chuva", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 21, nome_evento: "Períodos de muito calor", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true },
    { id: 22, nome_evento: "Volta às aulas", aumenta_vendas: false, diminui_vendas: false, meses_afetados: [], is_padrao: true }
];

// Flag para evitar listener duplicado do select
let selectListenerAdded = false;

// Configurar seleção de dado básico
function configurarSelectDadoBasico() {
    const select = document.getElementById('basicDataSelect');
    if (!select) return;
    
    // Adicionar listener apenas uma vez
    if (!selectListenerAdded) {
        selectListenerAdded = true;
        select.addEventListener('change', async function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                basicDataIdSelecionado = parseInt(selectedOption.value);
                anoAtual = parseInt(selectedOption.dataset.year);
                
                await carregarDadosBasicos();
                await carregarImportanciaMesesPorBasicData();
                await carregarEventos();
            } else {
                basicDataIdSelecionado = null;
                anoAtual = null;
                notasMeses = {};
            }
        });
    }
}

async function carregarDadosBasicos() {
    try {
        const response = await fetch('/importancia-meses/api/basic-data');
        if (!response.ok) throw new Error('Erro ao carregar dados básicos');
        
        const dados = await response.json();
        basicDataMap = {};
        
        // Carregar todos os dados básicos do ano selecionado
        dados.forEach(item => {
            if (item.year === anoAtual) {
                const key = `${item.year}-${String(item.month).padStart(2, '0')}`;
                basicDataMap[key] = item.clients_served;
            }
        });
    } catch (error) {
        console.error('Erro ao carregar dados básicos:', error);
    }
}

async function carregarImportanciaMesesPorBasicData() {
    if (!basicDataIdSelecionado) return;
    
    try {
        const response = await fetch(`/importancia-meses/api/basic-data/${basicDataIdSelecionado}/month-importance`);
        if (response.ok) {
            const meses = await response.json();
            notasMeses = {};
            meses.forEach(mes => {
                notasMeses[mes.month] = mes.nota_atribuida;
            });
        }
    } catch (error) {
        console.error('Erro ao carregar importância dos meses:', error);
        notasMeses = {};
    }
}

async function carregarEventos() {
    try {
        // Iniciar com eventos hardcode
        if (typeof EVENTOS_PADRAO_HARDCODE === 'undefined' || EVENTOS_PADRAO_HARDCODE.length === 0) {
            console.error('[carregarEventos] ERRO: EVENTOS_PADRAO_HARDCODE não está definido!');
            eventosList = [];
            return;
        }
        
        // Carregar eventos do servidor
        try {
            const response = await fetch('/importancia-meses/api/sales-events');
            if (response.ok) {
                const eventosServidor = await response.json();
                console.log(`[carregarEventos] Recebidos ${eventosServidor ? eventosServidor.length : 0} eventos do servidor`);
                
                if (Array.isArray(eventosServidor) && eventosServidor.length > 0) {
                    // Separar eventos padrão e customizados do servidor
                    const eventosPadraoServidor = eventosServidor.filter(e => e.is_padrao);
                    const eventosCustomizadosServidor = eventosServidor.filter(e => !e.is_padrao);
                    
                    // Criar map de eventos padrão do servidor por nome (lowercase)
                    const eventosPadraoServidorMap = new Map();
                    eventosPadraoServidor.forEach(e => eventosPadraoServidorMap.set(e.nome_evento.toLowerCase(), e));
                    
                    // Atualizar eventos hardcode com dados do servidor (se existirem)
                    eventosList = EVENTOS_PADRAO_HARDCODE.map(evento => {
                        const servidor = eventosPadraoServidorMap.get(evento.nome_evento.toLowerCase());
                        return servidor ? servidor : evento;
                    });
                    
                    // Adicionar eventos customizados do servidor (que não são padrão)
                    eventosCustomizadosServidor.forEach(evento => {
                        if (!eventosList.find(e => e.id === evento.id)) {
                            eventosList.push(evento);
                        }
                    });
                    
                    console.log(`[carregarEventos] Eventos mesclados: ${eventosList.length} total (${EVENTOS_PADRAO_HARDCODE.length} padrão + ${eventosCustomizadosServidor.length} customizados)`);
                } else {
                    // Nenhum evento no servidor, usar apenas hardcode
                    eventosList = [...EVENTOS_PADRAO_HARDCODE];
                    console.log('[carregarEventos] Nenhum evento no servidor, usando apenas hardcode');
                }
            } else {
                console.warn('[carregarEventos] Erro na resposta do servidor:', response.status);
                eventosList = [...EVENTOS_PADRAO_HARDCODE];
            }
        } catch (error) {
            console.warn('[carregarEventos] Erro ao carregar eventos do servidor (continuando com hardcode):', error);
            eventosList = [...EVENTOS_PADRAO_HARDCODE];
        }
        
        // Sempre renderizar após carregar (sobrescreve o HTML do Jinja2)
        console.log(`[carregarEventos] Renderizando ${eventosList.length} eventos na tabela...`);
        renderizarTabelaEventos();
    } catch (error) {
        console.error('[carregarEventos] Erro crítico:', error);
        // Garantir que pelo menos os eventos hardcode sejam carregados
        eventosList = [...EVENTOS_PADRAO_HARDCODE];
        renderizarTabelaEventos();
    }
}

// Funções removidas - tabela movida para tela principal

function calcularRitmoNegocio(notaAtual, notaAnterior) {
    if (notaAtual === null || notaAtual === undefined || notaAnterior === null || notaAnterior === undefined || notaAnterior === 0) {
        return null;
    }
    return (notaAtual / notaAnterior) * 100;
}

function calcularQuantidadeVendas(month, year, ritmo, quantidadeAnterior) {
    const key = `${year}-${String(month).padStart(2, '0')}`;
    
    // Se houver dados básicos, usar valor real
    if (basicDataMap[key] !== undefined) {
        return { real: basicDataMap[key], estimada: null };
    }
    
    // Se não houver, calcular estimativa
    if (ritmo !== null && quantidadeAnterior !== null) {
        const estimada = (ritmo / 100) * quantidadeAnterior;
        return { real: null, estimada: estimada };
    }
    
    return { real: null, estimada: null };
}

// Função removida - cálculos em tempo real não são mais necessários na tela de cadastro

function renderizarTabelaEventos() {
    // Tentar encontrar o elemento, com retry se não existir
    let tbody = document.getElementById('tabelaEventos');
    
    if (!tbody) {
        console.warn('[renderizarTabelaEventos] Elemento tabelaEventos não encontrado, tentando novamente em 100ms...');
        setTimeout(() => {
            renderizarTabelaEventos();
        }, 100);
        return;
    }
    
    // Se não houver eventos, usar hardcode
    if (!eventosList || eventosList.length === 0) {
        console.warn('[renderizarTabelaEventos] Lista vazia, usando eventos padrão em hardcode');
        if (typeof EVENTOS_PADRAO_HARDCODE !== 'undefined' && EVENTOS_PADRAO_HARDCODE.length > 0) {
            eventosList = [...EVENTOS_PADRAO_HARDCODE];
            console.log(`[renderizarTabelaEventos] Carregados ${eventosList.length} eventos do hardcode`);
        } else {
            console.error('[renderizarTabelaEventos] ERRO: EVENTOS_PADRAO_HARDCODE não está definido!');
            tbody.innerHTML = '<tr><td colspan="15" class="text-center text-danger">Erro: Eventos padrão não encontrados</td></tr>';
            return;
        }
    }
    
    console.log(`[renderizarTabelaEventos] Iniciando renderização de ${eventosList.length} eventos`);
    
    // Limpar tabela
    tbody.innerHTML = '';
    
    if (!eventosList || eventosList.length === 0) {
        console.error('[renderizarTabelaEventos] ERRO: eventosList ainda está vazio após tentar usar hardcode!');
        tbody.innerHTML = '<tr><td colspan="15" class="text-center text-danger">Erro: Nenhum evento para renderizar</td></tr>';
        return;
    }
    
    console.log(`[renderizarTabelaEventos] Renderizando ${eventosList.length} eventos`);
    eventosList.forEach(evento => {
        const tr = document.createElement('tr');
        const mesesAfetados = evento.meses_afetados || [];
        
        let mesesCells = '';
        for (let i = 1; i <= 12; i++) {
            const checked = mesesAfetados.includes(i) ? 'checked' : '';
            mesesCells += `
                <td class="text-center">
                    <input type="checkbox" class="form-check-input evento-mes-checkbox" 
                           data-event-id="${evento.id}" data-month="${i}" ${checked}>
                </td>
            `;
        }
        
        tr.innerHTML = `
            <td>${evento.nome_evento}</td>
            <td class="text-center">
                <input type="checkbox" class="form-check-input evento-aumenta-checkbox" 
                       data-event-id="${evento.id}" ${evento.aumenta_vendas ? 'checked' : ''}>
            </td>
            <td class="text-center">
                <input type="checkbox" class="form-check-input evento-diminui-checkbox" 
                       data-event-id="${evento.id}" ${evento.diminui_vendas ? 'checked' : ''}>
            </td>
            ${mesesCells}
        `;
        tbody.appendChild(tr);
    });
    
    console.log(`[renderizarTabelaEventos] Renderização concluída: ${eventosList.length} eventos exibidos`);
}

// Funções globais já definidas no início do script - não duplicar aqui

async function salvarImportanciaMeses() {
    if (!basicDataIdSelecionado) {
        alert('Por favor, selecione um dado básico.');
        return;
    }
    
    if (!anoAtual) {
        alert('Erro: Ano não identificado.');
        return;
    }
    
    // Coletar dados dos meses (usando dados já carregados, pois a tabela foi movida para tela principal)
    const meses = [];
    for (let month = 1; month <= 12; month++) {
        const nota = notasMeses[month] !== undefined ? notasMeses[month] : null;
        meses.push({ month: month, nota_atribuida: nota });
    }
    
    // Coletar dados dos eventos
    const eventos = [];
    eventosList.forEach(evento => {
        const aumentaCheckbox = document.querySelector(`.evento-aumenta-checkbox[data-event-id="${evento.id}"]`);
        const diminuiCheckbox = document.querySelector(`.evento-diminui-checkbox[data-event-id="${evento.id}"]`);
        const mesesAfetados = [];
        
        for (let i = 1; i <= 12; i++) {
            const checkbox = document.querySelector(`.evento-mes-checkbox[data-event-id="${evento.id}"][data-month="${i}"]`);
            if (checkbox && checkbox.checked) {
                mesesAfetados.push(i);
            }
        }
        
        eventos.push({
            id: evento.id,
            aumenta_vendas: aumentaCheckbox ? aumentaCheckbox.checked : false,
            diminui_vendas: diminuiCheckbox ? diminuiCheckbox.checked : false,
            meses_afetados: mesesAfetados
        });
    });
    
    try {
        const formData = new FormData();
        formData.append('basic_data_id', basicDataIdSelecionado);
        formData.append('meses_data', JSON.stringify(meses));
        formData.append('eventos_data', JSON.stringify(eventos));
        
        const response = await fetch('/importancia-meses/api/save', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) throw new Error('Erro ao salvar dados');
        
        const result = await response.json();
        if (result.success) {
            alert('Dados salvos com sucesso!');
            window.location.href = '/importancia-meses';
        }
    } catch (error) {
        console.error('Erro ao salvar:', error);
        alert('Erro ao salvar dados. Tente novamente.');
    }
}

// Função para carregar eventos imediatamente (sem async se não necessário)
function carregarEventosInmediatamente() {
    try {
        console.log('[carregarEventosInmediatamente] Carregando eventos hardcode...');
        
        // Garantir que eventosList tenha os eventos hardcode
        if (!eventosList || eventosList.length === 0) {
            if (typeof EVENTOS_PADRAO_HARDCODE !== 'undefined' && EVENTOS_PADRAO_HARDCODE.length > 0) {
                eventosList = [...EVENTOS_PADRAO_HARDCODE];
                console.log(`[carregarEventosInmediatamente] Carregados ${eventosList.length} eventos do hardcode`);
            } else {
                console.error('[carregarEventosInmediatamente] ERRO: EVENTOS_PADRAO_HARDCODE não definido!');
                return;
            }
        }
        
        // Renderizar imediatamente
        renderizarTabelaEventos();
    } catch (error) {
        console.error('[carregarEventosInmediatamente] Erro:', error);
    }
}

// Renderizar eventos imediatamente quando o script carrega (se DOM já estiver pronto)
(function() {
    console.log('[IIFE] Script carregado, verificando se pode renderizar eventos...');
    console.log('[IIFE] EVENTOS_PADRAO_HARDCODE definido?', typeof EVENTOS_PADRAO_HARDCODE !== 'undefined');
    console.log('[IIFE] EVENTOS_PADRAO_HARDCODE length:', typeof EVENTOS_PADRAO_HARDCODE !== 'undefined' ? EVENTOS_PADRAO_HARDCODE.length : 'N/A');
    
    function tentarRenderizar() {
        console.log('[tentarRenderizar] Tentando renderizar eventos...');
        console.log('[tentarRenderizar] eventosList:', eventosList);
        console.log('[tentarRenderizar] renderizarTabelaEventos definido?', typeof renderizarTabelaEventos === 'function');
        
        if (typeof EVENTOS_PADRAO_HARDCODE !== 'undefined' && EVENTOS_PADRAO_HARDCODE.length > 0) {
            if (typeof eventosList !== 'undefined') {
                eventosList = [...EVENTOS_PADRAO_HARDCODE];
                console.log('[tentarRenderizar] eventosList preenchido com', eventosList.length, 'eventos');
            }
            if (typeof renderizarTabelaEventos === 'function') {
                console.log('[tentarRenderizar] Chamando renderizarTabelaEventos()...');
                renderizarTabelaEventos();
            } else {
                console.error('[tentarRenderizar] renderizarTabelaEventos não é uma função!');
            }
        } else {
            console.error('[tentarRenderizar] EVENTOS_PADRAO_HARDCODE não está definido ou está vazio!');
        }
    }
    
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(tentarRenderizar, 50);
        setTimeout(tentarRenderizar, 200);
        setTimeout(tentarRenderizar, 500);
    }
})();

// Função de inicialização segura
function inicializarTela() {
    try {
        console.log('[inicializarTela] Iniciando configuração da tela...');
        configurarSelectDadoBasico();
        
        // Carregar eventos imediatamente (hardcode primeiro)
        carregarEventosInmediatamente();
        
        // Depois tentar carregar do servidor
        carregarEventos();
        
        console.log('[inicializarTela] Inicialização concluída');
    } catch (error) {
        console.error('[inicializarTela] Erro na inicialização:', error);
        // Tentar novamente após um delay
        setTimeout(() => {
            console.log('[inicializarTela] Tentando reinicializar...');
            inicializarTela();
        }, 500);
    }
}

// Renderizar eventos imediatamente (função simples e direta)
function renderizarEventosAgora() {
    console.log('=== INICIANDO RENDERIZAÇÃO DE EVENTOS ===');
    
    const tbody = document.getElementById('tabelaEventos');
    if (!tbody) {
        console.error('ERRO: Elemento tabelaEventos não encontrado!');
        setTimeout(renderizarEventosAgora, 100);
        return;
    }
    
    console.log('Elemento tabelaEventos encontrado:', tbody);
    
    // Garantir que eventosList tenha os eventos hardcode
    if (!eventosList || eventosList.length === 0) {
        if (typeof EVENTOS_PADRAO_HARDCODE !== 'undefined' && EVENTOS_PADRAO_HARDCODE.length > 0) {
            eventosList = [...EVENTOS_PADRAO_HARDCODE];
            console.log('Eventos hardcode carregados:', eventosList.length);
        } else {
            console.error('ERRO: EVENTOS_PADRAO_HARDCODE não está definido!');
            tbody.innerHTML = '<tr><td colspan="15" class="text-center text-danger">Erro: Eventos padrão não encontrados</td></tr>';
            return;
        }
    }
    
    console.log('Renderizando', eventosList.length, 'eventos...');
    
    // Limpar tabela
    tbody.innerHTML = '';
    
    // Renderizar cada evento
    eventosList.forEach((evento, index) => {
        console.log(`Renderizando evento ${index + 1}:`, evento.nome_evento);
        const tr = document.createElement('tr');
        const mesesAfetados = evento.meses_afetados || [];
        
        let mesesCells = '';
        for (let i = 1; i <= 12; i++) {
            const checked = mesesAfetados.includes(i) ? 'checked' : '';
            mesesCells += `<td class="text-center"><input type="checkbox" class="form-check-input evento-mes-checkbox" data-event-id="${evento.id}" data-month="${i}" ${checked}></td>`;
        }
        
        tr.innerHTML = `
            <td>${evento.nome_evento}</td>
            <td class="text-center"><input type="checkbox" class="form-check-input evento-aumenta-checkbox" data-event-id="${evento.id}" ${evento.aumenta_vendas ? 'checked' : ''}></td>
            <td class="text-center"><input type="checkbox" class="form-check-input evento-diminui-checkbox" data-event-id="${evento.id}" ${evento.diminui_vendas ? 'checked' : ''}></td>
            ${mesesCells}
        `;
        tbody.appendChild(tr);
    });
    
    console.log('=== RENDERIZAÇÃO CONCLUÍDA ===');
}

// Flag para evitar listeners duplicados
let modalListenerAdded = false;

// Configurar event listeners para botões (apenas resetar form quando modal abrir)
function configurarEventListeners() {
    console.log('[configurarEventListeners] Configurando listeners...');
    
    // Resetar form quando modal for aberto (adicionar apenas uma vez)
    if (!modalListenerAdded) {
        const modalEvento = document.getElementById('modalEvento');
        if (modalEvento) {
            modalListenerAdded = true;
            modalEvento.addEventListener('show.bs.modal', function() {
                console.log('[configurarEventListeners] Modal sendo aberto, resetando formulário');
                const formEvento = document.getElementById('formEvento');
                if (formEvento) {
                    formEvento.reset();
                }
            });
            console.log('[configurarEventListeners] Listener do modal adicionado');
        }
    } else {
        console.log('[configurarEventListeners] Listener do modal já foi adicionado anteriormente');
    }
}

// Inicializar quando o DOM estiver pronto
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded disparado');
        configurarEventListeners();
        inicializarTela();
        setTimeout(renderizarEventosAgora, 50);
    });
} else {
    // DOM já está pronto
    console.log('DOM já está pronto');
    configurarEventListeners();
    inicializarTela();
    setTimeout(renderizarEventosAgora, 50);
}

// Garantir que eventos sejam renderizados mesmo se houver algum problema
setTimeout(renderizarEventosAgora, 100);
setTimeout(renderizarEventosAgora, 300);
setTimeout(renderizarEventosAgora, 500);
setTimeout(renderizarEventosAgora, 1000);
</script>
{% endblock %}

