{% extends "base.html" %}

{% block title %}Gestão de Prioridades - GetUp Gestão{% endblock %}

{% block extra_css %}
<style>
    .navbar {
        z-index: 1000;
        display: flex !important;
        visibility: visible !important;
    }

    .help-icon {
        cursor: pointer;
        margin-left: 5px;
        opacity: 0.7;
        transition: opacity 0.3s ease;
    }

    .help-icon:hover {
        opacity: 1;
    }

    .modal {
        z-index: 1050;
    }

    .custom-bg {
        background-color: #f8f9fa;
    }
    
    .metric-card {
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        background-color: white;
        padding: 15px;
    }

    .metric-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .metric-values {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-bottom: 15px;
    }

    .value-box {
        padding: 8px;
        border-radius: 6px;
        background-color: #f8f9fa;
    }

    .value-box label {
        font-size: 0.8rem;
        color: #666;
        margin-bottom: 4px;
    }

    .value-box input {
        width: 100%;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 6px;
        text-align: right;
    }

    .control-box {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .control-box input {
        flex: 1;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 6px;
    }

    .btn-control {
        padding: 6px 12px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    .period-selector {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 30px;
    }

    .positive-variation {
        color: #28a745;
        background-color: #d4edda;
    }

    .negative-variation {
        color: #dc3545;
        background-color: #f8d7da;
    }

    @media (min-width: 768px) {
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
    }

    @media (min-width: 1200px) {
        .metrics-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    
    /* Modal styles */
    .modal-no-backdrop {
        background-color: rgba(0, 0, 0, 0.1);
    }
    
    .modal-no-backdrop .modal-dialog {
        margin-top: 20px;
    }
    
    .modal-backdrop {
        display: none !important;
    }
    
    body.modal-open {
        overflow: auto !important;
        padding-right: 0 !important;
    }
    
    .modal-open .container-fluid,
    .modal-open .card,
    .modal-open .form-control,
    .modal-open .btn,
    .modal-open .help-icon {
        pointer-events: auto !important;
    }

    .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }
</style>
{% endblock %}

{% block content %}
    {% include "components/navbar.html" %}
    <div class="container-fluid p-3">
        <!-- Period Selector -->
        <div class="period-selector">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <label for="basicDataSelect" class="form-label d-flex align-items-center">
                        <span>Período dos dados básicos</span>
                        <i class="bi bi-question-circle-fill ms-2 text-primary help-icon" 
                           data-bs-toggle="modal" 
                           data-bs-target="#helpModal"></i>
                    </label>
                    <select class="form-select" id="basicDataSelect">
                        {% for data in basic_data_list %}
                        <option value="{{ data.id }}" {% if data.is_current %}selected{% endif %}>
                            {{ data.month }}/{{ data.year }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 text-end">
                    <button id="resetButton" class="btn btn-primary" onclick="window.location.reload()">
                        <i class="bi bi-arrow-counterclockwise me-2"></i>Reiniciar
                    </button>
                </div>
            </div>
        </div>

        <!-- Metrics Grid -->
        <div class="metrics-grid">
            <!-- Margem -->
            <div class="metric-card">
                <div class="metric-title">
                    <span>Margem</span>
                    <i class="bi bi-question-circle-fill text-primary help-icon" 
                       data-bs-toggle="modal" 
                       data-bs-target="#margemHelpModal"></i>
                </div>
                <div class="metric-values">
                    <div class="value-box">
                        <label>Original</label>
                        <input type="text" id="margemOriginal" readonly>
                    </div>
                    <div class="value-box">
                        <label>Calculado</label>
                        <input type="text" id="margemCalculado" readonly>
                    </div>
                    <div class="value-box">
                        <label>Variação</label>
                        <input type="text" id="margemVariacao" readonly>
                    </div>
                </div>
            </div>

            <!-- Clientes -->
            <div class="metric-card">
                <div class="metric-title">
                    <span>Clientes Atendidos</span>
                    <i class="bi bi-question-circle-fill text-primary help-icon" 
                       data-bs-toggle="modal" 
                       data-bs-target="#clientesHelpModal"></i>
                </div>
                <div class="metric-values">
                    <div class="value-box">
                        <label>Original</label>
                        <input type="text" id="clientesOriginal" readonly>
                    </div>
                    <div class="value-box">
                        <label>Calculado</label>
                        <input type="text" id="clientesCalculado" readonly>
                    </div>
                    <div class="value-box">
                        <label>Variação</label>
                        <input type="text" id="clientesVariacao" readonly>
                    </div>
                </div>
                <div class="control-box">
                    <input type="text" id="clientesManual" placeholder="Digite a variação %" class="form-control">
                    <button class="btn btn-success btn-control" type="button" data-metric="clientes" data-action="increase">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                    <button class="btn btn-danger btn-control" type="button" data-metric="clientes" data-action="decrease">
                        <i class="bi bi-dash-circle"></i>
                    </button>
                </div>
            </div>

            <!-- Preço Médio -->
            <div class="metric-card">
                <div class="metric-title">
                    <span>Preço Médio</span>
                    <i class="bi bi-question-circle-fill text-primary help-icon" 
                       data-bs-toggle="modal" 
                       data-bs-target="#precoMedioHelpModal"></i>
                </div>
                <div class="metric-values">
                    <div class="value-box">
                        <label>Original</label>
                        <input type="text" id="precoMedioOriginal" readonly>
                    </div>
                    <div class="value-box">
                        <label>Calculado</label>
                        <input type="text" id="precoMedioCalculado" readonly>
                    </div>
                    <div class="value-box">
                        <label>Variação</label>
                        <input type="text" id="precoMedioVariacao" readonly>
                    </div>
                </div>
                <div class="control-box">
                    <input type="text" id="precoMedioManual" placeholder="Digite a variação %" class="form-control">
                    <button class="btn btn-success btn-control" type="button" data-metric="precoMedio" data-action="increase">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                    <button class="btn btn-danger btn-control" type="button" data-metric="precoMedio" data-action="decrease">
                        <i class="bi bi-dash-circle"></i>
                    </button>
                </div>
            </div>

            <!-- Ticket Médio -->
            <div class="metric-card">
                <div class="metric-title">
                    <span>Ticket Médio</span>
                    <i class="bi bi-question-circle-fill text-primary help-icon" 
                       data-bs-toggle="modal" 
                       data-bs-target="#ticketMedioHelpModal"></i>
                </div>
                <div class="metric-values">
                    <div class="value-box">
                        <label>Original</label>
                        <input type="text" id="ticketMedioOriginal" readonly>
                    </div>
                    <div class="value-box">
                        <label>Calculado</label>
                        <input type="text" id="ticketMedioCalculado" readonly>
                    </div>
                    <div class="value-box">
                        <label>Variação</label>
                        <input type="text" id="ticketMedioVariacao" readonly>
                    </div>
                </div>
                <div class="control-box">
                    <input type="text" id="ticketMedioManual" placeholder="Digite a variação %" class="form-control">
                    <button class="btn btn-success btn-control" type="button" data-metric="ticketMedio" data-action="increase">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                    <button class="btn btn-danger btn-control" type="button" data-metric="ticketMedio" data-action="decrease">
                        <i class="bi bi-dash-circle"></i>
                    </button>
                </div>
            </div>

            <!-- Faturamento -->
            <div class="metric-card">
                <div class="metric-title">
                    <span>Faturamento</span>
                    <i class="bi bi-question-circle-fill text-primary help-icon" 
                       data-bs-toggle="modal" 
                       data-bs-target="#faturamentoHelpModal"></i>
                </div>
                <div class="metric-values">
                    <div class="value-box">
                        <label>Original</label>
                        <input type="text" id="faturamentoOriginal" readonly>
                    </div>
                    <div class="value-box">
                        <label>Calculado</label>
                        <input type="text" id="faturamentoCalculado" readonly>
                    </div>
                    <div class="value-box">
                        <label>Variação</label>
                        <input type="text" id="faturamentoVariacao" readonly>
                    </div>
                </div>
                <div class="control-box">
                    <input type="text" id="faturamentoManual" placeholder="Digite a variação %" class="form-control">
                    <button class="btn btn-success btn-control" type="button" data-metric="faturamento" data-action="increase">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                    <button class="btn btn-danger btn-control" type="button" data-metric="faturamento" data-action="decrease">
                        <i class="bi bi-dash-circle"></i>
                    </button>
                </div>
            </div>

            <!-- Custos de Vendas -->
            <div class="metric-card">
                <div class="metric-title">
                    <span>Custos de Vendas</span>
                    <i class="bi bi-question-circle-fill text-primary help-icon" 
                       data-bs-toggle="modal" 
                       data-bs-target="#custosVendasHelpModal"></i>
                </div>
                <div class="metric-values">
                    <div class="value-box">
                        <label>Original</label>
                        <input type="text" id="custosVendasOriginal" readonly>
                    </div>
                    <div class="value-box">
                        <label>Calculado</label>
                        <input type="text" id="custosVendasCalculado" readonly>
                    </div>
                    <div class="value-box">
                        <label>Variação</label>
                        <input type="text" id="custosVendasVariacao" readonly>
                    </div>
                </div>
                <div class="control-box">
                    <input type="text" id="custosVendasManual" placeholder="Digite a variação %" class="form-control">
                    <button class="btn btn-success btn-control" type="button" data-metric="custosVendas" data-action="increase">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                    <button class="btn btn-danger btn-control" type="button" data-metric="custosVendas" data-action="decrease">
                        <i class="bi bi-dash-circle"></i>
                    </button>
                </div>
            </div>

            <!-- Custos de Insumos -->
            <div class="metric-card">
                <div class="metric-title">
                    <span>Custos de Insumos</span>
                    <i class="bi bi-question-circle-fill text-primary help-icon" 
                       data-bs-toggle="modal" 
                       data-bs-target="#custosInsumosHelpModal"></i>
                </div>
                <div class="metric-values">
                    <div class="value-box">
                        <label>Original</label>
                        <input type="text" id="custosInsumosOriginal" readonly>
                    </div>
                    <div class="value-box">
                        <label>Calculado</label>
                        <input type="text" id="custosInsumosCalculado" readonly>
                    </div>
                    <div class="value-box">
                        <label>Variação</label>
                        <input type="text" id="custosInsumosVariacao" readonly>
                    </div>
                </div>
                <div class="control-box">
                    <input type="text" id="custosInsumosManual" placeholder="Digite a variação %" class="form-control">
                    <button class="btn btn-success btn-control" type="button" data-metric="custosInsumos" data-action="increase">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                    <button class="btn btn-danger btn-control" type="button" data-metric="custosInsumos" data-action="decrease">
                        <i class="bi bi-dash-circle"></i>
                    </button>
                </div>
            </div>

            <!-- Custos Fixos -->
            <div class="metric-card">
                <div class="metric-title">
                    <span>Custos Fixos</span>
                    <i class="bi bi-question-circle-fill text-primary help-icon" 
                       data-bs-toggle="modal" 
                       data-bs-target="#custosFixosHelpModal"></i>
                </div>
                <div class="metric-values">
                    <div class="value-box">
                        <label>Original</label>
                        <input type="text" id="custosFixosOriginal" readonly>
                    </div>
                    <div class="value-box">
                        <label>Calculado</label>
                        <input type="text" id="custosFixosCalculado" readonly>
                    </div>
                    <div class="value-box">
                        <label>Variação</label>
                        <input type="text" id="custosFixosVariacao" readonly>
                    </div>
                </div>
                <div class="control-box">
                    <input type="text" id="custosFixosManual" placeholder="Digite a variação %" class="form-control">
                    <button class="btn btn-success btn-control" type="button" data-metric="custosFixos" data-action="increase">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                    <button class="btn btn-danger btn-control" type="button" data-metric="custosFixos" data-action="decrease">
                        <i class="bi bi-dash-circle"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ajuda -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content custom-bg">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel">Como usar a Gestão de Prioridades</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Esta ferramenta permite que você simule diferentes cenários para o seu negócio, baseado nos dados básicos que você já cadastrou.</p>
                    <ul>
                        <li>Selecione um período de dados básicos para análise</li>
                        <li>Defina um percentual de variação para simular diferentes cenários</li>
                        <li>Visualize os impactos das variações em diferentes métricas do negócio</li>
                        <li>Compare os valores originais com os valores calculados após as variações</li>
                        <li>Analise as variações percentuais em cada métrica</li>
                    </ul>
                    <p>Use esta ferramenta para tomar decisões baseadas em diferentes cenários e planejar ações para melhorar os resultados do seu negócio.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ajuda - Margem -->
    <div class="modal fade" id="margemHelpModal" tabindex="-1" aria-labelledby="margemHelpModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content custom-bg">
                <div class="modal-header">
                    <h5 class="modal-title" id="margemHelpModalLabel">Margem</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>A <strong>Margem</strong> representa a porcentagem de lucro em relação ao faturamento total.</p>
                    <p>Esta métrica é calculada automaticamente com base nos valores de faturamento e custos.</p>
                    <p>Os campos exibidos são:</p>
                    <ul>
                        <li><strong>Original:</strong> Valor da margem conforme os dados básicos selecionados</li>
                        <li><strong>Calculado:</strong> Valor da margem após as variações aplicadas</li>
                        <li><strong>Variação:</strong> Percentual de alteração entre o valor original e o calculado</li>
                    </ul>
                    <p>A cor de fundo do campo "Calculado" muda para verde quando a margem aumenta e para vermelho quando diminui.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ajuda - Clientes -->
    <div class="modal fade" id="clientesHelpModal" tabindex="-1" aria-labelledby="clientesHelpModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content custom-bg">
                <div class="modal-header">
                    <h5 class="modal-title" id="clientesHelpModalLabel">Clientes Atendidos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Os <strong>Clientes Atendidos</strong> representam o número total de clientes atendidos no período.</p>
                    <p>Para simular variações:</p>
                    <ol>
                        <li>Digite um percentual no campo de entrada</li>
                        <li>Clique no botão <i class="bi bi-plus-circle text-success"></i> para aumentar o número de clientes</li>
                        <li>Clique no botão <i class="bi bi-dash-circle text-danger"></i> para diminuir o número de clientes</li>
                    </ol>
                    <p>Os campos exibidos são:</p>
                    <ul>
                        <li><strong>Original:</strong> Número de clientes conforme os dados básicos selecionados</li>
                        <li><strong>Calculado:</strong> Número de clientes após a variação aplicada</li>
                        <li><strong>Variação:</strong> Percentual de alteração entre o valor original e o calculado</li>
                        <li><strong>Manual:</strong> Campo para digitar o percentual de variação desejado</li>
                    </ul>
                    <p>A cor de fundo do campo "Calculado" muda para verde quando o número de clientes aumenta e para vermelho quando diminui.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ajuda - Preço Médio -->
    <div class="modal fade" id="precoMedioHelpModal" tabindex="-1" aria-labelledby="precoMedioHelpModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content custom-bg">
                <div class="modal-header">
                    <h5 class="modal-title" id="precoMedioHelpModalLabel">Preço Médio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>O <strong>Preço Médio</strong> representa o valor médio cobrado por cliente.</p>
                    <p>Para simular variações:</p>
                    <ol>
                        <li>Digite um percentual no campo de entrada</li>
                        <li>Clique no botão <i class="bi bi-plus-circle text-success"></i> para aumentar o preço médio</li>
                        <li>Clique no botão <i class="bi bi-dash-circle text-danger"></i> para diminuir o preço médio</li>
                    </ol>
                    <p>Os campos exibidos são:</p>
                    <ul>
                        <li><strong>Original:</strong> Preço médio conforme os dados básicos selecionados</li>
                        <li><strong>Calculado:</strong> Preço médio após a variação aplicada</li>
                        <li><strong>Variação:</strong> Percentual de alteração entre o valor original e o calculado</li>
                        <li><strong>Manual:</strong> Campo para digitar o percentual de variação desejado</li>
                    </ul>
                    <p>A cor de fundo do campo "Calculado" muda para verde quando o preço médio aumenta e para vermelho quando diminui.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ajuda - Ticket Médio -->
    <div class="modal fade" id="ticketMedioHelpModal" tabindex="-1" aria-labelledby="ticketMedioHelpModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content custom-bg">
                <div class="modal-header">
                    <h5 class="modal-title" id="ticketMedioHelpModalLabel">Ticket Médio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>O <strong>Ticket Médio</strong> representa o valor médio gasto por cliente.</p>
                    <p>Para simular variações:</p>
                    <ol>
                        <li>Digite um percentual no campo de entrada</li>
                        <li>Clique no botão <i class="bi bi-plus-circle text-success"></i> para aumentar o ticket médio</li>
                        <li>Clique no botão <i class="bi bi-dash-circle text-danger"></i> para diminuir o ticket médio</li>
                    </ol>
                    <p>Os campos exibidos são:</p>
                    <ul>
                        <li><strong>Original:</strong> Ticket médio conforme os dados básicos selecionados</li>
                        <li><strong>Calculado:</strong> Ticket médio após a variação aplicada</li>
                        <li><strong>Variação:</strong> Percentual de alteração entre o valor original e o calculado</li>
                        <li><strong>Manual:</strong> Campo para digitar o percentual de variação desejado</li>
                    </ul>
                    <p>A cor de fundo do campo "Calculado" muda para verde quando o ticket médio aumenta e para vermelho quando diminui.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ajuda - Faturamento -->
    <div class="modal fade" id="faturamentoHelpModal" tabindex="-1" aria-labelledby="faturamentoHelpModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content custom-bg">
                <div class="modal-header">
                    <h5 class="modal-title" id="faturamentoHelpModalLabel">Faturamento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>O <strong>Faturamento</strong> representa a receita total de vendas.</p>
                    <p>Para simular variações:</p>
                    <ol>
                        <li>Digite um percentual no campo de entrada</li>
                        <li>Clique no botão <i class="bi bi-plus-circle text-success"></i> para aumentar o faturamento</li>
                        <li>Clique no botão <i class="bi bi-dash-circle text-danger"></i> para diminuir o faturamento</li>
                    </ol>
                    <p>Os campos exibidos são:</p>
                    <ul>
                        <li><strong>Original:</strong> Faturamento conforme os dados básicos selecionados</li>
                        <li><strong>Calculado:</strong> Faturamento após a variação aplicada</li>
                        <li><strong>Variação:</strong> Percentual de alteração entre o valor original e o calculado</li>
                        <li><strong>Manual:</strong> Campo para digitar o percentual de variação desejado</li>
                    </ul>
                    <p>A cor de fundo do campo "Calculado" muda para verde quando o faturamento aumenta e para vermelho quando diminui.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ajuda - Custos de Vendas -->
    <div class="modal fade" id="custosVendasHelpModal" tabindex="-1" aria-labelledby="custosVendasHelpModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content custom-bg">
                <div class="modal-header">
                    <h5 class="modal-title" id="custosVendasHelpModalLabel">Custos de Vendas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Os <strong>Custos de Vendas</strong> representam as despesas relacionadas às vendas, como comissões, marketing, etc.</p>
                    <p>Para simular variações:</p>
                    <ol>
                        <li>Digite um percentual no campo de entrada</li>
                        <li>Clique no botão <i class="bi bi-plus-circle text-success"></i> para aumentar os custos de vendas</li>
                        <li>Clique no botão <i class="bi bi-dash-circle text-danger"></i> para diminuir os custos de vendas</li>
                    </ol>
                    <p>Os campos exibidos são:</p>
                    <ul>
                        <li><strong>Original:</strong> Custos de vendas conforme os dados básicos selecionados</li>
                        <li><strong>Calculado:</strong> Custos de vendas após a variação aplicada</li>
                        <li><strong>Variação:</strong> Percentual de alteração entre o valor original e o calculado</li>
                        <li><strong>Manual:</strong> Campo para digitar o percentual de variação desejado</li>
                    </ul>
                    <p>A cor de fundo do campo "Calculado" muda para vermelho quando os custos de vendas aumentam e para verde quando diminuem.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ajuda - Custos de Insumos -->
    <div class="modal fade" id="custosInsumosHelpModal" tabindex="-1" aria-labelledby="custosInsumosHelpModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content custom-bg">
                <div class="modal-header">
                    <h5 class="modal-title" id="custosInsumosHelpModalLabel">Custos de Insumos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Os <strong>Custos de Insumos</strong> representam as despesas com materiais, produtos ou serviços necessários para a operação.</p>
                    <p>Para simular variações:</p>
                    <ol>
                        <li>Digite um percentual no campo de entrada</li>
                        <li>Clique no botão <i class="bi bi-plus-circle text-success"></i> para aumentar os custos de insumos</li>
                        <li>Clique no botão <i class="bi bi-dash-circle text-danger"></i> para diminuir os custos de insumos</li>
                    </ol>
                    <p>Os campos exibidos são:</p>
                    <ul>
                        <li><strong>Original:</strong> Custos de insumos conforme os dados básicos selecionados</li>
                        <li><strong>Calculado:</strong> Custos de insumos após a variação aplicada</li>
                        <li><strong>Variação:</strong> Percentual de alteração entre o valor original e o calculado</li>
                        <li><strong>Manual:</strong> Campo para digitar o percentual de variação desejado</li>
                    </ul>
                    <p>A cor de fundo do campo "Calculado" muda para vermelho quando os custos de insumos aumentam e para verde quando diminuem.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ajuda - Custos Fixos -->
    <div class="modal fade" id="custosFixosHelpModal" tabindex="-1" aria-labelledby="custosFixosHelpModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content custom-bg">
                <div class="modal-header">
                    <h5 class="modal-title" id="custosFixosHelpModalLabel">Custos Fixos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Os <strong>Custos Fixos</strong> representam as despesas que não variam com o volume de vendas, como aluguel, salários administrativos, etc.</p>
                    <p>Para simular variações:</p>
                    <ol>
                        <li>Digite um percentual no campo de entrada</li>
                        <li>Clique no botão <i class="bi bi-plus-circle text-success"></i> para aumentar os custos fixos</li>
                        <li>Clique no botão <i class="bi bi-dash-circle text-danger"></i> para diminuir os custos fixos</li>
                    </ol>
                    <p>Os campos exibidos são:</p>
                    <ul>
                        <li><strong>Original:</strong> Custos fixos conforme os dados básicos selecionados</li>
                        <li><strong>Calculado:</strong> Custos fixos após a variação aplicada</li>
                        <li><strong>Variação:</strong> Percentual de alteração entre o valor original e o calculado</li>
                        <li><strong>Manual:</strong> Campo para digitar o percentual de variação desejado</li>
                    </ul>
                    <p>A cor de fundo do campo "Calculado" muda para vermelho quando os custos fixos aumentam e para verde quando diminuem.</p>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Função para formatar valores monetários
    function formatMoney(value) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value);
    }

    // Função para formatar percentuais
    function formatPercent(value) {
        return value.toFixed(2) + '%';
    }

    // Função para calcular a variação percentual
    function calculateVariation(original, calculated) {
        if (original === 0) return 0;
        return ((calculated - original) / original) * 100;
    }
    
    // Função para limpar qualquer backdrop residual
    function clearModalBackdrop() {
        // Remover qualquer backdrop residual
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => {
            backdrop.parentNode.removeChild(backdrop);
        });
        
        // Remover classes que o Bootstrap adiciona ao body
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');
    }
    
    // Limpar qualquer backdrop residual ao carregar a página
    clearModalBackdrop();
    
    // Inicializar todas as modais de ajuda com backdrop: false
    document.querySelectorAll('.help-icon').forEach(icon => {
        icon.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const targetModalId = this.getAttribute('data-bs-target');
            const modalElement = document.querySelector(targetModalId);
            
            if (modalElement) {
                // Configurar a modal para não ter backdrop
                const modalOptions = {
                    backdrop: false,
                    keyboard: true
                };
                
                // Inicializar a modal com as opções
                const modal = new bootstrap.Modal(modalElement, modalOptions);
                
                // Adicionar classe para estilo personalizado
                modalElement.classList.add('modal-no-backdrop');
                
                // Mostrar a modal
                modal.show();
                
                // Garantir que o body não tenha a classe modal-open
                document.body.classList.remove('modal-open');
                document.body.style.removeProperty('padding-right');
                
                // Adicionar evento para fechar a modal ao clicar fora
                modalElement.addEventListener('click', function(event) {
                    if (event.target === modalElement) {
                        modal.hide();
                    }
                });
                
                // Adicionar evento para limpar a classe ao fechar
                modalElement.addEventListener('hidden.bs.modal', function() {
                    modalElement.classList.remove('modal-no-backdrop');
                    clearModalBackdrop();
                });
                
                // Adicionar evento para garantir que o body não tenha a classe modal-open
                modalElement.addEventListener('shown.bs.modal', function() {
                    document.body.classList.remove('modal-open');
                    document.body.style.removeProperty('padding-right');
                });
            }
        });
    });

    // Event listeners para os botões de aplicar percentual em cada métrica
    document.querySelectorAll('button[data-metric]').forEach(button => {
        button.addEventListener('click', function() {
            const metric = this.getAttribute('data-metric');
            const action = this.getAttribute('data-action');
            const isIncrease = action === 'increase';
            
            // Obter o valor do campo manual
            const manualElement = document.getElementById(`${metric}Manual`);
            if (!manualElement) return; // Se o elemento não existir, não fazer nada
            
            let percentual = parseFloat(manualElement.value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
            
            // Se não houver valor no campo manual, usar 0
            if (percentual === 0) {
                alert('Por favor, digite um valor no campo antes de aplicar a mudança.');
                return;
            }
            
            // Determinar se a métrica é um percentual ou valor monetário
            const isPercentage = metric === 'margem';
            
            applyMetricChange(metric, percentual, isIncrease, isPercentage);
        });
    });

    // Event listeners para os campos de entrada manual - apenas para exibição
    document.querySelectorAll('input[id$="Manual"]').forEach(input => {
        input.addEventListener('input', function() {
            const metric = this.id.replace('Manual', '');
            const isPercentage = metric === 'margem';
            
            // Obter o valor manual
            let manualValue = parseFloat(this.value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
            
            // Obter o valor original para cálculo da variação
            const originalElement = document.getElementById(`${metric}Original`);
            if (!originalElement || !originalElement.value) return;
            
            let original;
            if (isPercentage) {
                // Para percentuais, extrair o valor numérico do formato "XX.XX%"
                original = parseFloat(originalElement.value.replace('%', '')) || 0;
            } else {
                // Para valores monetários, extrair o valor numérico do formato "R$ XX.XX"
                original = parseFloat(originalElement.value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
            }
            
            // Atualizar o campo calculado
            const calculatedElement = document.getElementById(`${metric}Calculado`);
            if (isPercentage) {
                calculatedElement.value = formatPercent(manualValue);
            } else if (metric === 'clientes') {
                // Para clientes, calcular o valor com base no percentual
                const calculatedValue = original + (original * manualValue / 100);
                calculatedElement.value = Math.round(calculatedValue); // Arredondar para número inteiro
                
                // Recalcular a margem com base no novo número de clientes
                recalculateMargin();
            } else if (metric === 'precoMedio') {
                // Para preço médio, calcular o valor com base no percentual
                const calculatedValue = original + (original * manualValue / 100);
                calculatedElement.value = formatMoney(calculatedValue);
                
                // Recalcular faturamento, ticket médio e margem com base no novo preço médio
                recalculateFromPriceChange(manualValue);
            } else if (metric === 'ticketMedio') {
                // Para ticket médio, calcular o valor com base no percentual
                const calculatedValue = original + (original * manualValue / 100);
                calculatedElement.value = formatMoney(calculatedValue);
                
                // Recalcular faturamento, margem e custos com base no novo ticket médio
                recalculateFromTicketChange(manualValue);
            } else if (metric === 'custosVendas') {
                // Para custos de vendas, calcular o valor com base no percentual
                const calculatedValue = original + (original * manualValue / 100);
                calculatedElement.value = formatMoney(calculatedValue);
                
                // Recalcular margem com base nos novos custos de vendas
                recalculateFromSalesCostsChange(manualValue);
            } else if (metric === 'custosInsumos') {
                // Para custos de insumos, calcular o valor com base no percentual
                const calculatedValue = original + (original * manualValue / 100);
                calculatedElement.value = formatMoney(calculatedValue);
                
                // Recalcular margem com base nos novos custos de insumos
                recalculateFromOperationalCostsChange(manualValue);
            } else if (metric === 'custosFixos') {
                // Para custos fixos, calcular o valor com base no percentual
                const calculatedValue = original + (original * manualValue / 100);
                calculatedElement.value = formatMoney(calculatedValue);
                
                // Recalcular a margem com base nos novos custos fixos
                recalculateFromFixedCostsChange(isIncrease ? manualValue : -manualValue);
            } else {
                calculatedElement.value = formatMoney(manualValue);
            }
            
            // Alterar a cor de fundo com base na comparação com o valor original
            if (calculated > original) {
                if (metric === 'custosFixos') {
                    calculatedElement.style.backgroundColor = '#f8d7da'; // Vermelho para aumento de custos
                } else {
                    calculatedElement.style.backgroundColor = '#d4edda'; // Verde para aumento de outras métricas
                }
            } else if (calculated < original) {
                if (metric === 'custosFixos') {
                    calculatedElement.style.backgroundColor = '#d4edda'; // Verde para redução de custos
                } else {
                    calculatedElement.style.backgroundColor = '#f8d7da'; // Vermelho para redução de outras métricas
                }
            } else {
                calculatedElement.style.backgroundColor = ''; // Cor padrão
            }
            
            // Calcular e atualizar a variação
            const variation = calculateVariation(original, manualValue);
            document.getElementById(`${metric}Variacao`).value = formatPercent(variation);
        });
    });

    // Função para recalcular a margem com base nos novos valores
    function recalculateMargin() {
        // Obter os valores originais
        const faturamentoOriginal = parseFloat(document.getElementById('faturamentoOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const custosVendasOriginal = parseFloat(document.getElementById('custosVendasOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const custosInsumosOriginal = parseFloat(document.getElementById('custosInsumosOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const custosFixosOriginal = parseFloat(document.getElementById('custosFixosOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        
        // Obter o novo número de clientes
        const clientesCalculado = parseInt(document.getElementById('clientesCalculado').value) || 0;
        const clientesOriginal = parseInt(document.getElementById('clientesOriginal').value) || 1; // Evitar divisão por zero
        
        // Calcular o fator de ajuste baseado na variação do número de clientes
        const fatorAjuste = clientesCalculado / clientesOriginal;
        
        // Calcular os novos valores com base no fator de ajuste
        const faturamentoCalculado = faturamentoOriginal * fatorAjuste;
        const custosVendasCalculado = custosVendasOriginal * fatorAjuste;
        const custosInsumosCalculado = custosInsumosOriginal * fatorAjuste;
        // Custos fixos não variam com o número de clientes
        
        // Atualizar o campo faturamentoCalculado
        document.getElementById('faturamentoCalculado').value = formatMoney(faturamentoCalculado);
        
        // Calcular e atualizar a variação do faturamento
        const variacaoFaturamento = calculateVariation(faturamentoOriginal, faturamentoCalculado);
        document.getElementById('faturamentoVariacao').value = formatPercent(variacaoFaturamento);
        
        // Alterar a cor de fundo do faturamento calculado com base na comparação
        const faturamentoCalculadoElement = document.getElementById('faturamentoCalculado');
        if (faturamentoCalculado > faturamentoOriginal) {
            faturamentoCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro
        } else if (faturamentoCalculado < faturamentoOriginal) {
            faturamentoCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
        } else {
            faturamentoCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Atualizar o campo custosVendasCalculado
        document.getElementById('custosVendasCalculado').value = formatMoney(custosVendasCalculado);
        
        // Calcular e atualizar a variação dos custos de vendas
        const variacaoCustosVendas = calculateVariation(custosVendasOriginal, custosVendasCalculado);
        document.getElementById('custosVendasVariacao').value = formatPercent(variacaoCustosVendas);
        
        // Alterar a cor de fundo dos custos de vendas calculados com base na comparação
        const custosVendasCalculadoElement = document.getElementById('custosVendasCalculado');
        if (custosVendasCalculado > custosVendasOriginal) {
            custosVendasCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro (aumento de custos é negativo)
        } else if (custosVendasCalculado < custosVendasOriginal) {
            custosVendasCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro (redução de custos é positiva)
        } else {
            custosVendasCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Atualizar o campo custosInsumosCalculado
        document.getElementById('custosInsumosCalculado').value = formatMoney(custosInsumosCalculado);
        
        // Calcular e atualizar a variação dos custos de insumos
        const variacaoCustosInsumos = calculateVariation(custosInsumosOriginal, custosInsumosCalculado);
        document.getElementById('custosInsumosVariacao').value = formatPercent(variacaoCustosInsumos);
        
        // Alterar a cor de fundo dos custos de insumos calculados com base na comparação
        const custosInsumosCalculadoElement = document.getElementById('custosInsumosCalculado');
        if (custosInsumosCalculado > custosInsumosOriginal) {
            custosInsumosCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro (aumento de custos é negativo)
        } else if (custosInsumosCalculado < custosInsumosOriginal) {
            custosInsumosCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro (redução de custos é positiva)
        } else {
            custosInsumosCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Calcular a nova margem
        const novaMargem = faturamentoCalculado > 0 ? 
            ((faturamentoCalculado - (custosVendasCalculado + custosInsumosCalculado + custosFixosOriginal)) / faturamentoCalculado) * 100 : 0;
        
        // Atualizar o campo margemCalculado
        document.getElementById('margemCalculado').value = formatPercent(novaMargem);
        
        // Obter o valor original da margem para cálculo da variação
        const margemOriginal = parseFloat(document.getElementById('margemOriginal').value.replace('%', '')) || 0;
        
        // Calcular e atualizar a variação da margem
        const variacaoMargem = calculateVariation(margemOriginal, novaMargem);
        document.getElementById('margemVariacao').value = formatPercent(variacaoMargem);
        
        // Alterar a cor de fundo da margem calculada com base na comparação
        const margemCalculadoElement = document.getElementById('margemCalculado');
        if (novaMargem > margemOriginal) {
            margemCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro
        } else if (novaMargem < margemOriginal) {
            margemCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
        } else {
            margemCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
    }

    // Função para aplicar a mudança percentual a uma métrica específica
    function applyMetricChange(metric, percentual, isIncrease, isPercentage) {
        const originalElement = document.getElementById(`${metric}Original`);
        const calculatedElement = document.getElementById(`${metric}Calculado`);
        const variationElement = document.getElementById(`${metric}Variacao`);
        const manualElement = document.getElementById(`${metric}Manual`);
        
        if (!originalElement || !originalElement.value) return;
        
        let original;
        if (isPercentage) {
            // Para percentuais, extrair o valor numérico do formato "XX.XX%"
            original = parseFloat(originalElement.value.replace('%', '')) || 0;
            console.log(`Original ${metric}: ${original}%`);
        } else {
            // Para valores monetários, extrair o valor numérico do formato "R$ XX.XX"
            original = parseFloat(originalElement.value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
            console.log(`Original ${metric}: ${original}`);
        }
        
        console.log(`Percentual aplicado: ${percentual}%`);
        console.log(`Ação: ${isIncrease ? 'Aumentar' : 'Diminuir'}`);
        
        // Calcular o valor final com base na fórmula fornecida
        let calculated;
        if (isIncrease) {
            // Soma: valor_final = valor_original + (valor_original * percentual / 100)
            calculated = original + (original * percentual / 100);
            console.log(`Cálculo: ${original} + (${original} * ${percentual} / 100) = ${calculated}`);
        } else {
            // Subtração: valor_final = valor_original - (valor_original * percentual / 100)
            calculated = original - (original * percentual / 100);
            console.log(`Cálculo: ${original} - (${original} * ${percentual} / 100) = ${calculated}`);
        }
        
        // Calcular a variação percentual
        const variation = calculateVariation(original, calculated);
        console.log(`Variação: ${variation}%`);
        
        // Atualizar os elementos na interface
        if (isPercentage) {
            calculatedElement.value = formatPercent(calculated);
            console.log(`Valor calculado: ${formatPercent(calculated)}`);
        } else if (metric === 'clientes') {
            // Para clientes, exibir como número inteiro
            calculatedElement.value = Math.round(calculated);
            console.log(`Valor calculado: ${Math.round(calculated)}`);
            
            // Recalcular a margem com base no novo número de clientes
            recalculateMargin();
        } else if (metric === 'custosFixos') {
            // Para custos fixos, exibir como valor monetário
            calculatedElement.value = formatMoney(calculated);
            console.log(`Valor calculado: ${formatMoney(calculated)}`);
            
            // Recalcular a margem com base nos novos custos fixos
            recalculateFromFixedCostsChange(isIncrease ? percentual : -percentual);
        } else {
            calculatedElement.value = formatMoney(calculated);
            console.log(`Valor calculado: ${formatMoney(calculated)}`);
        }
        
        // Alterar a cor de fundo com base na comparação com o valor original
        if (calculated > original) {
            if (metric === 'custosFixos') {
                calculatedElement.style.backgroundColor = '#f8d7da'; // Vermelho para aumento de custos
            } else {
                calculatedElement.style.backgroundColor = '#d4edda'; // Verde para aumento de outras métricas
            }
        } else if (calculated < original) {
            if (metric === 'custosFixos') {
                calculatedElement.style.backgroundColor = '#d4edda'; // Verde para redução de custos
            } else {
                calculatedElement.style.backgroundColor = '#f8d7da'; // Vermelho para redução de outras métricas
            }
        } else {
            calculatedElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Limpar o campo manual
        if (manualElement) manualElement.value = '';
        
        variationElement.value = formatPercent(variation);
    }

    // Função para carregar dados básicos
    function loadBasicData(basicDataId) {
        console.log("Carregando dados básicos para ID:", basicDataId);
        
        fetch(`/gestao-prioridades/api/basic-data/${basicDataId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Dados não encontrados');
                }
                return response.json();
            })
            .then(data => {
                console.log("Dados recebidos:", data);
                
                // Verificar se fixed_costs é null ou zero e usar other_fixed_costs se necessário
                const fixedCosts = (!data.fixed_costs || data.fixed_costs === 0) ? data.other_fixed_costs : data.fixed_costs;
                
                // Verificar se ideal_profit_margin é null ou zero e usar ideal_service_profit_margin se necessário
                const idealProfitMargin = (!data.ideal_profit_margin || data.ideal_profit_margin === 0) ? data.ideal_service_profit_margin : data.ideal_profit_margin;
                
                // Calcular margem
                const margem = data.sales_revenue > 0 ? 
                    ((data.sales_revenue - (data.sales_expenses + data.operational_expenses + fixedCosts)) / data.sales_revenue) * 100 : 0;
                
                // Calcular preço médio
                const precoMedio = data.clients_served > 0 ? data.sales_revenue / data.clients_served : 0;
                
                // Preencher os campos originais
                document.getElementById('margemOriginal').value = formatPercent(margem);
                document.getElementById('clientesOriginal').value = data.clients_served;
                document.getElementById('precoMedioOriginal').value = formatMoney(precoMedio);
                document.getElementById('ticketMedioOriginal').value = formatMoney(precoMedio);
                document.getElementById('faturamentoOriginal').value = formatMoney(data.sales_revenue);
                document.getElementById('custosVendasOriginal').value = formatMoney(data.sales_expenses);
                document.getElementById('custosInsumosOriginal').value = formatMoney(data.operational_expenses);
                document.getElementById('custosFixosOriginal').value = formatMoney(fixedCosts);
                
                // Inicializar os campos calculados com os valores originais
                document.getElementById('margemCalculado').value = formatPercent(margem);
                document.getElementById('clientesCalculado').value = data.clients_served;
                document.getElementById('precoMedioCalculado').value = formatMoney(precoMedio);
                document.getElementById('ticketMedioCalculado').value = formatMoney(precoMedio);
                document.getElementById('faturamentoCalculado').value = formatMoney(data.sales_revenue);
                document.getElementById('custosVendasCalculado').value = formatMoney(data.sales_expenses);
                document.getElementById('custosInsumosCalculado').value = formatMoney(data.operational_expenses);
                document.getElementById('custosFixosCalculado').value = formatMoney(fixedCosts);
                
                // Inicializar os campos de variação com 0%
                document.getElementById('margemVariacao').value = formatPercent(0);
                document.getElementById('clientesVariacao').value = formatPercent(0);
                document.getElementById('precoMedioVariacao').value = formatPercent(0);
                document.getElementById('ticketMedioVariacao').value = formatPercent(0);
                document.getElementById('faturamentoVariacao').value = formatPercent(0);
                document.getElementById('custosVendasVariacao').value = formatPercent(0);
                document.getElementById('custosInsumosVariacao').value = formatPercent(0);
                document.getElementById('custosFixosVariacao').value = formatPercent(0);
                
                // Limpar os campos manuais
                const margemManualElement = document.getElementById('margemManual');
                if (margemManualElement) margemManualElement.value = '';
                
                document.getElementById('clientesManual').value = '';
                document.getElementById('precoMedioManual').value = '';
                document.getElementById('ticketMedioManual').value = '';
                document.getElementById('faturamentoManual').value = '';
                document.getElementById('custosVendasManual').value = '';
                document.getElementById('custosInsumosManual').value = '';
                document.getElementById('custosFixosManual').value = '';
            })
            .catch(error => {
                console.error('Erro ao carregar dados:', error);
                alert('Erro ao carregar os dados. Por favor, tente novamente.');
            });
    }

    // Event listener para o select de dados básicos
    document.getElementById('basicDataSelect').addEventListener('change', function() {
        const basicDataId = this.value;
        loadBasicData(basicDataId);
    });

    // Carregar dados iniciais quando a página carregar
    const selectElement = document.getElementById('basicDataSelect');
    if (selectElement && selectElement.value) {
        loadBasicData(selectElement.value);
    }

    // Função para recalcular campos com base na mudança de preço médio
    function recalculateFromPriceChange(percentual) {
        // Obter valores originais
        const precoMedioOriginal = parseFloat(document.getElementById('precoMedioOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const clientesCalculado = parseInt(document.getElementById('clientesCalculado').value) || 0;
        const custosVendasOriginal = parseFloat(document.getElementById('custosVendasOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const custosInsumosOriginal = parseFloat(document.getElementById('custosInsumosOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const custosFixosOriginal = parseFloat(document.getElementById('custosFixosOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        
        // Calcular o novo preço médio
        const precoMedioCalculado = precoMedioOriginal + (precoMedioOriginal * percentual / 100);
        
        // Atualizar o campo preço médio calculado
        document.getElementById('precoMedioCalculado').value = formatMoney(precoMedioCalculado);
        
        // Calcular e atualizar a variação do preço médio
        const variacaoPrecoMedio = calculateVariation(precoMedioOriginal, precoMedioCalculado);
        document.getElementById('precoMedioVariacao').value = formatPercent(variacaoPrecoMedio);
        
        // Atualizar o ticket médio (mesmo valor do preço médio)
        document.getElementById('ticketMedioCalculado').value = formatMoney(precoMedioCalculado);
        document.getElementById('ticketMedioVariacao').value = formatPercent(variacaoPrecoMedio);
        
        // Alterar a cor de fundo do ticket médio calculado com base na comparação
        const ticketMedioCalculadoElement = document.getElementById('ticketMedioCalculado');
        const ticketMedioOriginal = parseFloat(document.getElementById('ticketMedioOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        if (precoMedioCalculado > ticketMedioOriginal) {
            ticketMedioCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro
        } else if (precoMedioCalculado < ticketMedioOriginal) {
            ticketMedioCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
        } else {
            ticketMedioCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Calcular o novo faturamento (preço médio * número de clientes)
        const faturamentoCalculado = precoMedioCalculado * clientesCalculado;
        document.getElementById('faturamentoCalculado').value = formatMoney(faturamentoCalculado);
        
        // Calcular e atualizar a variação do faturamento
        const faturamentoOriginal = parseFloat(document.getElementById('faturamentoOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const variacaoFaturamento = calculateVariation(faturamentoOriginal, faturamentoCalculado);
        document.getElementById('faturamentoVariacao').value = formatPercent(variacaoFaturamento);
        
        // Alterar a cor de fundo do faturamento calculado com base na comparação
        const faturamentoCalculadoElement = document.getElementById('faturamentoCalculado');
        if (faturamentoCalculado > faturamentoOriginal) {
            faturamentoCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro
        } else if (faturamentoCalculado < faturamentoOriginal) {
            faturamentoCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
        } else {
            faturamentoCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Calcular os novos custos de vendas (proporcional ao faturamento)
        const custosVendasCalculado = custosVendasOriginal * (faturamentoCalculado / faturamentoOriginal);
        document.getElementById('custosVendasCalculado').value = formatMoney(custosVendasCalculado);
        
        // Calcular e atualizar a variação dos custos de vendas
        const variacaoCustosVendas = calculateVariation(custosVendasOriginal, custosVendasCalculado);
        document.getElementById('custosVendasVariacao').value = formatPercent(variacaoCustosVendas);
        
        // Alterar a cor de fundo dos custos de vendas calculados com base na comparação
        const custosVendasCalculadoElement = document.getElementById('custosVendasCalculado');
        if (custosVendasCalculado > custosVendasOriginal) {
            custosVendasCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro (aumento de custos é negativo)
        } else if (custosVendasCalculado < custosVendasOriginal) {
            custosVendasCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro (redução de custos é positiva)
        } else {
            custosVendasCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Calcular a nova margem
        const novaMargem = faturamentoCalculado > 0 ? 
            ((faturamentoCalculado - (custosVendasCalculado + custosInsumosOriginal + custosFixosOriginal)) / faturamentoCalculado) * 100 : 0;
        
        // Atualizar o campo margemCalculado
        document.getElementById('margemCalculado').value = formatPercent(novaMargem);
        
        // Obter o valor original da margem para cálculo da variação
        const margemOriginal = parseFloat(document.getElementById('margemOriginal').value.replace('%', '')) || 0;
        
        // Calcular e atualizar a variação da margem
        const variacaoMargem = calculateVariation(margemOriginal, novaMargem);
        document.getElementById('margemVariacao').value = formatPercent(variacaoMargem);
        
        // Alterar a cor de fundo da margem calculada com base na comparação
        const margemCalculadoElement = document.getElementById('margemCalculado');
        if (novaMargem > margemOriginal) {
            margemCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro
        } else if (novaMargem < margemOriginal) {
            margemCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
        } else {
            margemCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
    }

    // Função para recalcular campos com base na mudança de ticket médio
    function recalculateFromTicketChange(percentual) {
        // Obter valores originais
        const ticketMedioOriginal = parseFloat(document.getElementById('ticketMedioOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const clientesCalculado = parseInt(document.getElementById('clientesCalculado').value) || 0;
        const custosVendasOriginal = parseFloat(document.getElementById('custosVendasOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const custosInsumosOriginal = parseFloat(document.getElementById('custosInsumosOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const custosFixosOriginal = parseFloat(document.getElementById('custosFixosOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        
        // Calcular o novo ticket médio
        const ticketMedioCalculado = ticketMedioOriginal + (ticketMedioOriginal * percentual / 100);
        
        // Atualizar o campo ticket médio calculado
        document.getElementById('ticketMedioCalculado').value = formatMoney(ticketMedioCalculado);
        
        // Calcular e atualizar a variação do ticket médio
        const variacaoTicketMedio = calculateVariation(ticketMedioOriginal, ticketMedioCalculado);
        document.getElementById('ticketMedioVariacao').value = formatPercent(variacaoTicketMedio);
        
        // Alterar a cor de fundo do ticket médio calculado com base na comparação
        const ticketMedioCalculadoElement = document.getElementById('ticketMedioCalculado');
        if (ticketMedioCalculado > ticketMedioOriginal) {
            ticketMedioCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro
        } else if (ticketMedioCalculado < ticketMedioOriginal) {
            ticketMedioCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
        } else {
            ticketMedioCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Calcular o novo faturamento (ticket médio * número de clientes)
        const faturamentoCalculado = ticketMedioCalculado * clientesCalculado;
        document.getElementById('faturamentoCalculado').value = formatMoney(faturamentoCalculado);
        
        // Calcular e atualizar a variação do faturamento
        const faturamentoOriginal = parseFloat(document.getElementById('faturamentoOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const variacaoFaturamento = calculateVariation(faturamentoOriginal, faturamentoCalculado);
        document.getElementById('faturamentoVariacao').value = formatPercent(variacaoFaturamento);
        
        // Alterar a cor de fundo do faturamento calculado com base na comparação
        const faturamentoCalculadoElement = document.getElementById('faturamentoCalculado');
        if (faturamentoCalculado > faturamentoOriginal) {
            faturamentoCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro
        } else if (faturamentoCalculado < faturamentoOriginal) {
            faturamentoCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
        } else {
            faturamentoCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Calcular os novos custos de vendas (proporcional ao faturamento)
        const custosVendasCalculado = custosVendasOriginal * (faturamentoCalculado / faturamentoOriginal);
        document.getElementById('custosVendasCalculado').value = formatMoney(custosVendasCalculado);
        
        // Calcular e atualizar a variação dos custos de vendas
        const variacaoCustosVendas = calculateVariation(custosVendasOriginal, custosVendasCalculado);
        document.getElementById('custosVendasVariacao').value = formatPercent(variacaoCustosVendas);
        
        // Alterar a cor de fundo dos custos de vendas calculados com base na comparação
        const custosVendasCalculadoElement = document.getElementById('custosVendasCalculado');
        if (custosVendasCalculado > custosVendasOriginal) {
            custosVendasCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro (aumento de custos é negativo)
        } else if (custosVendasCalculado < custosVendasOriginal) {
            custosVendasCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro (redução de custos é positiva)
        } else {
            custosVendasCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Calcular os novos custos de insumos (proporcional ao faturamento)
        const custosInsumosCalculado = custosInsumosOriginal * (faturamentoCalculado / faturamentoOriginal);
        document.getElementById('custosInsumosCalculado').value = formatMoney(custosInsumosCalculado);
        
        // Calcular e atualizar a variação dos custos de insumos
        const variacaoCustosInsumos = calculateVariation(custosInsumosOriginal, custosInsumosCalculado);
        document.getElementById('custosInsumosVariacao').value = formatPercent(variacaoCustosInsumos);
        
        // Alterar a cor de fundo dos custos de insumos calculados com base na comparação
        const custosInsumosCalculadoElement = document.getElementById('custosInsumosCalculado');
        if (custosInsumosCalculado > custosInsumosOriginal) {
            custosInsumosCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro (aumento de custos é negativo)
        } else if (custosInsumosCalculado < custosInsumosOriginal) {
            custosInsumosCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro (redução de custos é positiva)
        } else {
            custosInsumosCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Calcular a nova margem
        const novaMargem = faturamentoCalculado > 0 ? 
            ((faturamentoCalculado - (custosVendasCalculado + custosInsumosCalculado + custosFixosOriginal)) / faturamentoCalculado) * 100 : 0;
        
        // Atualizar o campo margemCalculado
        document.getElementById('margemCalculado').value = formatPercent(novaMargem);
        
        // Obter o valor original da margem para cálculo da variação
        const margemOriginal = parseFloat(document.getElementById('margemOriginal').value.replace('%', '')) || 0;
        
        // Calcular e atualizar a variação da margem
        const variacaoMargem = calculateVariation(margemOriginal, novaMargem);
        document.getElementById('margemVariacao').value = formatPercent(variacaoMargem);
        
        // Alterar a cor de fundo da margem calculada com base na comparação
        const margemCalculadoElement = document.getElementById('margemCalculado');
        if (novaMargem > margemOriginal) {
            margemCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro
        } else if (novaMargem < margemOriginal) {
            margemCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
        } else {
            margemCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
    }

    // Função para recalcular campos com base na mudança de custos de vendas
    function recalculateFromSalesCostsChange(percentual) {
        // Obter valores originais
        const custosVendasOriginal = parseFloat(document.getElementById('custosVendasOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const faturamentoCalculado = parseFloat(document.getElementById('faturamentoCalculado').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const custosInsumosOriginal = parseFloat(document.getElementById('custosInsumosOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const custosFixosOriginal = parseFloat(document.getElementById('custosFixosOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        
        // Calcular o novo custo de vendas
        const custosVendasCalculado = custosVendasOriginal + (custosVendasOriginal * percentual / 100);
        
        // Atualizar o campo custos de vendas calculado
        document.getElementById('custosVendasCalculado').value = formatMoney(custosVendasCalculado);
        
        // Calcular e atualizar a variação dos custos de vendas
        const variacaoCustosVendas = calculateVariation(custosVendasOriginal, custosVendasCalculado);
        document.getElementById('custosVendasVariacao').value = formatPercent(variacaoCustosVendas);
        
        // Alterar a cor de fundo dos custos de vendas calculados com base na comparação
        const custosVendasCalculadoElement = document.getElementById('custosVendasCalculado');
        if (custosVendasCalculado > custosVendasOriginal) {
            custosVendasCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro (aumento de custos é negativo)
        } else if (custosVendasCalculado < custosVendasOriginal) {
            custosVendasCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro (redução de custos é positiva)
        } else {
            custosVendasCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Calcular a nova margem
        const novaMargem = faturamentoCalculado > 0 ? 
            ((faturamentoCalculado - (custosVendasCalculado + custosInsumosOriginal + custosFixosOriginal)) / faturamentoCalculado) * 100 : 0;
        
        // Atualizar o campo margemCalculado
        document.getElementById('margemCalculado').value = formatPercent(novaMargem);
        
        // Obter o valor original da margem para cálculo da variação
        const margemOriginal = parseFloat(document.getElementById('margemOriginal').value.replace('%', '')) || 0;
        
        // Calcular e atualizar a variação da margem
        const variacaoMargem = calculateVariation(margemOriginal, novaMargem);
        document.getElementById('margemVariacao').value = formatPercent(variacaoMargem);
        
        // Alterar a cor de fundo da margem calculada com base na comparação
        const margemCalculadoElement = document.getElementById('margemCalculado');
        if (novaMargem > margemOriginal) {
            margemCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro
        } else if (novaMargem < margemOriginal) {
            margemCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
        } else {
            margemCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
    }

    // Função para recalcular campos com base na mudança de custos de insumos
    function recalculateFromOperationalCostsChange(percentual) {
        // Obter valores originais
        const custosInsumosOriginal = parseFloat(document.getElementById('custosInsumosOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const faturamentoCalculado = parseFloat(document.getElementById('faturamentoCalculado').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const custosVendasOriginal = parseFloat(document.getElementById('custosVendasOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const custosFixosOriginal = parseFloat(document.getElementById('custosFixosOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const clientesCalculado = parseInt(document.getElementById('clientesCalculado').value) || 0;
        const clientesOriginal = parseInt(document.getElementById('clientesOriginal').value) || 1; // Evitar divisão por zero
        
        // Calcular o novo custo de insumos
        const custosInsumosCalculado = custosInsumosOriginal + (custosInsumosOriginal * percentual / 100);
        
        // Atualizar o campo custos de insumos calculado
        document.getElementById('custosInsumosCalculado').value = formatMoney(custosInsumosCalculado);
        
        // Calcular e atualizar a variação dos custos de insumos
        const variacaoCustosInsumos = calculateVariation(custosInsumosOriginal, custosInsumosCalculado);
        document.getElementById('custosInsumosVariacao').value = formatPercent(variacaoCustosInsumos);
        
        // Alterar a cor de fundo dos custos de insumos calculados com base na comparação
        const custosInsumosCalculadoElement = document.getElementById('custosInsumosCalculado');
        if (custosInsumosCalculado > custosInsumosOriginal) {
            custosInsumosCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro (aumento de custos é negativo)
        } else if (custosInsumosCalculado < custosInsumosOriginal) {
            custosInsumosCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro (redução de custos é positiva)
        } else {
            custosInsumosCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Calcular o fator de ajuste baseado na variação do número de clientes
        const fatorAjuste = clientesCalculado / clientesOriginal;
        
        // Calcular os novos custos de vendas com base no fator de ajuste
        const custosVendasCalculado = custosVendasOriginal * fatorAjuste;
        
        // Atualizar o campo custos de vendas calculado
        document.getElementById('custosVendasCalculado').value = formatMoney(custosVendasCalculado);
        
        // Calcular e atualizar a variação dos custos de vendas
        const variacaoCustosVendas = calculateVariation(custosVendasOriginal, custosVendasCalculado);
        document.getElementById('custosVendasVariacao').value = formatPercent(variacaoCustosVendas);
        
        // Alterar a cor de fundo dos custos de vendas calculados com base na comparação
        const custosVendasCalculadoElement = document.getElementById('custosVendasCalculado');
        if (custosVendasCalculado > custosVendasOriginal) {
            custosVendasCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro (aumento de custos é negativo)
        } else if (custosVendasCalculado < custosVendasOriginal) {
            custosVendasCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro (redução de custos é positiva)
        } else {
            custosVendasCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Calcular a nova margem
        const novaMargem = faturamentoCalculado > 0 ? 
            ((faturamentoCalculado - (custosVendasCalculado + custosInsumosCalculado + custosFixosOriginal)) / faturamentoCalculado) * 100 : 0;
        
        // Atualizar o campo margemCalculado
        document.getElementById('margemCalculado').value = formatPercent(novaMargem);
        
        // Obter o valor original da margem para cálculo da variação
        const margemOriginal = parseFloat(document.getElementById('margemOriginal').value.replace('%', '')) || 0;
        
        // Calcular e atualizar a variação da margem
        const variacaoMargem = calculateVariation(margemOriginal, novaMargem);
        document.getElementById('margemVariacao').value = formatPercent(variacaoMargem);
        
        // Alterar a cor de fundo da margem calculada com base na comparação
        const margemCalculadoElement = document.getElementById('margemCalculado');
        if (novaMargem > margemOriginal) {
            margemCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro
        } else if (novaMargem < margemOriginal) {
            margemCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
        } else {
            margemCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
    }

    // Função para recalcular campos com base na mudança de custos fixos
    function recalculateFromFixedCostsChange(percentual) {
        console.log('Recalculando com base na mudança de custos fixos:', percentual);
        
        // Obter valores originais
        const custosFixosOriginal = parseFloat(document.getElementById('custosFixosOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        console.log('Custos fixos original:', custosFixosOriginal);
        
        // Obter valores calculados
        const faturamentoCalculado = parseFloat(document.getElementById('faturamentoCalculado').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        console.log('Faturamento calculado:', faturamentoCalculado);
        
        const custosVendasCalculado = parseFloat(document.getElementById('custosVendasCalculado').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        console.log('Custos de vendas calculado:', custosVendasCalculado);
        
        const custosInsumosCalculado = parseFloat(document.getElementById('custosInsumosCalculado').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        console.log('Custos de insumos calculado:', custosInsumosCalculado);
        
        // Calcular o novo custo fixo
        const custosFixosCalculado = custosFixosOriginal + (custosFixosOriginal * percentual / 100);
        console.log('Custos fixos calculado:', custosFixosCalculado);
        
        // Atualizar o campo custos fixos calculado
        document.getElementById('custosFixosCalculado').value = formatMoney(custosFixosCalculado);
        
        // Calcular e atualizar a variação dos custos fixos
        const variacaoCustosFixos = calculateVariation(custosFixosOriginal, custosFixosCalculado);
        document.getElementById('custosFixosVariacao').value = formatPercent(variacaoCustosFixos);
        
        // Alterar a cor de fundo dos custos fixos calculados com base na comparação
        const custosFixosCalculadoElement = document.getElementById('custosFixosCalculado');
        
        // Para custos fixos, inverter a lógica de cores
        if (custosFixosCalculado < custosFixosOriginal) {
            custosFixosCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro (redução de custos é positiva)
        } else if (custosFixosCalculado > custosFixosOriginal) {
            custosFixosCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro (aumento de custos é negativo)
        } else {
            custosFixosCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }

        console.log('Variação dos custos fixos:', variacaoCustosFixos);
  
        
        // Calcular a nova margem - CORRIGINDO: usando o custosFixosCalculado para refletir a mudança
        const novaMargem = faturamentoCalculado > 0 ? 
            ((faturamentoCalculado - (custosVendasCalculado + custosInsumosCalculado + custosFixosCalculado)) / faturamentoCalculado) * 100 : 0;
        console.log('Nova margem calculada:', novaMargem);
        
        // Atualizar o campo margemCalculado
        document.getElementById('margemCalculado').value = formatPercent(novaMargem);
        
        // Obter o valor original da margem para cálculo da variação
        const margemOriginal = parseFloat(document.getElementById('margemOriginal').value.replace('%', '')) || 0;
        console.log('Margem original:', margemOriginal);
        
        // Calcular e atualizar a variação da margem
        const variacaoMargem = calculateVariation(margemOriginal, novaMargem);
        document.getElementById('margemVariacao').value = formatPercent(variacaoMargem);
        
        // Alterar a cor de fundo da margem calculada com base na comparação
        const margemCalculadoElement = document.getElementById('margemCalculado');
        if (novaMargem > margemOriginal) {
            margemCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro
        } else if (novaMargem < margemOriginal) {
            margemCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
        } else {
            margemCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
    }
});
</script>
{% endblock %} 