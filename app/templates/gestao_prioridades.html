{% extends "base.html" %}

{% block title %}Gestão de Prioridades - GetUp Gestão{% endblock %}

{% block content %}
    {% include "components/navbar.html" %}
    <div class="container py-4">
        <!-- Card Principal -->
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="card-title mb-0">Gestão de Prioridades</h4>
            </div>
            <div class="card-body">
                <!-- Combo Box de Dados Básicos -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="basicDataSelect" class="form-label">
                                Selecione o Período dos dados básicos
                                <i class="bi bi-question-circle-fill ms-2" 
                                   data-bs-toggle="modal" 
                                   data-bs-target="#helpModal" 
                                   style="cursor: pointer;"></i>
                            </label>
                            <select class="form-select" id="basicDataSelect">
                                {% for data in basic_data_list %}
                                <option value="{{ data.id }}" {% if data.is_current %}selected{% endif %}>
                                    {{ data.month }}/{{ data.year }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Campos Comparativos -->
                <div class="row">
                    <!-- Margem -->
                    <div class="col-md-12 mb-4">
                        <h5>Margem</h5>
                        <div class="input-group">
                            <input type="text" class="form-control" id="margemOriginal" readonly>
                            <input type="text" class="form-control" id="margemCalculado" readonly>
                            <input type="text" class="form-control" id="margemVariacao" readonly>
                            <input type="text" class="form-control" id="margemManual" placeholder="Digite um valor">
                            <button class="btn btn-success text-white" type="button" data-metric="margem" data-action="increase">
                                <i class="bi bi-plus-circle text-white"></i>
                            </button>
                            <button class="btn btn-danger text-white" type="button" data-metric="margem" data-action="decrease">
                                <i class="bi bi-dash-circle text-white"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Clientes -->
                    <div class="col-md-12 mb-4">
                        <h5>Clientes Atendidos</h5>
                        <div class="input-group">
                            <input type="text" class="form-control" id="clientesOriginal" readonly>
                            <input type="text" class="form-control" id="clientesCalculado" readonly>
                            <input type="text" class="form-control" id="clientesVariacao" readonly>
                            <input type="text" class="form-control" id="clientesManual" placeholder="Digite um valor">
                            <button class="btn btn-success text-white" type="button" data-metric="clientes" data-action="increase">
                                <i class="bi bi-plus-circle text-white"></i>
                            </button>
                            <button class="btn btn-danger text-white" type="button" data-metric="clientes" data-action="decrease">
                                <i class="bi bi-dash-circle text-white"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Preço Médio -->
                    <div class="col-md-12 mb-4">
                        <h5>Preço Médio</h5>
                        <div class="input-group">
                            <input type="text" class="form-control" id="precoMedioOriginal" readonly>
                            <input type="text" class="form-control" id="precoMedioCalculado" readonly>
                            <input type="text" class="form-control" id="precoMedioVariacao" readonly>
                            <input type="text" class="form-control" id="precoMedioManual" placeholder="Digite um valor">
                            <button class="btn btn-success text-white" type="button" data-metric="precoMedio" data-action="increase">
                                <i class="bi bi-plus-circle text-white"></i>
                            </button>
                            <button class="btn btn-danger text-white" type="button" data-metric="precoMedio" data-action="decrease">
                                <i class="bi bi-dash-circle text-white"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Ticket Médio -->
                    <div class="col-md-12 mb-4">
                        <h5>Ticket Médio</h5>
                        <div class="input-group">
                            <input type="text" class="form-control" id="ticketMedioOriginal" readonly>
                            <input type="text" class="form-control" id="ticketMedioCalculado" readonly>
                            <input type="text" class="form-control" id="ticketMedioVariacao" readonly>
                            <input type="text" class="form-control" id="ticketMedioManual" placeholder="Digite um valor">
                            <button class="btn btn-success text-white" type="button" data-metric="ticketMedio" data-action="increase">
                                <i class="bi bi-plus-circle text-white"></i>
                            </button>
                            <button class="btn btn-danger text-white" type="button" data-metric="ticketMedio" data-action="decrease">
                                <i class="bi bi-dash-circle text-white"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Faturamento -->
                    <div class="col-md-12 mb-4">
                        <h5>Faturamento</h5>
                        <div class="input-group">
                            <input type="text" class="form-control" id="faturamentoOriginal" readonly>
                            <input type="text" class="form-control" id="faturamentoCalculado" readonly>
                            <input type="text" class="form-control" id="faturamentoVariacao" readonly>
                            <input type="text" class="form-control" id="faturamentoManual" placeholder="Digite um valor">
                            <button class="btn btn-success text-white" type="button" data-metric="faturamento" data-action="increase">
                                <i class="bi bi-plus-circle text-white"></i>
                            </button>
                            <button class="btn btn-danger text-white" type="button" data-metric="faturamento" data-action="decrease">
                                <i class="bi bi-dash-circle text-white"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Custos de Vendas -->
                    <div class="col-md-12 mb-4">
                        <h5>Custos de Vendas</h5>
                        <div class="input-group">
                            <input type="text" class="form-control" id="custosVendasOriginal" readonly>
                            <input type="text" class="form-control" id="custosVendasCalculado" readonly>
                            <input type="text" class="form-control" id="custosVendasVariacao" readonly>
                            <input type="text" class="form-control" id="custosVendasManual" placeholder="Digite um valor">
                            <button class="btn btn-success text-white" type="button" data-metric="custosVendas" data-action="increase">
                                <i class="bi bi-plus-circle text-white"></i>
                            </button>
                            <button class="btn btn-danger text-white" type="button" data-metric="custosVendas" data-action="decrease">
                                <i class="bi bi-dash-circle text-white"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Custos de Insumos -->
                    <div class="col-md-12 mb-4">
                        <h5>Custos de Insumos</h5>
                        <div class="input-group">
                            <input type="text" class="form-control" id="custosInsumosOriginal" readonly>
                            <input type="text" class="form-control" id="custosInsumosCalculado" readonly>
                            <input type="text" class="form-control" id="custosInsumosVariacao" readonly>
                            <input type="text" class="form-control" id="custosInsumosManual" placeholder="Digite um valor">
                            <button class="btn btn-success text-white" type="button" data-metric="custosInsumos" data-action="increase">
                                <i class="bi bi-plus-circle text-white"></i>
                            </button>
                            <button class="btn btn-danger text-white" type="button" data-metric="custosInsumos" data-action="decrease">
                                <i class="bi bi-dash-circle text-white"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Custos Fixos -->
                    <div class="col-md-12 mb-4">
                        <h5>Custos Fixos</h5>
                        <div class="input-group">
                            <input type="text" class="form-control" id="custosFixosOriginal" readonly>
                            <input type="text" class="form-control" id="custosFixosCalculado" readonly>
                            <input type="text" class="form-control" id="custosFixosVariacao" readonly>
                            <input type="text" class="form-control" id="custosFixosManual" placeholder="Digite um valor">
                            <button class="btn btn-success text-white" type="button" data-metric="custosFixos" data-action="increase">
                                <i class="bi bi-plus-circle text-white"></i>
                            </button>
                            <button class="btn btn-danger text-white" type="button" data-metric="custosFixos" data-action="decrease">
                                <i class="bi bi-dash-circle text-white"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ajuda -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel">Como usar a Gestão de Prioridades</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Esta ferramenta permite que você simule diferentes cenários para o seu negócio, baseado nos dados básicos que você já cadastrou.</p>
                    <ul>
                        <li>Selecione um período de dados básicos para análise</li>
                        <li>Defina um percentual de variação para simular diferentes cenários</li>
                        <li>Visualize os impactos das variações em diferentes métricas do negócio</li>
                        <li>Compare os valores originais com os valores calculados após as variações</li>
                        <li>Analise as variações percentuais em cada métrica</li>
                    </ul>
                    <p>Use esta ferramenta para tomar decisões baseadas em diferentes cenários e planejar ações para melhorar os resultados do seu negócio.</p>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Função para formatar valores monetários
    function formatMoney(value) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value);
    }

    // Função para formatar percentuais
    function formatPercent(value) {
        return value.toFixed(2) + '%';
    }

    // Função para calcular a variação percentual
    function calculateVariation(original, calculated) {
        if (original === 0) return 0;
        return ((calculated - original) / original) * 100;
    }

    // Event listeners para os botões de aplicar percentual em cada métrica
    document.querySelectorAll('button[data-metric]').forEach(button => {
        button.addEventListener('click', function() {
            const metric = this.getAttribute('data-metric');
            const action = this.getAttribute('data-action');
            const isIncrease = action === 'increase';
            
            // Obter o valor do campo manual
            const manualElement = document.getElementById(`${metric}Manual`);
            let percentual = parseFloat(manualElement.value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
            
            // Se não houver valor no campo manual, usar 0
            if (percentual === 0) {
                alert('Por favor, digite um valor no campo antes de aplicar a mudança.');
                return;
            }
            
            // Determinar se a métrica é um percentual ou valor monetário
            const isPercentage = metric === 'margem';
            
            applyMetricChange(metric, percentual, isIncrease, isPercentage);
        });
    });

    // Event listeners para os campos de entrada manual - apenas para exibição
    document.querySelectorAll('input[id$="Manual"]').forEach(input => {
        input.addEventListener('input', function() {
            const metric = this.id.replace('Manual', '');
            const isPercentage = metric === 'margem';
            
            // Obter o valor manual
            let manualValue = parseFloat(this.value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
            
            // Apenas atualizar o campo calculado com o valor digitado
            const calculatedElement = document.getElementById(`${metric}Calculado`);
            if (isPercentage) {
                calculatedElement.value = formatPercent(manualValue);
            } else {
                calculatedElement.value = formatMoney(manualValue);
            }
        });
    });

    // Função para aplicar a mudança percentual a uma métrica específica
    function applyMetricChange(metric, percentual, isIncrease, isPercentage) {
        const originalElement = document.getElementById(`${metric}Original`);
        const calculatedElement = document.getElementById(`${metric}Calculado`);
        const variationElement = document.getElementById(`${metric}Variacao`);
        const manualElement = document.getElementById(`${metric}Manual`);
        
        if (!originalElement || !originalElement.value) return;
        
        let original;
        if (isPercentage) {
            // Para percentuais, extrair o valor numérico do formato "XX.XX%"
            original = parseFloat(originalElement.value.replace('%', '')) || 0;
        } else {
            // Para valores monetários, extrair o valor numérico do formato "R$ XX.XX"
            original = parseFloat(originalElement.value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        }
        
        // Calcular o valor final com base na fórmula fornecida
        let calculated;
        if (isIncrease) {
            // Soma: valor_final = valor_original + (valor_original * percentual / 100)
            calculated = original + (original * percentual / 100);
        } else {
            // Subtração: valor_final = valor_original - (valor_original * percentual / 100)
            calculated = original - (original * percentual / 100);
        }
        
        // Calcular a variação percentual
        const variation = calculateVariation(original, calculated);
        
        // Atualizar os elementos na interface
        if (isPercentage) {
            calculatedElement.value = formatPercent(calculated);
        } else {
            calculatedElement.value = formatMoney(calculated);
        }
        
        // Limpar o campo manual
        manualElement.value = '';
        
        variationElement.value = formatPercent(variation);
    }

    // Função para carregar dados básicos
    function loadBasicData(basicDataId) {
        console.log("Carregando dados básicos para ID:", basicDataId);
        
        fetch(`/gestao-prioridades/api/basic-data/${basicDataId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Dados não encontrados');
                }
                return response.json();
            })
            .then(data => {
                console.log("Dados recebidos:", data);
                
                // Calcular margem
                const margem = data.sales_revenue > 0 ? 
                    ((data.sales_revenue - (data.sales_expenses + data.operational_expenses + data.fixed_costs)) / data.sales_revenue) * 100 : 0;
                
                // Calcular preço médio
                const precoMedio = data.clients_served > 0 ? data.sales_revenue / data.clients_served : 0;
                
                // Preencher os campos originais
                document.getElementById('margemOriginal').value = formatPercent(margem);
                document.getElementById('clientesOriginal').value = data.clients_served;
                document.getElementById('precoMedioOriginal').value = formatMoney(precoMedio);
                document.getElementById('ticketMedioOriginal').value = formatMoney(precoMedio);
                document.getElementById('faturamentoOriginal').value = formatMoney(data.sales_revenue);
                document.getElementById('custosVendasOriginal').value = formatMoney(data.sales_expenses);
                document.getElementById('custosInsumosOriginal').value = formatMoney(data.operational_expenses);
                document.getElementById('custosFixosOriginal').value = formatMoney(data.fixed_costs);
                
                // Inicializar os campos calculados com os valores originais
                document.getElementById('margemCalculado').value = formatPercent(margem);
                document.getElementById('clientesCalculado').value = data.clients_served;
                document.getElementById('precoMedioCalculado').value = formatMoney(precoMedio);
                document.getElementById('ticketMedioCalculado').value = formatMoney(precoMedio);
                document.getElementById('faturamentoCalculado').value = formatMoney(data.sales_revenue);
                document.getElementById('custosVendasCalculado').value = formatMoney(data.sales_expenses);
                document.getElementById('custosInsumosCalculado').value = formatMoney(data.operational_expenses);
                document.getElementById('custosFixosCalculado').value = formatMoney(data.fixed_costs);
                
                // Inicializar os campos de variação com 0%
                document.getElementById('margemVariacao').value = formatPercent(0);
                document.getElementById('clientesVariacao').value = formatPercent(0);
                document.getElementById('precoMedioVariacao').value = formatPercent(0);
                document.getElementById('ticketMedioVariacao').value = formatPercent(0);
                document.getElementById('faturamentoVariacao').value = formatPercent(0);
                document.getElementById('custosVendasVariacao').value = formatPercent(0);
                document.getElementById('custosInsumosVariacao').value = formatPercent(0);
                document.getElementById('custosFixosVariacao').value = formatPercent(0);
                
                // Limpar os campos manuais
                document.getElementById('margemManual').value = '';
                document.getElementById('clientesManual').value = '';
                document.getElementById('precoMedioManual').value = '';
                document.getElementById('ticketMedioManual').value = '';
                document.getElementById('faturamentoManual').value = '';
                document.getElementById('custosVendasManual').value = '';
                document.getElementById('custosInsumosManual').value = '';
                document.getElementById('custosFixosManual').value = '';
            })
            .catch(error => {
                console.error('Erro ao carregar dados:', error);
                alert('Erro ao carregar os dados. Por favor, tente novamente.');
            });
    }

    // Event listener para o select de dados básicos
    document.getElementById('basicDataSelect').addEventListener('change', function() {
        const basicDataId = this.value;
        loadBasicData(basicDataId);
    });

    // Carregar dados iniciais quando a página carregar
    const selectElement = document.getElementById('basicDataSelect');
    if (selectElement && selectElement.value) {
        loadBasicData(selectElement.value);
    }
});
</script>
{% endblock %} 