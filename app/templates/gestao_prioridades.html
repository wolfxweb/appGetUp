{% extends "base.html" %}

{% block title %}Gestão de Prioridades - GetUp Gestão{% endblock %}

{% block content %}
    {% include "components/navbar.html" %}
    <div class="container py-4">
        <!-- Card Principal -->
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="card-title mb-0">Gestão de Prioridades</h4>
            </div>
            <div class="card-body">
                <!-- Combo Box de Dados Básicos -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="basicDataSelect" class="form-label">
                                Selecione o Período dos dados básicos
                                <i class="bi bi-question-circle-fill ms-2 text-white" 
                                   data-bs-toggle="modal" 
                                   data-bs-target="#helpModal" 
                                   style="cursor: pointer;"></i>
                            </label>
                            <select class="form-select" id="basicDataSelect">
                                {% for data in basic_data_list %}
                                <option value="{{ data.id }}" {% if data.is_current %}selected{% endif %}>
                                    {{ data.month }}/{{ data.year }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Campos Comparativos -->
                <div class="row">
                    <!-- Margem -->
                    <div class="col-md-12 mb-4">
                        <label class="form-label">Margem</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="margemOriginal" readonly>
                            <input type="text" class="form-control" id="margemCalculado" readonly>
                            <input type="text" class="form-control" id="margemVariacao" readonly>
                            <input type="text" class="form-control" id="margemManual" placeholder="Digite um valor">
                            <button class="btn btn-success text-white" type="button" data-metric="margem" data-action="increase">
                                <i class="bi bi-plus-circle text-white" style="color: white !important;"></i>
                            </button>
                            <button class="btn btn-danger text-white" type="button" data-metric="margem" data-action="decrease">
                                <i class="bi bi-dash-circle text-white" style="color: white !important;"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Clientes -->
                    <div class="col-md-12 mb-4">
                        <label class="form-label">Clientes Atendidos</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="clientesOriginal" readonly>
                            <input type="text" class="form-control" id="clientesCalculado" readonly>
                            <input type="text" class="form-control" id="clientesVariacao" readonly>
                            <input type="text" class="form-control" id="clientesManual" placeholder="Digite um valor">
                            <button class="btn btn-success text-white" type="button" data-metric="clientes" data-action="increase">
                                <i class="bi bi-plus-circle text-white" style="color: white !important;"></i>
                            </button>
                            <button class="btn btn-danger text-white" type="button" data-metric="clientes" data-action="decrease">
                                <i class="bi bi-dash-circle text-white" style="color: white !important;"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Preço Médio -->
                    <div class="col-md-12 mb-4">
                        <label class="form-label">Preço Médio</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="precoMedioOriginal" readonly>
                            <input type="text" class="form-control" id="precoMedioCalculado" readonly>
                            <input type="text" class="form-control" id="precoMedioVariacao" readonly>
                            <input type="text" class="form-control" id="precoMedioManual" placeholder="Digite um valor">
                            <button class="btn btn-success text-white" type="button" data-metric="precoMedio" data-action="increase">
                                <i class="bi bi-plus-circle text-white" style="color: white !important;"></i>
                            </button>
                            <button class="btn btn-danger text-white" type="button" data-metric="precoMedio" data-action="decrease">
                                <i class="bi bi-dash-circle text-white" style="color: white !important;"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Ticket Médio -->
                    <div class="col-md-12 mb-4">
                        <label class="form-label">Ticket Médio</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="ticketMedioOriginal" readonly>
                            <input type="text" class="form-control" id="ticketMedioCalculado" readonly>
                            <input type="text" class="form-control" id="ticketMedioVariacao" readonly>
                            <input type="text" class="form-control" id="ticketMedioManual" placeholder="Digite um valor">
                            <button class="btn btn-success text-white" type="button" data-metric="ticketMedio" data-action="increase">
                                <i class="bi bi-plus-circle text-white" style="color: white !important;"></i>
                            </button>
                            <button class="btn btn-danger text-white" type="button" data-metric="ticketMedio" data-action="decrease">
                                <i class="bi bi-dash-circle text-white" style="color: white !important;"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Faturamento -->
                    <div class="col-md-12 mb-4">
                        <label class="form-label">Faturamento</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="faturamentoOriginal" readonly>
                            <input type="text" class="form-control" id="faturamentoCalculado" readonly>
                            <input type="text" class="form-control" id="faturamentoVariacao" readonly>
                            <input type="text" class="form-control" id="faturamentoManual" placeholder="Digite um valor">
                            <button class="btn btn-success text-white" type="button" data-metric="faturamento" data-action="increase">
                                <i class="bi bi-plus-circle text-white" style="color: white !important;"></i>
                            </button>
                            <button class="btn btn-danger text-white" type="button" data-metric="faturamento" data-action="decrease">
                                <i class="bi bi-dash-circle text-white" style="color: white !important;"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Custos de Vendas -->
                    <div class="col-md-12 mb-4">
                        <label class="form-label">Custos de Vendas</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="custosVendasOriginal" readonly>
                            <input type="text" class="form-control" id="custosVendasCalculado" readonly>
                            <input type="text" class="form-control" id="custosVendasVariacao" readonly>
                            <input type="text" class="form-control" id="custosVendasManual" placeholder="Digite um valor">
                            <button class="btn btn-success text-white" type="button" data-metric="custosVendas" data-action="increase">
                                <i class="bi bi-plus-circle text-white" style="color: white !important;"></i>
                            </button>
                            <button class="btn btn-danger text-white" type="button" data-metric="custosVendas" data-action="decrease">
                                <i class="bi bi-dash-circle text-white" style="color: white !important;"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Custos de Insumos -->
                    <div class="col-md-12 mb-4">
                        <label class="form-label">Custos de Insumos</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="custosInsumosOriginal" readonly>
                            <input type="text" class="form-control" id="custosInsumosCalculado" readonly>
                            <input type="text" class="form-control" id="custosInsumosVariacao" readonly>
                            <input type="text" class="form-control" id="custosInsumosManual" placeholder="Digite um valor">
                            <button class="btn btn-success text-white" type="button" data-metric="custosInsumos" data-action="increase">
                                <i class="bi bi-plus-circle text-white" style="color: white !important;"></i>
                            </button>
                            <button class="btn btn-danger text-white" type="button" data-metric="custosInsumos" data-action="decrease">
                                <i class="bi bi-dash-circle text-white" style="color: white !important;"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Custos Fixos -->
                    <div class="col-md-12 mb-4">
                        <label class="form-label">Custos Fixos</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="custosFixosOriginal" readonly>
                            <input type="text" class="form-control" id="custosFixosCalculado" readonly>
                            <input type="text" class="form-control" id="custosFixosVariacao" readonly>
                            <input type="text" class="form-control" id="custosFixosManual" placeholder="Digite um valor">
                            <button class="btn btn-success text-white" type="button" data-metric="custosFixos" data-action="increase">
                                <i class="bi bi-plus-circle text-white" style="color: white !important;"></i>
                            </button>
                            <button class="btn btn-danger text-white" type="button" data-metric="custosFixos" data-action="decrease">
                                <i class="bi bi-dash-circle text-white" style="color: white !important;"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ajuda -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel">Como usar a Gestão de Prioridades</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Esta ferramenta permite que você simule diferentes cenários para o seu negócio, baseado nos dados básicos que você já cadastrou.</p>
                    <ul>
                        <li>Selecione um período de dados básicos para análise</li>
                        <li>Defina um percentual de variação para simular diferentes cenários</li>
                        <li>Visualize os impactos das variações em diferentes métricas do negócio</li>
                        <li>Compare os valores originais com os valores calculados após as variações</li>
                        <li>Analise as variações percentuais em cada métrica</li>
                    </ul>
                    <p>Use esta ferramenta para tomar decisões baseadas em diferentes cenários e planejar ações para melhorar os resultados do seu negócio.</p>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Função para formatar valores monetários
    function formatMoney(value) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value);
    }

    // Função para formatar percentuais
    function formatPercent(value) {
        return value.toFixed(2) + '%';
    }

    // Função para calcular a variação percentual
    function calculateVariation(original, calculated) {
        if (original === 0) return 0;
        return ((calculated - original) / original) * 100;
    }

    // Event listeners para os botões de aplicar percentual em cada métrica
    document.querySelectorAll('button[data-metric]').forEach(button => {
        button.addEventListener('click', function() {
            const metric = this.getAttribute('data-metric');
            const action = this.getAttribute('data-action');
            const isIncrease = action === 'increase';
            
            // Obter o valor do campo manual
            const manualElement = document.getElementById(`${metric}Manual`);
            let percentual = parseFloat(manualElement.value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
            
            // Se não houver valor no campo manual, usar 0
            if (percentual === 0) {
                alert('Por favor, digite um valor no campo antes de aplicar a mudança.');
                return;
            }
            
            // Determinar se a métrica é um percentual ou valor monetário
            const isPercentage = metric === 'margem';
            
            applyMetricChange(metric, percentual, isIncrease, isPercentage);
        });
    });

    // Event listeners para os campos de entrada manual - apenas para exibição
    document.querySelectorAll('input[id$="Manual"]').forEach(input => {
        input.addEventListener('input', function() {
            const metric = this.id.replace('Manual', '');
            const isPercentage = metric === 'margem';
            
            // Obter o valor manual
            let manualValue = parseFloat(this.value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
            
            // Obter o valor original para cálculo da variação
            const originalElement = document.getElementById(`${metric}Original`);
            if (!originalElement || !originalElement.value) return;
            
            let original;
            if (isPercentage) {
                // Para percentuais, extrair o valor numérico do formato "XX.XX%"
                original = parseFloat(originalElement.value.replace('%', '')) || 0;
            } else {
                // Para valores monetários, extrair o valor numérico do formato "R$ XX.XX"
                original = parseFloat(originalElement.value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
            }
            
            // Atualizar o campo calculado
            const calculatedElement = document.getElementById(`${metric}Calculado`);
            if (isPercentage) {
                calculatedElement.value = formatPercent(manualValue);
            } else if (metric === 'clientes') {
                // Para clientes, calcular o valor com base no percentual
                const calculatedValue = original + (original * manualValue / 100);
                calculatedElement.value = Math.round(calculatedValue); // Arredondar para número inteiro
                
                // Recalcular a margem com base no novo número de clientes
                recalculateMargin();
            } else if (metric === 'precoMedio') {
                // Para preço médio, calcular o valor com base no percentual
                const calculatedValue = original + (original * manualValue / 100);
                calculatedElement.value = formatMoney(calculatedValue);
                
                // Recalcular faturamento, ticket médio e margem com base no novo preço médio
                recalculateFromPriceChange(manualValue);
            } else if (metric === 'ticketMedio') {
                // Para ticket médio, calcular o valor com base no percentual
                const calculatedValue = original + (original * manualValue / 100);
                calculatedElement.value = formatMoney(calculatedValue);
                
                // Recalcular faturamento, margem e custos com base no novo ticket médio
                recalculateFromTicketChange(manualValue);
            } else {
                calculatedElement.value = formatMoney(manualValue);
            }
            
            // Alterar a cor de fundo com base na comparação com o valor original
            if (manualValue > original) {
                calculatedElement.style.backgroundColor = '#d4edda'; // Verde claro
            } else if (manualValue < original) {
                calculatedElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
            } else {
                calculatedElement.style.backgroundColor = ''; // Cor padrão
            }
            
            // Calcular e atualizar a variação
            const variation = calculateVariation(original, manualValue);
            document.getElementById(`${metric}Variacao`).value = formatPercent(variation);
        });
    });

    // Função para recalcular a margem com base nos novos valores
    function recalculateMargin() {
        // Obter os valores originais
        const faturamentoOriginal = parseFloat(document.getElementById('faturamentoOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const custosVendasOriginal = parseFloat(document.getElementById('custosVendasOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const custosInsumosOriginal = parseFloat(document.getElementById('custosInsumosOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const custosFixosOriginal = parseFloat(document.getElementById('custosFixosOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        
        // Obter o novo número de clientes
        const clientesCalculado = parseInt(document.getElementById('clientesCalculado').value) || 0;
        const clientesOriginal = parseInt(document.getElementById('clientesOriginal').value) || 1; // Evitar divisão por zero
        
        // Calcular o fator de ajuste baseado na variação do número de clientes
        const fatorAjuste = clientesCalculado / clientesOriginal;
        
        // Calcular os novos valores com base no fator de ajuste
        const faturamentoCalculado = faturamentoOriginal * fatorAjuste;
        const custosVendasCalculado = custosVendasOriginal * fatorAjuste;
        const custosInsumosCalculado = custosInsumosOriginal * fatorAjuste;
        // Custos fixos não variam com o número de clientes
        
        // Atualizar o campo faturamentoCalculado
        document.getElementById('faturamentoCalculado').value = formatMoney(faturamentoCalculado);
        
        // Calcular e atualizar a variação do faturamento
        const variacaoFaturamento = calculateVariation(faturamentoOriginal, faturamentoCalculado);
        document.getElementById('faturamentoVariacao').value = formatPercent(variacaoFaturamento);
        
        // Alterar a cor de fundo do faturamento calculado com base na comparação
        const faturamentoCalculadoElement = document.getElementById('faturamentoCalculado');
        if (faturamentoCalculado > faturamentoOriginal) {
            faturamentoCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro
        } else if (faturamentoCalculado < faturamentoOriginal) {
            faturamentoCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
        } else {
            faturamentoCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Atualizar o campo custosVendasCalculado
        document.getElementById('custosVendasCalculado').value = formatMoney(custosVendasCalculado);
        
        // Calcular e atualizar a variação dos custos de vendas
        const variacaoCustosVendas = calculateVariation(custosVendasOriginal, custosVendasCalculado);
        document.getElementById('custosVendasVariacao').value = formatPercent(variacaoCustosVendas);
        
        // Alterar a cor de fundo dos custos de vendas calculados com base na comparação
        const custosVendasCalculadoElement = document.getElementById('custosVendasCalculado');
        if (custosVendasCalculado > custosVendasOriginal) {
            custosVendasCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro (aumento de custos é negativo)
        } else if (custosVendasCalculado < custosVendasOriginal) {
            custosVendasCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro (redução de custos é positiva)
        } else {
            custosVendasCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Atualizar o campo custosInsumosCalculado
        document.getElementById('custosInsumosCalculado').value = formatMoney(custosInsumosCalculado);
        
        // Calcular e atualizar a variação dos custos de insumos
        const variacaoCustosInsumos = calculateVariation(custosInsumosOriginal, custosInsumosCalculado);
        document.getElementById('custosInsumosVariacao').value = formatPercent(variacaoCustosInsumos);
        
        // Alterar a cor de fundo dos custos de insumos calculados com base na comparação
        const custosInsumosCalculadoElement = document.getElementById('custosInsumosCalculado');
        if (custosInsumosCalculado > custosInsumosOriginal) {
            custosInsumosCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro (aumento de custos é negativo)
        } else if (custosInsumosCalculado < custosInsumosOriginal) {
            custosInsumosCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro (redução de custos é positiva)
        } else {
            custosInsumosCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Calcular a nova margem
        const novaMargem = faturamentoCalculado > 0 ? 
            ((faturamentoCalculado - (custosVendasCalculado + custosInsumosCalculado + custosFixosOriginal)) / faturamentoCalculado) * 100 : 0;
        
        // Atualizar o campo margemCalculado
        document.getElementById('margemCalculado').value = formatPercent(novaMargem);
        
        // Obter o valor original da margem para cálculo da variação
        const margemOriginal = parseFloat(document.getElementById('margemOriginal').value.replace('%', '')) || 0;
        
        // Calcular e atualizar a variação da margem
        const variacaoMargem = calculateVariation(margemOriginal, novaMargem);
        document.getElementById('margemVariacao').value = formatPercent(variacaoMargem);
        
        // Alterar a cor de fundo da margem calculada com base na comparação
        const margemCalculadoElement = document.getElementById('margemCalculado');
        if (novaMargem > margemOriginal) {
            margemCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro
        } else if (novaMargem < margemOriginal) {
            margemCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
        } else {
            margemCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
    }

    // Função para aplicar a mudança percentual a uma métrica específica
    function applyMetricChange(metric, percentual, isIncrease, isPercentage) {
        const originalElement = document.getElementById(`${metric}Original`);
        const calculatedElement = document.getElementById(`${metric}Calculado`);
        const variationElement = document.getElementById(`${metric}Variacao`);
        const manualElement = document.getElementById(`${metric}Manual`);
        
        if (!originalElement || !originalElement.value) return;
        
        let original;
        if (isPercentage) {
            // Para percentuais, extrair o valor numérico do formato "XX.XX%"
            original = parseFloat(originalElement.value.replace('%', '')) || 0;
            console.log(`Original ${metric}: ${original}%`);
        } else {
            // Para valores monetários, extrair o valor numérico do formato "R$ XX.XX"
            original = parseFloat(originalElement.value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
            console.log(`Original ${metric}: ${original}`);
        }
        
        console.log(`Percentual aplicado: ${percentual}%`);
        console.log(`Ação: ${isIncrease ? 'Aumentar' : 'Diminuir'}`);
        
        // Calcular o valor final com base na fórmula fornecida
        let calculated;
        if (isIncrease) {
            // Soma: valor_final = valor_original + (valor_original * percentual / 100)
            calculated = original + (original * percentual / 100);
            console.log(`Cálculo: ${original} + (${original} * ${percentual} / 100) = ${calculated}`);
        } else {
            // Subtração: valor_final = valor_original - (valor_original * percentual / 100)
            calculated = original - (original * percentual / 100);
            console.log(`Cálculo: ${original} - (${original} * ${percentual} / 100) = ${calculated}`);
        }
        
        // Calcular a variação percentual
        const variation = calculateVariation(original, calculated);
        console.log(`Variação: ${variation}%`);
        
        // Atualizar os elementos na interface
        if (isPercentage) {
            calculatedElement.value = formatPercent(calculated);
            console.log(`Valor calculado: ${formatPercent(calculated)}`);
        } else if (metric === 'clientes') {
            // Para clientes, exibir como número inteiro
            calculatedElement.value = Math.round(calculated);
            console.log(`Valor calculado: ${Math.round(calculated)}`);
            
            // Recalcular a margem com base no novo número de clientes
            recalculateMargin();
        } else {
            calculatedElement.value = formatMoney(calculated);
            console.log(`Valor calculado: ${formatMoney(calculated)}`);
        }
        
        // Alterar a cor de fundo com base na comparação com o valor original
        if (calculated > original) {
            calculatedElement.style.backgroundColor = '#d4edda'; // Verde claro
        } else if (calculated < original) {
            calculatedElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
        } else {
            calculatedElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Limpar o campo manual
        manualElement.value = '';
        
        variationElement.value = formatPercent(variation);
    }

    // Função para carregar dados básicos
    function loadBasicData(basicDataId) {
        console.log("Carregando dados básicos para ID:", basicDataId);
        
        fetch(`/gestao-prioridades/api/basic-data/${basicDataId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Dados não encontrados');
                }
                return response.json();
            })
            .then(data => {
                console.log("Dados recebidos:", data);
                
                // Verificar se fixed_costs é null ou zero e usar other_fixed_costs se necessário
                const fixedCosts = (!data.fixed_costs || data.fixed_costs === 0) ? data.other_fixed_costs : data.fixed_costs;
                
                // Verificar se ideal_profit_margin é null ou zero e usar ideal_service_profit_margin se necessário
                const idealProfitMargin = (!data.ideal_profit_margin || data.ideal_profit_margin === 0) ? data.ideal_service_profit_margin : data.ideal_profit_margin;
                
                // Calcular margem
                const margem = data.sales_revenue > 0 ? 
                    ((data.sales_revenue - (data.sales_expenses + data.operational_expenses + fixedCosts)) / data.sales_revenue) * 100 : 0;
                
                // Calcular preço médio
                const precoMedio = data.clients_served > 0 ? data.sales_revenue / data.clients_served : 0;
                
                // Preencher os campos originais
                document.getElementById('margemOriginal').value = formatPercent(margem);
                document.getElementById('clientesOriginal').value = data.clients_served;
                document.getElementById('precoMedioOriginal').value = formatMoney(precoMedio);
                document.getElementById('ticketMedioOriginal').value = formatMoney(precoMedio);
                document.getElementById('faturamentoOriginal').value = formatMoney(data.sales_revenue);
                document.getElementById('custosVendasOriginal').value = formatMoney(data.sales_expenses);
                document.getElementById('custosInsumosOriginal').value = formatMoney(data.operational_expenses);
                document.getElementById('custosFixosOriginal').value = formatMoney(fixedCosts);
                
                // Inicializar os campos calculados com os valores originais
                document.getElementById('margemCalculado').value = formatPercent(margem);
                document.getElementById('clientesCalculado').value = data.clients_served;
                document.getElementById('precoMedioCalculado').value = formatMoney(precoMedio);
                document.getElementById('ticketMedioCalculado').value = formatMoney(precoMedio);
                document.getElementById('faturamentoCalculado').value = formatMoney(data.sales_revenue);
                document.getElementById('custosVendasCalculado').value = formatMoney(data.sales_expenses);
                document.getElementById('custosInsumosCalculado').value = formatMoney(data.operational_expenses);
                document.getElementById('custosFixosCalculado').value = formatMoney(fixedCosts);
                
                // Inicializar os campos de variação com 0%
                document.getElementById('margemVariacao').value = formatPercent(0);
                document.getElementById('clientesVariacao').value = formatPercent(0);
                document.getElementById('precoMedioVariacao').value = formatPercent(0);
                document.getElementById('ticketMedioVariacao').value = formatPercent(0);
                document.getElementById('faturamentoVariacao').value = formatPercent(0);
                document.getElementById('custosVendasVariacao').value = formatPercent(0);
                document.getElementById('custosInsumosVariacao').value = formatPercent(0);
                document.getElementById('custosFixosVariacao').value = formatPercent(0);
                
                // Limpar os campos manuais
                document.getElementById('margemManual').value = '';
                document.getElementById('clientesManual').value = '';
                document.getElementById('precoMedioManual').value = '';
                document.getElementById('ticketMedioManual').value = '';
                document.getElementById('faturamentoManual').value = '';
                document.getElementById('custosVendasManual').value = '';
                document.getElementById('custosInsumosManual').value = '';
                document.getElementById('custosFixosManual').value = '';
            })
            .catch(error => {
                console.error('Erro ao carregar dados:', error);
                alert('Erro ao carregar os dados. Por favor, tente novamente.');
            });
    }

    // Event listener para o select de dados básicos
    document.getElementById('basicDataSelect').addEventListener('change', function() {
        const basicDataId = this.value;
        loadBasicData(basicDataId);
    });

    // Carregar dados iniciais quando a página carregar
    const selectElement = document.getElementById('basicDataSelect');
    if (selectElement && selectElement.value) {
        loadBasicData(selectElement.value);
    }

    // Função para recalcular campos com base na mudança de preço médio
    function recalculateFromPriceChange(percentual) {
        // Obter valores originais
        const precoMedioOriginal = parseFloat(document.getElementById('precoMedioOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const clientesCalculado = parseInt(document.getElementById('clientesCalculado').value) || 0;
        const custosVendasOriginal = parseFloat(document.getElementById('custosVendasOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const custosInsumosOriginal = parseFloat(document.getElementById('custosInsumosOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const custosFixosOriginal = parseFloat(document.getElementById('custosFixosOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        
        // Calcular o novo preço médio
        const precoMedioCalculado = precoMedioOriginal + (precoMedioOriginal * percentual / 100);
        
        // Atualizar o campo preço médio calculado
        document.getElementById('precoMedioCalculado').value = formatMoney(precoMedioCalculado);
        
        // Calcular e atualizar a variação do preço médio
        const variacaoPrecoMedio = calculateVariation(precoMedioOriginal, precoMedioCalculado);
        document.getElementById('precoMedioVariacao').value = formatPercent(variacaoPrecoMedio);
        
        // Atualizar o ticket médio (mesmo valor do preço médio)
        document.getElementById('ticketMedioCalculado').value = formatMoney(precoMedioCalculado);
        document.getElementById('ticketMedioVariacao').value = formatPercent(variacaoPrecoMedio);
        
        // Alterar a cor de fundo do ticket médio calculado com base na comparação
        const ticketMedioCalculadoElement = document.getElementById('ticketMedioCalculado');
        const ticketMedioOriginal = parseFloat(document.getElementById('ticketMedioOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        if (precoMedioCalculado > ticketMedioOriginal) {
            ticketMedioCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro
        } else if (precoMedioCalculado < ticketMedioOriginal) {
            ticketMedioCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
        } else {
            ticketMedioCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Calcular o novo faturamento (preço médio * número de clientes)
        const faturamentoCalculado = precoMedioCalculado * clientesCalculado;
        document.getElementById('faturamentoCalculado').value = formatMoney(faturamentoCalculado);
        
        // Calcular e atualizar a variação do faturamento
        const faturamentoOriginal = parseFloat(document.getElementById('faturamentoOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const variacaoFaturamento = calculateVariation(faturamentoOriginal, faturamentoCalculado);
        document.getElementById('faturamentoVariacao').value = formatPercent(variacaoFaturamento);
        
        // Alterar a cor de fundo do faturamento calculado com base na comparação
        const faturamentoCalculadoElement = document.getElementById('faturamentoCalculado');
        if (faturamentoCalculado > faturamentoOriginal) {
            faturamentoCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro
        } else if (faturamentoCalculado < faturamentoOriginal) {
            faturamentoCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
        } else {
            faturamentoCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Calcular os novos custos de vendas (proporcional ao faturamento)
        const custosVendasCalculado = custosVendasOriginal * (faturamentoCalculado / faturamentoOriginal);
        document.getElementById('custosVendasCalculado').value = formatMoney(custosVendasCalculado);
        
        // Calcular e atualizar a variação dos custos de vendas
        const variacaoCustosVendas = calculateVariation(custosVendasOriginal, custosVendasCalculado);
        document.getElementById('custosVendasVariacao').value = formatPercent(variacaoCustosVendas);
        
        // Alterar a cor de fundo dos custos de vendas calculados com base na comparação
        const custosVendasCalculadoElement = document.getElementById('custosVendasCalculado');
        if (custosVendasCalculado > custosVendasOriginal) {
            custosVendasCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro (aumento de custos é negativo)
        } else if (custosVendasCalculado < custosVendasOriginal) {
            custosVendasCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro (redução de custos é positiva)
        } else {
            custosVendasCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Calcular a nova margem
        const novaMargem = faturamentoCalculado > 0 ? 
            ((faturamentoCalculado - (custosVendasCalculado + custosInsumosOriginal + custosFixosOriginal)) / faturamentoCalculado) * 100 : 0;
        
        // Atualizar o campo margemCalculado
        document.getElementById('margemCalculado').value = formatPercent(novaMargem);
        
        // Obter o valor original da margem para cálculo da variação
        const margemOriginal = parseFloat(document.getElementById('margemOriginal').value.replace('%', '')) || 0;
        
        // Calcular e atualizar a variação da margem
        const variacaoMargem = calculateVariation(margemOriginal, novaMargem);
        document.getElementById('margemVariacao').value = formatPercent(variacaoMargem);
        
        // Alterar a cor de fundo da margem calculada com base na comparação
        const margemCalculadoElement = document.getElementById('margemCalculado');
        if (novaMargem > margemOriginal) {
            margemCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro
        } else if (novaMargem < margemOriginal) {
            margemCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
        } else {
            margemCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
    }

    // Função para recalcular campos com base na mudança de ticket médio
    function recalculateFromTicketChange(percentual) {
        // Obter valores originais
        const ticketMedioOriginal = parseFloat(document.getElementById('ticketMedioOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const clientesCalculado = parseInt(document.getElementById('clientesCalculado').value) || 0;
        const custosVendasOriginal = parseFloat(document.getElementById('custosVendasOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const custosInsumosOriginal = parseFloat(document.getElementById('custosInsumosOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const custosFixosOriginal = parseFloat(document.getElementById('custosFixosOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        
        // Calcular o novo ticket médio
        const ticketMedioCalculado = ticketMedioOriginal + (ticketMedioOriginal * percentual / 100);
        
        // Atualizar o campo ticket médio calculado
        document.getElementById('ticketMedioCalculado').value = formatMoney(ticketMedioCalculado);
        
        // Calcular e atualizar a variação do ticket médio
        const variacaoTicketMedio = calculateVariation(ticketMedioOriginal, ticketMedioCalculado);
        document.getElementById('ticketMedioVariacao').value = formatPercent(variacaoTicketMedio);
        
        // Alterar a cor de fundo do ticket médio calculado com base na comparação
        const ticketMedioCalculadoElement = document.getElementById('ticketMedioCalculado');
        if (ticketMedioCalculado > ticketMedioOriginal) {
            ticketMedioCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro
        } else if (ticketMedioCalculado < ticketMedioOriginal) {
            ticketMedioCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
        } else {
            ticketMedioCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Calcular o novo faturamento (ticket médio * número de clientes)
        const faturamentoCalculado = ticketMedioCalculado * clientesCalculado;
        document.getElementById('faturamentoCalculado').value = formatMoney(faturamentoCalculado);
        
        // Calcular e atualizar a variação do faturamento
        const faturamentoOriginal = parseFloat(document.getElementById('faturamentoOriginal').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        const variacaoFaturamento = calculateVariation(faturamentoOriginal, faturamentoCalculado);
        document.getElementById('faturamentoVariacao').value = formatPercent(variacaoFaturamento);
        
        // Alterar a cor de fundo do faturamento calculado com base na comparação
        const faturamentoCalculadoElement = document.getElementById('faturamentoCalculado');
        if (faturamentoCalculado > faturamentoOriginal) {
            faturamentoCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro
        } else if (faturamentoCalculado < faturamentoOriginal) {
            faturamentoCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
        } else {
            faturamentoCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Calcular os novos custos de vendas (proporcional ao faturamento)
        const custosVendasCalculado = custosVendasOriginal * (faturamentoCalculado / faturamentoOriginal);
        document.getElementById('custosVendasCalculado').value = formatMoney(custosVendasCalculado);
        
        // Calcular e atualizar a variação dos custos de vendas
        const variacaoCustosVendas = calculateVariation(custosVendasOriginal, custosVendasCalculado);
        document.getElementById('custosVendasVariacao').value = formatPercent(variacaoCustosVendas);
        
        // Alterar a cor de fundo dos custos de vendas calculados com base na comparação
        const custosVendasCalculadoElement = document.getElementById('custosVendasCalculado');
        if (custosVendasCalculado > custosVendasOriginal) {
            custosVendasCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro (aumento de custos é negativo)
        } else if (custosVendasCalculado < custosVendasOriginal) {
            custosVendasCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro (redução de custos é positiva)
        } else {
            custosVendasCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Calcular os novos custos de insumos (proporcional ao faturamento)
        const custosInsumosCalculado = custosInsumosOriginal * (faturamentoCalculado / faturamentoOriginal);
        document.getElementById('custosInsumosCalculado').value = formatMoney(custosInsumosCalculado);
        
        // Calcular e atualizar a variação dos custos de insumos
        const variacaoCustosInsumos = calculateVariation(custosInsumosOriginal, custosInsumosCalculado);
        document.getElementById('custosInsumosVariacao').value = formatPercent(variacaoCustosInsumos);
        
        // Alterar a cor de fundo dos custos de insumos calculados com base na comparação
        const custosInsumosCalculadoElement = document.getElementById('custosInsumosCalculado');
        if (custosInsumosCalculado > custosInsumosOriginal) {
            custosInsumosCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro (aumento de custos é negativo)
        } else if (custosInsumosCalculado < custosInsumosOriginal) {
            custosInsumosCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro (redução de custos é positiva)
        } else {
            custosInsumosCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
        
        // Calcular a nova margem
        const novaMargem = faturamentoCalculado > 0 ? 
            ((faturamentoCalculado - (custosVendasCalculado + custosInsumosCalculado + custosFixosOriginal)) / faturamentoCalculado) * 100 : 0;
        
        // Atualizar o campo margemCalculado
        document.getElementById('margemCalculado').value = formatPercent(novaMargem);
        
        // Obter o valor original da margem para cálculo da variação
        const margemOriginal = parseFloat(document.getElementById('margemOriginal').value.replace('%', '')) || 0;
        
        // Calcular e atualizar a variação da margem
        const variacaoMargem = calculateVariation(margemOriginal, novaMargem);
        document.getElementById('margemVariacao').value = formatPercent(variacaoMargem);
        
        // Alterar a cor de fundo da margem calculada com base na comparação
        const margemCalculadoElement = document.getElementById('margemCalculado');
        if (novaMargem > margemOriginal) {
            margemCalculadoElement.style.backgroundColor = '#d4edda'; // Verde claro
        } else if (novaMargem < margemOriginal) {
            margemCalculadoElement.style.backgroundColor = '#f8d7da'; // Vermelho claro
        } else {
            margemCalculadoElement.style.backgroundColor = ''; // Cor padrão
        }
    }
});
</script>
{% endblock %} 