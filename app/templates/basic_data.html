{% extends "base.html" %} {% block title %}Dados Básicos{% endblock %} {% block
content %} {% with active_page='basic_data' %} {% include
'components/navbar.html' %} {% endwith %}

<div class="container-fluid p-5">
  <div class="row">
    <div class="col-md-12">
      {% if error_message %}
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ error_message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Fechar"
        ></button>
      </div>
      {% endif %} {% if success_message %}
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ success_message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Fechar"
        ></button>
      </div>
      {% endif %}

      <div class="card shadow-sm">
        <div
          class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
        >
          <h5 class="card-title mb-0">
            <i class="bi bi-graph-up"></i> Dados Básicos
          </h5>
          <a href="/basic-data/new" class="btn btn-light btn-sm">
            <i class="bi bi-plus-circle"></i> Novo Registro
          </a>
        </div>

        <div class="card-body">
          {% if basic_data %}
          <!-- Filtros para a tabela -->
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="filterMonth" class="form-label">Mês/Ano</label>
              <input type="text" class="form-control" id="filterMonth" placeholder="Filtrar por mês/ano">
            </div>
            <div class="col-md-4">
              <label for="filterClients" class="form-label">Clientes Atendidos</label>
              <input type="number" class="form-control" id="filterClients" placeholder="Filtrar por clientes">
            </div>
            <div class="col-md-4">
              <label for="filterRevenue" class="form-label">Faturamento</label>
              <input type="number" class="form-control" id="filterRevenue" placeholder="Filtrar por faturamento">
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table table-striped table-hover" id="basicDataTable">
              <thead>
                <tr>
                  <th>Mês/Ano</th>
                  <th>Clientes Atendidos</th>
                  <th>Faturamento</th>
                  <th>Gastos com Vendas</th>
                  <th>Gastos com Insumos e Produtos</th>
                  {% if user.activity_type == 'Serviços' %}
                  <th>Pró-labore</th>
                  <th>Demais Custos Fixos</th>
                  <th>Horas de Trabalho por Semana</th>
                  <th>Margem de Lucro Ideal</th>
                  {% elif user.activity_type in ['Comércio', 'Indústria'] %}
                  <th>Custos Fixos</th>
                  <th>Margem de Lucro Ideal</th>
                  {% endif %}
                  <th>Ações</th>
                </tr>
              </thead>

              <tbody>
                {% for data in basic_data %}
                <tr>
                  <td>
                    {{ ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio',
                    'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro',
                    'Novembro', 'Dezembro'][data.month - 1] }} {{ data.year }}
                  </td>
                  <td>{{ data.clients_served }}</td>
                  <td>R$ {{ "{:,.2f}".format(data.sales_revenue).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                  <td>R$ {{ "{:,.2f}".format(data.sales_expenses).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                  <td>R$ {{ "{:,.2f}".format(data.input_product_expenses).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                  {% if user.activity_type == 'Serviços' %}
                  <td>
                    R$ {{ "{:,.2f}".format(data.pro_labore).replace(",", "X").replace(".", ",").replace("X", ".") if data.pro_labore is not none else 'N/A' }}
                  </td>
                  <td>R$ {{ "{:,.2f}".format(data.other_fixed_costs).replace(",", "X").replace(".", ",").replace("X", ".") if data.other_fixed_costs is not none else 'N/A' }}</td>
                  <td>
                    {{ "%.0f"|format(data.work_hours_per_week) if data.work_hours_per_week is not none else 'N/A' }}
                  </td>
                  <td>
                    {{ "%.0f"|format(data.ideal_service_profit_margin) if data.ideal_service_profit_margin is not none else 'N/A' }}%
                  </td>
                  {% elif user.activity_type in ['Comércio', 'Indústria'] %}
                  <td>
                    {{ data.fixed_costs if data.fixed_costs is not none else 'N/A' }}
                  </td>
                  <td>
                    {{ "%.0f"|format(data.ideal_profit_margin) if data.ideal_profit_margin is not none else 'N/A' }}%
                  </td>
                  {% endif %}
                  <td>
                    <div class="btn-group" role="group">
                      <a
                        href="/basic-data/edit/{{ data.id }}"
                        class="btn btn-sm btn-outline-primary"
                      >
                        <i class="bi bi-pencil"></i>
                      </a>
                      <form
                        method="post"
                        action="/basic-data/delete/{{ data.id }}"
                        class="d-inline"
                        onsubmit="return confirm('Tem certeza que deseja excluir este registro?');"
                      >
                        <button
                          type="submit"
                          class="btn btn-sm btn-outline-danger"
                        >
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="alert alert-info text-center">
            <p>Você ainda não possui registros de Dados Básicos.</p>
            <a href="/basic-data/new" class="btn btn-primary mt-2">
              <i class="bi bi-plus-circle"></i> Criar Primeiro Registro
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_css %}
<style>
  .navbar {
    z-index: 1000;
    display: flex !important;
    visibility: visible !important;
  }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Função para filtrar a tabela
    function filterTable() {
        const monthFilter = document.getElementById('filterMonth').value.toLowerCase();
        const clientsFilter = document.getElementById('filterClients').value;
        const revenueFilter = document.getElementById('filterRevenue').value;
        
        const rows = document.getElementById('basicDataTable').getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        
        for (let row of rows) {
            const cells = row.getElementsByTagName('td');
            const month = cells[0].textContent.toLowerCase();
            const clients = cells[1].textContent;
            const revenue = parseFloat(cells[2].textContent.replace('R$ ', '').replace('.', '').replace(',', '.'));
            
            const matchesMonth = month.includes(monthFilter);
            const matchesClients = !clientsFilter || clients.includes(clientsFilter);
            const matchesRevenue = !revenueFilter || revenue >= parseFloat(revenueFilter);
            
            row.style.display = (matchesMonth && matchesClients && matchesRevenue) ? '' : 'none';
        }
    }
    
    // Adicionar eventos de filtro
    document.getElementById('filterMonth').addEventListener('input', filterTable);
    document.getElementById('filterClients').addEventListener('input', filterTable);
    document.getElementById('filterRevenue').addEventListener('input', filterTable);
});
</script>
{% endblock %}
