{% extends "base.html" %}

{% block title %}{% if edit_mode %}Editar{% else %}Novo{% endif %} Dados Básicos{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #F5F5F5;
    }
    
    .navbar {
        z-index: 1000;
        display: flex !important;
        visibility: visible !important;
    }

    .help-icon {
        cursor: pointer;
        margin-left: 5px;
        opacity: 0.7;
        transition: opacity 0.3s ease;
    }

    .help-icon:hover {
        opacity: 1;
    }

    .modal {
        z-index: 9999 !important;
    }

    .modal-backdrop {
        z-index: 9998 !important;
    }

    .custom-bg {
        background-color: #f8f9fa;
    }
    
    .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }

    #warningMessage {
        font-size: 1.1em;
        padding: 15px;
        border-left: 5px solid #ffc107;
        background-color: #fff3cd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
        position: relative;
        z-index: 10;
    }

    #warningMessage p {
        margin: 0;
    }

    #warningMessage i {
        color: #ffc107;
        font-size: 1.2em;
        margin-right: 10px;
    }

    #warningMessage a {
        font-weight: 600;
        text-decoration: none;
    }

    #warningMessage a:hover {
        text-decoration: underline;
    }

    #saveButtonContainer.hide {
        display: none !important;
    }

    .form-control, .form-select {
        background-color: #F5F5F5 !important;
    }

    .input-group-text {
        background-color: #F5F5F5 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5" style="background-color: #F5F5F5; min-height: 100vh;">
    <div class="row">
        <div class="col-12">
            {% if error_message %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {{ error_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
            {% endif %}

            {% if warning_message %}
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                {{ warning_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
            {% endif %}

           
            <div class="card shadow-sm" style="background-color: #F5F5F5;">
                <div class="card-body">
                    <!-- Logo alinhada à esquerda dentro do card -->
                    <div class="mb-4">
                        <p>Cliente tem que enviar logo</p>
                        <!--
                        <img src="{{ url_for('static', path='images/Wolfx-Logo.png') }}" alt="Gestão de Custos" class="img-fluid" style="max-width: 150px;">
                        -->
                        </div>

                    <div class="row">
                        <!-- Coluna da Logo e Texto (3 colunas) -->
                        <div class="col-md-3">
                            <div class="d-flex flex-column align-items-center">
                                <div class="mb-4">
                                    <img src="{{ url_for('static', path='images/user-register.jpg') }}" alt="Gestão de Custos" class="img-fluid" style="max-width: 200px;">
                                </div>
                                <div class="text-center">
                                    <p class="mb-2" style="font-size: 1.2rem;">
                                        Todos os dados devem se referir ao mês selecionado.
                                        Os Dados Básicos viabilizam o uso desta plataforma e determinam a atualidade e qualidade dos cálculos e análises.
                                        Se você puder anotar os dados de meses anteriores, terá uma visão mais ampla do desempenho do seu negócio.</p>

                                </div>
                            </div>
                        </div>

                        <!-- Coluna do Formulário (9 colunas) -->
                        <div class="col-md-9">
                            <!-- Nova linha com os 4 botões -->
                            <div class="row mb-4">
                                <div class="col-12 col-md-3 mb-2 mb-md-0">
                                    <a href="/dashboard" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
                                        Índice
                                    </a>
                                </div>
                                <div class="col-12 col-md-3 mb-2 mb-md-0">
                                    <button type="button" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
                                        Diagnóstico
                                    </button>
                                </div>
                                <div class="col-12 col-md-3 mb-2 mb-md-0">
                                    <button type="button" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
                                        Simulador
                                    </button>
                                </div>
                                <div class="col-12 col-md-3">
                                    <button type="button" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
                                        Calculadora de preços
                                    </button>
                                </div>
                            </div>
                            <div class="card" style="background-color: #F0F0F0;">
                                <div class="card-body">
                                    {% if user.activity_type == 'Serviços' %}
                                    <form method="post" action="{% if edit_mode %}/basic-data/update/{{ basic_data.id }}{% else %}/basic-data/save{% endif %}" id="basicDataForm">
                                        {% if show_confirm %}
                                        <input type="hidden" name="confirm_update" value="true">
                                        {% endif %}
                                      
                                        <input type="hidden" name="edit_mode" value="{{ 'true' if edit_mode else 'false' }}">
                                      
                                        <!-- Primeira linha: Mês e Ano -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="month" class="form-label">
                                                    Mês* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#monthHelpModal"></i>
                                                </label>
                                                <select class="form-select" id="month" name="month" required {% if edit_mode %}disabled{% endif %}>
                                                    {% for month in range(1, 13) %}
                                                    <option value="{{ month }}" 
                                                        {% if basic_data and basic_data.month == month %}selected{% endif %}
                                                        {% if not basic_data and month == current_month %}selected{% endif %}>
                                                        {{ ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][month-1] }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                                {% if edit_mode %}
                                                    <input type="hidden" name="month" value="{{ basic_data.month }}">
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="year" class="form-label">
                                                    Ano* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#yearHelpModal"></i>
                                                </label>
                                                <input type="number" class="form-control" id="year" name="year" 
                                                    value="{{ basic_data.year if basic_data else current_year }}" 
                                                    min="2020" required {% if edit_mode %}disabled{% endif %}>
                                                {% if edit_mode %}
                                                    <input type="hidden" name="year" value="{{ basic_data.year }}">
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Segunda linha: Clientes e Faturamento -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="clients_served" class="form-label">
                                                    Quantidade de Clientes Atendidos* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#clientsServedHelpModal"></i>
                                                </label>
                                                <input type="number" class="form-control" id="clients_served" name="clients_served" 
                                                    value="{{ basic_data.clients_served if basic_data else '' }}" required min="0">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="sales_revenue" class="form-label">
                                                    Faturamento com Vendas* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#salesRevenueHelpModal"></i>
                                                </label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="sales_revenue" name="sales_revenue" 
                                                        value="{{ (basic_data.sales_revenue/10)|round(2) if basic_data and basic_data.sales_revenue is not none else '' }}" 
                                                        required pattern="^R?\$?\s*[\d.,]+$">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Terceira linha: Gastos -->
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label for="gastos_vendas" class="form-label">
                                                    Gastos com Vendas* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#salesExpensesHelpModal"></i>
                                                </label>
                                                <div class="input-group">
                                                    <div class="col-9 p-0">
                                                        <input type="text" class="form-control" id="gastos_vendas" name="gastos_vendas" required>
                                                    </div>
                                                    <div class="col-3 p-0">
                                                        <input type="text" class="form-control" id="gastos_vendas_percentual" name="gastos_vendas_percentual" readonly>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="gastos_insumos" class="form-label">
                                                    Gastos com Insumos e Produtos* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#inputProductExpensesHelpModal"></i>
                                                </label>
                                                <div class="input-group">
                                                    <div class="col-9 p-0">
                                                        <input type="text" class="form-control" id="gastos_insumos" name="gastos_insumos" required>
                                                    </div>
                                                    <div class="col-3 p-0">
                                                        <input type="text" class="form-control" id="gastos_insumos_percentual" name="gastos_insumos_percentual" readonly>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Quarta linha: Pró-labore e Custos Fixos -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="pro_labore" class="form-label">
                                                    Pró-labore 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#proLaboreHelpModal"></i>
                                                </label>
                                                <div class="input-group">
                                                    <div class="col-9 p-0">
                                                        <input type="text" class="form-control" id="pro_labore" name="pro_labore" 
                                                            value="{{ (basic_data.pro_labore/10)|round(2) if basic_data and basic_data.pro_labore is not none else '' }}">
                                                    </div>
                                                    <div class="col-3 p-0">
                                                        <input type="text" class="form-control" placeholder="" name="pro_labore_percentual">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="demais_custos_fixos" class="form-label">
                                                    Demais Custos Fixos* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#otherFixedCostsHelpModal"></i>
                                                </label>
                                                <div class="input-group">
                                                    <div class="col-9 p-0">
                                                        <input type="text" class="form-control" id="demais_custos_fixos" name="demais_custos_fixos" required>
                                                    </div>
                                                    <div class="col-3 p-0">
                                                        <input type="text" class="form-control" id="demais_custos_fixos_percentual" name="demais_custos_fixos_percentual" readonly>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Quinta linha: Horas e Capacidade -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="work_hours_per_week" class="form-label">
                                                    Horas de Trabalho por Semana 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#workHoursHelpModal"></i>
                                                </label>
                                                <input type="number" step="1" class="form-control" id="work_hours_per_week" name="work_hours_per_week" 
                                                    value="{{ basic_data.work_hours_per_week|int if basic_data and basic_data.work_hours_per_week else '' }}" min="0" max="168">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="service_capacity" class="form-label">
                                                    Capacidade de Atendimento 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#serviceCapacityHelpModal"></i>
                                                </label>
                                                <input type="text" class="form-control" id="service_capacity" name="service_capacity" 
                                                    value="{{ basic_data.service_capacity if basic_data else '' }}">
                                            </div>
                                        </div>

                                        <!-- Sexta linha: Margem de Lucro -->
                                        <div class="row justify-content-center">
                                            <div class="col-md-4">
                                                <div class="text-center mb-2">
                                                    <label for="ideal_service_profit_margin" class="form-label">
                                                        Margem de Lucro Ideal (%)
                                                        <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#idealServiceProfitMarginHelpModal"></i>
                                                    </label>
                                                </div>
                                                <div class="input-group">
                                                    <input type="number" step="1" class="form-control" id="ideal_service_profit_margin" name="ideal_service_profit_margin" 
                                                        value="{{ basic_data.ideal_service_profit_margin|int if basic_data and basic_data.ideal_service_profit_margin else '' }}" min="0" max="100">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row mt-4">
                                            <div class="col-12 text-center">
                                                <button type="button" class="btn btn-secondary me-2" style="background-color: #6c757d; border-color: #6c757d;" onclick="document.getElementById('basicDataForm').reset();">
                                                    Limpar
                                                </button>
                                                <button type="submit" class="btn btn-secondary me-2" style="background-color: #6c757d; border-color: #6c757d;">
                                                    Salvar
                                                </button>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-12 text-center">
                                                <a href="/basic-data/history" class="btn btn-secondary" style="background-color: #6c757d; border-color: #6c757d;">
                                                    Histórico
                                                </a>
                                            </div>
                                        </div>
                                    </form>
                                    {% else %}
                                    <form method="post" action="{% if edit_mode %}/basic-data/update/{{ basic_data.id }}{% else %}/basic-data/save{% endif %}" id="basicDataForm">
                                        {% if show_confirm %}
                                        <input type="hidden" name="confirm_update" value="true">
                                        {% endif %}
                                      
                                        <input type="hidden" name="edit_mode" value="{{ 'true' if edit_mode else 'false' }}">
                                      
                                        <!-- Primeira linha: Mês e Ano -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="month" class="form-label">
                                                    Mês* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#monthHelpModal"></i>
                                                </label>
                                                <select class="form-select" id="month" name="month" required {% if edit_mode %}disabled{% endif %}>
                                                    {% for month in range(1, 13) %}
                                                    <option value="{{ month }}" 
                                                        {% if basic_data and basic_data.month == month %}selected{% endif %}
                                                        {% if not basic_data and month == current_month %}selected{% endif %}>
                                                        {{ ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][month-1] }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                                {% if edit_mode %}
                                                    <input type="hidden" name="month" value="{{ basic_data.month }}">
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="year" class="form-label">
                                                    Ano* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#yearHelpModal"></i>
                                                </label>
                                                <input type="number" class="form-control" id="year" name="year" 
                                                    value="{{ basic_data.year if basic_data else current_year }}" 
                                                    min="2020" required {% if edit_mode %}disabled{% endif %}>
                                                {% if edit_mode %}
                                                    <input type="hidden" name="year" value="{{ basic_data.year }}">
                                                {% endif %}
                                            </div>
                                        </div>
                
                                        <!-- Segunda linha: Clientes e Faturamento -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="clients_served" class="form-label">
                                                    Quantidade de Clientes Atendidos* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#clientsServedHelpModal"></i>
                                                </label>
                                                <input type="number" class="form-control" id="clients_served" name="clients_served" 
                                                    value="{{ basic_data.clients_served if basic_data else '' }}" required min="0">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="sales_revenue" class="form-label">
                                                    Faturamento com Vendas* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#salesRevenueHelpModal"></i>
                                                </label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="sales_revenue" name="sales_revenue" 
                                                        value="{{ (basic_data.sales_revenue/10)|round(2) if basic_data and basic_data.sales_revenue is not none else '' }}" 
                                                        required pattern="^R?\$?\s*[\d.,]+$">
                                                </div>
                                            </div>
                                        </div>
                
                                        <!-- Terceira linha: Gastos -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="gastos_vendas" class="form-label">
                                                    Gastos com Vendas* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#salesExpensesHelpModal"></i>
                                                </label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="gastos_vendas" name="gastos_vendas" required>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="gastos_insumos" class="form-label">
                                                    Gastos com Insumos e Produtos* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#inputProductExpensesHelpModal"></i>
                                                </label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="gastos_insumos" name="gastos_insumos" required>
                                                </div>
                                            </div>
                                        </div>
                
                                        <!-- Quarta linha: Margem de Lucro -->
                                        <div class="row justify-content-center">
                                            <div class="col-md-4">
                                                <div class="text-center mb-2">
                                                    <label for="ideal_service_profit_margin" class="form-label">
                                                        Margem de Lucro Ideal (%)
                                                        <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#idealServiceProfitMarginHelpModal"></i>
                                                    </label>
                                                </div>
                                                <div class="input-group">
                                                    <input type="number" step="1" class="form-control" id="ideal_service_profit_margin" name="ideal_service_profit_margin" 
                                                        value="{{ basic_data.ideal_service_profit_margin|int if basic_data and basic_data.ideal_service_profit_margin else '' }}" min="0" max="100">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                        </div>
                
                                        <div class="row mt-4">
                                            <div class="col-12 text-center">
                                                <button type="button" class="btn btn-secondary me-2" style="background-color: #6c757d; border-color: #6c757d;" onclick="document.getElementById('basicDataForm').reset();">
                                                    Limpar
                                                </button>
                                                <button type="submit" class="btn btn-secondary me-2" style="background-color: #6c757d; border-color: #6c757d;">
                                                    Salvar
                                                </button>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-12 text-center">
                                                <a href="/basic-data/history" class="btn btn-secondary" style="background-color: #6c757d; border-color: #6c757d;">
                                                    Histórico
                                                </a>
                                            </div>
                                        </div>
                                    </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>  
        </div>
    </div>

    <!-- Tabela de Logs - Movida para fora do card principal -->
    {% if edit_mode %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Histórico de Alterações</h5>
                </div>
                <div class="card-body">
                    <!-- Filtros para o histórico -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="logFilter" placeholder="Filtrar por descrição...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                <input type="date" class="form-control" id="dateFilter">
                            </div>
                        </div>
                    </div>
                    
                    <table class="table table-striped" id="logsTable">
                        <thead>
                            <tr>
                                <th>Descrição da Alteração</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in logs %}
                            <tr>
                                <td>{{ log.change_description }}</td>
                                <td>{{ log.created_at.strftime('%d/%m/%Y') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% if logs|length == 0 %}
                    <p class="text-muted">Nenhuma alteração registrada.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="confirmReplaceModal" tabindex="-1" data-bs-backdrop="static" aria-labelledby="confirmReplaceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmReplaceModalLabel">Confirmar Substituição</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                Já existe um registro para este mês. Deseja substituir?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não</button>
                <button type="button" class="btn btn-primary" id="confirmReplace">Sim</button>
            </div>
        </div>
    </div>
</div>
  
<!-- Help Modals -->
<div class="modal fade" id="monthHelpModal" tabindex="-1" aria-labelledby="monthHelpModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mês</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Selecione o mês correspondente aos dados que você está registrando. Por padrão, o mês atual é selecionado.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="yearHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ano</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Insira o ano correspondente aos dados que você está registrando. O ano atual é selecionado por padrão.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="clientsServedHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Clientes Atendidos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Informe o número total de clientes atendidos no período. Considere todos os clientes que receberam seus serviços ou produtos.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="salesRevenueHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Faturamento com Vendas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Registre o valor total de receitas geradas pelas vendas no período. Inclua todos os valores recebidos de clientes.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="salesExpensesHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gastos com Vendas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Informe todos os custos diretamente relacionados às vendas, como comissões, taxas de transação, despesas de marketing, etc.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="inputProductExpensesHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gastos com Insumos e Produtos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Registre o valor gasto em matérias-primas, produtos para revenda ou insumos necessários para a produção ou prestação de serviços.
            </div>
        </div>
    </div>
</div>

{% if user.activity_type in ['Comércio', 'Indústria'] %}
<div class="modal fade" id="fixedCostsHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Custos Fixos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Informe os custos que permanecem constantes independentemente do volume de vendas, como aluguel, salários fixos, energia, água, etc.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="idealProfitMarginHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Margem de Lucro Ideal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Indique a porcentagem de lucro que você considera ideal para seu negócio após descontar todos os custos e despesas.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="serviceCapacityHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Capacidade de Atendimento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Descreva sua capacidade de atendimento, como número máximo de clientes, produtos que pode produzir, ou serviços que pode realizar.
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if user.activity_type == 'Serviços' %}
<div class="modal fade" id="proLaboreHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pró-labore</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Registre o valor do pró-labore, que é a remuneração do empresário pelos serviços prestados à empresa.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="workHoursHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Horas de Trabalho por Semana</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Informe o total de horas trabalhadas por semana. O máximo possível é 168 horas (7 dias * 24 horas).
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="otherFixedCostsHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Demais Custos Fixos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Registre outros custos fixos não cobertos anteriormente, como despesas administrativas, manutenção de equipamentos, etc.
            </div>
        </div>
    </div>
</div>
{% endif %}
<div class="modal fade" id="idealServiceProfitMarginHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Margem de Lucro Ideal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Indique a porcentagem de lucro que você considera ideal para seus serviços após descontar todos os custos e despesas.
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('basicDataForm');
    
    // Função para validar o formulário
    function validateForm() {
        let isValid = true;
        
        // Validar campos monetários
        const currencyFields = ['sales_revenue', 'sales_expenses', 'input_product_expenses'];
        currencyFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                const value = field.value.trim();
                if (!value || !value.match(/^R?\$?\s*[\d.,]+$/)) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            }
        });
        
        return isValid;
    }
    
    // Adicionar evento de submit ao formulário
    form.addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
            return false;
        }
    });
    
    // Adicionar eventos de input para validação em tempo real
    const currencyFields = ['sales_revenue', 'sales_expenses', 'input_product_expenses'];
    currencyFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', function() {
                if (this.value.trim().match(/^R?\$?\s*[\d.,]+$/)) {
                    this.classList.remove('is-invalid');
                } else {
                    this.classList.add('is-invalid');
                }
            });
        }
    });
    
    // Definir variáveis globais
    const isEditMode = {% if edit_mode %}true{% else %}false{% endif %};
    const confirmReplaceModal = document.getElementById('confirmReplaceModal');
    const confirmModal = new bootstrap.Modal(confirmReplaceModal, {
        backdrop: 'static',
        keyboard: false
    });
    let isConfirmed = false;

    // Lista de campos que devem ser formatados como moeda
    const currencyInputs = [
        'sales_revenue', 
        'sales_expenses', 
        'input_product_expenses', 
        'fixed_costs', 
        'pro_labore', 
        'other_fixed_costs'
    ];
    console.log(currencyInputs);

    // Função para validar o campo ideal_service_profit_margin
    function validateProfitMarginInput(input) {
        let value = parseFloat(input.value);
        
        // Se o valor for negativo, definir como 0
        if (value < 0) {
            value = 0;
        }
        
        // Se o valor for maior que 100, definir como 100
        if (value > 100) {
            value = 100;
        }
        
        // Atualizar o valor do campo
        input.value = value;
    }

    // Adicionar evento para validar o campo ideal_service_profit_margin
    const profitMarginInput = document.getElementById('ideal_service_profit_margin');
    if (profitMarginInput) {
        profitMarginInput.addEventListener('input', function() {
            validateProfitMarginInput(this);
        });
        
        profitMarginInput.addEventListener('blur', function() {
            validateProfitMarginInput(this);
        });
    }

    // Função para formatar valor como moeda brasileira (R$)
    function formatCurrency(value) {
        // Remover todos os caracteres não numéricos, exceto ponto e vírgula
        let numericValue = value.replace(/[^\d,.-]/g, '');
        
        // Tratar separadores de milhares e decimais
        // Primeiro, remover todos os pontos (separadores de milhares)
        numericValue = numericValue.replace(/\./g, '');
        
        // Substituir vírgula por ponto para conversão
        numericValue = numericValue.replace(',', '.');
        
        // Converter para número
        let number = parseFloat(numericValue);
        
        // Verificar se é um número válido
        if (isNaN(number)) {
            return '';
        }
        
        // Formatar como moeda brasileira sem o símbolo R$
        return new Intl.NumberFormat('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(number);
    }

    // Função para converter valor formatado para número (para envio ao banco)
    function currencyToNumber(value) {
        // Remover todos os caracteres não numéricos, exceto ponto e vírgula
        let numericValue = value.replace(/[^\d,.-]/g, '');
        
        // Verificar se o valor contém vírgula (formato brasileiro)
        if (numericValue.includes(',')) {
            // Se contém vírgula, tratar como formato brasileiro (65.000,00)
            
            // Remover todos os pontos (separadores de milhares)
            numericValue = numericValue.replace(/\./g, '');
            
            // Substituir vírgula por ponto para conversão
            numericValue = numericValue.replace(',', '.');
        } else if (numericValue.includes('.')) {
            // Se contém ponto, verificar se é formato americano (65,000.00) ou brasileiro (65.000,00)
            
            // Verificar se o último ponto é seguido por dois dígitos (formato americano)
            const parts = numericValue.split('.');
            if (parts.length > 1 && parts[parts.length - 1].length === 2) {
                // Formato americano (65,000.00), não precisa fazer nada
            } else {
                // Formato brasileiro com ponto (65.000,00), remover pontos
                numericValue = numericValue.replace(/\./g, '');
            }
        }
        
        // Converter para número
        let number = parseFloat(numericValue);
        
        // Verificar se é um número válido
        if (isNaN(number)) {
            return 0;
        }
        
        // Retornar com 2 casas decimais
        // NÃO multiplicar por 100, apenas retornar o valor exato
        return number;
    }

    // Função para aplicar formatação em tempo real
    function setupCurrencyInputs() {
        currencyInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                // Formatar valor inicial se existir
                if (input.value) {
                    input.value = formatCurrency(input.value);
                }
                
                // Adicionar evento para formatação em tempo real
                input.addEventListener('input', function(e) {
                    // Obter posição do cursor
                    const cursorPosition = this.selectionStart;
                    
                    // Formatar o valor
                    const formattedValue = formatCurrency(this.value);
                    
                    // Atualizar o valor do campo
                    this.value = formattedValue;
                    
                    // Ajustar a posição do cursor
                    if (cursorPosition) {
                        // Calcular nova posição do cursor
                        const newPosition = cursorPosition + (formattedValue.length - this.value.length);
                        this.setSelectionRange(newPosition, newPosition);
                    }
                });
                
                // Adicionar evento para formatação ao perder o foco
                input.addEventListener('blur', function() {
                    this.value = formatCurrency(this.value);
                });
            }
        });
    }

    // Função para preparar os dados antes do envio do formulário
    function prepareFormData() {
        // Lista de campos que devem ser formatados como moeda
        const currencyInputs = [
            'sales_revenue', 
            'sales_expenses', 
            'input_product_expenses', 
            'fixed_costs', 
            'pro_labore', 
            'other_fixed_costs'
        ];
        
        // Processar campos monetários
        currencyInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input && input.value) {
                // Converter para número antes do envio
                const numericValue = currencyToNumber(input.value);
                
                // Atualizar o valor do campo original com o valor numérico
                input.value = numericValue;
                
                // Log para debug
                console.log(`Campo ${inputId}: valor original = ${input.value}, valor convertido = ${numericValue}`);
            }
        });
        
        // Log todos os campos do formulário para debug
        const formData = new FormData(form);
        console.log('Dados do formulário antes do envio:', Object.fromEntries(formData));
    }

    // Inicializar formatação de campos monetários
    setupCurrencyInputs();

    // Função para verificar se já existem dados para o mês/ano selecionado
    async function checkExistingData() {
        // Se estiver em modo de edição, não fazer a verificação
        if (isEditMode) return;
        
        const month = document.getElementById('month').value;
        const year = document.getElementById('year').value;
        const saveButtonContainer = document.getElementById('saveButtonContainer');
        const warningMessage = document.getElementById('warningMessage');
        
        // Mostrar mensagem de carregamento
        if (warningMessage) {
            warningMessage.style.display = 'block';
            warningMessage.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle"></i> Verificando dados existentes...</div>';
        }
        
        try {
            const response = await fetch(`/basic-data/check/${year}/${month}`);
            const data = await response.json();

            if (data.exists) {
                // Se existem dados, ocultar o botão de salvar e mostrar a mensagem de aviso
                if (saveButtonContainer) {
                    saveButtonContainer.style.display = 'none';
                }
                
                // Mostrar a mensagem de aviso
                if (warningMessage) {
                    warningMessage.innerHTML = `
                        <div class="alert alert-warning" role="alert">
                            <i class="bi bi-exclamation-triangle-fill" style="color: red !important;"></i>
                            <strong>Atenção!</strong> Já existem dados básicos cadastrados para ${month}/${year}.
                            <br>
                            Você pode:
                            <ul class="mb-0">
                                <li><a href="/basic-data" class="alert-link">Voltar à tela de consulta</a> para ver os dados existentes</li>
                            </ul>
                        </div>
                    `;
                    warningMessage.style.display = 'block';
                }
            } else {
                // Se não existem dados, mostrar o botão de salvar e ocultar a mensagem de aviso
                if (saveButtonContainer) {
                    saveButtonContainer.style.display = 'block';
                }
                
                // Ocultar a mensagem de aviso
                if (warningMessage) {
                    warningMessage.style.display = 'none';
                }
            }
        } catch (error) {
            console.error('Erro ao verificar dados existentes:', error);
            if (warningMessage) {
                warningMessage.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        Erro ao verificar dados existentes. Por favor, tente novamente.
                    </div>
                `;
                warningMessage.style.display = 'block';
            }
        }
    }

    // Verificar dados existentes ao carregar a página e quando houver mudanças
    if (!isEditMode) {
        // Verificar imediatamente ao carregar a página
        checkExistingData();
        
        // Adicionar eventos para verificar quando o mês ou ano mudar
        const monthSelect = document.getElementById('month');
        const yearInput = document.getElementById('year');
        
        if (monthSelect) {
            monthSelect.addEventListener('change', function() {
                checkExistingData();
            });
        }
        
        if (yearInput) {
            yearInput.addEventListener('input', function() {
                checkExistingData();
            });
            yearInput.addEventListener('change', function() {
                checkExistingData();
            });
        }
    }

    // Função para validar campos obrigatórios
    function validateRequiredFields() {
        // Campos obrigatórios base
        const baseRequiredFields = [
            { id: 'clients_served', name: 'Quantidade de Clientes Atendidos' },
            { id: 'sales_revenue', name: 'Faturamento com Vendas' },
            { id: 'sales_expenses', name: 'Gastos com Vendas' },
            { id: 'input_product_expenses', name: 'Gastos com Insumos e Produtos' }
        ];

        // Campos obrigatórios adicionais para Serviços
        const servicesRequiredFields = [
            { id: 'pro_labore', name: 'Pró-labore' },
            { id: 'other_fixed_costs', name: 'Demais Custos Fixos' },
            { id: 'work_hours_per_week', name: 'Horas de Trabalho por Semana' },
            { id: 'ideal_service_profit_margin', name: 'Margem de Lucro Ideal (%)' }
        ];

        // Determinar se é do tipo Serviços
        const isServicesType = {% if user.activity_type == 'Serviços' %}true{% else %}false{% endif %};

        // Combinar campos obrigatórios base com campos adicionais se for do tipo Serviços
        const requiredFields = isServicesType 
            ? [...baseRequiredFields, ...servicesRequiredFields]
            : baseRequiredFields;

        let isValid = true;
        let missingFields = [];

        requiredFields.forEach(field => {
            const input = document.getElementById(field.id);
            if (!input || !input.value.trim()) {
                isValid = false;
                missingFields.push(field.name);
                input.classList.add('is-invalid');
            } else {
                input.classList.remove('is-invalid');
            }
        });

        if (!isValid) {
            // Verificar se já existe um alerta de campos obrigatórios
            let existingAlert = document.querySelector('.alert-danger[data-type="required-fields"]');
            
            if (!existingAlert) {
                existingAlert = document.createElement('div');
                existingAlert.className = 'alert alert-danger alert-dismissible fade show';
                existingAlert.setAttribute('data-type', 'required-fields');
                existingAlert.role = 'alert';
                existingAlert.innerHTML = `
                    <strong>Campos obrigatórios não preenchidos:</strong>
                    <ul class="mb-0">
                        ${missingFields.map(field => `<li>${field}</li>`).join('')}
                    </ul>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                `;

                // Inserir o novo alerta antes do formulário
                const form = document.getElementById('basicDataForm');
                form.parentNode.insertBefore(existingAlert, form);
            } else {
                // Atualizar o conteúdo do alerta existente
                existingAlert.querySelector('ul').innerHTML = missingFields.map(field => `<li>${field}</li>`).join('');
            }

            // Rolar até o alerta
            existingAlert.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            // Remover o alerta de campos obrigatórios se existir
            const existingAlert = document.querySelector('.alert-danger[data-type="required-fields"]');
            if (existingAlert) {
                existingAlert.remove();
            }
        }

        return isValid;
    }

    // Modificar o evento de submit do formulário
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Validar campos obrigatórios
        if (!validateRequiredFields()) {
            return;
        }

        // Se estiver em modo de edição, enviar o formulário diretamente
        if (isEditMode) {
            console.log('Modo de edição: true, enviando formulário diretamente');
            prepareFormData();
            form.submit();
            return;
        }

        // Se já foi confirmado, permite o envio
        if (isConfirmed) {
            prepareFormData();
            form.submit();
            return;
        }

        // Verifica se já existe registro para o mês/ano selecionado (apenas para novo registro)
        const month = document.getElementById('month').value;
        const year = document.getElementById('year').value;
        
        try {
            const response = await fetch(`/basic-data/check/${year}/${month}`);
            const data = await response.json();

            if (data.exists) {
                // Se existe, mostra o modal de confirmação
                confirmModal.show();
            } else {
                // Se não existe, envia o formulário normalmente
                prepareFormData();
                form.submit();
            }
        } catch (error) {
            console.error('Erro ao verificar dados existentes:', error);
            prepareFormData();
            form.submit(); // Em caso de erro, tenta enviar mesmo assim
        }
    });

    // Botão de confirmação no modal
    document.getElementById('confirmReplace').addEventListener('click', function() {
        isConfirmed = true;
        confirmModal.hide();
        
        // Remover qualquer backdrop residual
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => {
            backdrop.parentNode.removeChild(backdrop);
        });
        
        // Remover classes que o Bootstrap adiciona ao body
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');
        
        // Submeter o formulário após um breve delay
        setTimeout(() => {
            prepareFormData();
            form.submit();
        }, 100);
    });

    // Reset da confirmação quando o modal é fechado
    confirmReplaceModal.addEventListener('hidden.bs.modal', function() {
        if (!isConfirmed) {
            isConfirmed = false;
        }
        
        // Remover qualquer backdrop residual quando o modal é fechado por qualquer razão
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => {
            backdrop.parentNode.removeChild(backdrop);
        });
        
        // Remover classes que o Bootstrap adiciona ao body
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');
    });

    // Modificar o evento do botão de atualizar
    document.getElementById('updateButton')?.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Validar campos obrigatórios
        if (!validateRequiredFields()) {
            return;
        }
        
        prepareFormData();
        form.submit();
    });

    // Modificar o evento do botão de salvar
    document.getElementById('saveButton')?.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Validar campos obrigatórios
        if (!validateRequiredFields()) {
            return;
        }
        
        prepareFormData();
        form.submit();
    });
    
    // Implementação do filtro para a tabela de logs
    const logFilter = document.getElementById('logFilter');
    const dateFilter = document.getElementById('dateFilter');
    const logsTable = document.getElementById('logsTable');
    
    if (logFilter && dateFilter && logsTable) {
        // Função para filtrar a tabela
        function filterLogsTable() {
            const filterText = logFilter.value.toLowerCase();
            const filterDate = dateFilter.value;
            
            const rows = logsTable.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const description = row.cells[0].textContent.toLowerCase();
                const dateCell = row.cells[1].textContent;
                
                // Verificar se a descrição contém o texto do filtro
                const matchesText = description.includes(filterText);
                
                // Verificar se a data corresponde ao filtro de data
                let matchesDate = true;
                if (filterDate) {
                    // Converter a data do formato dd/mm/yyyy para yyyy-mm-dd para comparação
                    const dateParts = dateCell.split(' ')[0].split('/');
                    const rowDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                    matchesDate = rowDate === filterDate;
                }
                
                // Mostrar ou esconder a linha com base nos filtros
                if (matchesText && matchesDate) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Verificar se há linhas visíveis
            const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
            const noResultsMessage = logsTable.nextElementSibling;
            
            if (visibleRows.length === 0) {
                if (!noResultsMessage || !noResultsMessage.classList.contains('text-muted')) {
                    const message = document.createElement('p');
                    message.className = 'text-muted mt-3';
                    message.textContent = 'Nenhum resultado encontrado.';
                    logsTable.parentNode.insertBefore(message, logsTable.nextSibling);
                }
            } else if (noResultsMessage && noResultsMessage.classList.contains('text-muted')) {
                noResultsMessage.remove();
            }
        }
        
        // Adicionar eventos para os filtros
        logFilter.addEventListener('input', filterLogsTable);
        dateFilter.addEventListener('change', filterLogsTable);
    }

    // Função para calcular porcentagem
    function calcularPorcentagem(valor, receita) {
        if (!valor || !receita || receita === 0) return '0%';
        const porcentagem = (parseFloat(valor) / parseFloat(receita)) * 100;
        return porcentagem.toFixed(2) + '%';
    }

    // Função para atualizar todas as porcentagens
    function atualizarPorcentagens() {
        const receita = document.getElementById('sales_revenue').value.replace(/[^\d,]/g, '').replace(',', '.');
        
        // Pro-labore
        const proLabore = document.getElementById('pro_labore').value.replace(/[^\d,]/g, '').replace(',', '.');
        document.getElementById('pro_labore_percentual').value = calcularPorcentagem(proLabore, receita);
        
        // Gastos com Vendas
        const gastosVendas = document.getElementById('gastos_vendas').value.replace(/[^\d,]/g, '').replace(',', '.');
        document.getElementById('gastos_vendas_percentual').value = calcularPorcentagem(gastosVendas, receita);
        
        // Gastos com Insumos
        const gastosInsumos = document.getElementById('gastos_insumos').value.replace(/[^\d,]/g, '').replace(',', '.');
        document.getElementById('gastos_insumos_percentual').value = calcularPorcentagem(gastosInsumos, receita);
        
        // Demais Custos Fixos
        const demaisCustos = document.getElementById('demais_custos_fixos').value.replace(/[^\d,]/g, '').replace(',', '.');
        document.getElementById('demais_custos_fixos_percentual').value = calcularPorcentagem(demaisCustos, receita);
    }

    // Adicionar event listeners para os campos
    document.getElementById('sales_revenue').addEventListener('input', atualizarPorcentagens);
    document.getElementById('pro_labore').addEventListener('input', atualizarPorcentagens);
    document.getElementById('gastos_vendas').addEventListener('input', atualizarPorcentagens);
    document.getElementById('gastos_insumos').addEventListener('input', atualizarPorcentagens);
    document.getElementById('demais_custos_fixos').addEventListener('input', atualizarPorcentagens);

    // Atualizar porcentagens ao carregar a página
    document.addEventListener('DOMContentLoaded', atualizarPorcentagens);
});
</script>
{% endblock %}