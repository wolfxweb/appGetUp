{% extends "base.html" %}

{% block title %}{% if edit_mode %}Editar{% else %}Novo{% endif %} Dados Básicos{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #F5F5F5;
    }
    
    .navbar {
        z-index: 1000;
        display: flex !important;
        visibility: visible !important;
    }

    .help-icon {
        cursor: pointer;
        margin-left: 5px;
        opacity: 0.7;
        transition: opacity 0.3s ease;
    }

    .help-icon:hover {
        opacity: 1;
    }

    .modal {
        z-index: 9999 !important;
    }

    .modal-backdrop {
        z-index: 9998 !important;
    }

    .custom-bg {
        background-color: #f8f9fa;
    }
    
    .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }

    #warningMessage {
        font-size: 1.1em;
        padding: 15px;
        border-left: 5px solid #ffc107;
        background-color: #fff3cd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
        position: relative;
        z-index: 10;
    }

    #warningMessage p {
        margin: 0;
    }

    #warningMessage i {
        color: #ffc107;
        font-size: 1.2em;
        margin-right: 10px;
    }

    #warningMessage a {
        font-weight: 600;
        text-decoration: none;
    }

    #warningMessage a:hover {
        text-decoration: underline;
    }

    #saveButtonContainer.hide {
        display: none !important;
    }

    .form-control, .form-select {
        background-color: #F5F5F5 !important;
    }

    .input-group-text {
        background-color: #F5F5F5 !important;
    }

    .invalid-percentage {
        background-color: #ffebee !important;
        border-color: #dc3545 !important;
        color: #dc3545 !important;
    }

    #other_fixed_costs_percentual.invalid-percentage {
        background-color: #ffebee !important;
        border-color: #dc3545 !important;
        color: #dc3545 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5" style="background-color: #F5F5F5; min-height: 100vh;">
    <div class="row">
        <div class="col-12">
            {% if error_message %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {{ error_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
            {% endif %}

            {% if warning_message %}
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                {{ warning_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
            {% endif %}

           
            <div class="card shadow-sm" style="background-color: #F5F5F5;">
                <div class="card-body">
                    <!-- Logo alinhada à esquerda dentro do card -->
                    <div class="mb-4">
                        <p>Cliente tem que enviar logo</p>
                        <!--
                        <img src="{{ url_for('static', path='images/Wolfx-Logo.png') }}" alt="Gestão de Custos" class="img-fluid" style="max-width: 150px;">
                        -->
                        </div>

                    <div class="row">
                        <!-- Coluna da Logo e Texto (3 colunas) -->
                        <div class="col-md-3">
                            <div class="d-flex flex-column align-items-center">
                                <div class="mb-4">
                                    <img src="{{ url_for('static', path='images/user-register.jpg') }}" alt="Gestão de Custos" class="img-fluid" style="max-width: 200px;">
                                </div>
                                <div class="text-center">
                                    <p class="mb-2" style="font-size: 1.2rem;">
                                        Todos os dados devem se referir ao mês selecionado.
                                        Os Dados Básicos viabilizam o uso desta plataforma e determinam a atualidade e qualidade dos cálculos e análises.
                                        Se você puder anotar os dados de meses anteriores, terá uma visão mais ampla do desempenho do seu negócio.</p>

                                </div>
                            </div>
                        </div>

                        <!-- Coluna do Formulário (9 colunas) -->
                        <div class="col-md-9">
                            <!-- Nova linha com os 4 botões -->
                            <div class="row mb-4">
                                <div class="col-12 col-md-3 mb-2 mb-md-0">
                                    <a href="/dashboard" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
                                        Índice
                                    </a>
                                </div>
                                <div class="col-12 col-md-3 mb-2 mb-md-0">
                                    <button type="button" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
                                        Diagnóstico
                                    </button>
                                </div>
                                <div class="col-12 col-md-3 mb-2 mb-md-0">
                                    <button type="button" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
                                        Simulador
                                    </button>
                                </div>
                                <div class="col-12 col-md-3">
                                    <button type="button" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
                                        Calculadora de preços
                                    </button>
                                </div>
                            </div>
                            <div class="card" style="background-color: #F0F0F0;">
                                <div class="card-body">
                                    {% if user.activity_type == 'Serviços' %}
                                    <form method="post" action="{% if edit_mode %}/basic-data/update/{{ basic_data.id }}{% else %}/basic-data/save{% endif %}" id="basicDataForm">
                                        {% if show_confirm %}
                                        <input type="hidden" name="confirm_update" value="true">
                                        {% endif %}
                                      
                                        <input type="hidden" name="edit_mode" value="{{ 'true' if edit_mode else 'false' }}">
                                        {% if basic_data %}
                                        <input type="hidden" name="data_id" value="{{ basic_data.id }}">
                                        {% endif %}
                                      
                                        <!-- Primeira linha: Mês e Ano -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="month" class="form-label">
                                                    Mês* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#monthHelpModal"></i>
                                                </label>
                                                <select class="form-select" id="month" name="month" required {% if edit_mode %}disabled{% endif %}>
                                                    {% for month in range(1, 13) %}
                                                    <option value="{{ month }}" 
                                                        {% if basic_data and basic_data.month == month %}selected{% endif %}
                                                        {% if not basic_data and month == current_month %}selected{% endif %}>
                                                        {{ ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][month-1] }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                                {% if edit_mode %}
                                                    <input type="hidden" name="month" value="{{ basic_data.month }}">
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="year" class="form-label">
                                                    Ano* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#yearHelpModal"></i>
                                                </label>
                                                <input type="number" class="form-control" id="year" name="year" 
                                                    value="{{ basic_data.year if basic_data else current_year }}" 
                                                    min="2020" required {% if edit_mode %}disabled{% endif %}>
                                                {% if edit_mode %}
                                                    <input type="hidden" name="year" value="{{ basic_data.year }}">
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Segunda linha: Clientes e Faturamento -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="clients_served" class="form-label">
                                                    Quantidade de Clientes Atendidos* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#clientsServedHelpModal"></i>
                                                </label>
                                                <input type="number" class="form-control" id="clients_served" name="clients_served" 
                                                    value="{{ basic_data.clients_served if basic_data else '' }}" required min="0">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="sales_revenue" class="form-label">
                                                    Faturamento com Vendas* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#salesRevenueHelpModal"></i>
                                                </label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="sales_revenue" name="sales_revenue" 
                                                        value="{{ (basic_data.sales_revenue/10)|round(2) if basic_data and basic_data.sales_revenue is not none else '' }}" 
                                                        required pattern="^R?\$?\s*[\d.,]+$">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Terceira linha: Gastos -->
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label for="sales_expenses" class="form-label">
                                                    Gastos com Vendas* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#salesExpensesHelpModal"></i>
                                                </label>
                                                <div class="input-group">
                                                    <div class="col-9 p-0">
                                                        <input type="text" class="form-control" id="sales_expenses_display" 
                                                            value="{{ (basic_data.sales_expenses/10)|round(2) if basic_data and basic_data.sales_expenses is not none else '' }}" 
                                                            required pattern="^R?\$?\s*[\d.,]+$">
                                                        <input type="hidden" id="sales_expenses" name="sales_expenses" value="{{ (basic_data.sales_expenses/10)|round(2) if basic_data and basic_data.sales_expenses is not none else '0' }}">
                                                    </div>
                                                    <div class="col-3 p-0">
                                                        <input type="text" class="form-control" id="sales_expenses_percentual" readonly>
                                                        <input type="hidden" id="sales_expenses_percentual_hidden" name="sales_expenses_percentual">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="input_product_expenses" class="form-label">
                                                    Gastos com Insumos e Produtos* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#inputProductExpensesHelpModal"></i>
                                                </label>
                                                <div class="input-group">
                                                    <div class="col-9 p-0">
                                                        <input type="text" class="form-control" id="input_product_expenses_display" 
                                                            value="{{ (basic_data.input_product_expenses/10)|round(2) if basic_data and basic_data.input_product_expenses is not none else '' }}" 
                                                            required pattern="^R?\$?\s*[\d.,]+$">
                                                        <input type="hidden" id="input_product_expenses" name="input_product_expenses" value="{{ (basic_data.input_product_expenses/10)|round(2) if basic_data and basic_data.input_product_expenses is not none else '0' }}">
                                                    </div>
                                                    <div class="col-3 p-0">
                                                        <input type="text" class="form-control" id="input_product_expenses_percentual" readonly>
                                                        <input type="hidden" id="input_product_expenses_percentual_hidden" name="input_product_expenses_percentual">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Quarta linha: Pró-labore e Custos Fixos -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="pro_labore" class="form-label">
                                                    Pró-labore 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#proLaboreHelpModal"></i>
                                                </label>
                                                <div class="input-group">
                                                    <div class="col-9 p-0">
                                                        <input type="text" class="form-control" id="pro_labore" name="pro_labore" 
                                                            value="{{ (basic_data.pro_labore/10)|round(2) if basic_data and basic_data.pro_labore is not none else '' }}">
                                                    </div>
                                                    <div class="col-3 p-0">
                                                        <input type="text" class="form-control" id="pro_labore_percentual" readonly>
                                                        <input type="hidden" id="pro_labore_percentual_hidden" name="pro_labore_percentual">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="other_fixed_costs" class="form-label">
                                                    Demais Custos Fixos* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#otherFixedCostsHelpModal"></i>
                                                </label>
                                                <div class="input-group">
                                                    <div class="col-9 p-0">
                                                        <input type="text" class="form-control" id="other_fixed_costs" name="other_fixed_costs" 
                                                            value="{{ (basic_data.other_fixed_costs/10)|round(2) if basic_data and basic_data.other_fixed_costs is not none else '' }}">
                                                    </div>
                                                    <div class="col-3 p-0">
                                                        <input type="text" class="form-control" id="other_fixed_costs_percentual" name="other_fixed_costs_percentual" readonly>
                                                        <input type="hidden" id="other_fixed_costs_percentual_hidden" name="other_fixed_costs_percentual_hidden">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Quinta linha: Horas e Capacidade -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="work_hours_per_week" class="form-label">
                                                    Horas de Trabalho por Semana 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#workHoursHelpModal"></i>
                                                </label>
                                                <input type="number" step="1" class="form-control" id="work_hours_per_week" name="work_hours_per_week" 
                                                    value="{{ basic_data.work_hours_per_week|int if basic_data and basic_data.work_hours_per_week else '' }}" min="0" max="168">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="service_capacity" class="form-label">
                                                    Capacidade de Atendimento 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#serviceCapacityHelpModal"></i>
                                                </label>
                                                <input type="text" class="form-control" id="service_capacity" name="service_capacity" 
                                                    value="{{ basic_data.service_capacity if basic_data else '' }}">
                                            </div>
                                        </div>

                                        <!-- Sexta linha: Margem de Lucro -->
                                        <div class="row justify-content-center">
                                            <div class="col-md-4">
                                                <div class="text-center mb-2">
                                                    <label for="ideal_service_profit_margin" class="form-label">
                                                        Margem de Lucro Ideal (%)
                                                        <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#idealServiceProfitMarginHelpModal"></i>
                                                    </label>
                                                </div>
                                                <div class="input-group">
                                                    <input type="number" step="1" class="form-control" id="ideal_service_profit_margin" name="ideal_service_profit_margin" 
                                                        value="{{ basic_data.ideal_service_profit_margin|int if basic_data and basic_data.ideal_service_profit_margin else '' }}" min="0" max="100">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row mt-4">
                                            <div class="col-12 text-center">
                                                <button type="button" class="btn btn-secondary me-2" style="background-color: #6c757d; border-color: #6c757d;" onclick="document.getElementById('basicDataForm').reset();">
                                                    Limpar
                                                </button>
                                                <button type="submit" class="btn btn-secondary me-2" style="background-color: #6c757d; border-color: #6c757d;">
                                                    {% if edit_mode %}Atualizar{% else %}Salvar{% endif %}
                                                </button>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-12 text-center">
                                                <a href="/basic-data/" class="btn btn-secondary" style="background-color: #6c757d; border-color: #6c757d;">
                                                    Histórico
                                                </a>
                                            </div>
                                        </div>
                                    </form>
                                    {% else %}
                                    <form method="post" action="{% if edit_mode %}/basic-data/update/{{ basic_data.id }}{% else %}/basic-data/save{% endif %}" id="basicDataForm">
                                        {% if show_confirm %}
                                        <input type="hidden" name="confirm_update" value="true">
                                        {% endif %}
                                      
                                        <input type="hidden" name="edit_mode" value="{{ 'true' if edit_mode else 'false' }}">
                                        {% if basic_data %}
                                        <input type="hidden" name="data_id" value="{{ basic_data.id }}">
                                        {% endif %}
                                      
                                        <!-- Primeira linha: Mês e Ano -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="month" class="form-label">
                                                    Mês* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#monthHelpModal"></i>
                                                </label>
                                                <select class="form-select" id="month" name="month" required {% if edit_mode %}disabled{% endif %}>
                                                    {% for month in range(1, 13) %}
                                                    <option value="{{ month }}" 
                                                        {% if basic_data and basic_data.month == month %}selected{% endif %}
                                                        {% if not basic_data and month == current_month %}selected{% endif %}>
                                                        {{ ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][month-1] }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                                {% if edit_mode %}
                                                    <input type="hidden" name="month" value="{{ basic_data.month }}">
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="year" class="form-label">
                                                    Ano* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#yearHelpModal"></i>
                                                </label>
                                                <input type="number" class="form-control" id="year" name="year" 
                                                    value="{{ basic_data.year if basic_data else current_year }}" 
                                                    min="2020" required {% if edit_mode %}disabled{% endif %}>
                                                {% if edit_mode %}
                                                    <input type="hidden" name="year" value="{{ basic_data.year }}">
                                                {% endif %}
                                            </div>
                                        </div>
                
                                        <!-- Segunda linha: Clientes e Faturamento -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="clients_served" class="form-label">
                                                    Quantidade de Clientes Atendidos* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#clientsServedHelpModal"></i>
                                                </label>
                                                <input type="number" class="form-control" id="clients_served" name="clients_served" 
                                                    value="{{ basic_data.clients_served if basic_data else '' }}" required min="0">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="sales_revenue" class="form-label">
                                                    Faturamento com Vendas* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#salesRevenueHelpModal"></i>
                                                </label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="sales_revenue" name="sales_revenue" 
                                                        value="{{ (basic_data.sales_revenue/10)|round(2) if basic_data and basic_data.sales_revenue is not none else '' }}" 
                                                        required pattern="^R?\$?\s*[\d.,]+$">
                                                </div>
                                            </div>
                                        </div>
                
                                        <!-- Terceira linha: Gastos -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="sales_expenses" class="form-label">
                                                    Gastos com Vendas* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#salesExpensesHelpModal"></i>
                                                </label>
                                                <div class="input-group">
                                                    <div class="col-9 p-0">
                                                        <input type="text" class="form-control" id="sales_expenses_display" 
                                                            value="{{ (basic_data.sales_expenses/10)|round(2) if basic_data and basic_data.sales_expenses is not none else '' }}" 
                                                            required pattern="^R?\$?\s*[\d.,]+$">
                                                        <input type="hidden" id="sales_expenses" name="sales_expenses" value="{{ (basic_data.sales_expenses/10)|round(2) if basic_data and basic_data.sales_expenses is not none else '0' }}">
                                                    </div>
                                                    <div class="col-3 p-0">
                                                        <input type="text" class="form-control" id="sales_expenses_percentual" readonly>
                                                        <input type="hidden" id="sales_expenses_percentual_hidden" name="sales_expenses_percentual">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="input_product_expenses" class="form-label">
                                                    Gastos com Insumos e Produtos* 
                                                    <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#inputProductExpensesHelpModal"></i>
                                                </label>
                                                <div class="input-group">
                                                    <div class="col-9 p-0">
                                                        <input type="text" class="form-control" id="input_product_expenses_display" 
                                                            value="{{ (basic_data.input_product_expenses/10)|round(2) if basic_data and basic_data.input_product_expenses is not none else '' }}" 
                                                            required pattern="^R?\$?\s*[\d.,]+$">
                                                        <input type="hidden" id="input_product_expenses" name="input_product_expenses" value="{{ (basic_data.input_product_expenses/10)|round(2) if basic_data and basic_data.input_product_expenses is not none else '0' }}">
                                                    </div>
                                                    <div class="col-3 p-0">
                                                        <input type="text" class="form-control" id="input_product_expenses_percentual" readonly>
                                                        <input type="hidden" id="input_product_expenses_percentual_hidden" name="input_product_expenses_percentual">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                
                                        <!-- Quarta linha: Margem de Lucro -->
                                        <div class="row justify-content-center">
                                            <div class="col-md-4">
                                                <div class="text-center mb-2">
                                                    <label for="ideal_service_profit_margin" class="form-label">
                                                        Margem de Lucro Ideal (%)
                                                        <i class="bi bi-lightbulb-fill" style="cursor: pointer; margin-left: 5px; font-size: 1.1rem; color: #FFD700 !important;" data-bs-toggle="modal" data-bs-target="#idealServiceProfitMarginHelpModal"></i>
                                                    </label>
                                                </div>
                                                <div class="input-group">
                                                    <input type="number" step="1" class="form-control" id="ideal_service_profit_margin" name="ideal_service_profit_margin" 
                                                        value="{{ basic_data.ideal_service_profit_margin|int if basic_data and basic_data.ideal_service_profit_margin else '' }}" min="0" max="100">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                        </div>
                
                                        <div class="row mt-4">
                                            <div class="col-12 text-center">
                                                <button type="button" class="btn btn-secondary me-2" style="background-color: #6c757d; border-color: #6c757d;" onclick="document.getElementById('basicDataForm').reset();">
                                                    Limpar
                                                </button>
                                                <button type="submit" class="btn btn-secondary me-2" style="background-color: #6c757d; border-color: #6c757d;">
                                                    {% if edit_mode %}Atualizar{% else %}Salvar{% endif %}
                                                </button>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-12 text-center">
                                                <a href="/basic-data/" class="btn btn-secondary" style="background-color: #6c757d; border-color: #6c757d;">
                                                    Histórico
                                                </a>
                                            </div>
                                        </div>
                                    </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>  
        </div>
    </div>

    <!-- Tabela de Logs - Movida para fora do card principal -->
    {% if edit_mode %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Histórico de Alterações</h5>
                </div>
                <div class="card-body">
                    <!-- Filtros para o histórico -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="logFilter" placeholder="Filtrar por descrição...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                <input type="date" class="form-control" id="dateFilter">
                            </div>
                        </div>
                    </div>
                    
                    <table class="table table-striped" id="logsTable">
                        <thead>
                            <tr>
                                <th>Descrição da Alteração</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in logs %}
                            <tr>
                                <td>{{ log.change_description }}</td>
                                <td>{{ log.created_at.strftime('%d/%m/%Y') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% if logs|length == 0 %}
                    <p class="text-muted">Nenhuma alteração registrada.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="confirmReplaceModal" tabindex="-1" data-bs-backdrop="static" aria-labelledby="confirmReplaceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmReplaceModalLabel">Registro Existente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p>Já existe um registro para o período selecionado. Deseja atualizar os dados existentes?</p>
                <p class="text-muted small">Ao confirmar, as alterações serão registradas no histórico de mudanças.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não</button>
                <button type="button" class="btn btn-primary" id="confirmReplace">Sim, Atualizar</button>
            </div>
        </div>
    </div>
</div>
  
<!-- Help Modals -->
<div class="modal fade" id="monthHelpModal" tabindex="-1" aria-labelledby="monthHelpModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mês</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Selecione o mês correspondente aos dados que você está registrando. Por padrão, o mês atual é selecionado.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="yearHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ano</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Insira o ano correspondente aos dados que você está registrando. O ano atual é selecionado por padrão.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="clientsServedHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Clientes Atendidos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Informe o número total de clientes atendidos no período. Considere todos os clientes que receberam seus serviços ou produtos.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="salesRevenueHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Faturamento com Vendas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Registre o valor total de receitas geradas pelas vendas no período. Inclua todos os valores recebidos de clientes.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="salesExpensesHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gastos com Vendas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Informe todos os custos diretamente relacionados às vendas, como comissões, taxas de transação, despesas de marketing, etc.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="inputProductExpensesHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gastos com Insumos e Produtos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Registre o valor gasto em matérias-primas, produtos para revenda ou insumos necessários para a produção ou prestação de serviços.
            </div>
        </div>
    </div>
</div>

{% if user.activity_type in ['Comércio', 'Indústria'] %}
<div class="modal fade" id="fixedCostsHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Custos Fixos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Informe os custos que permanecem constantes independentemente do volume de vendas, como aluguel, salários fixos, energia, água, etc.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="idealProfitMarginHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Margem de Lucro Ideal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Indique a porcentagem de lucro que você considera ideal para seu negócio após descontar todos os custos e despesas.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="serviceCapacityHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Capacidade de Atendimento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Descreva sua capacidade de atendimento, como número máximo de clientes, produtos que pode produzir, ou serviços que pode realizar.
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if user.activity_type == 'Serviços' %}
<div class="modal fade" id="proLaboreHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pró-labore</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Registre o valor do pró-labore, que é a remuneração do empresário pelos serviços prestados à empresa.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="workHoursHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Horas de Trabalho por Semana</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Informe o total de horas trabalhadas por semana. O máximo possível é 168 horas (7 dias * 24 horas).
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="otherFixedCostsHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Demais Custos Fixos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Registre outros custos fixos não cobertos anteriormente, como despesas administrativas, manutenção de equipamentos, etc.
            </div>
        </div>
    </div>
</div>
{% endif %}
<div class="modal fade" id="idealServiceProfitMarginHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Margem de Lucro Ideal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Indique a porcentagem de lucro que você considera ideal para seus serviços após descontar todos os custos e despesas.
            </div>
        </div>
    </div>
</div>

<script>
    // Função para formatar valores monetários
    function formatarMoeda(valor) {
        if (!valor) return '';
        // Remove caracteres não numéricos
        valor = valor.replace(/\D/g, '');
        // Converte para número e divide por 100 para obter os centavos
        const numero = parseInt(valor) / 100;
        if (isNaN(numero)) return '';
        // Formata como moeda brasileira
        return numero.toLocaleString('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // Função para calcular porcentagem
    function calcularPorcentagem(valor, receita) {
        if (!valor || !receita || receita === 0) return '';
        const porcentagem = (parseFloat(valor) / parseFloat(receita)) * 100;
        return porcentagem.toFixed(2) + '%';
    }

    // Função para atualizar campos hidden
    function updateHiddenFields() {
        // Sales Expenses
        const salesExpensesDisplay = document.getElementById('sales_expenses_display');
        const salesExpenses = document.getElementById('sales_expenses');
        if (salesExpensesDisplay && salesExpenses) {
            const value = salesExpensesDisplay.value.replace(/\D/g, '');
            salesExpenses.value = value;
        }

        // Input Product Expenses
        const inputProductExpensesDisplay = document.getElementById('input_product_expenses_display');
        const inputProductExpenses = document.getElementById('input_product_expenses');
        if (inputProductExpensesDisplay && inputProductExpenses) {
            const value = inputProductExpensesDisplay.value.replace(/\D/g, '');
            inputProductExpenses.value = value;
        }
    }

    // Função para atualizar porcentagens
    function atualizarPorcentagens() {
        const receita = document.getElementById('sales_revenue').value.replace(/\D/g, '');
        
        // Gastos com Vendas
        const gastosVendas = document.getElementById('sales_expenses_display').value.replace(/\D/g, '');
        const porcentagemVendas = calcularPorcentagem(gastosVendas, receita);
        document.getElementById('sales_expenses_percentual').value = porcentagemVendas;
        document.getElementById('sales_expenses_percentual_hidden').value = porcentagemVendas.replace('%', '');
        
        // Aplicar regra de cor para gastos com vendas
        const porcentagemVendasNum = parseFloat(porcentagemVendas);
        const percentualVendasField = document.getElementById('sales_expenses_percentual');
        if (porcentagemVendasNum < 0 || porcentagemVendasNum > 100) {
            percentualVendasField.classList.add('invalid-percentage');
        } else {
            percentualVendasField.classList.remove('invalid-percentage');
        }

        // Gastos com Insumos
        const gastosInsumos = document.getElementById('input_product_expenses_display').value.replace(/\D/g, '');
        const porcentagemInsumos = calcularPorcentagem(gastosInsumos, receita);
        document.getElementById('input_product_expenses_percentual').value = porcentagemInsumos;
        document.getElementById('input_product_expenses_percentual_hidden').value = porcentagemInsumos.replace('%', '');
        
        // Aplicar regra de cor para gastos com insumos
        const porcentagemInsumosNum = parseFloat(porcentagemInsumos);
        const percentualInsumosField = document.getElementById('input_product_expenses_percentual');
        if (porcentagemInsumosNum < 0 || porcentagemInsumosNum > 100) {
            percentualInsumosField.classList.add('invalid-percentage');
        } else {
            percentualInsumosField.classList.remove('invalid-percentage');
        }

        // Pro-labore
        const proLabore = document.getElementById('pro_labore').value.replace(/\D/g, '');
        const porcentagemProLabore = calcularPorcentagem(proLabore, receita);
        document.getElementById('pro_labore_percentual').value = porcentagemProLabore;
        document.getElementById('pro_labore_percentual_hidden').value = porcentagemProLabore.replace('%', '');
        
        // Aplicar regra de cor para pró-labore
        const porcentagemProLaboreNum = parseFloat(porcentagemProLabore);
        const percentualProLaboreField = document.getElementById('pro_labore_percentual');
        if (porcentagemProLaboreNum < 0 || porcentagemProLaboreNum > 100) {
            percentualProLaboreField.classList.add('invalid-percentage');
        } else {
            percentualProLaboreField.classList.remove('invalid-percentage');
        }

        // Demais Custos Fixos
        const demaisCustos = document.getElementById('other_fixed_costs').value.replace(/\D/g, '');
        const porcentagemDemaisCustos = calcularPorcentagem(demaisCustos, receita);
        const percentualDemaisCustosField = document.getElementById('other_fixed_costs_percentual');
        percentualDemaisCustosField.value = porcentagemDemaisCustos;
        document.getElementById('other_fixed_costs_percentual_hidden').value = porcentagemDemaisCustos.replace('%', '');
        
        // Aplicar regra de cor para demais custos fixos
        const porcentagemDemaisCustosNum = parseFloat(porcentagemDemaisCustos);
        if (porcentagemDemaisCustosNum < 0 || porcentagemDemaisCustosNum > 100) {
            percentualDemaisCustosField.classList.add('invalid-percentage');
        } else {
            percentualDemaisCustosField.classList.remove('invalid-percentage');
        }

        // Atualizar campos hidden
        updateHiddenFields();
    }

    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('basicDataForm');
        
        // Função para formatar valores iniciais
        function formatInitialValues() {
            const fields = [
                'sales_expenses_display',
                'input_product_expenses_display',
                'pro_labore',
                'other_fixed_costs',
                'sales_revenue'
            ];

            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value) {
                    const value = field.value.replace(/\D/g, '');
                    field.value = formatarMoeda(value);
                }
            });
        }

        // Formatar valores iniciais
        formatInitialValues();

        // Atualizar campos quando os valores mudarem
        const monetaryFields = [
            'sales_expenses_display',
            'input_product_expenses_display',
            'pro_labore',
            'other_fixed_costs',
            'sales_revenue'
        ];

        monetaryFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', function(e) {
                    // Preserva a posição do cursor
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    
                    // Formata o valor
                    const value = this.value.replace(/\D/g, '');
                    this.value = formatarMoeda(value);
                    
                    // Restaura a posição do cursor
                    const newLength = this.value.length;
                    const newStart = Math.min(start, newLength);
                    const newEnd = Math.min(end, newLength);
                    this.setSelectionRange(newStart, newEnd);
                    
                    atualizarPorcentagens();
                });

                field.addEventListener('blur', function() {
                    const value = this.value.replace(/\D/g, '');
                    this.value = formatarMoeda(value);
                    atualizarPorcentagens();
                });
            }
        });

        // Atualizar porcentagens ao carregar a página
        atualizarPorcentagens();
        
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            updateHiddenFields();
            form.submit();
        });
    });
</script>
{% endblock %}