{% extends "base.html" %}

{% block title %}{% if edit_mode %}Editar{% else %}Novo{% endif %} Dados Básicos{% endblock %}

{% block extra_css %}
<style>
    .navbar {
        z-index: 1000;
        display: flex !important;
        visibility: visible !important;
    }

    .help-icon {
        cursor: pointer;
        margin-left: 5px;
        opacity: 0.7;
        transition: opacity 0.3s ease;
    }

    .help-icon:hover {
        opacity: 1;
    }

    .modal {
        z-index: 1050;
    }

    .custom-bg {
        background-color: #f8f9fa; /* Cor de fundo clara, semelhante ao bg-light */
    }
    
    /* Estilo para garantir que o X de fechar fique branco */
    .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }

    /* Estilos para a mensagem de aviso */
    #warningMessage {
        font-size: 1.1em;
        padding: 15px;
        border-left: 5px solid #ffc107;
        background-color: #fff3cd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
        position: relative;
        z-index: 10;
    }

    #warningMessage p {
        margin: 0;
    }

    #warningMessage i {
        color: #ffc107;
        font-size: 1.2em;
        margin-right: 10px;
    }

    #warningMessage a {
        font-weight: 600;
        text-decoration: none;
    }

    #warningMessage a:hover {
        text-decoration: underline;
    }

    #saveButtonContainer.hide {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
{% with active_page='basic_data' %}
{% include 'components/navbar.html' %}
{% endwith %}

<div class="container-fluid p-5">
    <div class="row">
        <div class="col-md-10 mx-auto">
            {% if error_message %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {{ error_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
            {% endif %}

            {% if warning_message %}
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                {{ warning_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
            {% endif %}

            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        {% if edit_mode %}Editar{% else %}Adicionar{% endif %} Dados Básicos
                    </h5>
                </div>
                <div class="card-body">

                    <form method="post" action="/basic-data/save">
                        {% if show_confirm %}
                        <input type="hidden" name="confirm_update" value="true">
                        {% endif %}
                      
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="month" class="form-label">
                                    Mês* 
                                    <i class="bi bi-question-circle-fill text-primary help-icon" data-bs-toggle="modal" data-bs-target="#monthHelpModal"></i>
                                </label>
                                <select class="form-select" id="month" name="month" required {% if edit_mode %}disabled{% endif %}>
                                    {% for month in range(1, 13) %}
                                    <option value="{{ month }}" 
                                        {% if basic_data and basic_data.month == month %}selected{% endif %}
                                        {% if not basic_data and month == current_month %}selected{% endif %}>
                                        {{ ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][month-1] }}
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if edit_mode %}
                                    <input type="hidden" name="month" value="{{ basic_data.month }}">
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="year" class="form-label">
                                    Ano* 
                                    <i class="bi bi-question-circle-fill text-primary help-icon" data-bs-toggle="modal" data-bs-target="#yearHelpModal"></i>
                                </label>
                                <input type="number" class="form-control" id="year" name="year" 
                                    value="{{ basic_data.year if basic_data else current_year }}" 
                                    min="2020" required {% if edit_mode %}disabled{% endif %}>
                                {% if edit_mode %}
                                    <input type="hidden" name="year" value="{{ basic_data.year }}">
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="clients_served" class="form-label">
                                    Quantidade de Clientes Atendidos* 
                                    <i class="bi bi-question-circle-fill text-primary help-icon" data-bs-toggle="modal" data-bs-target="#clientsServedHelpModal"></i>
                                </label>
                                <input type="number" class="form-control" id="clients_served" name="clients_served" 
                                    value="{{ basic_data.clients_served if basic_data else '' }}" required min="0">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="sales_revenue" class="form-label">
                                    Faturamento com Vendas* 
                                    <i class="bi bi-question-circle-fill text-primary help-icon" data-bs-toggle="modal" data-bs-target="#salesRevenueHelpModal"></i>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" class="form-control" id="sales_revenue" name="sales_revenue" 
                                        value="{{ (basic_data.sales_revenue/10)|round(2) if basic_data and basic_data.sales_revenue is not none else '' }}" required>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="sales_expenses" class="form-label">
                                    Gastos com Vendas* 
                                    <i class="bi bi-question-circle-fill text-primary help-icon" data-bs-toggle="modal" data-bs-target="#salesExpensesHelpModal"></i>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" class="form-control" id="sales_expenses" name="sales_expenses" 
                                        value="{{ (basic_data.sales_expenses/10)|round(2) if basic_data and basic_data.sales_expenses is not none else '' }}" required>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="input_product_expenses" class="form-label">
                                    Gastos com Insumos e Produtos* 
                                    <i class="bi bi-question-circle-fill text-primary help-icon" data-bs-toggle="modal" data-bs-target="#inputProductExpensesHelpModal"></i>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" class="form-control" id="input_product_expenses" name="input_product_expenses" 
                                        value="{{ (basic_data.input_product_expenses/10)|round(2) if basic_data and basic_data.input_product_expenses is not none else '' }}" required>
                                </div>
                            </div>
                        </div>

                        {% if user.activity_type in ['Comércio', 'Indústria'] %}
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="fixed_costs" class="form-label">
                                    Custos Fixos 
                                    <i class="bi bi-question-circle-fill text-primary help-icon" data-bs-toggle="modal" data-bs-target="#fixedCostsHelpModal"></i>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" class="form-control" id="fixed_costs" name="fixed_costs" 
                                        value="{{ (basic_data.fixed_costs/10)|round(2) if basic_data and basic_data.fixed_costs is not none else '' }}">
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="ideal_profit_margin" class="form-label">
                                    Margem de Lucro Ideal (%) 
                                    <i class="bi bi-question-circle-fill text-primary help-icon" data-bs-toggle="modal" data-bs-target="#idealProfitMarginHelpModal"></i>
                                </label>
                                <div class="input-group">
                                    <input type="number" step="1" class="form-control" id="ideal_profit_margin" name="ideal_profit_margin" 
                                        value="{{ basic_data.ideal_profit_margin|int if basic_data and basic_data.ideal_profit_margin else '' }}" min="0" max="100" required>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="service_capacity" class="form-label">
                                    Capacidade de Atendimento 
                                    <i class="bi bi-question-circle-fill text-primary help-icon" data-bs-toggle="modal" data-bs-target="#serviceCapacityHelpModal"></i>
                                </label>
                                <input type="text" class="form-control" id="service_capacity" name="service_capacity" 
                                    value="{{ basic_data.service_capacity if basic_data else '' }}">
                            </div>
                        </div>
                        {% endif %}

                        {% if user.activity_type == 'Serviços' %}
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="pro_labore" class="form-label">
                                    Pró-labore 
                                    <i class="bi bi-question-circle-fill text-primary help-icon" data-bs-toggle="modal" data-bs-target="#proLaboreHelpModal"></i>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" class="form-control" id="pro_labore" name="pro_labore" 
                                        value="{{ (basic_data.pro_labore/10)|round(2) if basic_data and basic_data.pro_labore is not none else '' }}">
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="other_fixed_costs" class="form-label">
                                    Demais Custos Fixos 
                                    <i class="bi bi-question-circle-fill text-primary help-icon" data-bs-toggle="modal" data-bs-target="#otherFixedCostsHelpModal"></i>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" class="form-control" id="other_fixed_costs" name="other_fixed_costs" 
                                        value="{{ (basic_data.other_fixed_costs/10)|round(2) if basic_data and basic_data.other_fixed_costs is not none else '' }}">
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="work_hours_per_week" class="form-label">
                                    Horas de Trabalho por Semana 
                                    <i class="bi bi-question-circle-fill text-primary help-icon" data-bs-toggle="modal" data-bs-target="#workHoursHelpModal"></i>
                                </label>
                                <input type="number" step="1" class="form-control" id="work_hours_per_week" name="work_hours_per_week" 
                                    value="{{ basic_data.work_hours_per_week|int if basic_data and basic_data.work_hours_per_week else '' }}" min="0" max="168">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="ideal_service_profit_margin" class="form-label">
                                    Margem de Lucro Ideal (%) 
                                    <i class="bi bi-question-circle-fill text-primary help-icon" data-bs-toggle="modal" data-bs-target="#idealServiceProfitMarginHelpModal"></i>
                                </label>
                                <div class="input-group">
                                    <input type="number" step="1" class="form-control" id="ideal_service_profit_margin" name="ideal_service_profit_margin" 
                                        value="{{ basic_data.ideal_service_profit_margin|int if basic_data and basic_data.ideal_service_profit_margin else '' }}" min="0" max="100">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if user.activity_type not in ['Serviços'] %}
                        <div class="row">
                            <!-- Campo "É o Atual?" removido -->
                        </div>
                        {% endif %}

                        <div class="d-flex justify-content-end mt-4">
                            {% if edit_mode %}
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" id="updateButton">
                                        <i class="bi bi-check-circle" style="color: white !important;"></i> Atualizar Dados
                                    </button>
                                    <a href="/basic-data" class="btn btn-outline-secondary">
                                        <i class="bi bi-arrow-left"></i> Voltar
                                    </a>
                                </div>
                            {% else %}
                                <div class="d-flex flex-column align-items-end w-100">
                                    <div id="warningMessage" class="w-100 mb-3" style="display: none;">
                                        <p class="text-warning">
                                            <i class="bi bi-exclamation-triangle-fill"></i> 
                                            Já existem dados básicos cadastrados para o mês e ano selecionados. 
                                            <a href="/basic-data" class="text-warning">Volte à tela de consulta de dados básicos</a> e ajuste conforme sua necessidade.
                                        </p>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <a href="/basic-data" class="btn btn-outline-secondary">
                                            <i class="bi bi-arrow-left"></i> Voltar
                                        </a>
                                        <div id="saveButtonContainer">
                                            <button type="submit" class="btn btn-primary" id="saveButton">
                                                <i class="bi bi-check-circle" style="color: white !important;"></i> Salvar Dados
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Logs - Movida para fora do card principal -->
    {% if edit_mode %}
    <div class="row mt-4">
        <div class="col-md-10 mx-auto">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Histórico de Alterações</h5>
                </div>
                <div class="card-body">
                    <!-- Filtros para o histórico -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="logFilter" placeholder="Filtrar por descrição...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                <input type="date" class="form-control" id="dateFilter">
                            </div>
                        </div>
                    </div>
                    
                    <table class="table table-striped" id="logsTable">
                        <thead>
                            <tr>
                                <th>Descrição da Alteração</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in logs %}
                            <tr>
                                <td>{{ log.change_description }}</td>
                                <td>{{ log.created_at.strftime('%d/%m/%Y') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% if logs|length == 0 %}
                    <p class="text-muted">Nenhuma alteração registrada.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="confirmReplaceModal" tabindex="-1" data-bs-backdrop="static" aria-labelledby="confirmReplaceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmReplaceModalLabel">Confirmar Substituição</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                Já existe um registro para este mês. Deseja substituir?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não</button>
                <button type="button" class="btn btn-primary" id="confirmReplace">Sim</button>
            </div>
        </div>
    </div>
</div>
  
<!-- Help Modals -->
<div class="modal fade" id="monthHelpModal" tabindex="-1" aria-labelledby="monthHelpModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Mês</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Selecione o mês correspondente aos dados que você está registrando. Por padrão, o mês atual é selecionado.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="yearHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Ano</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Insira o ano correspondente aos dados que você está registrando. O ano atual é selecionado por padrão.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="clientsServedHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Clientes Atendidos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Informe o número total de clientes atendidos no período. Considere todos os clientes que receberam seus serviços ou produtos.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="salesRevenueHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Faturamento com Vendas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Registre o valor total de receitas geradas pelas vendas no período. Inclua todos os valores recebidos de clientes.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="salesExpensesHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Gastos com Vendas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Informe todos os custos diretamente relacionados às vendas, como comissões, taxas de transação, despesas de marketing, etc.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="inputProductExpensesHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Gastos com Insumos e Produtos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Registre o valor gasto em matérias-primas, produtos para revenda ou insumos necessários para a produção ou prestação de serviços.
            </div>
        </div>
    </div>
</div>

{% if user.activity_type in ['Comércio', 'Indústria'] %}
<div class="modal fade" id="fixedCostsHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Custos Fixos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Informe os custos que permanecem constantes independentemente do volume de vendas, como aluguel, salários fixos, energia, água, etc.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="idealProfitMarginHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Margem de Lucro Ideal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Indique a porcentagem de lucro que você considera ideal para seu negócio após descontar todos os custos e despesas.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="serviceCapacityHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Capacidade de Atendimento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Descreva sua capacidade de atendimento, como número máximo de clientes, produtos que pode produzir, ou serviços que pode realizar.
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if user.activity_type == 'Serviços' %}
<div class="modal fade" id="proLaboreHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Pró-labore</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Registre o valor do pró-labore, que é a remuneração do empresário pelos serviços prestados à empresa.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="workHoursHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Horas de Trabalho por Semana</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Informe o total de horas trabalhadas por semana. O máximo possível é 168 horas (7 dias * 24 horas).
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="otherFixedCostsHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Demais Custos Fixos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Registre outros custos fixos não cobertos anteriormente, como despesas administrativas, manutenção de equipamentos, etc.
            </div>
        </div>
    </div>
</div>
{% endif %}
<div class="modal fade" id="idealServiceProfitMarginHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Margem de Lucro Ideal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Indique a porcentagem de lucro que você considera ideal para seus serviços após descontar todos os custos e despesas.
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Lista de campos que devem ser formatados como moeda
    const currencyInputs = [
        'sales_revenue', 
        'sales_expenses', 
        'input_product_expenses', 
        'fixed_costs', 
        'pro_labore', 
        'other_fixed_costs'
    ];
    console.log(currencyInputs);

    // Função para formatar valor como moeda brasileira (R$)
    function formatCurrency(value) {
        // Remover todos os caracteres não numéricos, exceto ponto e vírgula
        let numericValue = value.replace(/[^\d,.-]/g, '');
        
        // Tratar separadores de milhares e decimais
        // Primeiro, remover todos os pontos (separadores de milhares)
        numericValue = numericValue.replace(/\./g, '');
        
        // Substituir vírgula por ponto para conversão
        numericValue = numericValue.replace(',', '.');
        
        // Converter para número
        let number = parseFloat(numericValue);
        
        // Verificar se é um número válido
        if (isNaN(number)) {
            return '';
        }
        
        // Formatar como moeda brasileira sem o símbolo R$
        return new Intl.NumberFormat('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(number);
    }

    // Função para converter valor formatado para número (para envio ao banco)
    function currencyToNumber(value) {
        // Remover todos os caracteres não numéricos, exceto ponto e vírgula
        let numericValue = value.replace(/[^\d,.-]/g, '');
        
        // Verificar se o valor contém vírgula (formato brasileiro)
        if (numericValue.includes(',')) {
            // Se contém vírgula, tratar como formato brasileiro (65.000,00)
            
            // Remover todos os pontos (separadores de milhares)
            numericValue = numericValue.replace(/\./g, '');
            
            // Substituir vírgula por ponto para conversão
            numericValue = numericValue.replace(',', '.');
        } else if (numericValue.includes('.')) {
            // Se contém ponto, verificar se é formato americano (65,000.00) ou brasileiro (65.000,00)
            
            // Verificar se o último ponto é seguido por dois dígitos (formato americano)
            const parts = numericValue.split('.');
            if (parts.length > 1 && parts[parts.length - 1].length === 2) {
                // Formato americano (65,000.00), não precisa fazer nada
            } else {
                // Formato brasileiro com ponto (65.000,00), remover pontos
                numericValue = numericValue.replace(/\./g, '');
            }
        }
        
        // Converter para número
        let number = parseFloat(numericValue);
        
        // Verificar se é um número válido
        if (isNaN(number)) {
            return 0;
        }
        
        // Retornar com 2 casas decimais
        return number.toFixed(2);
    }

    // Função para aplicar formatação em tempo real
    function setupCurrencyInputs() {
        currencyInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                // Formatar valor inicial se existir
                if (input.value) {
                    input.value = formatCurrency(input.value);
                }
                
                // Adicionar evento para formatação em tempo real
                input.addEventListener('input', function(e) {
                    // Obter posição do cursor
                    const cursorPosition = this.selectionStart;
                    
                    // Formatar o valor
                    const formattedValue = formatCurrency(this.value);
                    
                    // Atualizar o valor do campo
                    this.value = formattedValue;
                    
                    // Ajustar a posição do cursor
                    if (cursorPosition) {
                        // Calcular nova posição do cursor
                        const newPosition = cursorPosition + (formattedValue.length - this.value.length);
                        this.setSelectionRange(newPosition, newPosition);
                    }
                });
                
                // Adicionar evento para formatação ao perder o foco
                input.addEventListener('blur', function() {
                    this.value = formatCurrency(this.value);
                });
            }
        });
    }

    // Função para preparar os dados antes do envio do formulário
    function prepareFormData() {
        currencyInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input && input.value) {
                // Converter para número antes do envio
                const numericValue = currencyToNumber(input.value);
                
                // Atualizar o valor do campo original com o valor numérico
                input.value = numericValue;
            }
        });
    }

    // Inicializar formatação de campos monetários
    setupCurrencyInputs();

    // Adicionar evento para preparar dados antes do envio do formulário
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            prepareFormData();
        });
    }

    // Inicializar todas as modais de ajuda com backdrop: false para evitar que bloqueiem a interação com a página
    document.querySelectorAll('.modal').forEach(modalElement => {
        // Criar uma instância do modal do Bootstrap com backdrop: false
        const modal = new bootstrap.Modal(modalElement, {
            backdrop: false,
            keyboard: true
        });
        
        // Adicionar evento para fechar a modal quando clicar fora dela
        modalElement.addEventListener('click', function(e) {
            // Se o clique foi fora do conteúdo da modal
            if (e.target === modalElement) {
                modal.hide();
            }
        });
    });

    // Form submission handling
    const confirmReplaceModal = document.getElementById('confirmReplaceModal');
    const confirmModal = new bootstrap.Modal(confirmReplaceModal, {
        backdrop: 'static',
        keyboard: false
    });
    let isConfirmed = false;
    const isEditMode = {% if edit_mode %}true{% else %}false{% endif %};

    // Função para verificar se já existem dados para o mês/ano selecionados
    async function checkExistingData() {
        if (isEditMode) return; // Não verificar em modo de edição
        
        const month = document.getElementById('month').value;
        const year = document.getElementById('year').value;
        const saveButtonContainer = document.getElementById('saveButtonContainer');
        const warningMessage = document.getElementById('warningMessage');
        
        console.log(`Verificando dados para mês: ${month}, ano: ${year}`);
        console.log(`Elementos encontrados: saveButtonContainer=${!!saveButtonContainer}, warningMessage=${!!warningMessage}`);
        
        try {
            const url = `/basic-data/check/${year}/${month}`;
            console.log(`Fazendo requisição para: ${url}`);
            
            const response = await fetch(url);
            console.log(`Resposta recebida: ${response.status} ${response.statusText}`);
            
            const data = await response.json();
            console.log(`Dados recebidos: ${JSON.stringify(data)}`);

            if (data.exists) {
                // Se existem dados, ocultar o botão de salvar e mostrar a mensagem de aviso
                console.log('Dados existem, ocultando botão e mostrando mensagem');
                
                // Ocultar o botão de salvar
                if (saveButtonContainer) {
                    saveButtonContainer.style.display = 'none';
                    console.log('Botão de salvar ocultado');
                }
                
                // Mostrar a mensagem de aviso
                if (warningMessage) {
                    warningMessage.style.display = 'block';
                    console.log('Mensagem de aviso exibida');
                }
            } else {
                // Se não existem dados, mostrar o botão de salvar e ocultar a mensagem de aviso
                console.log('Dados não existem, mostrando botão e ocultando mensagem');
                
                // Mostrar o botão de salvar
                if (saveButtonContainer) {
                    saveButtonContainer.style.display = 'block';
                    console.log('Botão de salvar exibido');
                }
                
                // Ocultar a mensagem de aviso
                if (warningMessage) {
                    warningMessage.style.display = 'none';
                    console.log('Mensagem de aviso ocultada');
                }
            }
        } catch (error) {
            console.error('Erro ao verificar dados existentes:', error);
        }
    }

    // Verificar dados existentes ao carregar a página e quando houver mudanças
    if (!isEditMode) {
        // Verificar imediatamente ao carregar a página
        console.log('Modo de edição: false, verificando dados existentes ao carregar a página');
        console.log('Elementos encontrados:');
        console.log('- saveButtonContainer:', document.getElementById('saveButtonContainer'));
        console.log('- warningMessage:', document.getElementById('warningMessage'));
        console.log('- month:', document.getElementById('month'));
        console.log('- year:', document.getElementById('year'));
        
        checkExistingData();
        
        // Adicionar eventos para verificar quando o mês ou ano mudar
        const monthSelect = document.getElementById('month');
        const yearInput = document.getElementById('year');
        
        if (monthSelect) {
            monthSelect.addEventListener('change', function() {
                console.log('Mês alterado para:', this.value);
                checkExistingData();
            });
        }
        
        if (yearInput) {
            yearInput.addEventListener('input', function() {
                console.log('Ano alterado para:', this.value);
                checkExistingData();
            });
            yearInput.addEventListener('change', function() {
                console.log('Ano alterado para:', this.value);
                checkExistingData();
            });
        }
    } else {
        console.log('Modo de edição: true, não verificando dados existentes');
    }

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Se já foi confirmado, permite o envio
        if (isConfirmed) {
            prepareFormData();
            form.submit();
            return;
        }

        // Se não estiver em modo de edição, envia o formulário diretamente
        if (!isEditMode) {
            prepareFormData();
            form.submit();
            return;
        }

        // Verifica se já existe registro para o mês/ano selecionado
        const month = document.getElementById('month').value;
        const year = document.getElementById('year').value;
        
        try {
            const response = await fetch(`/basic-data/check/${year}/${month}`);
            const data = await response.json();

            if (data.exists) {
                // Se existe, mostra o modal de confirmação
                confirmModal.show();
            } else {
                // Se não existe, envia o formulário normalmente
                prepareFormData();
                form.submit();
            }
        } catch (error) {
            console.error('Erro ao verificar dados existentes:', error);
            prepareFormData();
            form.submit(); // Em caso de erro, tenta enviar mesmo assim
        }
    });

    // Botão de confirmação no modal
    document.getElementById('confirmReplace').addEventListener('click', function() {
        isConfirmed = true;
        confirmModal.hide();
        
        // Remover qualquer backdrop residual
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => {
            backdrop.parentNode.removeChild(backdrop);
        });
        
        // Remover classes que o Bootstrap adiciona ao body
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');
        
        // Submeter o formulário após um breve delay
        setTimeout(() => {
            prepareFormData();
            form.submit();
        }, 100);
    });

    // Reset da confirmação quando o modal é fechado
    confirmReplaceModal.addEventListener('hidden.bs.modal', function() {
        if (!isConfirmed) {
            isConfirmed = false;
        }
        
        // Remover qualquer backdrop residual quando o modal é fechado por qualquer razão
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => {
            backdrop.parentNode.removeChild(backdrop);
        });
        
        // Remover classes que o Bootstrap adiciona ao body
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');
    });

    // Submissão do formulário para o botão de atualizar
    document.getElementById('updateButton')?.addEventListener('click', function(e) {
        e.preventDefault();
        prepareFormData();
        form.submit();
    });

    // O botão de salvar pode submeter diretamente
    document.getElementById('saveButton')?.addEventListener('click', function(e) {
        prepareFormData();
        form.submit();
    });
    
    // Implementação do filtro para a tabela de logs
    const logFilter = document.getElementById('logFilter');
    const dateFilter = document.getElementById('dateFilter');
    const logsTable = document.getElementById('logsTable');
    
    if (logFilter && dateFilter && logsTable) {
        // Função para filtrar a tabela
        function filterLogsTable() {
            const filterText = logFilter.value.toLowerCase();
            const filterDate = dateFilter.value;
            
            const rows = logsTable.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const description = row.cells[0].textContent.toLowerCase();
                const dateCell = row.cells[1].textContent;
                
                // Verificar se a descrição contém o texto do filtro
                const matchesText = description.includes(filterText);
                
                // Verificar se a data corresponde ao filtro de data
                let matchesDate = true;
                if (filterDate) {
                    // Converter a data do formato dd/mm/yyyy para yyyy-mm-dd para comparação
                    const dateParts = dateCell.split(' ')[0].split('/');
                    const rowDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                    matchesDate = rowDate === filterDate;
                }
                
                // Mostrar ou esconder a linha com base nos filtros
                if (matchesText && matchesDate) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Verificar se há linhas visíveis
            const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
            const noResultsMessage = logsTable.nextElementSibling;
            
            if (visibleRows.length === 0) {
                if (!noResultsMessage || !noResultsMessage.classList.contains('text-muted')) {
                    const message = document.createElement('p');
                    message.className = 'text-muted mt-3';
                    message.textContent = 'Nenhum resultado encontrado.';
                    logsTable.parentNode.insertBefore(message, logsTable.nextSibling);
                }
            } else if (noResultsMessage && noResultsMessage.classList.contains('text-muted')) {
                noResultsMessage.remove();
            }
        }
        
        // Adicionar eventos para os filtros
        logFilter.addEventListener('input', filterLogsTable);
        dateFilter.addEventListener('change', filterLogsTable);
    }
});
</script>
{% endblock %}
