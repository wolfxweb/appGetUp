{% extends "base.html" %}

{% block title %}{% if edit_mode %}Editar{% else %}Novo{% endif %} Dados Básicos{% endblock %}

{% block extra_css %}
<style>
    .navbar {
        z-index: 1000;
        display: flex !important;
        visibility: visible !important;
    }

    .help-icon {
        cursor: pointer;
        margin-left: 5px;
        opacity: 0.7;
        transition: opacity 0.3s ease;
    }

    .help-icon:hover {
        opacity: 1;
    }

    .modal {
        z-index: 1050;
    }

    .custom-bg {
        background-color: #f8f9fa; /* Cor de fundo clara, semelhante ao bg-light */
    }
</style>
{% endblock %}

{% block content %}
{% with active_page='basic_data' %}
{% include 'components/navbar.html' %}
{% endwith %}

<div class="container-fluid p-5">
    <div class="row">
        <div class="col-md-10 mx-auto">
            {% if error_message %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {{ error_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
            {% endif %}

            {% if warning_message %}
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                {{ warning_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
            {% endif %}

            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-graph-up"></i> 
                        {% if edit_mode %}Editar{% else %}Adicionar{% endif %} Dados Básicos
                    </h5>
                </div>
                <div class="card-body">

                    <form method="post" action="/basic-data/save">
                        {% if show_confirm %}
                        <input type="hidden" name="confirm_update" value="true">
                        {% endif %}
                      
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="month" class="form-label">
                                    Mês* 
                                    <i class="bi bi-question-circle text-primary help-icon" data-bs-toggle="modal" data-bs-target="#monthHelpModal"></i>
                                </label>
                                <select class="form-select" id="month" name="month" required {% if edit_mode %}disabled{% endif %}>
                                    {% for month in range(1, 13) %}
                                    <option value="{{ month }}" 
                                        {% if basic_data and basic_data.month == month %}selected{% endif %}
                                        {% if month == month or month == basic_data.month %}selected{% endif %}>
                                        {{ ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][month-1] }}
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if edit_mode %}
                                    <input type="hidden" name="month" value="{{ basic_data.month }}">
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="year" class="form-label">
                                    Ano* 
                                    <i class="bi bi-question-circle text-primary help-icon" data-bs-toggle="modal" data-bs-target="#yearHelpModal"></i>
                                </label>
                                <input type="number" class="form-control" id="year" name="year" 
                                    value="{{ basic_data.year if basic_data else current_year }}" 
                                    min="2020" required {% if edit_mode %}disabled{% endif %}>
                                {% if edit_mode %}
                                    <input type="hidden" name="year" value="{{ basic_data.year }}">
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="clients_served" class="form-label">
                                    Quantidade de Clientes Atendidos* 
                                    <i class="bi bi-question-circle text-primary help-icon" data-bs-toggle="modal" data-bs-target="#clientsServedHelpModal"></i>
                                </label>
                                <input type="number" class="form-control" id="clients_served" name="clients_served" 
                                    value="{{ basic_data.clients_served if basic_data else '' }}" required min="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="sales_revenue" class="form-label">
                                    Faturamento com Vendas* 
                                    <i class="bi bi-question-circle text-primary help-icon" data-bs-toggle="modal" data-bs-target="#salesRevenueHelpModal"></i>
                                </label>
                                <input type="text" class="form-control" id="sales_revenue" name="sales_revenue" 
                                    value="{{ basic_data.sales_revenue if basic_data else '' }}" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="sales_expenses" class="form-label">
                                    Gastos com Vendas* 
                                    <i class="bi bi-question-circle text-primary help-icon" data-bs-toggle="modal" data-bs-target="#salesExpensesHelpModal"></i>
                                </label>
                                <input type="text" class="form-control" id="sales_expenses" name="sales_expenses" 
                                    value="{{ basic_data.sales_expenses if basic_data else '' }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="input_product_expenses" class="form-label">
                                    Gastos com Insumos e Produtos* 
                                    <i class="bi bi-question-circle text-primary help-icon" data-bs-toggle="modal" data-bs-target="#inputProductExpensesHelpModal"></i>
                                </label>
                                <input type="text" class="form-control" id="input_product_expenses" name="input_product_expenses" 
                                    value="{{ basic_data.input_product_expenses if basic_data else '' }}" required>
                            </div>
                        </div>

                        {% if user.activity_type in ['Comércio', 'Indústria'] %}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fixed_costs" class="form-label">
                                    Custos Fixos 
                                    <i class="bi bi-question-circle text-primary help-icon" data-bs-toggle="modal" data-bs-target="#fixedCostsHelpModal"></i>
                                </label>
                                <input type="text" class="form-control" id="fixed_costs" name="fixed_costs" 
                                    value="{{ basic_data.fixed_costs if basic_data else '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="ideal_profit_margin" class="form-label">
                                    Margem de Lucro Ideal (%) 
                                    <i class="bi bi-question-circle text-primary help-icon" data-bs-toggle="modal" data-bs-target="#idealProfitMarginHelpModal"></i>
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="ideal_profit_margin" name="ideal_profit_margin" 
                                        value="{{ basic_data.ideal_profit_margin if basic_data else '' }}" min="0" max="100" required>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="service_capacity" class="form-label">
                                    Capacidade de Atendimento 
                                    <i class="bi bi-question-circle text-primary help-icon" data-bs-toggle="modal" data-bs-target="#serviceCapacityHelpModal"></i>
                                </label>
                                <input type="text" class="form-control" id="service_capacity" name="service_capacity" 
                                    value="{{ basic_data.service_capacity if basic_data else '' }}">
                            </div>
                        </div>
                        {% endif %}

                        {% if user.activity_type == 'Serviços' %}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="pro_labore" class="form-label">
                                    Pró-labore 
                                    <i class="bi bi-question-circle text-primary help-icon" data-bs-toggle="modal" data-bs-target="#proLaboreHelpModal"></i>
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="pro_labore" name="pro_labore" 
                                        value="{{ basic_data.pro_labore if basic_data else '' }}">
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="work_hours_per_week" class="form-label">
                                    Horas de Trabalho por Semana 
                                    <i class="bi bi-question-circle text-primary help-icon" data-bs-toggle="modal" data-bs-target="#workHoursHelpModal"></i>
                                </label>
                                <input type="number" step="0.5" class="form-control" id="work_hours_per_week" name="work_hours_per_week" 
                                    value="{{ basic_data.work_hours_per_week if basic_data else '' }}" min="0" max="168">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="other_fixed_costs" class="form-label">
                                    Demais Custos Fixos 
                                    <i class="bi bi-question-circle text-primary help-icon" data-bs-toggle="modal" data-bs-target="#otherFixedCostsHelpModal"></i>
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="other_fixed_costs" name="other_fixed_costs" 
                                        value="{{ basic_data.other_fixed_costs if basic_data else '' }}">
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="ideal_service_profit_margin" class="form-label">
                                    Margem de Lucro Ideal (%) 
                                    <i class="bi bi-question-circle text-primary help-icon" data-bs-toggle="modal" data-bs-target="#idealServiceProfitMarginHelpModal"></i>
                                </label>
                                <div class="input-group">
                                    <input type="number" step="0.01" class="form-control" id="ideal_service_profit_margin" name="ideal_service_profit_margin" 
                                        value="{{ basic_data.ideal_service_profit_margin if basic_data else '' }}" min="0" max="100">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="form-group">
                            <label for="is_current">É o Atual?</label>
                            <select class="form-control" id="is_current" name="is_current">
                                <option value="true" {% if basic_data and basic_data.is_current %}selected{% endif %}>Sim</option>
                                <option value="false" {% if basic_data and not basic_data.is_current %}selected{% endif %}>Não</option>
                            </select>
                        </div>

                        <div class="d-grid mt-4">
                            {% if edit_mode %}
                                <button type="button" class="btn btn-primary" id="updateButton">
                                    <i class="bi bi-check-circle"></i> Atualizar Dados
                                </button>
                            {% else %}
                                <button type="submit" class="btn btn-primary" id="saveButton">
                                    <i class="bi bi-check-circle"></i> Salvar Dados
                                </button>
                            {% endif %}
                        </div>
                    </form>

                    <!-- Tabela de Logs - Adicionada aqui -->
                    {% if edit_mode %}
                        <div class="card mt-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Histórico de Alterações</h5>
                            </div>
                            <div class="card-body bg-light">
                                <table class="table table-striped">
                                    <thead>
                                       
                                    </thead>
                                    <tbody>
                                        {% for log in logs %}
                                        <tr>
                                            <td>{{ log.change_description }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                {% if logs|length == 0 %}
                                <p class="text-muted">Nenhuma alteração registrada.</p>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="confirmReplaceModal" tabindex="-1" data-bs-backdrop="static" aria-labelledby="confirmReplaceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmReplaceModalLabel">Confirmar Substituição</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                Já existe um registro para este mês. Deseja substituir?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não</button>
                <button type="button" class="btn btn-primary" id="confirmReplace">Sim</button>
            </div>
        </div>
    </div>
</div>

<!-- Help Modals -->
<div class="modal fade" id="monthHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Mês</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Selecione o mês correspondente aos dados que você está registrando. Por padrão, o mês atual é selecionado.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="yearHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Ano</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Insira o ano correspondente aos dados que você está registrando. O ano atual é selecionado por padrão.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="clientsServedHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Clientes Atendidos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Informe o número total de clientes atendidos no período. Considere todos os clientes que receberam seus serviços ou produtos.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="salesRevenueHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Faturamento com Vendas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Registre o valor total de receitas geradas pelas vendas no período. Inclua todos os valores recebidos de clientes.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="salesExpensesHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Gastos com Vendas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Informe todos os custos diretamente relacionados às vendas, como comissões, taxas de transação, despesas de marketing, etc.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="inputProductExpensesHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Gastos com Insumos e Produtos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Registre o valor gasto em matérias-primas, produtos para revenda ou insumos necessários para a produção ou prestação de serviços.
            </div>
        </div>
    </div>
</div>

{% if user.activity_type in ['Comércio', 'Indústria'] %}
<div class="modal fade" id="fixedCostsHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Custos Fixos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Informe os custos que permanecem constantes independentemente do volume de vendas, como aluguel, salários fixos, energia, água, etc.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="idealProfitMarginHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Margem de Lucro Ideal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Indique a porcentagem de lucro que você considera ideal para seu negócio após descontar todos os custos e despesas.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="serviceCapacityHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Capacidade de Atendimento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Descreva sua capacidade de atendimento, como número máximo de clientes, produtos que pode produzir, ou serviços que pode realizar.
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if user.activity_type == 'Serviços' %}
<div class="modal fade" id="proLaboreHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Pró-labore</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Registre o valor do pró-labore, que é a remuneração do empresário pelos serviços prestados à empresa.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="workHoursHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Horas de Trabalho por Semana</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Informe o total de horas trabalhadas por semana. O máximo possível é 168 horas (7 dias * 24 horas).
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="otherFixedCostsHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Demais Custos Fixos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Registre outros custos fixos não cobertos anteriormente, como despesas administrativas, manutenção de equipamentos, etc.
            </div>
        </div>
    </div>
</div>
{% endif %}
<div class="modal fade" id="idealServiceProfitMarginHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuda: Margem de Lucro Ideal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Indique a porcentagem de lucro que você considera ideal para seus serviços após descontar todos os custos e despesas.
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const currencyInputs = [
        'sales_revenue', 
        'sales_expenses', 
        'input_product_expenses', 
        'fixed_costs', 
        'pro_labore', 
        'other_fixed_costs'
    ];

    // Form submission handling
    const form = document.querySelector('form');
    const confirmReplaceModal = document.getElementById('confirmReplaceModal');
    const confirmModal = new bootstrap.Modal(confirmReplaceModal, {
        backdrop: 'static',
        keyboard: false
    });
    let isConfirmed = false;
    const isEditMode = {% if edit_mode %}true{% else %}false{% endif %};

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Se já foi confirmado, permite o envio
        if (isConfirmed) {
            form.submit();
            return;
        }

        // Se não estiver em modo de edição, envia o formulário diretamente
        if (!isEditMode) {
            form.submit();
            return;
        }

        // Verifica se já existe registro para o mês/ano selecionado
        const month = document.getElementById('month').value;
        const year = document.getElementById('year').value;
        
        try {
            const response = await fetch(`/basic-data/check/${year}/${month}`);
            const data = await response.json();

            if (data.exists) {
                // Se existe, mostra o modal de confirmação
                confirmModal.show();
            } else {
                // Se não existe, envia o formulário normalmente
                form.submit();
            }
        } catch (error) {
            console.error('Erro ao verificar dados existentes:', error);
            form.submit(); // Em caso de erro, tenta enviar mesmo assim
        }
    });

    // Botão de confirmação no modal
    document.getElementById('confirmReplace').addEventListener('click', function() {
        isConfirmed = true;
        confirmModal.hide();
        
        // Remover qualquer backdrop residual
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => {
            backdrop.parentNode.removeChild(backdrop);
        });
        
        // Remover classes que o Bootstrap adiciona ao body
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');
        
        // Submeter o formulário após um breve delay
        setTimeout(() => {
            form.submit();
        }, 100);
    });

    // Reset da confirmação quando o modal é fechado
    confirmReplaceModal.addEventListener('hidden.bs.modal', function() {
        if (!isConfirmed) {
            isConfirmed = false;
        }
        
        // Remover qualquer backdrop residual quando o modal é fechado por qualquer razão
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => {
            backdrop.parentNode.removeChild(backdrop);
        });
        
        // Remover classes que o Bootstrap adiciona ao body
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');
    });

    // Submissão do formulário para o botão de atualizar
    document.getElementById('updateButton')?.addEventListener('click', function(e) {
        e.preventDefault();
        form.submit();
    });

    // O botão de salvar pode submeter diretamente
    document.getElementById('saveButton')?.addEventListener('click', function(e) {
        form.submit();
    });
});
</script>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ... existing script code ...
});
</script>
{% endblock %}
