{% extends "base.html" %}

{% block title %}{% if edit_mode %}Editar{% else %}Novo{% endif %} Dados Básicos{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #F5F5F5;
    }
    
    .navbar {
        z-index: 1000;
        display: flex !important;
        visibility: visible !important;
    }

    .help-icon {
        cursor: pointer;
        margin-left: 5px;
        opacity: 0.7;
        transition: opacity 0.3s ease;
    }

    .help-icon:hover {
        opacity: 1;
    }

    .modal {
        z-index: 9999 !important;
    }

    .modal-backdrop {
        z-index: 9998 !important;
    }

    .custom-bg {
        background-color: #f8f9fa;
    }
    
    .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }

    #warningMessage {
        font-size: 1.1em;
        padding: 15px;
        border-left: 5px solid #ffc107;
        background-color: #fff3cd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
        position: relative;
        z-index: 10;
    }

    #warningMessage p {
        margin: 0;
    }

    #warningMessage i {
        color: #ffc107;
        font-size: 1.2em;
        margin-right: 10px;
    }

    #warningMessage a {
        font-weight: 600;
        text-decoration: none;
    }

    #warningMessage a:hover {
        text-decoration: underline;
    }

    #saveButtonContainer.hide {
        display: none !important;
    }

    .form-control, .form-select {
        background-color: #F5F5F5 !important;
    }

    .input-group-text {
        background-color: #F5F5F5 !important;
    }

    .invalid-percentage {
        background-color: #ffebee !important;
        border-color: #dc3545 !important;
        color: #dc3545 !important;
    }

    #other_fixed_costs_percentual.invalid-percentage {
        background-color: #ffebee !important;
        border-color: #dc3545 !important;
        color: #dc3545 !important;
    }

    /* Pagination icons styling */
    .pagination .page-link {
        color: #6c757d !important;
        border-color: #6c757d !important;
    }
    
    .pagination .page-link:hover {
        color: #5a6268 !important;
        background-color: #e9ecef !important;
        border-color: #5a6268 !important;
    }
    
    .pagination .page-item.active .page-link {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
        color: white !important;
    }
    
    .pagination .page-item.disabled .page-link {
        color: #adb5bd !important;
        border-color: #dee2e6 !important;
    }

    /* Modal headers styling */
    .modal-header {
        background-color: #6c757d !important;
        color: white !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5" style="background-color: #F5F5F5; min-height: 100vh;">
    <div class="row">
        <div class="col-12">
           
            {% if error_message %}
            <!--
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {{ error_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
            -->
            {% endif %}

            {% if warning_message %}
            <!--
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                {{ warning_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
            -->

                <b>{{ warning_message }}</b>
              </div>
            {% endif %}
            
           
            <div class="card shadow-sm" style="background-color: #F5F5F5;">
                <div class="card-body">
                    <!-- Logo alinhada à esquerda dentro do card -->
                    <div class="mb-4">
                        <img src="{{ url_for('static', path='images/Logo.png') }}" alt="Gestão de Custos" class="img-fluid" style="max-width: 150px;">                    
                    </div>
                    <div class="row">
                        <!-- Coluna da Logo e Texto (3 colunas) -->
                        <div class="col-md-3">
                            <div class="d-flex flex-column align-items-center">
                                <div class="mb-4">
                                    <img src="{{ url_for('static', path='images/user-register.jpg') }}" alt="Gestão de Custos" class="img-fluid" style="max-width: 200px;">
                                </div>
                                <div class="text-center">
                                    <p class="mb-2" style="font-size: 1.2rem;">
                                        Todos os dados devem se referir ao mês selecionado.
                                        Os Dados Básicos viabilizam o uso desta plataforma e determinam a atualidade e qualidade dos cálculos e análises.
                                        Se você puder anotar os dados de meses anteriores, terá uma visão mais ampla do desempenho do seu negócio.</p>

                                </div>
                            </div>
                        </div>

                        <!-- Coluna do Formulário (9 colunas) -->
                        <div class="col-md-9">
                            <!-- Nova linha com os 4 botões -->
                            <div class="row mb-4">
                                <div class="col-12 col-md-3 mb-2 mb-md-0">
                                    <a href="/dashboard" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
                                        Índice
                                    </a>
                                </div>
                                <div class="col-12 col-md-3 mb-2 mb-md-0">
                                    <a href="/diagnostico"  type="button" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
                                        Diagnóstico
                                    </a>
                                </div>
                                <div class="col-12 col-md-3 mb-2 mb-md-0">
                                    <a href="/simulador" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
                                        Simulador
                                    </a>
                                </div>
                                <div class="col-12 col-md-3">
                                    <button type="button" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
                                        Calculadora de preços
                                    </button>
                                </div>
                            </div>
                            <div class="card" style="background-color: #F0F0F0;">
                                <div class="card-body">
                                    {% if user.activity_type != 'Comércio atacadista' and user.activity_type != 'Comércio varejista' %}
                                    <form method="post" action="{% if edit_mode %}/basic-data/update/{{ basic_data.id }}{% else %}/basic-data/save{% endif %}" id="basicDataForm">
                                        {% if show_confirm %}
                                        <input type="hidden" name="confirm_update" value="true">
                                        {% endif %}
                                      
                                        <input type="hidden" name="edit_mode" value="{{ 'true' if edit_mode else 'false' }}">
                                        {% if basic_data %}
                                        <input type="hidden" name="data_id" value="{{ basic_data.id }}">
                                        {% endif %}
                                      
                                        <!-- Primeira linha: Mês e Ano -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="month" class="form-label">
                                                    Mês* 
                                                    <img src="{{ url_for('static', path='images/icone_lampada.png') }}" alt="Ajuda" style="width: 22px; height: 22px; cursor: pointer; margin-left: 5px;" data-bs-toggle="modal" data-bs-target="#monthHelpModal" />
                                                </label>
                                                <select class="form-select" id="month" name="month" required {% if edit_mode %}disabled{% endif %}>
                                                    {% for month in range(1, 13) %}
                                                    <option value="{{ month }}" 
                                                        {% if basic_data and basic_data.month == month %}selected{% endif %}
                                                        {% if not basic_data and month == (current_month - 1 if current_month > 1 else 12) %}selected{% endif %}>
                                                        {{ ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][month-1] }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                                {% if edit_mode %}
                                                    <input type="hidden" name="month" value="{{ basic_data.month }}">
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="year" class="form-label">
                                                    Ano* 
                                                    <img src="{{ url_for('static', path='images/icone_lampada.png') }}" alt="Ajuda" style="width: 22px; height: 22px; cursor: pointer; margin-left: 5px;" data-bs-toggle="modal" data-bs-target="#yearHelpModal" />
                                                </label>
                                                <input type="number" class="form-control" id="year" name="year" 
                                                    value="{{ basic_data.year if basic_data else current_year }}" 
                                                    min="2020" required {% if edit_mode %}disabled{% endif %}>
                                                {% if edit_mode %}
                                                    <input type="hidden" name="year" value="{{ basic_data.year }}">
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Segunda linha: Clientes e Faturamento -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="clients_served" class="form-label">
                                                    Quantidade de Clientes Atendidos* 
                                                    <img src="{{ url_for('static', path='images/icone_lampada.png') }}" alt="Ajuda" style="width: 22px; height: 22px; cursor: pointer; margin-left: 5px;" data-bs-toggle="modal" data-bs-target="#clientsServedHelpModal" />
                                                </label>
                                                <input type="number" class="form-control" id="clients_served" name="clients_served" 
                                                    value="{{ basic_data.clients_served if basic_data else '' }}" required min="0">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="sales_revenue" class="form-label">
                                                    Faturamento com Vendas* 
                                                    <img src="{{ url_for('static', path='images/icone_lampada.png') }}" alt="Ajuda" style="width: 22px; height: 22px; cursor: pointer; margin-left: 5px;" data-bs-toggle="modal" data-bs-target="#salesRevenueHelpModal" />
                                                </label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="sales_revenue" name="sales_revenue" 
                                                        value="{{ basic_data.sales_revenue|float if basic_data and basic_data.sales_revenue is not none else '' }}" 
                                                        required pattern="^R?\$?\s*[\d.,]+$">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Terceira linha: Gastos -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="sales_expenses" class="form-label">
                                                    Gastos com Vendas* 
                                                    <img src="{{ url_for('static', path='images/icone_lampada.png') }}" alt="Ajuda" style="width: 22px; height: 22px; cursor: pointer; margin-left: 5px;" data-bs-toggle="modal" data-bs-target="#salesExpensesHelpModal" />
                                                </label>
                                                <div class="input-group">
                                                    <div class="col-9 p-0">
                                                        <input type="text" class="form-control" id="sales_expenses_display" 
                                                            value="{{ basic_data.sales_expenses|float if basic_data and basic_data.sales_expenses is not none else '' }}" 
                                                            required pattern="^R?\$?\s*[\d.,]+$">
                                                        <input type="hidden" id="sales_expenses" name="sales_expenses" value="{{ basic_data.sales_expenses|float if basic_data and basic_data.sales_expenses is not none else '0' }}">
                                                    </div>
                                                    <div class="col-3 p-0">
                                                        <input type="text" class="form-control" id="sales_expenses_percentual" readonly>
                                                        <input type="hidden" id="sales_expenses_percentual_hidden" name="sales_expenses_percentual">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="input_product_expenses" class="form-label">
                                                    Gastos com Insumos e Produtos* 
                                                    <img src="{{ url_for('static', path='images/icone_lampada.png') }}" alt="Ajuda" style="width: 22px; height: 22px; cursor: pointer; margin-left: 5px;" data-bs-toggle="modal" data-bs-target="#inputProductExpensesHelpModal" />
                                                </label>
                                                <div class="input-group">
                                                    <div class="col-9 p-0">
                                                        <input type="text" class="form-control" id="input_product_expenses_display" 
                                                            value="{{ basic_data.input_product_expenses|float if basic_data and basic_data.input_product_expenses is not none else '' }}" 
                                                            required pattern="^R?\$?\s*[\d.,]+$">
                                                        <input type="hidden" id="input_product_expenses" name="input_product_expenses" value="{{ basic_data.input_product_expenses|float if basic_data and basic_data.input_product_expenses is not none else '0' }}">
                                                    </div>
                                                    <div class="col-3 p-0">
                                                        <input type="text" class="form-control" id="input_product_expenses_percentual" readonly>
                                                        <input type="hidden" id="input_product_expenses_percentual_hidden" name="input_product_expenses_percentual">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Quarta linha: Pró-labore e Custos Fixos -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="pro_labore" class="form-label">
                                                    Pró-labore 
                                                    <img src="{{ url_for('static', path='images/icone_lampada.png') }}" alt="Ajuda" style="width: 22px; height: 22px; cursor: pointer; margin-left: 5px;" data-bs-toggle="modal" data-bs-target="#proLaboreHelpModal" />
                                                </label>
                                                <div class="input-group">
                                                    <div class="col-9 p-0">
                                                        <input type="text" class="form-control" id="pro_labore" name="pro_labore" 
                                                            value="{{ basic_data.pro_labore|round(2) if basic_data and basic_data.pro_labore is not none else '' }}">
                                                    </div>
                                                    <div class="col-3 p-0">
                                                        <input type="text" class="form-control" id="pro_labore_percentual" readonly>
                                                        <input type="hidden" id="pro_labore_percentual_hidden" name="pro_labore_percentual">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="other_fixed_costs" class="form-label">
                                                    Demais Custos Fixos* 
                                                    <img src="{{ url_for('static', path='images/icone_lampada.png') }}" alt="Ajuda" style="width: 22px; height: 22px; cursor: pointer; margin-left: 5px;" data-bs-toggle="modal" data-bs-target="#otherFixedCostsHelpModal" />
                                                </label>
                                                <div class="input-group">
                                                    <div class="col-9 p-0">
                                                        <input type="text" class="form-control" id="other_fixed_costs" name="other_fixed_costs" 
                                                            value="{{ basic_data.other_fixed_costs|round(2) if basic_data and basic_data.other_fixed_costs is not none else '' }}">
                                                    </div>
                                                    <div class="col-3 p-0">
                                                        <input type="text" class="form-control" id="other_fixed_costs_percentual" name="other_fixed_costs_percentual" readonly>
                                                        <input type="hidden" id="other_fixed_costs_percentual_hidden" name="other_fixed_costs_percentual_hidden">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Quinta linha: Horas e Capacidade -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="work_hours_per_week" class="form-label">
                                                    Horas de Trabalho por Semana 
                                                    <img src="{{ url_for('static', path='images/icone_lampada.png') }}" alt="Ajuda" style="width: 22px; height: 22px; cursor: pointer; margin-left: 5px;" data-bs-toggle="modal" data-bs-target="#workHoursHelpModal" />
                                                </label>
                                                <input type="number" step="1" class="form-control" id="work_hours_per_week" name="work_hours_per_week" 
                                                    value="{{ basic_data.work_hours_per_week|int if basic_data and basic_data.work_hours_per_week else '' }}" min="0" max="168">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="service_capacity" class="form-label">
                                                    Capacidade de Atendimento 
                                                    <img src="{{ url_for('static', path='images/icone_lampada.png') }}" alt="Ajuda" style="width: 22px; height: 22px; cursor: pointer; margin-left: 5px;" data-bs-toggle="modal" data-bs-target="#serviceCapacityHelpModal" />
                                                </label>
                                                <input type="text" class="form-control" id="service_capacity" name="service_capacity" 
                                                    value="{{ basic_data.service_capacity if basic_data else '' }}">
                                            </div>
                                        </div>

                                        <!-- Sexta linha: Margem de Lucro -->
                                        <div class="row justify-content-center">
                                            <div class="col-md-4">
                                                <div class="text-center mb-2">
                                                    <label for="ideal_service_profit_margin" class="form-label">
                                                        Margem de Lucro Ideal (%)
                                                        <img src="{{ url_for('static', path='images/icone_lampada.png') }}" alt="Ajuda" style="width: 22px; height: 22px; cursor: pointer; margin-left: 5px;" data-bs-toggle="modal" data-bs-target="#idealServiceProfitMarginHelpModal" />
                                                    </label>
                                                </div>
                                                <div class="input-group">
                                                    <input type="number" step="1" class="form-control" id="ideal_service_profit_margin" name="ideal_service_profit_margin" 
                                                        value="{{ basic_data.ideal_service_profit_margin|int if basic_data and basic_data.ideal_service_profit_margin else '' }}" min="0" max="100">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                        </div>
                                            
            {% if error_message %}
            <!--
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {{ error_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
            -->
            <div class="col-12 text-center bg-warning text-secondary p-2 mt-4">
                <b>{{ error_message }}</b>
              </div>
            
            {% endif %}

                                        <div class="row mt-4">
                                            <div class="col-12 text-center">
                                                <button type="button" class="btn btn-secondary me-2" style="background-color: #6c757d; border-color: #6c757d;" onclick="document.getElementById('basicDataForm').reset();">
                                                    Limpar
                                                </button>
                                                <button type="submit" class="btn btn-secondary me-2" style="background-color: #6c757d; border-color: #6c757d;">
                                                    {% if edit_mode %}Atualizar{% else %}Salvar{% endif %}
                                                </button>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-12 text-center">
                                                <a href="/basic-data/" class="btn btn-secondary" style="background-color: #6c757d; border-color: #6c757d;">
                                                    Histórico
                                                </a>
                                            </div>
                                        </div>
                                    </form>
                                    {% else %}
                                    <!-- Formulario dados basicos  comercio e industria-->
                                    <form method="post" action="{% if edit_mode %}/basic-data/update/{{ basic_data.id }}{% else %}/basic-data/save{% endif %}" id="basicDataForm">
                                        {% if show_confirm %}
                                        <input type="hidden" name="confirm_update" value="true">
                                        {% endif %}
                                      
                                        <input type="hidden" name="edit_mode" value="{{ 'true' if edit_mode else 'false' }}">
                                        {% if basic_data %}
                                        <input type="hidden" name="data_id" value="{{ basic_data.id }}">
                                        {% endif %}
                                      
                                        <!-- Primeira linha: Mês e Ano -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="month" class="form-label">
                                                    Mês* 
                                                    <img src="{{ url_for('static', path='images/icone_lampada.png') }}" alt="Ajuda" style="width: 22px; height: 22px; cursor: pointer; margin-left: 5px;" data-bs-toggle="modal" data-bs-target="#monthHelpModal" />
                                                </label>
                                                <select class="form-select" id="month" name="month" required {% if edit_mode %}disabled{% endif %}>
                                                    {% for month in range(1, 13) %}
                                                    <option value="{{ month }}" 
                                                        {% if basic_data and basic_data.month == month %}selected{% endif %}
                                                        {% if not basic_data and month == (current_month - 1 if current_month > 1 else 12) %}selected{% endif %}>
                                                        {{ ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][month-1] }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                                {% if edit_mode %}
                                                    <input type="hidden" name="month" value="{{ basic_data.month }}">
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="year" class="form-label">
                                                    Ano* 
                                                    <img src="{{ url_for('static', path='images/icone_lampada.png') }}" alt="Ajuda" style="width: 22px; height: 22px; cursor: pointer; margin-left: 5px;" data-bs-toggle="modal" data-bs-target="#yearHelpModal" />
                                                </label>
                                                <input type="number" class="form-control" id="year" name="year" 
                                                    value="{{ basic_data.year if basic_data else current_year }}" 
                                                    min="2020" required {% if edit_mode %}disabled{% endif %}>
                                                {% if edit_mode %}
                                                    <input type="hidden" name="year" value="{{ basic_data.year }}">
                                                {% endif %}
                                            </div>
                                        </div>
                
                                        <!-- Segunda linha: Faturamento e Quantidade de Clientes -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="sales_revenue" class="form-label">
                                                    Faturamento com Vendas* 
                                                    <img src="{{ url_for('static', path='images/icone_lampada.png') }}" alt="Ajuda" style="width: 22px; height: 22px; cursor: pointer; margin-left: 5px;" data-bs-toggle="modal" data-bs-target="#salesRevenueHelpModal" />
                                                </label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="sales_revenue" name="sales_revenue" 
                                                        value="{{ basic_data.sales_revenue|float if basic_data and basic_data.sales_revenue is not none else '' }}" 
                                                        required pattern="^R?\$?\s*[\d.,]+$">
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="clients_served" class="form-label">
                                                    Quantidade de Clientes Atendidos
                                                    <img src="{{ url_for('static', path='images/icone_lampada.png') }}" alt="Ajuda" style="width: 22px; height: 22px; cursor: pointer; margin-left: 5px;" data-bs-toggle="modal" data-bs-target="#clientsServedHelpModal" />
                                                </label>
                                                <input type="number" class="form-control" id="clients_served" name="clients_served" 
                                                    value="{{ basic_data.clients_served if basic_data else '' }}" min="0">
                                            </div>
                                        </div>
                
                                        <!-- Terceira linha: Gastos -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="sales_expenses" class="form-label">
                                                    Gastos com Vendas* 
                                                    <img src="{{ url_for('static', path='images/icone_lampada.png') }}" alt="Ajuda" style="width: 22px; height: 22px; cursor: pointer; margin-left: 5px;" data-bs-toggle="modal" data-bs-target="#salesExpensesHelpModal" />
                                                </label>
                                                <div class="input-group">
                                                    <div class="col-9 p-0">
                                                        <input type="text" class="form-control" id="sales_expenses_display" 
                                                            value="{{ basic_data.sales_expenses|float if basic_data and basic_data.sales_expenses is not none else '' }}" 
                                                            required pattern="^R?\$?\s*[\d.,]+$">
                                                        <input type="hidden" id="sales_expenses" name="sales_expenses" value="{{ basic_data.sales_expenses|float if basic_data and basic_data.sales_expenses is not none else '0' }}">
                                                    </div>
                                                    <div class="col-3 p-0">
                                                        <input type="text" class="form-control" id="sales_expenses_percentual" readonly>
                                                        <input type="hidden" id="sales_expenses_percentual_hidden" name="sales_expenses_percentual">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="input_product_expenses" class="form-label">
                                                    Gastos com Insumos e Produtos* 
                                                    <img src="{{ url_for('static', path='images/icone_lampada.png') }}" alt="Ajuda" style="width: 22px; height: 22px; cursor: pointer; margin-left: 5px;" data-bs-toggle="modal" data-bs-target="#inputProductExpensesHelpModal" />
                                                </label>
                                                <div class="input-group">
                                                    <div class="col-9 p-0">
                                                        <input type="text" class="form-control" id="input_product_expenses_display" 
                                                            value="{{ basic_data.input_product_expenses|float if basic_data and basic_data.input_product_expenses is not none else '' }}" 
                                                            required pattern="^R?\$?\s*[\d.,]+$">
                                                        <input type="hidden" id="input_product_expenses" name="input_product_expenses" value="{{ basic_data.input_product_expenses|float if basic_data and basic_data.input_product_expenses is not none else '0' }}">
                                                    </div>
                                                    <div class="col-3 p-0">
                                                        <input type="text" class="form-control" id="input_product_expenses_percentual" readonly>
                                                        <input type="hidden" id="input_product_expenses_percentual_hidden" name="input_product_expenses_percentual">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                
                                        <!-- Quarta linha: Custos Fixos e Capacidade de Atendimento -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="other_fixed_costs" class="form-label">
                                                    Custos Fixos 
                                                    <img src="{{ url_for('static', path='images/icone_lampada.png') }}" alt="Ajuda" style="width: 22px; height: 22px; cursor: pointer; margin-left: 5px;" data-bs-toggle="modal" data-bs-target="#fixedCostsHelpModal" />
                                                </label>
                                                <div class="input-group">
                                                    <div class="col-9 p-0">
                                                        <input type="text" class="form-control" id="other_fixed_costs" name="other_fixed_costs" 
                                                            value="{{ basic_data.other_fixed_costs|round(2) if basic_data and basic_data.other_fixed_costs is not none else '' }}">
                                                    </div>
                                                    <div class="col-3 p-0">
                                                        <input type="text" class="form-control" id="other_fixed_costs_percentual" readonly>
                                                        <input type="hidden" id="other_fixed_costs_percentual_hidden" name="other_fixed_costs_percentual_hidden">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="service_capacity" class="form-label">
                                                    Capacidade de Atendimento
                                                    <img src="{{ url_for('static', path='images/icone_lampada.png') }}" alt="Ajuda" style="width: 22px; height: 22px; cursor: pointer; margin-left: 5px;" data-bs-toggle="modal" data-bs-target="#serviceCapacityHelpModal" />
                                                </label>
                                                <input type="text" class="form-control" id="service_capacity" name="service_capacity" 
                                                    value="{{ basic_data.service_capacity if basic_data else '' }}">
                                            </div>
                                        </div>
                
                                        <!-- Quinta linha: Margem de Lucro Ideal -->
                                        <div class="row justify-content-center">
                                            <div class="col-md-4">
                                                <div class="text-center mb-2">
                                                    <label for="ideal_service_profit_margin" class="form-label">
                                                        Margem de Lucro Ideal (%)
                                                        <img src="{{ url_for('static', path='images/icone_lampada.png') }}" alt="Ajuda" style="width: 22px; height: 22px; cursor: pointer; margin-left: 5px;" data-bs-toggle="modal" data-bs-target="#idealProfitMarginHelpModal" />
                                                    </label>
                                                </div>
                                                <div class="input-group">
                                                    <input type="number" step="1" class="form-control" id="ideal_service_profit_margin" name="ideal_service_profit_margin" 
                                                        value="{{ basic_data.ideal_service_profit_margin|int if basic_data and basic_data.ideal_service_profit_margin else '' }}" min="0" max="100">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mt-4">
                                        {% if error_message and edit_mode %}
                                        <div class="col-12 text-center bg-warning text-white p-2">
                                          <b>{{ error_message }}</b>
                                        </div>
                                        {% endif %}
                                        </div>
                                        <div class="row mt-4">
                                            <div class="col-12 text-center">
                                                <button type="button" class="btn btn-secondary me-2" style="background-color: #6c757d; border-color: #6c757d;" onclick="document.getElementById('basicDataForm').reset();">
                                                    Limpar
                                                </button>
                                                <button type="submit" class="btn btn-secondary me-2" style="background-color: #6c757d; border-color: #6c757d;">
                                                    {% if edit_mode %}Atualizar{% else %}Salvar{% endif %}
                                                </button>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-12 text-center">
                                                <a href="/basic-data/" class="btn btn-secondary" style="background-color: #6c757d; border-color: #6c757d;">
                                                    Histórico
                                                </a>
                                            </div>
                                        </div>
                                    </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>  
        </div>
    </div>

    <!-- Tabela de Logs - Movida para fora do card principal -->
    {% if edit_mode %}
    <div class="row mt-4 mb-5">
        <div class="col-12">
            <div class="card" style="background-color: #F0F0F0;">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Histórico de Alterações</h5>
                </div>
                <div class="card-body">
                    <!-- Filtros para o histórico -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="logFilter" placeholder="Filtrar por descrição...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                <input type="date" class="form-control" id="dateFilter">
                            </div>
                        </div>
                    </div>
                    
                    <table class="table table-striped" id="logsTable">
                        <thead>
                            <tr>
                                <th>Descrição da Alteração</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in logs %}
                            <tr>
                                <td>{{ log.change_description }}</td>
                                <td>{{ log.created_at.strftime('%d/%m/%Y') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% if logs|length == 0 %}
                    <p class="text-muted">Nenhuma alteração registrada.</p>
                    {% endif %}
                    
                    <!-- Controles de Paginação -->
                    {% if total_pages > 1 %}
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted">
                            Mostrando {{ logs|length }} de {{ total_logs }} registros
                            (Página {{ current_page }} de {{ total_pages }})
                        </div>
                        <nav aria-label="Paginação do histórico">
                            <ul class="pagination pagination-sm mb-0">
                                <!-- Primeira página -->
                                {% if current_page > 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="/basic-data/edit/{{ basic_data.id }}?page=1" aria-label="Primeira">
                                        <span aria-hidden="true">&laquo;&laquo;</span>
                                    </a>
                                </li>
                                <!-- Página anterior -->
                                <li class="page-item">
                                    <a class="page-link" href="/basic-data/edit/{{ basic_data.id }}?page={{ current_page - 1 }}" aria-label="Anterior">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">&laquo;&laquo;</span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link">&laquo;</span>
                                </li>
                                {% endif %}
                                
                                <!-- Páginas numeradas -->
                                {% for page_num in range(1, total_pages + 1) %}
                                    {% if page_num == current_page %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                    {% elif page_num >= current_page - 2 and page_num <= current_page + 2 %}
                                    <li class="page-item">
                                        <a class="page-link" href="/basic-data/edit/{{ basic_data.id }}?page={{ page_num }}">{{ page_num }}</a>
                                    </li>
                                    {% elif page_num == 1 or page_num == total_pages %}
                                    <li class="page-item">
                                        <a class="page-link" href="/basic-data/edit/{{ basic_data.id }}?page={{ page_num }}">{{ page_num }}</a>
                                    </li>
                                    {% elif page_num == current_page - 3 or page_num == current_page + 3 %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                    {% endif %}
                                {% endfor %}
                                
                                <!-- Próxima página -->
                                {% if current_page < total_pages %}
                                <li class="page-item">
                                    <a class="page-link" href="/basic-data/edit/{{ basic_data.id }}?page={{ current_page + 1 }}" aria-label="Próxima">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                                <!-- Última página -->
                                <li class="page-item">
                                    <a class="page-link" href="/basic-data/edit/{{ basic_data.id }}?page={{ total_pages }}" aria-label="Última">
                                        <span aria-hidden="true">&raquo;&raquo;</span>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">&raquo;</span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link">&raquo;&raquo;</span>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="confirmReplaceModal" tabindex="-1" data-bs-backdrop="static" aria-labelledby="confirmReplaceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmReplaceModalLabel">Registro Existente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p>Já existe um registro para o período selecionado. Deseja atualizar os dados existentes?</p>
                <p class="text-muted small">Ao confirmar, as alterações serão registradas no histórico de mudanças.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não</button>
                <button type="button" class="btn btn-primary" id="confirmReplace">Sim, Atualizar</button>
            </div>
        </div>
    </div>
</div>
  
<!-- Help Modals -->
<div class="modal fade" id="monthHelpModal" tabindex="-1" aria-labelledby="monthHelpModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mês</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Selecione o mês correspondente aos dados que você está registrando. Por padrão, o mês atual é selecionado.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="yearHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ano</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Insira o ano correspondente aos dados que você está registrando. O ano atual é selecionado por padrão.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="clientsServedHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Clientes Atendidos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Informe o número total de clientes atendidos no período. Considere todos os clientes que receberam seus serviços ou produtos.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="salesRevenueHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Faturamento com Vendas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Registre o valor total de receitas geradas pelas vendas no período. Inclua todos os valores recebidos de clientes.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="salesExpensesHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gastos com Vendas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Informe todos os custos diretamente relacionados às vendas, como comissões, taxas de transação, despesas de marketing, etc.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="inputProductExpensesHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gastos com Insumos e Produtos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Registre o valor gasto em matérias-primas, produtos para revenda ou insumos necessários para a produção ou prestação de serviços.
            </div>
        </div>
    </div>
</div>

{% if user.activity_type != 'Comércio atacadista' and user.activity_type != 'Comércio varejista' %}
<div class="modal fade" id="fixedCostsHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Custos Fixos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Informe os custos que permanecem constantes independentemente do volume de vendas, como aluguel, salários fixos, energia, água, etc.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="idealProfitMarginHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Margem de Lucro Ideal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Indique a porcentagem de lucro que você considera ideal para seu negócio após descontar todos os custos e despesas.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="serviceCapacityHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Capacidade de Atendimento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Descreva sua capacidade de atendimento, como número máximo de clientes, produtos que pode produzir, ou serviços que pode realizar.
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if user.activity_type != 'Comércio atacadista' and user.activity_type != 'Comércio varejista' %}
<div class="modal fade" id="proLaboreHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pró-labore</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Registre o valor do pró-labore, que é a remuneração do empresário pelos serviços prestados à empresa.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="workHoursHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Horas de Trabalho por Semana</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Informe o total de horas trabalhadas por semana. O máximo possível é 168 horas (7 dias * 24 horas).
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="otherFixedCostsHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Demais Custos Fixos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Registre outros custos fixos não cobertos anteriormente, como despesas administrativas, manutenção de equipamentos, etc.
            </div>
        </div>
    </div>
</div>
{% endif %}
<div class="modal fade" id="idealServiceProfitMarginHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Margem de Lucro Ideal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Indique a porcentagem de lucro que você considera ideal para seus serviços após descontar todos os custos e despesas.
            </div>
        </div>
    </div>
</div>

<script>
    // Função para formatar valores monetários
    function formatarMoeda(valor) {
        if (!valor) return '';
        
        // Remove caracteres não numéricos exceto ponto e vírgula
        let valorLimpo = valor.toString().replace(/[^\d.,]/g, '');
        
        // Se não tem vírgula nem ponto, assume que é um número inteiro
        if (!valorLimpo.includes(',') && !valorLimpo.includes('.')) {
            const numero = parseFloat(valorLimpo);
            if (isNaN(numero)) return '';
            return numero.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        // Se tem vírgula, trata como formato brasileiro (vírgula = decimal)
        if (valorLimpo.includes(',')) {
            // Se tem ponto antes da vírgula, remove pontos (separadores de milhares)
            const partes = valorLimpo.split(',');
            if (partes.length === 2) {
                const inteira = partes[0].replace(/\./g, '');
                const decimal = partes[1];
                const numero = parseFloat(inteira + '.' + decimal);
                if (isNaN(numero)) return '';
                return numero.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
        }
        
        // Se tem apenas ponto, trata como decimal
        if (valorLimpo.includes('.') && !valorLimpo.includes(',')) {
            const numero = parseFloat(valorLimpo);
            if (isNaN(numero)) return '';
            return numero.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        return valor.toString();
    }

    // Função para converter valor formatado para número
    function converterParaNumero(valor) {
        if (!valor) return 0;
        // Remove pontos (separadores de milhares)
        valor = valor.toString().replace(/\./g, '');
        // Substitui a vírgula por ponto (separador decimal)
        valor = valor.replace(',', '.');
        // Remove qualquer outro caractere não numérico exceto o ponto decimal
        valor = valor.replace(/[^\d.]/g, '');
        // Converte para número
        return parseFloat(valor) || 0;
    }

    // Função para calcular porcentagem
    function calcularPorcentagem(valor, receita) {
        if (!valor || !receita || receita === 0) return '';
        // Remove caracteres não numéricos e converte para número
        const valorNumerico = converterParaNumero(valor);
        const receitaNumerica = converterParaNumero(receita);
        const porcentagem = (valorNumerico / receitaNumerica) * 100;
        return porcentagem.toFixed(2) + '%';
    }

    // Função para verificar e aplicar cor na porcentagem
    function verificarPorcentagem(campo) {
        if (!campo.value) return;
        // Remove o símbolo % e converte para número
        const valor = parseFloat(campo.value.replace('%', ''));
        if (valor > 100) {
            campo.classList.add('invalid-percentage');
        } else {
            campo.classList.remove('invalid-percentage');
        }
    }

    // Função para atualizar campos hidden
    function updateHiddenFields() {
        // Sales Expenses
        const salesExpensesDisplay = document.getElementById('sales_expenses_display');
        const salesExpenses = document.getElementById('sales_expenses');
        if (salesExpensesDisplay && salesExpenses) {
            salesExpenses.value = converterParaNumero(salesExpensesDisplay.value);
        }

        // Input Product Expenses
        const inputProductExpensesDisplay = document.getElementById('input_product_expenses_display');
        const inputProductExpenses = document.getElementById('input_product_expenses');
        if (inputProductExpensesDisplay && inputProductExpenses) {
            inputProductExpenses.value = converterParaNumero(inputProductExpensesDisplay.value);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('basicDataForm');
        
        // Função para formatar valores iniciais
        function formatInitialValues() {
            const fields = [
                'sales_expenses_display',
                'input_product_expenses_display',
                'pro_labore',
                'other_fixed_costs',
                'sales_revenue'
            ];

            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value) {
                    field.value = formatarMoeda(field.value);
                }
            });
        }

        // Formatar valores iniciais
        formatInitialValues();

        // Atualizar campos quando os valores mudarem
        const monetaryFields = [
            'sales_expenses_display',
            'input_product_expenses_display',
            'pro_labore',
            'other_fixed_costs',
            'sales_revenue'
        ];

        monetaryFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', function(e) {
                    // Durante a digitação, apenas recalcula as porcentagens
                    // Não formata o valor para não interferir na digitação
                    recalcularPorcentagens();
                });

                field.addEventListener('blur', function() {
                    // Ao sair do campo, formata o valor
                    this.value = formatarMoeda(this.value);
                    recalcularPorcentagens();
                });
            }
        });

        // Função para recalcular todas as porcentagens
        function recalcularPorcentagens() {
            const receita = converterParaNumero(document.getElementById('sales_revenue').value);
            
            // Recalcular porcentagem de gastos com vendas em relação ao faturamento
            const salesExpensesDisplay = document.getElementById('sales_expenses_display');
            const salesExpensesPercentual = document.getElementById('sales_expenses_percentual');
            if (salesExpensesDisplay && salesExpensesPercentual && receita > 0) {
                const valorGastos = converterParaNumero(salesExpensesDisplay.value);
                const porcentagem = (valorGastos / receita) * 100;
                salesExpensesPercentual.value = porcentagem.toFixed(2) + '%';
                verificarPorcentagem(salesExpensesPercentual);
            } else if (salesExpensesPercentual) {
                salesExpensesPercentual.value = '0.00%';
            }

            // Recalcular porcentagem de gastos com insumos em relação ao faturamento
            const inputProductExpensesDisplay = document.getElementById('input_product_expenses_display');
            const inputProductExpensesPercentual = document.getElementById('input_product_expenses_percentual');
            if (inputProductExpensesDisplay && inputProductExpensesPercentual && receita > 0) {
                const valorInsumos = converterParaNumero(inputProductExpensesDisplay.value);
                const porcentagem = (valorInsumos / receita) * 100;
                inputProductExpensesPercentual.value = porcentagem.toFixed(2) + '%';
                verificarPorcentagem(inputProductExpensesPercentual);
            } else if (inputProductExpensesPercentual) {
                inputProductExpensesPercentual.value = '0.00%';
            }

            // Recalcular porcentagem de pró-labore em relação ao faturamento
            const proLabore = document.getElementById('pro_labore');
            const proLaborePercentual = document.getElementById('pro_labore_percentual');
            if (proLabore && proLaborePercentual && receita > 0) {
                const valorProLabore = converterParaNumero(proLabore.value);
                const porcentagem = (valorProLabore / receita) * 100;
                proLaborePercentual.value = porcentagem.toFixed(2) + '%';
                verificarPorcentagem(proLaborePercentual);
            } else if (proLaborePercentual) {
                proLaborePercentual.value = '0.00%';
            }

            // Recalcular porcentagem de custos fixos em relação ao faturamento
            const otherFixedCosts = document.getElementById('other_fixed_costs');
            const otherFixedCostsPercentual = document.getElementById('other_fixed_costs_percentual');
            if (otherFixedCosts && otherFixedCostsPercentual && receita > 0) {
                const valorCustosFixos = converterParaNumero(otherFixedCosts.value);
                const porcentagem = (valorCustosFixos / receita) * 100;
                otherFixedCostsPercentual.value = porcentagem.toFixed(2) + '%';
                verificarPorcentagem(otherFixedCostsPercentual);
            } else if (otherFixedCostsPercentual) {
                otherFixedCostsPercentual.value = '0.00%';
            }
        }

        // Atualizar porcentagens ao carregar a página
        recalcularPorcentagens();
        
        // Funcionalidade de filtros para o histórico de alterações
        const logFilter = document.getElementById('logFilter');
        const dateFilter = document.getElementById('dateFilter');
        const logsTable = document.getElementById('logsTable');
        
        if (logFilter && dateFilter && logsTable) {
            // Função para filtrar as linhas da tabela
            function filterLogs() {
                const filterText = logFilter.value.toLowerCase();
                const filterDate = dateFilter.value;
                const rows = logsTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
                
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const description = row.cells[0].textContent.toLowerCase();
                    const dateCell = row.cells[1].textContent;
                    
                    // Converter data brasileira (dd/mm/yyyy) para formato compatível com input date (yyyy-mm-dd)
                    let rowDate = '';
                    if (dateCell) {
                        const dateParts = dateCell.split('/');
                        if (dateParts.length === 3) {
                            rowDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                        }
                    }
                    
                    // Verificar se a linha atende aos critérios de filtro
                    const matchesText = !filterText || description.includes(filterText);
                    const matchesDate = !filterDate || rowDate === filterDate;
                    
                    if (matchesText && matchesDate) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
                
                // Mostrar mensagem se nenhum resultado for encontrado
                updateNoResultsMessage();
            }
            
            // Função para mostrar/esconder mensagem de "nenhum resultado"
            function updateNoResultsMessage() {
                const tbody = logsTable.getElementsByTagName('tbody')[0];
                const rows = tbody.getElementsByTagName('tr');
                let hasVisibleRows = false;
                let hasRealRows = 0;
                
                // Primeiro, remover qualquer mensagem existente
                const existingMessage = tbody.querySelector('.no-results-message');
                if (existingMessage) {
                    existingMessage.remove();
                }
                
                // Contar linhas reais (excluindo mensagens) e verificar quais estão visíveis
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    // Ignorar linhas que são mensagens de "nenhum resultado"
                    if (!row.className.includes('no-results-message')) {
                        hasRealRows++;
                        // Verificar se a linha está visível (display não é 'none')
                        const computedStyle = window.getComputedStyle(row);
                        if (computedStyle.display !== 'none' && row.style.display !== 'none') {
                            hasVisibleRows = true;
                        }
                    }
                }
                
                // Só adicionar mensagem se há registros reais mas nenhum está visível
                if (hasRealRows > 0 && !hasVisibleRows) {
                    const messageRow = document.createElement('tr');
                    messageRow.className = 'no-results-message';
                    messageRow.innerHTML = '<td colspan="2" class="text-center text-muted">Nenhuma alteração encontrada com os filtros aplicados.</td>';
                    tbody.appendChild(messageRow);
                }
            }
            
            // Adicionar event listeners para os filtros
            logFilter.addEventListener('input', filterLogs);
            dateFilter.addEventListener('change', filterLogs);
            
            // Função para limpar filtros
            function clearFilters() {
                logFilter.value = '';
                dateFilter.value = '';
                
                // Garantir que todas as linhas reais estejam visíveis
                const tbody = logsTable.getElementsByTagName('tbody')[0];
                const rows = tbody.getElementsByTagName('tr');
                
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    // Só mostrar linhas que não são mensagens
                    if (!row.className.includes('no-results-message')) {
                        row.style.display = '';
                    }
                }
                
                // Remover qualquer mensagem de "nenhum resultado"
                const existingMessage = tbody.querySelector('.no-results-message');
                if (existingMessage) {
                    existingMessage.remove();
                }
            }
            
            // Adicionar botão para limpar filtros (opcional)
            const clearButton = document.createElement('button');
            clearButton.type = 'button';
            clearButton.className = 'btn btn-outline-secondary btn-sm';
            clearButton.textContent = 'Limpar Filtros';
            clearButton.onclick = clearFilters;
            
            // Inserir o botão após o campo de data
            if (dateFilter.parentNode && dateFilter.parentNode.parentNode) {
                const buttonCol = document.createElement('div');
                buttonCol.className = 'col-md-12 mt-2 text-end';
                buttonCol.appendChild(clearButton);
                dateFilter.parentNode.parentNode.appendChild(buttonCol);
            }
        }
        
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            updateHiddenFields();
            form.submit();
        });
    });
</script>
{% endblock %}