{% extends "base.html" %}

{% block title %}Produto - GetUp Gestão{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{{ super() }}
{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #F5F5F5 !important;
    }
    .container-fluid, .container {
        background-color: #F5F5F5 !important;
    }
    .card, .card-body {
        background-color: #F0F0F0 !important;
    }
    .card-header.bg-secondary {
        background-color: #6c757d !important;
        color: white !important;
    }
    .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
    }
    .btn-secondary:hover {
        background-color: #5a6268;
        border-color: #545b62;
        color: white;
    }
    .form-control, .form-select {
        background-color: #F5F5F5 !important;
    }
    .nav-tabs {
        border-bottom: 2px solid #6c757d;
    }
    .nav-tabs .nav-link {
        color: #6c757d;
        border: 1px solid transparent;
        border-top-left-radius: 0.375rem;
        border-top-right-radius: 0.375rem;
    }
    .nav-tabs .nav-link:hover {
        border-color: #e9ecef #e9ecef #6c757d;
        color: #495057;
    }
    .nav-tabs .nav-link.active {
        color: #495057;
        background-color: #F0F0F0;
        border-color: #6c757d #6c757d #F0F0F0;
        font-weight: bold;
    }
    .tab-content {
        padding-top: 20px;
    }
    .tab-pane {
        min-height: 200px;
    }
    .table th {
        white-space: nowrap;
        background-color: #f8f9fa;
    }
    .table td {
        vertical-align: middle;
    }
    .btn-action {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        line-height: 1.5;
        border-radius: 0.2rem;
    }
    .btn-action i {
        color: white !important;
    }
    .btn-secondary i,
    .btn-danger i {
        color: white !important;
    }
    .table-responsive {
        margin-bottom: 1rem;
        border-radius: 0.25rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="background-color: #F5F5F5; min-height: 100vh;">
  <div class="row">
    <div class="col-md-12 mt-5">
        <div class="col-md-12 mb-4">
            <img src="/static/images/Logo.png" alt="Logo" height="40">
        </div>
      <!-- Botões de navegação -->
      <div class="row mb-4 justify-content-center">
        <div class="col-12 col-md-2 mb-2 mb-md-0">
          <a href="/dashboard" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
            Índice
          </a>
        </div>
        <div class="col-12 col-md-2 mb-2 mb-md-0">
          <a href="/basic-data/new" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
            Dados Básicos
          </a>
        </div>
        <div class="col-12 col-md-2 mb-2 mb-md-0">
          <a href="/simulador" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
            Simulador
          </a>
        </div>
        <div class="col-12 col-md-2 mb-2 mb-md-0">
          <button type="button" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
            Calculadora de preços
          </button>
        </div>
      </div>

      <!-- Card com conteúdo e tabs -->
      <div class="card shadow mb-4" style="background-color: #F0F0F0;">
        <div class="card-header bg-secondary text-white">
          <h4 class="card-title mb-0">Produto</h4>
        </div>
        <div class="card-body">
          <!-- Tabs -->
          <ul class="nav nav-tabs mb-3" id="produtoTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">
                Dashboard
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="produto-tab" data-bs-toggle="tab" data-bs-target="#produto" type="button" role="tab" aria-controls="produto" aria-selected="false">
                Produto
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="categoria-tab" data-bs-toggle="tab" data-bs-target="#categoria" type="button" role="tab" aria-controls="categoria" aria-selected="false">
                Categoria
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="importancia-meses-tab" data-bs-toggle="tab" data-bs-target="#importancia-meses" type="button" role="tab" aria-controls="importancia-meses" aria-selected="false">
                Importância dos Meses
              </button>
            </li>
          </ul>
          
          <!-- Tab content -->
          <div class="tab-content" id="produtoTabsContent">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
              <!-- Análise Curva ABC -->
              <div class="card shadow-sm mb-4" style="background-color: #F0F0F0;">
                <div class="card-header bg-secondary text-white">
                  <h5 class="mb-0"><i class="bi bi-graph-up"></i> Análise Curva ABC</h5>
                </div>
                <div class="card-body p-3">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <canvas id="curvaAbcChart"></canvas>
                    </div>
                    <div class="col-md-6 mb-3">
                      <canvas id="distribuicaoClasseChart"></canvas>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-md-12">
                      <div class="table-responsive">
                        <table class="table table-sm table-hover" id="tabelaResumoCurvaAbc">
                          <thead>
                            <tr>
                              <th style="width: 30px;"></th>
                              <th>Classe</th>
                              <th>Quantidade</th>
                              <th>Faturamento (R$)</th>
                              <th>% do Total</th>
                            </tr>
                          </thead>
                          <tbody id="resumoCurvaAbc">
                            <tr>
                              <td colspan="5" class="text-center">
                                <i class="spinner-border spinner-border-sm me-2"></i>Carregando dados...
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Produto Tab -->
            <div class="tab-pane fade" id="produto" role="tabpanel" aria-labelledby="produto-tab">
              <!-- Botão para adicionar produto -->
              <div class="mb-3">
                <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#produtoModal" id="btnAdicionarProduto">
                  <i class="bi bi-plus-circle"></i> Adicionar Produto
                </button>
              </div>
              
              <!-- Tabela de produtos -->
              <div class="table-responsive">
                <table class="table table-hover" id="produtosTable">
                  <thead>
                    <tr>
                      <th>Nome do Produto</th>
                      <th>Faturamento por<br>Mercadoria</th>
                      <th>Preço de<br>Venda</th>
                      <th>Custo de<br>Aquisição</th>
                      <th>Quantidade de<br>Vendas</th>
                      <th>Gastos com<br>Vendas</th>
                      <th>Gastos com<br>Compras</th>
                      <th>Margem Contrib.<br>Informada (%)</th>
                      <th>Margem Contrib.<br>Corrigida (%)</th>
                      <th>Margem Contrib.<br>(R$)</th>
                      <th>Custos<br>Fixos</th>
                      <th>Ponto de<br>Equilíbrio</th>
                      <th>Margem<br>Operacional</th>
                      <th>Ações</th>
                    </tr>
                  </thead>
                  <tbody id="produtosTableBody">
                    <!-- Produtos serão carregados aqui via JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Categoria Tab -->
            <div class="tab-pane fade" id="categoria" role="tabpanel" aria-labelledby="categoria-tab">
              <!-- Botão para adicionar categoria -->
              <div class="mb-3">
                <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#categoriaModal" id="btnAdicionarCategoria">
                  <i class="bi bi-plus-circle"></i> Adicionar Categoria
                </button>
              </div>
              
              <!-- Tabela de categorias -->
              <div class="table-responsive">
                <table class="table table-hover" id="categoriasTable">
                  <thead>
                    <tr>
                      <th>Código</th>
                      <th>Nome</th>
                      <th>Ações</th>
                    </tr>
                  </thead>
                  <tbody id="categoriasTableBody">
                    <!-- Categorias serão carregadas aqui via JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Importância dos Meses Tab -->
            <div class="tab-pane fade" id="importancia-meses" role="tabpanel" aria-labelledby="importancia-meses-tab">
              <!-- Conteúdo da Importância dos Meses -->
              <p>Conteúdo da Importância dos Meses será adicionado aqui.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Categoria -->
<div class="modal fade" id="categoriaModal" tabindex="-1" aria-labelledby="categoriaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-secondary text-white">
        <h5 class="modal-title" id="categoriaModalLabel">Adicionar Categoria</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="categoriaForm">
        <div class="modal-body">
          <input type="hidden" id="categoriaCodigoOriginal" name="categoriaCodigoOriginal">
          <div class="mb-3">
            <label for="categoriaNome" class="form-label">Nome da Categoria</label>
            <input type="text" class="form-control" id="categoriaNome" name="nome" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para Produto -->
<div class="modal fade" id="produtoModal" tabindex="-1" aria-labelledby="produtoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-secondary text-white">
        <h5 class="modal-title" id="produtoModalLabel">Adicionar Produto</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="produtoForm">
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
          <input type="hidden" id="produtoCodigoOriginal" name="produtoCodigoOriginal">
          
          <h6 class="mb-3 text-secondary">Informações Básicas</h6>
          
          <div class="mb-3">
            <label for="produtoNome" class="form-label">Nome do Produto <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="produtoNome" name="nome" required>
          </div>
          
          <div class="mb-3">
            <label for="produtoCategoriaCodigo" class="form-label">Categoria</label>
            <select class="form-select" id="produtoCategoriaCodigo" name="categoria_codigo">
              <option value="">Selecione uma categoria</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="produtoBasicDataId" class="form-label">Dados Básicos</label>
            <select class="form-select" id="produtoBasicDataId" name="basic_data_id">
              <option value="">Selecione um período</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="produtoPrecoVenda" class="form-label">Preço de Venda (R$) <span class="text-danger">*</span></label>
            <input type="number" step="0.01" class="form-control" id="produtoPrecoVenda" name="preco_venda" required>
          </div>
          
          <div class="mb-3">
            <label for="produtoCustoAquisicao" class="form-label">Custo de Aquisição (R$) <span class="text-danger">*</span></label>
            <input type="number" step="0.01" class="form-control" id="produtoCustoAquisicao" name="custo_aquisicao" required>
          </div>
          
          <div class="mb-3">
            <label for="produtoPercentualFaturamento" class="form-label">Percentual que o produto representa no faturamento (%)</label>
            <input type="number" step="0.01" class="form-control" id="produtoPercentualFaturamento" name="percentual_faturamento">
          </div>
          
          <div class="mb-3">
            <div class="alert alert-info mb-0" id="calculoQuantidadeVendas" style="display: none;">
              <small>Com base nesta participação, as vendas teriam sido de <strong><span id="quantidadeVendasCalculada">0</span></strong> unidades. Caso não concorde, reveja o % informado.</small>
            </div>
          </div>
          
          <!-- Campos Calculados - Ocultos na modal mas salvos no banco de dados -->
          <div style="display: none;">
            <hr class="my-4">
            <h6 class="mb-3 text-secondary">Campos Calculados</h6>
            
            <div class="mb-3">
              <label for="produtoFaturamentoPorMercadoria" class="form-label">Faturamento por Mercadoria (R$)</label>
              <input type="number" step="0.01" class="form-control" id="produtoFaturamentoPorMercadoria" name="faturamento_por_mercadoria" readonly>
            </div>
            
            <div class="mb-3">
              <label for="produtoQuantidadeVendas" class="form-label">Quantidade de Vendas</label>
              <input type="number" step="1" class="form-control" id="produtoQuantidadeVendas" name="quantidade_vendas" readonly>
            </div>
            
            <div class="mb-3">
              <label for="produtoGastosComVendas" class="form-label">Gastos com Vendas (R$)</label>
              <input type="number" step="0.01" class="form-control" id="produtoGastosComVendas" name="gastos_com_vendas" readonly>
            </div>
            
            <div class="mb-3">
              <label for="produtoGastosComCompras" class="form-label">Gastos com Compras (R$)</label>
              <input type="number" step="0.01" class="form-control" id="produtoGastosComCompras" name="gastos_com_compras" readonly>
            </div>
            
            <div class="mb-3">
              <label for="produtoMargemContribuicaoValor" class="form-label">Margem de Contribuição (R$)</label>
              <input type="number" step="0.01" class="form-control" id="produtoMargemContribuicaoValor" name="margem_contribuicao_valor" readonly>
            </div>
            
            <div class="mb-3">
              <label for="produtoMargemContribuicaoInformada" class="form-label">Margem de Contribuição (%) Informada</label>
              <input type="number" step="0.01" class="form-control" id="produtoMargemContribuicaoInformada" name="margem_contribuicao_informada" readonly>
            </div>
            
            <div class="mb-3">
              <label for="produtoMargemContribuicaoCorrigida" class="form-label">Margem de Contribuição (%) Corrigida</label>
              <input type="number" step="0.01" class="form-control" id="produtoMargemContribuicaoCorrigida" name="margem_contribuicao_corrigida" readonly>
            </div>
            
            <div class="mb-3">
              <label for="produtoCustosFixos" class="form-label">Custos Fixos (R$)</label>
              <input type="number" step="0.01" class="form-control" id="produtoCustosFixos" name="custos_fixos" readonly>
            </div>
            
            <div class="mb-3">
              <label for="produtoPontoEquilibrio" class="form-label">Ponto de Equilíbrio</label>
              <input type="number" step="0.01" class="form-control" id="produtoPontoEquilibrio" name="ponto_equilibrio" readonly>
            </div>
            
            <div class="mb-3">
              <label for="produtoMargemOperacional" class="form-label">Margem Operacional</label>
              <input type="number" step="0.01" class="form-control" id="produtoMargemOperacional" name="margem_operacional" readonly>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Tornar funções globalmente acessíveis
window.categoriasEditando = null;

// Carregar categorias ao carregar a página e ao mostrar a tab
document.addEventListener('DOMContentLoaded', function() {
  // Carregar categorias quando a tab de categoria for clicada
  const categoriaTab = document.getElementById('categoria-tab');
  if (categoriaTab) {
    categoriaTab.addEventListener('shown.bs.tab', function() {
      carregarCategorias();
    });
  }
  
  // Também carregar se a tab já estiver ativa
  if (categoriaTab && categoriaTab.classList.contains('active')) {
    carregarCategorias();
  }
  
  // Adicionar event listener ao botão de adicionar categoria
  const btnAdicionarCategoria = document.querySelector('[data-bs-target="#categoriaModal"]');
  if (btnAdicionarCategoria) {
    btnAdicionarCategoria.addEventListener('click', function() {
      openCategoriaModal();
    });
  }
  
  // Carregar produtos quando a tab de produto for clicada
  const produtoTab = document.getElementById('produto-tab');
  if (produtoTab) {
    produtoTab.addEventListener('shown.bs.tab', function() {
      carregarProdutos();
      carregarCategoriasParaSelect();
      carregarBasicDataParaSelect();
    });
  }
  
  // Adicionar event listener ao botão de adicionar produto
  const btnAdicionarProduto = document.getElementById('btnAdicionarProduto');
  if (btnAdicionarProduto) {
    btnAdicionarProduto.addEventListener('click', function() {
      openProdutoModal();
    });
  }
  
  // Adicionar event listeners para cálculo automático de margens
  const precoVendaInput = document.getElementById('produtoPrecoVenda');
  const custoAquisicaoInput = document.getElementById('produtoCustoAquisicao');
  const percentualFaturamentoInput = document.getElementById('produtoPercentualFaturamento');
  const basicDataIdInput = document.getElementById('produtoBasicDataId');
  
  if (precoVendaInput) {
    precoVendaInput.addEventListener('input', calcularCamposProduto);
    precoVendaInput.addEventListener('blur', calcularCamposProduto);
  }
  
  if (custoAquisicaoInput) {
    custoAquisicaoInput.addEventListener('input', calcularCamposProduto);
    custoAquisicaoInput.addEventListener('blur', calcularCamposProduto);
  }
  
  if (percentualFaturamentoInput) {
    percentualFaturamentoInput.addEventListener('input', () => {
      console.log('Event: percentualFaturamento input');
      calcularCamposProduto();
    });
    percentualFaturamentoInput.addEventListener('blur', () => {
      console.log('Event: percentualFaturamento blur');
      calcularCamposProduto();
    });
  }
  
  if (basicDataIdInput) {
    basicDataIdInput.addEventListener('change', () => {
      console.log('Event: basicDataId change', basicDataIdInput.value);
      calcularCamposProduto();
    });
  }
});

// Abrir modal para adicionar ou editar categoria
window.openCategoriaModal = function(categoriaCodigo = null) {
  window.categoriasEditando = categoriaCodigo;
  const modal = new bootstrap.Modal(document.getElementById('categoriaModal'));
  const form = document.getElementById('categoriaForm');
  const modalTitle = document.getElementById('categoriaModalLabel');
  
  if (categoriaCodigo) {
    modalTitle.textContent = 'Editar Categoria';
    // Carregar dados da categoria (código agora é Integer)
    fetch(`/categoria/api/get/${categoriaCodigo}`)
      .then(response => response.json())
      .then(data => {
        document.getElementById('categoriaCodigoOriginal').value = data.codigo;
        document.getElementById('categoriaNome').value = data.nome;
      })
      .catch(error => {
        console.error('Erro ao carregar categoria:', error);
        alert('Erro ao carregar categoria');
      });
  } else {
    modalTitle.textContent = 'Adicionar Categoria';
    form.reset();
    document.getElementById('categoriaCodigoOriginal').value = '';
  }
  
  modal.show();
}

// Submeter formulário de categoria
document.getElementById('categoriaForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const categoriaCodigoOriginal = document.getElementById('categoriaCodigoOriginal').value;
  const nome = document.getElementById('categoriaNome').value.trim();
  
  if (!nome) {
    alert('Por favor, informe o nome da categoria');
    return;
  }
  
  const formData = new FormData();
  formData.append('nome', nome);
  
  const url = categoriaCodigoOriginal ? `/categoria/api/update/${categoriaCodigoOriginal}` : '/categoria/api/create';
  const method = categoriaCodigoOriginal ? 'PUT' : 'POST';
  
  try {
    const response = await fetch(url, {
      method: method,
      body: formData
    });
    
    const data = await response.json();
    
    if (response.ok) {
      const modalElement = document.getElementById('categoriaModal');
      const modal = bootstrap.Modal.getInstance(modalElement);
      
      // Resetar formulário antes de fechar
      document.getElementById('categoriaForm').reset();
      document.getElementById('categoriaCodigoOriginal').value = '';
      
      // Fechar modal e remover backdrop corretamente
      if (modal) {
        // Aguardar o evento de fechamento da modal para fazer cleanup
        modalElement.addEventListener('hidden.bs.modal', function cleanup() {
          // Remover backdrop se ainda existir (pode haver múltiplos)
          const backdrops = document.querySelectorAll('.modal-backdrop');
          backdrops.forEach(backdrop => backdrop.remove());
          
          // Restaurar scroll do body
          document.body.classList.remove('modal-open');
          document.body.style.overflow = '';
          document.body.style.paddingRight = '';
          
          // Garantir que estamos na tab de categoria e que ela esteja ativa
          const categoriaTab = document.getElementById('categoria-tab');
          const categoriaPane = document.getElementById('categoria');
          
          if (categoriaTab && categoriaPane) {
            // Remover active de todas as tabs
            document.querySelectorAll('#produtoTabs .nav-link').forEach(tabLink => {
              tabLink.classList.remove('active');
              tabLink.setAttribute('aria-selected', 'false');
            });
            
            // Remover active de todos os panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
              pane.classList.remove('show', 'active');
            });
            
            // Ativar a tab de categoria
            categoriaTab.classList.add('active');
            categoriaTab.setAttribute('aria-selected', 'true');
            categoriaPane.classList.add('show', 'active');
            
            // Usar Bootstrap Tab API para garantir que funcione corretamente
            const tab = bootstrap.Tab.getOrCreateInstance(categoriaTab);
            tab.show();
          }
          
          // Recarregar categorias após um pequeno delay
          setTimeout(() => {
            if (typeof window.carregarCategorias === 'function') {
              window.carregarCategorias();
            }
          }, 200);
          
          // Mostrar mensagem de sucesso
          const mensagem = categoriaCodigoOriginal ? 'Categoria atualizada com sucesso!' : 'Categoria adicionada com sucesso!';
          const alertDiv = document.createElement('div');
          alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
          alertDiv.style.zIndex = '9999';
          alertDiv.innerHTML = `
            ${mensagem}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          `;
          document.body.appendChild(alertDiv);
          setTimeout(() => {
            if (alertDiv.parentNode) {
              alertDiv.remove();
            }
          }, 3000);
        }, { once: true });
        
        // Fechar a modal
        modal.hide();
      } else {
        // Se não há instância da modal, fazer cleanup manual
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        // Recarregar categorias
        setTimeout(() => {
          if (typeof window.carregarCategorias === 'function') {
            window.carregarCategorias();
          }
        }, 200);
      }
    } else {
      alert(data.error || 'Erro ao salvar categoria');
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao salvar categoria. Por favor, tente novamente.');
  }
});

// Carregar categorias (já filtradas pelo usuário logado no backend)
window.carregarCategorias = async function() {
  try {
    const tbody = document.getElementById('categoriasTableBody');
    if (!tbody) {
      console.error('Tabela de categorias não encontrada');
      return;
    }
    
    // Mostrar loading
    tbody.innerHTML = '<tr><td colspan="3" class="text-center"><i class="spinner-border spinner-border-sm me-2"></i>Carregando categorias...</td></tr>';
    
    const response = await fetch('/categoria/api/list');
    
    if (!response.ok) {
      throw new Error(`Erro ${response.status}: ${response.statusText}`);
    }
    
    const categorias = await response.json();
    
    tbody.innerHTML = '';
    
    if (!categorias || categorias.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-4">Nenhuma categoria cadastrada. Clique em "Adicionar Categoria" para criar uma nova.</td></tr>';
      return;
    }
    
    // Ordenar categorias por nome
    categorias.sort((a, b) => a.nome.localeCompare(b.nome));
    
    categorias.forEach(categoria => {
      const tr = document.createElement('tr');
      // Código agora é Integer, não precisa escapar
      tr.innerHTML = `
        <td><strong>${categoria.codigo}</strong></td>
        <td>${categoria.nome}</td>
        <td>
          <button class="btn btn-sm btn-secondary btn-action me-2" onclick="openCategoriaModal(${categoria.codigo})" title="Editar categoria">
            <i class="bi bi-pencil"></i> Editar
          </button>
          <button class="btn btn-sm btn-danger btn-action" onclick="removerCategoria(${categoria.codigo})" title="Remover categoria">
            <i class="bi bi-trash"></i> Remover
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (error) {
    console.error('Erro ao carregar categorias:', error);
    const tbody = document.getElementById('categoriasTableBody');
    if (tbody) {
      tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger py-4">Erro ao carregar categorias. Por favor, recarregue a página.</td></tr>';
    }
  }
}

// Remover categoria
window.removerCategoria = async function(categoriaCodigo) {
  if (!confirm('Tem certeza que deseja remover esta categoria?')) {
    return;
  }
  
  try {
    const response = await fetch(`/categoria/api/delete/${categoriaCodigo}`, {
      method: 'DELETE'
    });
    
    const data = await response.json();
    
    if (response.ok) {
      // Recarregar categorias
      carregarCategorias();
      
      // Mostrar mensagem de sucesso
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
      alertDiv.style.zIndex = '9999';
      alertDiv.innerHTML = `
        Categoria removida com sucesso!
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      document.body.appendChild(alertDiv);
      setTimeout(() => {
        alertDiv.remove();
      }, 3000);
    } else {
      alert(data.error || 'Erro ao remover categoria');
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao remover categoria. Por favor, tente novamente.');
  }
}

// ============ FUNÇÕES PARA PRODUTOS ============

// Variável global para armazenar dados básicos
let basicDataCache = null;

// Função para carregar dados básicos
async function carregarBasicData(basicDataId) {
  if (!basicDataId) {
    console.log('carregarBasicData: basicDataId vazio');
    basicDataCache = null;
    return null;
  }
  
  console.log('carregarBasicData: Carregando dados para ID:', basicDataId);
  
  try {
    const url = `/produto/api/basic-data/${basicDataId}`;
    console.log('carregarBasicData: Fazendo requisição para:', url);
    const response = await fetch(url);
    console.log('carregarBasicData: Response status:', response.status);
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('carregarBasicData: Erro na resposta:', response.status, response.statusText, errorText);
      basicDataCache = null;
      return null;
    }
    
    const data = await response.json();
    console.log('carregarBasicData: Dados recebidos:', data);
    basicDataCache = data;
    return data;
  } catch (error) {
    console.error('carregarBasicData: Erro ao carregar dados básicos:', error);
    basicDataCache = null;
    return null;
  }
}

// Função para calcular os campos do produto
window.calcularCamposProduto = async function() {
  console.log('=== INÍCIO CÁLCULO CAMPOS PRODUTO ===');
  
  const precoVenda = parseFloat(document.getElementById('produtoPrecoVenda').value) || 0;
  const custoAquisicao = parseFloat(document.getElementById('produtoCustoAquisicao').value) || 0;
  const percentualFaturamento = parseFloat(document.getElementById('produtoPercentualFaturamento').value) || 0;
  const basicDataId = document.getElementById('produtoBasicDataId').value;
  
  console.log('Valores:', { precoVenda, custoAquisicao, percentualFaturamento, basicDataId });
  
  // Carregar dados básicos se houver basic_data_id selecionado
  let basicData = null;
  if (basicDataId) {
    console.log('Carregando dados básicos para ID:', basicDataId);
    basicData = await carregarBasicData(basicDataId);
    console.log('Dados básicos carregados:', basicData);
  } else {
    console.log('Nenhum basic_data_id selecionado');
  }
  
  // Calcular Margem de Contribuição (R$)
  const margemContribuicaoValor = precoVenda - custoAquisicao;
  document.getElementById('produtoMargemContribuicaoValor').value = margemContribuicaoValor.toFixed(2);
  
  // Calcular Margem de Contribuição (%) Informada
  let margemContribuicaoPercentual = 0;
  if (precoVenda > 0) {
    margemContribuicaoPercentual = (margemContribuicaoValor / precoVenda) * 100;
  }
  document.getElementById('produtoMargemContribuicaoInformada').value = margemContribuicaoPercentual.toFixed(2);
  
  // Margem de Contribuição (%) Corrigida inicialmente é igual à informada
  document.getElementById('produtoMargemContribuicaoCorrigida').value = margemContribuicaoPercentual.toFixed(2);
  
  // Calcular campos usando dados básicos com percentual
  console.log('Verificando condições para cálculos:', { basicData: !!basicData, percentualFaturamento });
  
  // Buscar elementos do DOM - podem não existir se o modal não estiver aberto
  const calculoQuantidadeVendasDiv = document.getElementById('calculoQuantidadeVendas');
  const quantidadeVendasCalculadaEl = document.getElementById('quantidadeVendasCalculada');
  const produtoQuantidadeVendasEl = document.getElementById('produtoQuantidadeVendas');
  
  let faturamentoPorMercadoria = 0;
  let quantidadeVendas = 0;
  
  if (basicData && percentualFaturamento > 0) {
    console.log('Calculando campos com dados básicos e percentual');
    const percentualDecimal = percentualFaturamento / 100;
    const fatLoja = basicData.sales_revenue || 0;
    
    // 1. Faturamento por Mercadoria = %Faturamento * Fat.Loja
    // Exemplo: se faturamento loja = 100 e percentual = 30%, então faturamento por mercadoria = 30
    faturamentoPorMercadoria = percentualDecimal * fatLoja;
    console.log('Faturamento por Mercadoria calculado:', faturamentoPorMercadoria, '(Loja:', fatLoja, 'Percentual:', percentualFaturamento + '%)');
    document.getElementById('produtoFaturamentoPorMercadoria').value = faturamentoPorMercadoria.toFixed(2);
    
    // 2. Gastos com Vendas = %Faturamento * Gastos com Vendas (Loja)
    const gastosComVendas = percentualDecimal * (basicData.sales_expenses || 0);
    console.log('Gastos com Vendas:', gastosComVendas);
    document.getElementById('produtoGastosComVendas').value = gastosComVendas.toFixed(2);
    
    // 3. Gastos com Compras = %Faturamento * Gastos com Compras (Loja)
    const gastosComCompras = percentualDecimal * (basicData.input_product_expenses || 0);
    console.log('Gastos com Compras:', gastosComCompras);
    document.getElementById('produtoGastosComCompras').value = gastosComCompras.toFixed(2);
    
    // 4. Custos Fixos = %Faturamento * Custos Fixos (Loja)
    const custosFixos = percentualDecimal * ((basicData.fixed_costs || 0) + (basicData.other_fixed_costs || 0));
    console.log('Custos Fixos:', custosFixos);
    document.getElementById('produtoCustosFixos').value = custosFixos.toFixed(2);
    
    // 5. Quantidade de Vendas = %Faturamento * Quantidade de Clientes Atendidos (clients_served dos dados básicos)
    // Usa o clients_served dos dados básicos aplicado ao percentual
    const quantidadeClientesLoja = basicData.clients_served || 0;
    console.log('Quantidade de Clientes Atendidos da Loja (clients_served):', quantidadeClientesLoja, 'do basicData:', basicData.clients_served);
    
    // Calcular quantidade de vendas sempre que houver dados básicos e percentual
    quantidadeVendas = percentualDecimal * quantidadeClientesLoja;
    console.log('Quantidade de Vendas após aplicar percentual:', quantidadeVendas, '(Loja:', quantidadeClientesLoja, 'Percentual:', percentualFaturamento + '%)');
    
    // Função para atualizar os elementos (será chamada imediatamente e com retry se necessário)
    const atualizarElementosQuantidadeVendas = () => {
      const quantidadeVendasCalculadaEl = document.getElementById('quantidadeVendasCalculada');
      const produtoQuantidadeVendasEl = document.getElementById('produtoQuantidadeVendas');
      const calculoQuantidadeVendasDiv = document.getElementById('calculoQuantidadeVendas');
      
      // Atualizar valor no span dentro da mensagem
      if (quantidadeVendasCalculadaEl) {
        quantidadeVendasCalculadaEl.textContent = Math.round(quantidadeVendas);
      }
      
      // Atualizar valor no campo de input
      if (produtoQuantidadeVendasEl) {
        produtoQuantidadeVendasEl.value = Math.round(quantidadeVendas);
      }
      
      // Exibir mensagem informativa - sempre que houver dados básicos e percentual
      if (calculoQuantidadeVendasDiv) {
        calculoQuantidadeVendasDiv.style.display = 'block';
        return true; // Indica que todos os elementos foram encontrados
      }
      return false; // Indica que precisa tentar novamente
    };
    
    // Tentar atualizar imediatamente
    const elementosEncontrados = atualizarElementosQuantidadeVendas();
    
    // Se não encontrou todos os elementos, tentar novamente com retries
    if (!elementosEncontrados) {
      setTimeout(() => atualizarElementosQuantidadeVendas(), 50);
      setTimeout(() => atualizarElementosQuantidadeVendas(), 150);
      setTimeout(() => atualizarElementosQuantidadeVendas(), 300);
    }
    
    // 6. Ponto de Equilíbrio = Custos Fixos / Margem de Contribuição (R$)
    // Ponto de Equilíbrio = Custos Fixos / (Preço Venda - Custo Aquisição)
    if (margemContribuicaoValor > 0 && custosFixos > 0) {
      const pontoEquilibrio = custosFixos / margemContribuicaoValor;
      console.log('Ponto de Equilíbrio:', pontoEquilibrio, '(Custos Fixos:', custosFixos, 'Margem Contrib:', margemContribuicaoValor + ')');
      document.getElementById('produtoPontoEquilibrio').value = pontoEquilibrio.toFixed(2);
    } else {
      document.getElementById('produtoPontoEquilibrio').value = '';
    }
    
    // 7. Margem Operacional = (Faturamento por Mercadoria - Total Gastos) / Faturamento por Mercadoria * 100
    if (faturamentoPorMercadoria > 0) {
      const totalGastos = gastosComVendas + gastosComCompras + custosFixos;
      const margemOperacional = ((faturamentoPorMercadoria - totalGastos) / faturamentoPorMercadoria) * 100;
      console.log('Margem Operacional:', margemOperacional, '(Faturamento:', faturamentoPorMercadoria, 'Total Gastos:', totalGastos + ')');
      document.getElementById('produtoMargemOperacional').value = margemOperacional.toFixed(2);
    } else {
      document.getElementById('produtoMargemOperacional').value = '';
    }
    
    console.log('Cálculos concluídos com sucesso');
  } else {
    console.log('Não há dados básicos ou percentual - limpando campos');
    // Limpar campos calculados se não houver dados básicos ou percentual
    document.getElementById('produtoFaturamentoPorMercadoria').value = '';
    document.getElementById('produtoQuantidadeVendas').value = '';
    document.getElementById('produtoGastosComVendas').value = '';
    document.getElementById('produtoGastosComCompras').value = '';
    document.getElementById('produtoCustosFixos').value = '';
    document.getElementById('produtoPontoEquilibrio').value = '';
    document.getElementById('produtoMargemOperacional').value = '';
    if (calculoQuantidadeVendasDiv) {
      calculoQuantidadeVendasDiv.style.display = 'none';
    }
  }
  
  console.log('=== FIM CÁLCULO CAMPOS PRODUTO ===');
};

// Carregar categorias para o select do produto
async function carregarCategoriasParaSelect() {
  try {
    const response = await fetch('/categoria/api/list');
    const categorias = await response.json();
    const select = document.getElementById('produtoCategoriaCodigo');
    
    if (select) {
      // Limpar opções existentes exceto a primeira
      while (select.options.length > 1) {
        select.remove(1);
      }
      
      categorias.forEach(categoria => {
        const option = document.createElement('option');
        option.value = categoria.codigo;
        option.textContent = categoria.nome;
        select.appendChild(option);
      });
    }
  } catch (error) {
    console.error('Erro ao carregar categorias para select:', error);
  }
}

// Carregar dados básicos para o select do produto
async function carregarBasicDataParaSelect() {
  try {
    const response = await fetch('/produto/api/basic-data');
    const basicDataList = await response.json();
    const select = document.getElementById('produtoBasicDataId');
    
    if (select) {
      // Limpar opções existentes exceto a primeira
      while (select.options.length > 1) {
        select.remove(1);
      }
      
      basicDataList.forEach(bd => {
        const option = document.createElement('option');
        option.value = bd.id;
        option.textContent = bd.display;
        select.appendChild(option);
      });
    }
  } catch (error) {
    console.error('Erro ao carregar dados básicos para select:', error);
  }
}

// Abrir modal para adicionar ou editar produto
window.openProdutoModal = function(produtoCodigo = null) {
  const modal = new bootstrap.Modal(document.getElementById('produtoModal'));
  const form = document.getElementById('produtoForm');
  const modalTitle = document.getElementById('produtoModalLabel');
  
  // Carregar categorias e dados básicos nos selects
  carregarCategoriasParaSelect();
  carregarBasicDataParaSelect();
  
  if (produtoCodigo) {
    modalTitle.textContent = 'Editar Produto';
    // Carregar dados do produto
    fetch(`/produto/api/get/${produtoCodigo}`)
      .then(response => response.json())
      .then(data => {
        document.getElementById('produtoCodigoOriginal').value = data.codigo;
        document.getElementById('produtoNome').value = data.nome || '';
        document.getElementById('produtoCategoriaCodigo').value = data.categoria_codigo || '';
        document.getElementById('produtoBasicDataId').value = data.basic_data_id || '';
        document.getElementById('produtoFaturamentoPorMercadoria').value = data.faturamento_por_mercadoria || '';
        document.getElementById('produtoPrecoVenda').value = data.preco_venda || '';
        document.getElementById('produtoCustoAquisicao').value = data.custo_aquisicao || '';
        document.getElementById('produtoPercentualFaturamento').value = data.percentual_faturamento || '';
        document.getElementById('produtoQuantidadeVendas').value = data.quantidade_vendas || '';
        document.getElementById('produtoGastosComVendas').value = data.gastos_com_vendas || '';
        document.getElementById('produtoGastosComCompras').value = data.gastos_com_compras || '';
        document.getElementById('produtoCustosFixos').value = data.custos_fixos || '';
        document.getElementById('produtoPontoEquilibrio').value = data.ponto_equilibrio || '';
        document.getElementById('produtoMargemOperacional').value = data.margem_operacional || '';
        
        // Recalcular campos de margem baseado no preço de venda e custo de aquisição
        setTimeout(() => {
          calcularCamposProduto();
        }, 100);
      })
      .catch(error => {
        console.error('Erro ao carregar produto:', error);
        alert('Erro ao carregar produto');
      });
  } else {
    modalTitle.textContent = 'Adicionar Produto';
    form.reset();
    document.getElementById('produtoCodigoOriginal').value = '';
    
    // Limpar campos calculados
    document.getElementById('produtoMargemContribuicaoValor').value = '';
    document.getElementById('produtoMargemContribuicaoInformada').value = '';
    document.getElementById('produtoMargemContribuicaoCorrigida').value = '';
  }
  
  // Adicionar event listeners após o modal ser mostrado
  setTimeout(() => {
    const precoVendaInput = document.getElementById('produtoPrecoVenda');
    const custoAquisicaoInput = document.getElementById('produtoCustoAquisicao');
    const percentualFaturamentoInput = document.getElementById('produtoPercentualFaturamento');
    const basicDataIdInput = document.getElementById('produtoBasicDataId');
    
    // Função wrapper para garantir que o cálculo seja chamado sempre que qualquer campo dependente mudar
    const recalcular = () => {
      console.log('Recalculando campos do produto (triggered by field change)...');
      // Garantir que o cálculo seja feito, mesmo se o DOM ainda não estiver pronto
      setTimeout(() => {
        calcularCamposProduto();
      }, 10);
    };
    
    // Remover todos os listeners anteriores e adicionar novos para garantir que o cálculo seja refeito
    if (precoVendaInput) {
      precoVendaInput.oninput = null;
      precoVendaInput.onblur = null;
      precoVendaInput.onchange = null;
      precoVendaInput.addEventListener('input', recalcular);
      precoVendaInput.addEventListener('blur', recalcular);
      precoVendaInput.addEventListener('change', recalcular);
      console.log('Event listeners adicionados ao campo Preço de Venda');
    }
    
    if (custoAquisicaoInput) {
      custoAquisicaoInput.oninput = null;
      custoAquisicaoInput.onblur = null;
      custoAquisicaoInput.onchange = null;
      custoAquisicaoInput.addEventListener('input', recalcular);
      custoAquisicaoInput.addEventListener('blur', recalcular);
      custoAquisicaoInput.addEventListener('change', recalcular);
      console.log('Event listeners adicionados ao campo Custo de Aquisição');
    }
    
    if (percentualFaturamentoInput) {
      percentualFaturamentoInput.oninput = null;
      percentualFaturamentoInput.onblur = null;
      percentualFaturamentoInput.onchange = null;
      percentualFaturamentoInput.addEventListener('input', recalcular);
      percentualFaturamentoInput.addEventListener('blur', recalcular);
      percentualFaturamentoInput.addEventListener('change', recalcular);
      console.log('Event listeners adicionados ao campo Percentual de Faturamento');
    }
    
    if (basicDataIdInput) {
      basicDataIdInput.onchange = null;
      basicDataIdInput.addEventListener('change', () => {
        console.log('Event: basicDataId change', basicDataIdInput.value);
        recalcular();
      });
      console.log('Event listener adicionado ao campo Dados Básicos');
    }
    
    // Se estiver editando, calcular campos
    if (produtoCodigo) {
      setTimeout(() => {
        calcularCamposProduto();
      }, 300);
    }
  }, 100);
  
  // Adicionar listener para quando o modal estiver completamente aberto
  const produtoModalElement = document.getElementById('produtoModal');
  if (produtoModalElement) {
    // Função para executar quando o modal estiver completamente aberto
    const onModalShown = () => {
      console.log('Modal completamente aberto - garantindo que elementos estejam disponíveis...');
      setTimeout(() => {
        calcularCamposProduto();
      }, 50);
    };
    
    produtoModalElement.addEventListener('shown.bs.modal', onModalShown, { once: true });
  }
  
  modal.show();
}

// Submeter formulário de produto
document.getElementById('produtoForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const produtoCodigoOriginal = document.getElementById('produtoCodigoOriginal').value;
  const nome = document.getElementById('produtoNome').value.trim();
  
  if (!nome) {
    alert('Por favor, informe o nome do produto');
    return;
  }
  
  const formData = new FormData();
  formData.append('nome', nome);
  
  // Mapeamento de campos
  const camposMap = {
    'categoria_codigo': 'produtoCategoriaCodigo',
    'basic_data_id': 'produtoBasicDataId',
    'faturamento_por_mercadoria': 'produtoFaturamentoPorMercadoria',
    'preco_venda': 'produtoPrecoVenda',
    'custo_aquisicao': 'produtoCustoAquisicao',
    'percentual_faturamento': 'produtoPercentualFaturamento',
    'quantidade_vendas': 'produtoQuantidadeVendas',
    'gastos_com_vendas': 'produtoGastosComVendas',
    'gastos_com_compras': 'produtoGastosComCompras',
    'margem_contribuicao_informada': 'produtoMargemContribuicaoInformada',
    'margem_contribuicao_corrigida': 'produtoMargemContribuicaoCorrigida',
    'margem_contribuicao_valor': 'produtoMargemContribuicaoValor',
    'custos_fixos': 'produtoCustosFixos',
    'ponto_equilibrio': 'produtoPontoEquilibrio',
    'margem_operacional': 'produtoMargemOperacional'
  };
  
  Object.keys(camposMap).forEach(campo => {
    const elemento = document.getElementById(camposMap[campo]);
    if (elemento && elemento.value) {
      formData.append(campo, elemento.value);
    }
  });
  
  const url = produtoCodigoOriginal ? `/produto/api/update/${produtoCodigoOriginal}` : '/produto/api/create';
  const method = produtoCodigoOriginal ? 'PUT' : 'POST';
  
  try {
    const response = await fetch(url, {
      method: method,
      body: formData
    });
    
    const data = await response.json();
    
    if (response.ok) {
      const modalElement = document.getElementById('produtoModal');
      const modal = bootstrap.Modal.getInstance(modalElement);
      
      document.getElementById('produtoForm').reset();
      document.getElementById('produtoCodigoOriginal').value = '';
      
      if (modal) {
        modalElement.addEventListener('hidden.bs.modal', function cleanup() {
          const backdrops = document.querySelectorAll('.modal-backdrop');
          backdrops.forEach(backdrop => backdrop.remove());
          document.body.classList.remove('modal-open');
          document.body.style.overflow = '';
          document.body.style.paddingRight = '';
          
          const produtoTab = document.getElementById('produto-tab');
          const produtoPane = document.getElementById('produto');
          
          if (produtoTab && produtoPane) {
            document.querySelectorAll('#produtoTabs .nav-link').forEach(tabLink => {
              tabLink.classList.remove('active');
              tabLink.setAttribute('aria-selected', 'false');
            });
            
            document.querySelectorAll('.tab-pane').forEach(pane => {
              pane.classList.remove('show', 'active');
            });
            
            produtoTab.classList.add('active');
            produtoTab.setAttribute('aria-selected', 'true');
            produtoPane.classList.add('show', 'active');
            
            const tab = bootstrap.Tab.getOrCreateInstance(produtoTab);
            tab.show();
          }
          
          setTimeout(() => {
            if (typeof window.carregarProdutos === 'function') {
              window.carregarProdutos();
            }
          }, 200);
          
          const mensagem = produtoCodigoOriginal ? 'Produto atualizado com sucesso!' : 'Produto adicionado com sucesso!';
          const alertDiv = document.createElement('div');
          alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
          alertDiv.style.zIndex = '9999';
          alertDiv.innerHTML = `
            ${mensagem}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          `;
          document.body.appendChild(alertDiv);
          setTimeout(() => {
            if (alertDiv.parentNode) {
              alertDiv.remove();
            }
          }, 3000);
        }, { once: true });
        
        modal.hide();
      }
    } else {
      alert(data.error || 'Erro ao salvar produto');
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao salvar produto. Por favor, tente novamente.');
  }
});

// Carregar produtos (já filtrados pelo usuário logado no backend) agrupados por categoria
window.carregarProdutos = async function() {
  try {
    const tbody = document.getElementById('produtosTableBody');
    if (!tbody) {
      console.error('Tabela de produtos não encontrada');
      return;
    }
    
    tbody.innerHTML = '<tr><td colspan="14" class="text-center"><i class="spinner-border spinner-border-sm me-2"></i>Carregando produtos...</td></tr>';
    
    // Carregar produtos e categorias em paralelo
    const [produtosResponse, categoriasResponse] = await Promise.all([
      fetch('/produto/api/list'),
      fetch('/produto/api/categorias')
    ]);
    
    if (!produtosResponse.ok) {
      throw new Error(`Erro ${produtosResponse.status}: ${produtosResponse.statusText}`);
    }
    
    const produtos = await produtosResponse.json();
    const categorias = await categoriasResponse.json();
    
    tbody.innerHTML = '';
    
    if (!produtos || produtos.length === 0) {
      tbody.innerHTML = '<tr><td colspan="14" class="text-center text-muted py-4">Nenhum produto cadastrado. Clique em "Adicionar Produto" para criar um novo.</td></tr>';
      return;
    }
    
    // Criar mapa de categorias (codigo -> nome)
    const categoriasMap = {};
    categorias.forEach(cat => {
      categoriasMap[cat.codigo] = cat.nome;
    });
    
    // Função auxiliar para formatar valores monetários
    const formatMoney = (valor) => valor ? 'R$ ' + parseFloat(valor).toFixed(2).replace('.', ',') : '-';
    
    // Função auxiliar para formatar percentuais
    const formatPercent = (valor) => valor ? parseFloat(valor).toFixed(2).replace('.', ',') + '%' : '-';
    
    // Função auxiliar para formatar números
    const formatNumber = (valor) => valor ? parseFloat(valor).toFixed(2).replace('.', ',') : '-';
    
    // Função auxiliar para formatar números inteiros (sem casas decimais)
    const formatInteger = (valor) => valor ? Math.round(parseFloat(valor)).toString() : '-';
    
    // Agrupar produtos por categoria
    const produtosPorCategoria = {};
    const produtosSemCategoria = [];
    
    produtos.forEach(produto => {
      const categoriaCodigo = produto.categoria_codigo;
      if (categoriaCodigo) {
        if (!produtosPorCategoria[categoriaCodigo]) {
          produtosPorCategoria[categoriaCodigo] = [];
        }
        produtosPorCategoria[categoriaCodigo].push(produto);
      } else {
        produtosSemCategoria.push(produto);
      }
    });
    
    // Função para calcular totais de uma categoria
    const calcularTotaisCategoria = (prods) => {
      const faturamento = prods.reduce((sum, p) => sum + (parseFloat(p.faturamento_por_mercadoria) || 0), 0);
      const gastosVendas = prods.reduce((sum, p) => sum + (parseFloat(p.gastos_com_vendas) || 0), 0);
      const gastosCompras = prods.reduce((sum, p) => sum + (parseFloat(p.gastos_com_compras) || 0), 0);
      const custosFixos = prods.reduce((sum, p) => sum + (parseFloat(p.custos_fixos) || 0), 0);
      const totalGastos = gastosVendas + gastosCompras + custosFixos;
      
      // Calcular margem operacional como: (Faturamento - Total Gastos) / Faturamento * 100
      const margemOperacional = faturamento > 0 ? ((faturamento - totalGastos) / faturamento) * 100 : 0;
      
      return {
        faturamento: faturamento,
        quantidadeVendas: prods.reduce((sum, p) => sum + (parseFloat(p.quantidade_vendas) || 0), 0),
        gastosVendas: gastosVendas,
        gastosCompras: gastosCompras,
        margemContribValor: prods.reduce((sum, p) => sum + (parseFloat(p.margem_contribuicao_valor) || 0), 0),
        custosFixos: custosFixos,
        pontoEquilibrio: prods.reduce((sum, p) => sum + (parseFloat(p.ponto_equilibrio) || 0), 0),
        margemOperacional: margemOperacional
      };
    };
    
    // Ordenar categorias por nome
    const categoriasOrdenadas = Object.keys(produtosPorCategoria).sort((a, b) => {
      const nomeA = categoriasMap[a] || '';
      const nomeB = categoriasMap[b] || '';
      return nomeA.localeCompare(nomeB);
    });
    
    // Adicionar produtos agrupados por categoria
    categoriasOrdenadas.forEach(categoriaCodigo => {
      const produtosCategoria = produtosPorCategoria[categoriaCodigo];
      const categoriaNome = categoriasMap[categoriaCodigo] || `Categoria ${categoriaCodigo}`;
      
      // Ordenar produtos da categoria por nome
      produtosCategoria.sort((a, b) => a.nome.localeCompare(b.nome));
      
      // Calcular totais da categoria
      const totais = calcularTotaisCategoria(produtosCategoria);
      
      // Linha de cabeçalho da categoria com totais
      const trCategoria = document.createElement('tr');
      trCategoria.className = 'table-light fw-bold';
      trCategoria.innerHTML = `
        <td><strong>${categoriaNome}</strong> <small>(Total)</small></td>
        <td><strong>${formatMoney(totais.faturamento)}</strong></td>
        <td>-</td>
        <td>-</td>
        <td><strong>${formatInteger(totais.quantidadeVendas)}</strong></td>
        <td><strong>${formatMoney(totais.gastosVendas)}</strong></td>
        <td><strong>${formatMoney(totais.gastosCompras)}</strong></td>
        <td>-</td>
        <td>-</td>
        <td><strong>${formatMoney(totais.margemContribValor)}</strong></td>
        <td><strong>${formatMoney(totais.custosFixos)}</strong></td>
        <td><strong>${formatNumber(totais.pontoEquilibrio)}</strong></td>
        <td><strong>${formatPercent(totais.margemOperacional)}</strong></td>
        <td>-</td>
      `;
      tbody.appendChild(trCategoria);
      
      // Adicionar produtos da categoria
      produtosCategoria.forEach(produto => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>&nbsp;&nbsp;&nbsp;&nbsp;${produto.nome}</td>
          <td>${formatMoney(produto.faturamento_por_mercadoria)}</td>
          <td>${formatMoney(produto.preco_venda)}</td>
          <td>${formatMoney(produto.custo_aquisicao)}</td>
          <td>${formatInteger(produto.quantidade_vendas)}</td>
          <td>${formatMoney(produto.gastos_com_vendas)}</td>
          <td>${formatMoney(produto.gastos_com_compras)}</td>
          <td>${formatPercent(produto.margem_contribuicao_informada)}</td>
          <td>${formatPercent(produto.margem_contribuicao_corrigida)}</td>
          <td>${formatMoney(produto.margem_contribuicao_valor)}</td>
          <td>${formatMoney(produto.custos_fixos)}</td>
          <td>${formatNumber(produto.ponto_equilibrio)}</td>
          <td>${formatPercent(produto.margem_operacional)}</td>
          <td>
            <button class="btn btn-sm btn-secondary btn-action me-2" onclick="openProdutoModal(${produto.codigo})" title="Editar produto">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-danger btn-action" onclick="removerProduto(${produto.codigo})" title="Remover produto">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    });
    
    // Adicionar produtos sem categoria no final
    if (produtosSemCategoria.length > 0) {
      produtosSemCategoria.sort((a, b) => a.nome.localeCompare(b.nome));
      
      const totaisSemCategoria = calcularTotaisCategoria(produtosSemCategoria);
      
      // Linha de cabeçalho para produtos sem categoria
      const trSemCategoria = document.createElement('tr');
      trSemCategoria.className = 'table-light fw-bold';
      trSemCategoria.innerHTML = `
        <td><strong>Sem Categoria</strong> <small>(Total)</small></td>
        <td><strong>${formatMoney(totaisSemCategoria.faturamento)}</strong></td>
        <td>-</td>
        <td>-</td>
        <td><strong>${formatInteger(totaisSemCategoria.quantidadeVendas)}</strong></td>
        <td><strong>${formatMoney(totaisSemCategoria.gastosVendas)}</strong></td>
        <td><strong>${formatMoney(totaisSemCategoria.gastosCompras)}</strong></td>
        <td>-</td>
        <td>-</td>
        <td><strong>${formatMoney(totaisSemCategoria.margemContribValor)}</strong></td>
        <td><strong>${formatMoney(totaisSemCategoria.custosFixos)}</strong></td>
        <td><strong>${formatNumber(totaisSemCategoria.pontoEquilibrio)}</strong></td>
        <td><strong>${formatPercent(totaisSemCategoria.margemOperacional)}</strong></td>
        <td>-</td>
      `;
      tbody.appendChild(trSemCategoria);
      
      produtosSemCategoria.forEach(produto => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>&nbsp;&nbsp;&nbsp;&nbsp;${produto.nome}</td>
          <td>${formatMoney(produto.faturamento_por_mercadoria)}</td>
          <td>${formatMoney(produto.preco_venda)}</td>
          <td>${formatMoney(produto.custo_aquisicao)}</td>
          <td>${formatInteger(produto.quantidade_vendas)}</td>
          <td>${formatMoney(produto.gastos_com_vendas)}</td>
          <td>${formatMoney(produto.gastos_com_compras)}</td>
          <td>${formatPercent(produto.margem_contribuicao_informada)}</td>
          <td>${formatPercent(produto.margem_contribuicao_corrigida)}</td>
          <td>${formatMoney(produto.margem_contribuicao_valor)}</td>
          <td>${formatMoney(produto.custos_fixos)}</td>
          <td>${formatNumber(produto.ponto_equilibrio)}</td>
          <td>${formatPercent(produto.margem_operacional)}</td>
          <td>
            <button class="btn btn-sm btn-secondary btn-action me-2" onclick="openProdutoModal(${produto.codigo})" title="Editar produto">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-danger btn-action" onclick="removerProduto(${produto.codigo})" title="Remover produto">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
  } catch (error) {
    console.error('Erro ao carregar produtos:', error);
    const tbody = document.getElementById('produtosTableBody');
    if (tbody) {
      tbody.innerHTML = '<tr><td colspan="14" class="text-center text-danger py-4">Erro ao carregar produtos. Por favor, recarregue a página.</td></tr>';
    }
  }
}

// Remover produto
window.removerProduto = async function(produtoCodigo) {
  if (!confirm('Tem certeza que deseja remover este produto?')) {
    return;
  }
  
  try {
    const response = await fetch(`/produto/api/delete/${produtoCodigo}`, {
      method: 'DELETE'
    });
    
    const data = await response.json();
    
    if (response.ok) {
      carregarProdutos();
      
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
      alertDiv.style.zIndex = '9999';
      alertDiv.innerHTML = `
        Produto removido com sucesso!
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      document.body.appendChild(alertDiv);
      setTimeout(() => {
        alertDiv.remove();
      }, 3000);
    } else {
      alert(data.error || 'Erro ao remover produto');
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao remover produto. Por favor, tente novamente.');
  }
}

// Carregar Curva ABC
document.addEventListener('DOMContentLoaded', function() {
  let curvaAbcChart = null;
  let distribuicaoClasseChart = null;
  
  // Armazenar dados da curva ABC globalmente
  let dadosCurvaAbc = null;
  
  // Função para formatar valores
  const formatMoney = (valor) => valor ? 'R$ ' + parseFloat(valor).toFixed(2).replace('.', ',') : '-';
  const formatPercent = (valor) => valor ? parseFloat(valor).toFixed(2).replace('.', ',') + '%' : '-';
  
  // Função para exibir/ocultar produtos de uma classe
  function toggleProdutosClasse(classe) {
    const detalhesRowId = `detalhes-${classe}`;
    const detalhesRow = document.getElementById(detalhesRowId);
    const classeRow = document.querySelector(`[data-classe="${classe}"]`);
    const iconTd = classeRow?.querySelector('.icon-toggle');
    
    if (detalhesRow) {
      // Se já existe, remover ou mostrar
      if (detalhesRow.style.display === 'none' || !detalhesRow.style.display) {
        detalhesRow.style.display = '';
        if (iconTd) iconTd.innerHTML = '<i class="bi bi-chevron-down"></i>';
      } else {
        detalhesRow.style.display = 'none';
        if (iconTd) iconTd.innerHTML = '<i class="bi bi-chevron-right"></i>';
      }
    } else {
      // Criar linha de detalhes
      if (!dadosCurvaAbc) return;
      
      const produtosClasse = dadosCurvaAbc.curva_abc.filter(p => p.classe === classe);
      if (produtosClasse.length === 0) return;
      
      // Criar linha de detalhes
      const detalhesTr = document.createElement('tr');
      detalhesTr.id = detalhesRowId;
      detalhesTr.className = 'table-secondary';
      detalhesTr.style.backgroundColor = '#f8f9fa';
      
      let produtosHtml = produtosClasse.map(produto => `
        <tr style="background-color: #ffffff;">
          <td></td>
          <td style="padding-left: 30px;"><small>${produto.nome}</small></td>
          <td><small>${produto.quantidade_vendas || '-'}</small></td>
          <td><small>${formatMoney(produto.faturamento)}</small></td>
          <td><small>${formatPercent(produto.percentual_produto)}</small></td>
        </tr>
      `).join('');
      
      detalhesTr.innerHTML = `
        <td colspan="5" style="padding: 0;">
          <table class="table table-sm mb-0" style="margin-bottom: 0;">
            <thead>
              <tr>
                <th style="width: 30px;"></th>
                <th>Nome do Produto</th>
                <th>Qtd. Vendas</th>
                <th>Faturamento (R$)</th>
                <th>% do Total</th>
              </tr>
            </thead>
            <tbody>
              ${produtosHtml}
            </tbody>
          </table>
        </td>
      `;
      
      // Inserir após a linha da classe
      if (classeRow && classeRow.nextSibling) {
        classeRow.parentNode.insertBefore(detalhesTr, classeRow.nextSibling);
      } else if (classeRow) {
        classeRow.parentNode.appendChild(detalhesTr);
      }
      
      if (iconTd) iconTd.innerHTML = '<i class="bi bi-chevron-down"></i>';
    }
  }
  
  // Carregar dados da curva ABC
  async function carregarCurvaABC() {
    try {
      const response = await fetch('/produto/api/curva-abc');
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Erro ao carregar dados');
      }
      
      // Armazenar dados globalmente
      dadosCurvaAbc = data;
      
      // Atualizar resumo
      const resumoTbody = document.getElementById('resumoCurvaAbc');
      if (resumoTbody) {
        if (data.resumo && data.curva_abc && data.curva_abc.length > 0) {
          resumoTbody.innerHTML = `
            <tr class="table-light classe-row" data-classe="A" style="cursor: pointer;" onclick="window.toggleProdutosClasse('A')">
              <td class="icon-toggle"><i class="bi bi-chevron-right"></i></td>
              <td><strong>Classe A</strong></td>
              <td>${data.resumo.classe_a.quantidade}</td>
              <td>R$ ${data.resumo.classe_a.faturamento.toFixed(2).replace('.', ',')}</td>
              <td>${data.resumo.classe_a.percentual.toFixed(2)}%</td>
            </tr>
            <tr class="table-light classe-row" data-classe="B" style="cursor: pointer;" onclick="window.toggleProdutosClasse('B')">
              <td class="icon-toggle"><i class="bi bi-chevron-right"></i></td>
              <td><strong>Classe B</strong></td>
              <td>${data.resumo.classe_b.quantidade}</td>
              <td>R$ ${data.resumo.classe_b.faturamento.toFixed(2).replace('.', ',')}</td>
              <td>${data.resumo.classe_b.percentual.toFixed(2)}%</td>
            </tr>
            <tr class="table-light classe-row" data-classe="C" style="cursor: pointer;" onclick="window.toggleProdutosClasse('C')">
              <td class="icon-toggle"><i class="bi bi-chevron-right"></i></td>
              <td><strong>Classe C</strong></td>
              <td>${data.resumo.classe_c.quantidade}</td>
              <td>R$ ${data.resumo.classe_c.faturamento.toFixed(2).replace('.', ',')}</td>
              <td>${data.resumo.classe_c.percentual.toFixed(2)}%</td>
            </tr>
            <tr class="table-info fw-bold">
              <td></td>
              <td><strong>Total</strong></td>
              <td>${data.quantidade_total}</td>
              <td><strong>R$ ${data.faturamento_total.toFixed(2).replace('.', ',')}</strong></td>
              <td><strong>100%</strong></td>
            </tr>
          `;
        } else {
          resumoTbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum produto com faturamento cadastrado.</td></tr>';
        }
      }
      
      // Preparar dados para gráficos
      if (data.curva_abc && data.curva_abc.length > 0) {
        // Gráfico de Curva ABC (Pareto)
        const labels = data.curva_abc.map(p => p.nome.length > 20 ? p.nome.substring(0, 20) + '...' : p.nome);
        const faturamentos = data.curva_abc.map(p => p.faturamento);
        const percentuaisAcumulados = data.curva_abc.map(p => p.percentual_acumulado);
        
        const ctx1 = document.getElementById('curvaAbcChart');
        if (ctx1) {
          if (curvaAbcChart) {
            curvaAbcChart.destroy();
          }
          curvaAbcChart = new Chart(ctx1, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Faturamento (R$)',
                data: faturamentos,
                backgroundColor: data.curva_abc.map(p => {
                  if (p.classe === 'A') return 'rgba(40, 167, 69, 0.7)';
                  if (p.classe === 'B') return 'rgba(255, 193, 7, 0.7)';
                  return 'rgba(220, 53, 69, 0.7)';
                }),
                borderColor: data.curva_abc.map(p => {
                  if (p.classe === 'A') return 'rgba(40, 167, 69, 1)';
                  if (p.classe === 'B') return 'rgba(255, 193, 7, 1)';
                  return 'rgba(220, 53, 69, 1)';
                }),
                borderWidth: 1
              }, {
                label: '% Acumulado',
                data: percentuaisAcumulados,
                type: 'line',
                borderColor: 'rgba(0, 123, 255, 1)',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                yAxisID: 'y1',
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                title: {
                  display: true,
                  text: 'Curva ABC - Faturamento por Produto'
                },
                legend: {
                  display: true
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'Faturamento (R$)'
                  }
                },
                y1: {
                  type: 'linear',
                  display: true,
                  position: 'right',
                  max: 100,
                  title: {
                    display: true,
                    text: '% Acumulado'
                  },
                  grid: {
                    drawOnChartArea: false
                  }
                }
              }
            }
          });
        }
        
        // Gráfico de Distribuição por Classe
        const ctx2 = document.getElementById('distribuicaoClasseChart');
        if (ctx2) {
          if (distribuicaoClasseChart) {
            distribuicaoClasseChart.destroy();
          }
          distribuicaoClasseChart = new Chart(ctx2, {
            type: 'doughnut',
            data: {
              labels: ['Classe A', 'Classe B', 'Classe C'],
              datasets: [{
                data: [
                  data.resumo.classe_a.faturamento,
                  data.resumo.classe_b.faturamento,
                  data.resumo.classe_c.faturamento
                ],
                backgroundColor: [
                  'rgba(40, 167, 69, 0.7)',
                  'rgba(255, 193, 7, 0.7)',
                  'rgba(220, 53, 69, 0.7)'
                ],
                borderColor: [
                  'rgba(40, 167, 69, 1)',
                  'rgba(255, 193, 7, 1)',
                  'rgba(220, 53, 69, 1)'
                ],
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                title: {
                  display: true,
                  text: 'Distribuição de Faturamento por Classe'
                },
                legend: {
                  position: 'bottom'
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const label = context.label || '';
                      const value = context.parsed || 0;
                      const percentual = data.resumo[label.toLowerCase().replace('classe ', 'classe_')].percentual;
                      return `${label}: R$ ${value.toFixed(2).replace('.', ',')} (${percentual.toFixed(2)}%)`;
                    }
                  }
                }
              }
            }
          });
        }
      } else {
        // Se não houver dados, mostrar mensagem
        const ctx1 = document.getElementById('curvaAbcChart');
        const ctx2 = document.getElementById('distribuicaoClasseChart');
        if (ctx1 && ctx1.parentElement) ctx1.parentElement.innerHTML = '<p class="text-center text-muted">Nenhum produto com faturamento cadastrado.</p>';
        if (ctx2 && ctx2.parentElement) ctx2.parentElement.innerHTML = '<p class="text-center text-muted">Nenhum produto com faturamento cadastrado.</p>';
      }
    } catch (error) {
      console.error('Erro ao carregar curva ABC:', error);
      const resumoTbody = document.getElementById('resumoCurvaAbc');
      if (resumoTbody) {
        resumoTbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erro ao carregar dados. Por favor, recarregue a página.</td></tr>';
      }
    }
  }
  
  // Tornar função global para acesso via onclick
  window.toggleProdutosClasse = toggleProdutosClasse;
  
  // Carregar dados quando a aba Dashboard for ativada
  const dashboardTab = document.getElementById('dashboard-tab');
  if (dashboardTab) {
    dashboardTab.addEventListener('shown.bs.tab', function() {
      // Aguardar um pouco para garantir que o DOM está pronto
      setTimeout(() => {
        carregarCurvaABC();
      }, 100);
    });
    
    // Se a aba Dashboard já estiver ativa, carregar imediatamente
    if (dashboardTab.classList.contains('active')) {
      setTimeout(() => {
        carregarCurvaABC();
      }, 500);
    }
  }
});
</script>
{% endblock %}
