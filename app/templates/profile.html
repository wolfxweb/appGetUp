{% extends "base.html" %}

{% block title %}Meus Dados{% endblock %}

{% block head %}
<script>
    // Definir as áreas de especialidade para cada atividade
    const specialtyAreas = {
        'AMBULANTE': [
            'Açaí', 'Algodão doce', 'Artesanato', 'Balas, bombons e chocolates', 'Barraca de pastel',
            'Bebidas e refresco', 'Bijuterias', 'Cachorro-quente', 'Calçados', 'Caldo de cana',
            'Churrasquinho', 'Churros', 'Crepe', 'Doces', 'Eletrônicos', 'Ervas medicinais',
            'Sanduiches', 'Mate', 'Milho cozido', 'Óculos', 'Pipoca', 'Relógios',
            'Revenda de bijuterias e semi-jóias', 'Roupas e/ou acessórios', 'Sorvete',
            'Souvenirs temáticos e lembranças', 'Tapioca', 'Outra area ambulante'
        ],
        'ATACADO': [
            'Acessórios para aparelhos celulares', 'Adubos e defensivos agrícolas',
            'Alimentos congelados', 'Artigos de decoração', 'Artigos esportivos',
            'Artigos para festas', 'Autopeças e acessórios', 'Bebidas',
            'Bolsas, carteiras, cintos, malas, etc.', 'Brinquedos e jogos',
            'Calçados atacado', 'Cama, mesa e banho', 'Cereais', 'Doces atacado',
            'Eletrodomésticos atacado', 'Eletro-eletrônicos e informática',
            'Equipamentos de sinalização e segurança', 'Equipamentos e acessórios para a área da saúde',
            'Equipamentos e utensílios para copa e cozinha', 'Fantasias',
            'Implementos agrícolas', 'Instrumentos musicais', 'Livros, revistas, jornais',
            'Materiais de construção', 'Materiais de escritório',
            'Materiais de higiene e limpeza', 'Medicamentos',
            'Medicamentos e produtos veterinários', 'Produtos alimentícios',
            'Produtos e implementos de jardinagem', 'Roupas', 'Sorvetes',
            'Uniformes atacado', 'Vestuário', 'Outra área atacado'
        ],
        'AUTOMOTORES': [
            'Automóveis e utilitários', 'Autopeças e acessórios',
            'Barcos, botes, lanchas, jet-skis', 'Baterias', 'Bicicletas',
            'Caminhões', 'Caminhões, ônibus e vans', 'Carrocerias e baús',
            'Carrocerias para ônibus e vans', 'Combustíveis e lubrificantes',
            'Equipamentos para transporte coletivo', 'Equipamentos para transporte de cargas',
            'Máquinas e implementos agrícolas', 'Motocicletas', 'Ônibus e vans',
            'Pneus', 'Outra área automotores'
        ],
        'VAREJO - Alimentação fora do Lar': [
            'Bar/Boteco', 'Açaiteria', 'Biscoitos', 'Bistrô', 'Bomboniere',
            'Boulangerie', 'Cachaçaria', 'Café colonial', 'Cafeteria - café expresso',
            'Cantina Italiana', 'Casa de chá', 'Casa de sucos', 'Cervejaria',
            'Chocolates', 'Choperia', 'Churrascaria', 'Comidas delivery',
            'Confeitaria', 'Creperia', 'Delicatessen', 'Doceria', 'Fast food',
            'Food truck', 'Gelateria', 'Hamburgueria', 'Lanchonete',
            'Loja de bolos e tortas', 'Loja de conveniências',
            'Loja de sanduíches naturais', 'Loja de vinhos e destilados',
            'Mate e salgados', 'Padaria', 'Pamonharia', 'Panificadora',
            'Pastelaria', 'Petisqueria', 'Pizzaria', 'Quiosque de praia',
            'Quiosque de Shopping', 'Refeições industriais',
            'Refeições prontas ("marmitex")', 'Restaurante à la carte',
            'Restaurante árabe', 'Restaurante chinês', 'Restaurante coreano',
            'Restaurante culinária baiana', 'Restaurante culinária capixaba',
            'Restaurante culinária goiana', 'Restaurante culinária internacional',
            'Restaurante culinária mineira', 'Restaurante culinária nordestina',
            'Restaurante culinária portuguesa', 'Restaurante de alta gastronomia',
            'Restaurante de caldos e saladas', 'Restaurante de frutos do mar',
            'Restaurante frango assado - galeteria', 'Restaurante japonês',
            'Restaurante regional', 'Restaurante self-service',
            'Restaurante temático', 'Restaurante vegano',
            'Restaurante vegetariano', 'Rotisserie', 'Snack-bar',
            'Sorveteria', 'Sucos', 'Tapiocaria', 'Temakeria',
            'Outra área varejo alimentação'
        ],
        'Varejo - Animais domesticos': [
            'Medicamentos veterinários', 'Pet shop', 'Rações',
            'Outra área animais domesticos'
        ],
        'Varejo - Arte, decoração e utilidades para o Lar': [
            'Antiquário', 'Aquários e peixes ornamentais', 'Arte e artesanato',
            'Artigos de cama, mesa e banho', 'Colchões',
            'Cortinas, tapetes e carpetes', 'Eletrodomésticos',
            'Equipamentos e utensílios para copa e cozinha',
            'Flores e plantas artificiais', 'Floricultura - flores naturais',
            'Gás de cozinha', 'Louças', 'Lustres e iluminação',
            'Materiais e peças para artesanato', 'Móveis',
            'Móveis de aço', 'Móveis e estofados', 'Móveis planejados',
            'Móveis rústicos', 'Móveis usados', 'Persianas e cortinas',
            'Plantas ornamentais', 'Presentes e artigos de decoração',
            'Quadros e molduras', 'Tapetes',
            'Outra área varejo utilizadades e decoração'
        ],
        'Varejo - Bebidas e produtos alimentícios': [
            'Açougue', 'Adega', 'Armazém', 'Embalagens', 'Frutaria',
            'Minimercado', 'Padarias', 'Peixaria', 'Quitanda',
            'Supermercado', 'Outra área varejo alimenticío'
        ],
        'Varejo - Copa e cozinha': [
            'Equipamentos de refrigeração', 'Máquinas e equipamentos',
            'Materiais de limpeza e higiene', 'Mobiliário',
            'Uniformes para cozinha',
            'Utensílios, louças, talheres e acessórios',
            'Outra área varejo copa cozinha'
        ],
        'Varejo - Eletroeletrônicos e informática': [
            'Acessórios para celulares', 'Computadores e acessórios',
            'Equipamentos de som', 'Equipamentos e materiais de Informática',
            'Materiais de informática', 'Telefones celulares e tablets',
            'Outra área eletronicos e imformática'
        ],
        'Varejo - Festas, leitura, música, esporte e lazer': [
            'Barcos e artigos náuticos', 'Brinquedos e jogos infantis',
            'Caça e pesca', 'Camping', 'Discos para colecionadores',
            'Equipamentos de ginástica', 'Equipamentos de salvatagem',
            'Equipamentos para esportes', 'Esportes náuticos',
            'Esportes radicais', 'Fantasias para festas',
            'Instrumentos musicais para festas', 'Livraria',
            'Loja de roupas e acessórios para surfistas', 'Moda praia',
            'Piano', 'Roupas, uniformes e calçados esportivos',
            'Suplementos nutricionais e vitaminas', 'Outra área varejo festas'
        ],
        'Varejo - Jardinagem': [
            'Adubos, sementes e defensivos', 'Árvores adultas',
            'Máquinas, equipamentos e acessórios', 'Móveis para exteriores',
            'Plantas ornamentais', 'Sementes e mudas', 'Viveiro de mudas',
            'Outra área varejo jardinagem'
        ],
        'Varejo - Materiais de construção': [
            'Aquecedor solar', 'Brita', 'Carpintaria', 'Cimento',
            'Equipamentos de segurança', 'Esquadrias',
            'Exploração e comércio de areia', 'Ferragens',
            'Ferramentas, máquinas e equipamentos',
            'Ferro e aço para construção', 'Laje pré-moldada',
            'Loja de ferragens', 'Loja de tintas', 'Louças sanitárias',
            'Madeireira', 'Máquinas, implementos e acessórios',
            'Materiais de construção', 'Materiais elétricos',
            'Peças para refrigeração', 'Pisos e revestimentos',
            'Portas e janelas', 'Serralheria', 'Telhas e tijolos',
            'Tintas e materias para pintura', 'Vidraçaria',
            'Outra área varejo materiais construcao'
        ],
        'Varejo - Papéis e utilidades para escritórios': [
            'Materiais de escritório', 'Papelaria',
            'Outra área varejo utilidades escritório'
        ],
        'Varejo - Saúde e bem-estar': [
            'Aparelhos auditivos', 'Aparelhos ortopédicos', 'Drogaria',
            'Ervas medicinais e homeopatia', 'Farmácia',
            'Farmácia de manipulação', 'Ótica', 'Produtos fitness',
            'Produtos naturais', 'Outra área varejo saúde e bem estar'
        ],
        'Varejo - Vestuário,calçados e complementos': [
            'Armarinho', 'Aviamentos', 'Bijuterias e semi-jóias',
            'Bolsas e calçados', 'Calçados e acessórios',
            'Calçados e acessórios femininos', 'Calçados e acessórios infantis',
            'Calçados e acessórios masculinos',
            'Cosméticos, perfumes e acessórios', 'Joalheria',
            'Loja de departamentos', 'Moda feminina', 'Moda infantil',
            'Moda íntima', 'Moda jovem', 'Moda masculina', 'Moda praia',
            'Perfumaria', 'Roupas e acessórios plus size',
            'Roupas usadas (Brechó)',
            'Roupas, acessórios e produtos para bebês', 'Sex shop',
            'Tecidos', 'Uniformes', 'Vestidos de noiva',
            'Outra área vestuário e calçados'
        ]
    };

    // Função para carregar as áreas de especialidade
    function loadSpecialtyAreas() {
        const activityType = document.getElementById('company_activity').value;
        const specialtyAreaSelect = document.getElementById('specialty_area');
        const savedSpecialtyArea = specialtyAreaSelect.getAttribute('data-saved-value');
        
        // Limpar opções existentes
        specialtyAreaSelect.innerHTML = '<option value="" disabled>Selecione a área de especialidade</option>';
        
        // Habilitar o select
        specialtyAreaSelect.disabled = false;
        
        // Adicionar novas opções
        if (activityType && specialtyAreas[activityType]) {
            specialtyAreas[activityType].forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                if (area === savedSpecialtyArea) {
                    option.selected = true;
                }
                specialtyAreaSelect.appendChild(option);
            });
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const companyActivitySelect = document.getElementById('company_activity');
        const specialtyAreaSelect = document.getElementById('specialty_area');
        
        // Salvar o valor atual da área de especialidade
        if (specialtyAreaSelect) {
            const currentValue = specialtyAreaSelect.value;
            if (currentValue) {
                specialtyAreaSelect.setAttribute('data-saved-value', currentValue);
            }
        }
        
        if (companyActivitySelect) {
            companyActivitySelect.addEventListener('change', loadSpecialtyAreas);
            // Carregar áreas de especialidade se já houver uma atividade selecionada
            if (companyActivitySelect.value) {
                loadSpecialtyAreas();
            }
        }

        // Formatar WhatsApp
        const whatsappInput = document.getElementById('whatsapp');
        if (whatsappInput) {
            whatsappInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                
                if (value.length > 11) {
                    value = value.substring(0, 11);
                }
                
                if (value.length > 2) {
                    value = '(' + value.substring(0, 2) + ') ' + value.substring(2);
                }
                if (value.length > 10) {
                    value = value.substring(0, 10) + '-' + value.substring(10);
                }
                
                e.target.value = value;
            });
        }

        // Enviar formulário
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                
                // Remover o campo de senha do FormData
                formData.delete('password');
                
                // Adicionar o campo action baseado no botão que foi clicado
                const submitButton = document.activeElement;
                if (submitButton && submitButton.name === 'action') {
                    formData.append('action', submitButton.value);
                } else {
                    formData.append('action', 'update');
                }
                
                fetch('/profile/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(formData)
                })
                .then(response => {
                    if (response.ok) {
                        // Se a resposta for ok, recarregar a página
                        window.location.reload();
                    } else if (response.status === 500) {
                        // Se for erro interno do servidor
                        throw new Error('Erro interno do servidor. Por favor, tente novamente mais tarde.');
                    } else {
                        // Para outros erros, tentar ler como texto
                        return response.text().then(text => {
                            try {
                                // Tentar parsear como JSON
                                const data = JSON.parse(text);
                                let errorMessage = 'Erro ao atualizar perfil';
                                
                                if (data.detail) {
                                    if (Array.isArray(data.detail)) {
                                        const fieldNames = {
                                            'name': 'Nome',
                                            'email': 'Email',
                                            'whatsapp': 'WhatsApp',
                                            'state': 'Estado',
                                            'city': 'Cidade',
                                            'activity_type': 'Área de atuação',
                                            'company_activity': 'Atividade da Empresa',
                                            'specialty_area': 'Área de Especialidade'
                                        };

                                        errorMessage = data.detail.map(error => {
                                            const fieldName = error.loc && error.loc[1] ? fieldNames[error.loc[1]] || error.loc[1] : 'Campo';
                                            return `O preenchimento do campo ${fieldName} é obrigatório.`;
                                        }).join('\n\n');
                                    } else {
                                        errorMessage = data.detail;
                                    }
                                }
                                
                                throw new Error(errorMessage);
                            } catch (e) {
                                // Se não for JSON, usar o texto da resposta como mensagem de erro
                                throw new Error(text || 'Erro ao processar a requisição');
                            }
                        });
                    }
                })
                .catch(error => {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'alert alert-danger';
                    errorDiv.style.whiteSpace = 'pre-line';
                    errorDiv.textContent = error.message;
                    
                    const existingError = form.querySelector('.alert');
                    if (existingError) {
                        existingError.remove();
                    }
                    
                    form.insertBefore(errorDiv, form.firstChild);
                });
            });
        }

        // Inicializar todos os tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                html: true
            })
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="container p-5" style="background-color: #F5F5F5; min-height: 100vh;">
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm mb-4" style="background-color: #F5F5F5;">
                <div class="card-body p-3">
                    <div class="row align-items-center mb-4">
                        <div class="col-md-6">
                            <h4>Meus Dados</h4>
                        </div>
                        <div class="col-md-6 text-end">
                            <a href="/dashboard" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Voltar ao Dashboard
                            </a>
                        </div>
                    </div>

                    {% if error_message %}
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        {{ error_message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                    </div>
                    {% endif %}

                    {% if success_message %}
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        {{ success_message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                    </div>
                    {% endif %}

                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <form method="POST" action="/profile">
                                <div class="row">
                                    <!-- Dados Pessoais -->
                                    <div class="col-md-6 mb-3">
                                        <h5 class="mb-3">Dados Pessoais</h5>
                                        <div class="mb-3">
                                            <label for="name" class="form-label">Nome</label>
                                            <input type="text" class="form-control" id="name" name="name" value="{{ user.name }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="email" class="form-label">E-mail</label>
                                            <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="whatsapp" class="form-label">WhatsApp</label>
                                            <input type="text" class="form-control" id="whatsapp" name="whatsapp" value="{{ user.whatsapp }}">
                                        </div>
                                        <div class="mb-3">
                                            <label for="activity_type" class="form-label">Tipo de Atividade</label>
                                            <select class="form-select" id="activity_type" name="activity_type" required>
                                                <option value="Serviços" {% if user.activity_type == 'Serviços' %}selected{% endif %}>Serviços</option>
                                                <option value="Comércio" {% if user.activity_type == 'Comércio' %}selected{% endif %}>Comércio</option>
                                                <option value="Indústria" {% if user.activity_type == 'Indústria' %}selected{% endif %}>Indústria</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Dados Adicionais -->
                                    <div class="col-md-6 mb-3">
                                        <h5 class="mb-3">Dados Adicionais</h5>
                                        <div class="mb-3">
                                            <label for="gender" class="form-label">Gênero</label>
                                            <select class="form-select" id="gender" name="gender">
                                                <option value="">Selecione...</option>
                                                <option value="Masculino" {% if user.gender == 'Masculino' %}selected{% endif %}>Masculino</option>
                                                <option value="Feminino" {% if user.gender == 'Feminino' %}selected{% endif %}>Feminino</option>
                                            </select>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="birth_day" class="form-label">Dia do Aniversário</label>
                                                <input type="number" class="form-control" id="birth_day" name="birth_day" min="1" max="31" value="{{ user.birth_day }}">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="birth_month" class="form-label">Mês do Aniversário</label>
                                                <input type="number" class="form-control" id="birth_month" name="birth_month" min="1" max="12" value="{{ user.birth_month }}">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="married" class="form-label">Estado Civil</label>
                                            <select class="form-select" id="married" name="married">
                                                <option value="">Selecione...</option>
                                                <option value="Sim" {% if user.married == 'Sim' %}selected{% endif %}>Sim</option>
                                                <option value="Não" {% if user.married == 'Não' %}selected{% endif %}>Não</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="children" class="form-label">Tem Filhos?</label>
                                            <select class="form-select" id="children" name="children">
                                                <option value="">Selecione...</option>
                                                <option value="Sim" {% if user.children == 'Sim' %}selected{% endif %}>Sim</option>
                                                <option value="Não" {% if user.children == 'Não' %}selected{% endif %}>Não</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="grandchildren" class="form-label">Tem Netos?</label>
                                            <select class="form-select" id="grandchildren" name="grandchildren">
                                                <option value="">Selecione...</option>
                                                <option value="Sim" {% if user.grandchildren == 'Sim' %}selected{% endif %}>Sim</option>
                                                <option value="Não" {% if user.grandchildren == 'Não' %}selected{% endif %}>Não</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Endereço -->
                                    <div class="col-md-12 mb-3">
                                        <h5 class="mb-3">Endereço</h5>
                                        <div class="row">
                                            <div class="col-md-2 mb-3">
                                                <label for="cep" class="form-label">CEP</label>
                                                <input type="text" class="form-control" id="cep" name="cep" value="{{ user.cep }}">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="street" class="form-label">Logradouro</label>
                                                <input type="text" class="form-control" id="street" name="street" value="{{ user.street }}">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="neighborhood" class="form-label">Bairro</label>
                                                <input type="text" class="form-control" id="neighborhood" name="neighborhood" value="{{ user.neighborhood }}">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label for="city" class="form-label">Cidade</label>
                                                <input type="text" class="form-control" id="city" name="city" value="{{ user.city }}">
                                            </div>
                                            <div class="col-md-2 mb-3">
                                                <label for="state" class="form-label">Estado</label>
                                                <input type="text" class="form-control" id="state" name="state" value="{{ user.state }}">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="complement" class="form-label">Complemento</label>
                                                <input type="text" class="form-control" id="complement" name="complement" value="{{ user.complement }}">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Dados Profissionais -->
                                    <div class="col-md-12 mb-3">
                                        <h5 class="mb-3">Dados Profissionais</h5>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="company_activity" class="form-label">Atividade da Empresa</label>
                                                <input type="text" class="form-control" id="company_activity" name="company_activity" value="{{ user.company_activity }}">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="specialty_area" class="form-label">Área de Especialidade</label>
                                                <input type="text" class="form-control" id="specialty_area" name="specialty_area" value="{{ user.specialty_area }}">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Botões -->
                                    <div class="col-md-12 text-end">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-save"></i> Salvar Alterações
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Máscara para o campo de WhatsApp
    const whatsappInput = document.getElementById('whatsapp');
    if (whatsappInput) {
        whatsappInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);
            if (value.length > 2) {
                value = `(${value.slice(0, 2)}) ${value.slice(2)}`;
            }
            if (value.length > 9) {
                value = `${value.slice(0, 9)}-${value.slice(9)}`;
            }
            e.target.value = value;
        });
    }

    // Máscara para o campo de CEP
    const cepInput = document.getElementById('cep');
    if (cepInput) {
        cepInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 8) value = value.slice(0, 8);
            if (value.length > 5) {
                value = `${value.slice(0, 5)}-${value.slice(5)}`;
            }
            e.target.value = value;
        });
    }
});
</script>
{% endblock %} 