{% extends "base.html" %}

{% block title %}Importância dos Meses - GetUp Gestão{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{{ super() }}
{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #F5F5F5 !important;
    }
    .container-fluid, .container {
        background-color: #F5F5F5 !important;
    }
    .card, .card-body {
        background-color: #F0F0F0 !important;
    }
    .card-header.bg-secondary {
        background-color: #6c757d !important;
        color: white !important;
    }
    .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
    }
    .btn-secondary:hover {
        background-color: #5a6268;
        border-color: #545b62;
        color: white;
    }
    .form-control, .form-select {
        background-color: #F5F5F5 !important;
    }
    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
    }
    .mes-nome {
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="background-color: #F5F5F5; min-height: 100vh;">
  <div class="row">
    <div class="col-md-12 mt-5">
        <div class="col-md-12 mb-4">
            <img src="/static/images/Logo.png" alt="Logo" height="40">
        </div>
      <!-- Botões de navegação -->
      <div class="row mb-4 justify-content-center">
        <div class="col-12 col-md-2 mb-2 mb-md-0">
          <a href="/dashboard" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
            Índice
          </a>
        </div>
        <div class="col-12 col-md-2 mb-2 mb-md-0">
          <a href="/basic-data/new" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
            Dados Básicos
          </a>
        </div>
        <div class="col-12 col-md-2 mb-2 mb-md-0">
          <a href="/diagnostico" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
            Diagnóstico
          </a>
        </div>
        <div class="col-12 col-md-2 mb-2 mb-md-0">
          <a href="/simulador" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
            Simulador
          </a>
        </div>
        <div class="col-12 col-md-2 mb-2 mb-md-0">
          <button type="button" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
            Calculadora de preços
          </button>
        </div>
        <div class="col-12 col-md-2 mb-2 mb-md-0">
          <a href="/produto" class="btn btn-secondary w-100" style="background-color: #6c757d; border-color: #6c757d; color: white;">
            Produto
          </a>
        </div>
      </div>

      <!-- Botão Cadastrar -->
      <div class="row mb-4">
        <div class="col-12">
          <a href="/importancia-meses/cadastrar" class="btn btn-secondary btn-lg">
            <i class="bi bi-plus-circle"></i> Cadastrar Importâncias dos Meses
          </a>
        </div>
      </div>

      <!-- Card principal -->
      <div class="card shadow mb-4" style="background-color: #F0F0F0;">
        <div class="card-header bg-secondary text-white">
          <h4 class="card-title mb-0">Importância dos Meses</h4>
        </div>
        <div class="card-body">
          <!-- Seção: Seleção de Ano -->
          <div class="row mb-4">
            <div class="col-md-6">
              <label for="anoSelect" class="form-label">Selecione o Ano:</label>
              <select class="form-select" id="anoSelect">
                <option value="">Selecione um ano...</option>
              </select>
            </div>
          </div>

          <!-- Mensagem quando não há dados -->
          <div id="mensagemSemDados" class="alert alert-info" style="display: none;">
            Nenhuma importância de mês cadastrada. Clique em 'Cadastrar Importâncias dos Meses' para começar.
          </div>

          <!-- Tabela: Importância dos Meses -->
          <div id="tabelaMesesContainer" style="display: none;">
            <h5 class="mb-3">Importância dos Meses</h5>
            <div class="table-responsive">
              <table class="table table-bordered table-hover">
                <thead class="table-light">
                  <tr>
                    <th>Ano</th>
                    <th>Mês</th>
                    <th>Notas Atribuídas</th>
                    <th>Ritmo do Negócio (%)</th>
                    <th>Quantidade de Vendas</th>
                  </tr>
                </thead>
                <tbody id="tabelaMeses">
                  <!-- Será preenchido via JavaScript -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Gráfico de Barras: Quantidade de Vendas por Mês -->
          <div id="graficoContainer" style="display: none;" class="mt-5">
            <h5 class="mb-3">Quantidade de Vendas por Mês</h5>
            <div class="card">
              <div class="card-body">
                <canvas id="graficoVendas"></canvas>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const mesesNomes = ['', 'JAN', 'FEV', 'MAR', 'ABR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'DEZ'];

let anoAtual = new Date().getFullYear();

// Popular dropdown de anos com anos disponíveis no banco
async function popularAnos() {
    console.log('[popularAnos] Iniciando...');
    const select = document.getElementById('anoSelect');
    const mensagemSemDados = document.getElementById('mensagemSemDados');
    
    if (!select) {
        console.error('[popularAnos] Elemento anoSelect não encontrado!');
        return;
    }
    
    if (!mensagemSemDados) {
        console.error('[popularAnos] Elemento mensagemSemDados não encontrado!');
        return;
    }
    
    try {
        console.log('[popularAnos] Fazendo requisição para /importancia-meses/api/available-years...');
        const response = await fetch('/importancia-meses/api/available-years', {
            credentials: 'include'
        });
        console.log('[popularAnos] Response status:', response.status, response.statusText);
        
        if (response.ok) {
            const anos = await response.json();
            console.log('[popularAnos] Anos recebidos:', anos);
            
            if (!Array.isArray(anos) || anos.length === 0) {
                // Não há anos cadastrados - mostrar mensagem e ocultar dropdown
                console.log('[popularAnos] Nenhum ano encontrado');
                select.style.display = 'none';
                mensagemSemDados.style.display = 'block';
                mensagemSemDados.textContent = 'Nenhuma importância de mês cadastrada. Clique em "Cadastrar Importâncias dos Meses" para começar.';
                document.getElementById('tabelaMesesContainer').style.display = 'none';
                return;
            }
            
            // Há anos cadastrados - mostrar dropdown e popular
            console.log('[popularAnos] Populando dropdown com', anos.length, 'anos');
            select.style.display = 'block';
            mensagemSemDados.style.display = 'none';
            select.innerHTML = '<option value="">Selecione um ano...</option>';
            
            anos.sort((a, b) => b - a); // Ordenar do mais recente para o mais antigo
            anos.forEach(ano => {
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                select.appendChild(option);
            });
            
            // Selecionar o primeiro ano (mais recente) automaticamente
            if (anos.length > 0) {
                select.value = anos[0];
                console.log('[popularAnos] Selecionando ano:', anos[0]);
                await carregarImportanciaMeses();
            }
        } else {
            // Erro na API - mostrar mensagem
            console.error('[popularAnos] Erro na resposta:', response.status);
            const errorText = await response.text();
            console.error('[popularAnos] Erro detalhado:', errorText);
            select.style.display = 'none';
            mensagemSemDados.style.display = 'block';
            mensagemSemDados.textContent = 'Erro ao carregar dados. Tente novamente.';
        }
    } catch (error) {
        console.error('[popularAnos] Erro ao carregar anos:', error);
        select.style.display = 'none';
        mensagemSemDados.style.display = 'block';
        mensagemSemDados.textContent = 'Erro ao carregar dados. Tente novamente.';
    }
    
    // Adicionar listener apenas uma vez
    if (!select.hasAttribute('data-listener-added')) {
        select.setAttribute('data-listener-added', 'true');
        select.addEventListener('change', function() {
            if (this.value) {
                console.log('[popularAnos] Ano alterado para:', this.value);
                carregarImportanciaMeses();
            }
        });
    }
}

async function carregarImportanciaMeses() {
    const ano = document.getElementById('anoSelect').value;
    if (!ano) {
        console.log('Nenhum ano selecionado');
        return;
    }
    
    console.log('Carregando dados para o ano:', ano);
    
    try {
        const response = await fetch(`/importancia-meses/api/month-importance/${ano}`, {
            credentials: 'include'
        });
        console.log('Response status:', response.status);
        
        if (!response.ok) throw new Error('Erro ao carregar dados');
        
        const meses = await response.json();
        console.log('Meses recebidos:', meses);
        // Log detalhado dos primeiros meses para debug
        if (meses.length > 0) {
            console.log('Primeiros 3 meses detalhados:', meses.slice(0, 3).map(m => ({
                month: m.month,
                nota: m.nota_atribuida,
                ritmo: m.ritmo_negocio_percentual,
                qtd_real: m.quantidade_vendas_real,
                qtd_est: m.quantidade_vendas_estimada
            })));
            console.log('Últimos 3 meses detalhados:', meses.slice(9, 12).map(m => ({
                month: m.month,
                nota: m.nota_atribuida,
                ritmo: m.ritmo_negocio_percentual,
                qtd_real: m.quantidade_vendas_real,
                qtd_est: m.quantidade_vendas_estimada
            })));
        }
        
        if (meses.length === 0) {
            console.log('Nenhum mês encontrado para o ano:', ano);
            document.getElementById('mensagemSemDados').style.display = 'block';
            document.getElementById('tabelaMesesContainer').style.display = 'none';
            document.getElementById('graficoContainer').style.display = 'none';
            return;
        }
        
        console.log('Exibindo tabela com', meses.length, 'meses');
        document.getElementById('mensagemSemDados').style.display = 'none';
        document.getElementById('tabelaMesesContainer').style.display = 'block';
        
        preencherTabelaMeses(meses);
        
        // Criar gráfico de barras
        criarGraficoVendas(meses);
    } catch (error) {
        console.error('Erro ao carregar dados:', error);
        document.getElementById('mensagemSemDados').style.display = 'block';
        document.getElementById('mensagemSemDados').textContent = 'Erro ao carregar dados. Tente novamente.';
    }
}

function preencherTabelaMeses(meses) {
    const tbody = document.getElementById('tabelaMeses');
    tbody.innerHTML = '';
    
    // Ordenar meses de 1 a 12
    meses.sort((a, b) => a.month - b.month);
    
    // Garantir que temos dados para todos os 12 meses (criar objetos vazios se necessário)
    const mesesMap = {};
    meses.forEach(mes => {
        mesesMap[mes.month] = mes;
    });
    
    // Preencher todos os 12 meses
    const anoDoPrimeiroMes = meses.length > 0 ? meses[0].year : new Date().getFullYear();
    for (let month = 1; month <= 12; month++) {
        const mes = mesesMap[month] || {
            year: anoDoPrimeiroMes,
            month: month,
            nota_atribuida: null,
            ritmo_negocio_percentual: null,
            quantidade_vendas_real: null,
            quantidade_vendas_estimada: null,
            peso_mes: null
        };
        
        const tr = document.createElement('tr');
        const quantidadeVendas = mes.quantidade_vendas_real !== null && mes.quantidade_vendas_real !== undefined 
            ? mes.quantidade_vendas_real 
            : mes.quantidade_vendas_estimada;
        
        tr.innerHTML = `
            <td>${mes.year}</td>
            <td class="mes-nome">${mesesNomes[mes.month]}</td>
            <td>${mes.nota_atribuida !== null && mes.nota_atribuida !== undefined ? mes.nota_atribuida.toFixed(2) : '-'}</td>
            <td>${mes.ritmo_negocio_percentual !== null && mes.ritmo_negocio_percentual !== undefined ? mes.ritmo_negocio_percentual.toFixed(1) + '%' : '-'}</td>
            <td>${quantidadeVendas !== null && quantidadeVendas !== undefined ? Math.round(quantidadeVendas) : '-'}</td>
        `;
        tbody.appendChild(tr);
    }
}

// Funções removidas - tabela de eventos não é mais exibida na tela principal

let graficoVendas = null;

function criarGraficoVendas(meses) {
    const canvas = document.getElementById('graficoVendas');
    if (!canvas) {
        console.warn('[criarGraficoVendas] Canvas não encontrado');
        return;
    }
    
    // Destruir gráfico anterior se existir
    if (graficoVendas) {
        graficoVendas.destroy();
        graficoVendas = null;
    }
    
    // Preparar dados
    const labels = [];
    const dados = [];
    
    // Ordenar meses por número do mês (1-12)
    const mesesOrdenados = [...meses].sort((a, b) => a.month - b.month);
    
    mesesOrdenados.forEach(mes => {
        const quantidadeVendas = mes.quantidade_vendas_real !== null && mes.quantidade_vendas_real !== undefined 
            ? mes.quantidade_vendas_real 
            : mes.quantidade_vendas_estimada;
        
        if (quantidadeVendas !== null && quantidadeVendas !== undefined) {
            labels.push(mesesNomes[mes.month]);
            dados.push(Math.round(quantidadeVendas));
        }
    });
    
    // Se não houver dados, ocultar o gráfico
    if (dados.length === 0) {
        document.getElementById('graficoContainer').style.display = 'none';
        return;
    }
    
    // Exibir o gráfico
    document.getElementById('graficoContainer').style.display = 'block';
    
    // Verificar se Chart está disponível
    if (typeof Chart === 'undefined') {
        console.error('[criarGraficoVendas] Chart.js não está disponível');
        return;
    }
    
    // Criar gráfico de barras verticais
    const ctx = canvas.getContext('2d');
    graficoVendas = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Quantidade de Vendas',
                data: dados,
                backgroundColor: 'rgba(108, 117, 125, 0.6)',
                borderColor: 'rgba(108, 117, 125, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        precision: 0
                    },
                    title: {
                        display: true,
                        text: 'Quantidade de Vendas'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Mês'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Vendas: ' + Math.round(context.parsed.y);
                        }
                    }
                }
            }
        }
    });
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    popularAnos();
    const ano = document.getElementById('anoSelect').value;
    if (ano) {
        carregarImportanciaMeses();
    }
});
</script>
{% endblock %}
